<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-02-20 Thu 20:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The kcats Programming Language (Production Implementation)</title>
<meta name="author" content="Skyrod Vactai" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<style> pre.src { background: black; color: white; } #content { max-width: 1000px } </style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="docs-custom.css"/>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">The kcats Programming Language (Production Implementation)</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc914b4b">1. Production implementation</a>
<ul>
<li><a href="#org3786925">1.1. Base Language</a></li>
<li><a href="#org8f7bde1">1.2. Status</a></li>
<li><a href="#org7c32313">1.3. Building</a>
<ul>
<li><a href="#org9f8b24c">1.3.1. Dependencies</a></li>
<li><a href="#org501b3d6">1.3.2. Build</a></li>
</ul>
</li>
<li><a href="#using">1.4. Using</a>
<ul>
<li><a href="#orgf5f6fb5">1.4.1. Command line REPL</a></li>
<li><a href="#org49ce2e9">1.4.2. Command line</a></li>
<li><a href="#orgf1539ea">1.4.3. Emacs Interactive REPL</a></li>
</ul>
</li>
<li><a href="#source">1.5. Source</a>
<ul>
<li><a href="#org366c5eb">1.5.1. Project File</a></li>
<li><a href="#orgef06597">1.5.2. Internal traits</a></li>
<li><a href="#orgba8e7e0">1.5.3. Internal data types</a>
<ul>
<li><a href="#org2a25d15">1.5.3.1. Basic internal types</a></li>
<li><a href="#org1c94495">1.5.3.2. Number types</a></li>
<li><a href="#org03c7a40">1.5.3.3. Container types</a></li>
<li><a href="#orge706abd">1.5.3.4. Associative types</a></li>
<li><a href="#org5fbbd44">1.5.3.5. Error types</a></li>
<li><a href="#org0d595b4">1.5.3.6. Dictionary types</a></li>
<li><a href="#org13398d0">1.5.3.7. Environment types</a></li>
<li><a href="#orgf4eeb2c">1.5.3.8. Hash-based object cache</a></li>
<li><a href="#orgf780a71">1.5.3.9. Cryptographic primitives</a></li>
</ul>
</li>
<li><a href="#org39730eb">1.5.4. Serialization</a></li>
<li><a href="#org1475d19">1.5.5. Builtin words</a></li>
<li><a href="#org18c6b15">1.5.6. Top level library</a></li>
<li><a href="#org5c0639a">1.5.7. Top level execution</a></li>
<li><a href="#orgbe9061d">1.5.8. Pipes (input/output)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8d92ec7">2. Issues</a>
<ul>
<li><a href="#org4b76d8e">2.1. <span class="todo INPROGRESS">INPROGRESS</span> Interactive mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></a>
<ul>
<li><a href="#org2323da4">2.1.1. <span class="done CANCELED">CANCELED</span> Only print the changed part of the stack</a></li>
<li><a href="#orgf696351">2.1.2. <span class="todo TODO">TODO</span> Emacs keybindings to send common stack ops</a></li>
</ul>
</li>
<li><a href="#orga676960">2.2. <span class="todo INPROGRESS">INPROGRESS</span> Implement pipes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#orgab74701">2.2.1. <span class="done DONE">DONE</span> Write to a file</a></li>
<li><a href="#org0522754">2.2.2. <span class="done DONE">DONE</span> Read from a file</a></li>
<li><a href="#org8e9ca26">2.2.3. <span class="done DONE">DONE</span> Close a pipe</a></li>
<li><a href="#org0d686fc">2.2.4. <span class="done DONE">DONE</span> Serialize pipes with something sane</a></li>
<li><a href="#org97f3dbe">2.2.5. <span class="done DONE">DONE</span> Sockets</a>
<ul>
<li><a href="#orgf6f05d8">2.2.5.1. <span class="done DONE">DONE</span> Server Sockets</a></li>
<li><a href="#org8ead95a">2.2.5.2. <span class="done DONE">DONE</span> Sockets</a></li>
<li><a href="#orgce6f42f">2.2.5.3. <span class="done CANCELED">CANCELED</span> Assemble is broken when reading files</a></li>
</ul>
</li>
<li><a href="#orgd05b66d">2.2.6. <span class="done DONE">DONE</span> Convert In/Out traits to enums in pipes modules</a></li>
<li><a href="#org08c6b6d">2.2.7. <span class="done DONE">DONE</span> Composable transforms</a>
<ul>
<li><a href="#orgae64dc8">2.2.7.1. <span class="done DONE">DONE</span> Siphon from one pipe to another</a></li>
</ul>
</li>
<li><a href="#orga9253b8">2.2.8. <span class="done CANCELED">CANCELED</span> Filled pipes</a></li>
<li><a href="#org35348ae">2.2.9. <span class="todo INPROGRESS">INPROGRESS</span> Object pipes</a>
<ul>
<li><a href="#orgf9c5e7d">2.2.9.1. <span class="todo INPROGRESS">INPROGRESS</span> Generator re-splitting</a></li>
<li><a href="#orgbce918a">2.2.9.2. <span class="todo TODO">TODO</span> Another take on re-splitting</a></li>
</ul>
</li>
<li><a href="#orgb4c3492">2.2.10. <span class="done DONE">DONE</span> Time pipe</a></li>
<li><a href="#orgf2775d8">2.2.11. <span class="done DONE">DONE</span> stdin/stdout pipes</a></li>
<li><a href="#orgf342c52">2.2.12. <span class="done CANCELED">CANCELED</span> Pipe take outcome</a></li>
</ul>
</li>
<li><a href="#orgce67a64">2.3. <span class="todo TODO">TODO</span> Error should have actual struct fields&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></a></li>
<li><a href="#orgf6eb2b2">2.4. <span class="todo INPROGRESS">INPROGRESS</span> Script</a>
<ul>
<li><a href="#orgac88733">2.4.1. <span class="done DONE">DONE</span> Cryptographic primitives</a>
<ul>
<li><a href="#orgb5d7c19">2.4.1.1. <span class="done DONE">DONE</span> SHA256</a></li>
<li><a href="#org1fa7444">2.4.1.2. <span class="done DONE">DONE</span> Signing</a></li>
<li><a href="#org1d82031">2.4.1.3. <span class="done DONE">DONE</span> Make verify return the message</a></li>
<li><a href="#org51e7aa5">2.4.1.4. <span class="todo TODO">TODO</span> AES Encryption</a></li>
<li><a href="#org24284f6">2.4.1.5. <span class="todo TODO">TODO</span> Random</a></li>
</ul>
</li>
<li><a href="#org737ee8d">2.4.2. <span class="done DONE">DONE</span> Pure functional env</a></li>
<li><a href="#orgc746435">2.4.3. <span class="todo TODO">TODO</span> Infinite loop protection</a></li>
</ul>
</li>
<li><a href="#org9a1dc22">2.5. <span class="todo TODO">TODO</span> retry should have opposite argument order&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span>&#xa0;<span class="consistency">consistency</span></span></a></li>
<li><a href="#org4a1d67e">2.6. <span class="todo INPROGRESS">INPROGRESS</span> Support Kademlia DHT</a>
<ul>
<li><a href="#org86b1d2e">2.6.1. <span class="done DONE">DONE</span> XOR</a></li>
<li><a href="#org84fc915">2.6.2. <span class="todo INPROGRESS">INPROGRESS</span> Simple API server</a></li>
<li><a href="#org45bfd27">2.6.3. <span class="todo INPROGRESS">INPROGRESS</span> Simple API client</a></li>
<li><a href="#org789a88a">2.6.4. <span class="todo TODO">TODO</span> Kademlia functions</a></li>
</ul>
</li>
<li><a href="#org263ae9b">2.7. <span class="done DONE">DONE</span> read and emit don't have quite the same semantics&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></a></li>
<li><a href="#org2e9b381">2.8. <span class="done DONE">DONE</span> Inconsistent stack handling when encountering error&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></a>
<ul>
<li><a href="#org654a014">2.8.1. <span class="done DONE">DONE</span> 'read' on invalid edn consumes the string argument</a></li>
<li><a href="#org6ec8808">2.8.2. <span class="done DONE">DONE</span> Division by zero consumes stack items</a></li>
</ul>
</li>
<li><a href="#org42113af">2.9. <span class="done DONE">DONE</span> Inconsistent expression handling when encountering error</a></li>
<li><a href="#org536a8dd">2.10. <span class="todo TODO">TODO</span> Performance optimizations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></a>
<ul>
<li><a href="#org111e96c">2.10.1. <span class="todo TODO">TODO</span> Compile programs</a></li>
<li><a href="#org250d638">2.10.2. <span class="todo TODO">TODO</span> Programs as their own immutable type</a></li>
</ul>
</li>
<li><a href="#orgf0c264b">2.11. <span class="todo INPROGRESS">INPROGRESS</span> Generators&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#orgf6d131d">2.11.1. <span class="done DONE">DONE</span> Basic functionality and generators</a></li>
<li><a href="#org6c9e5e8">2.11.2. <span class="done DONE">DONE</span> map</a></li>
<li><a href="#orgb301c1c">2.11.3. <span class="done DONE">DONE</span> filter</a></li>
<li><a href="#org5ae56d5">2.11.4. <span class="done DONE">DONE</span> take</a></li>
<li><a href="#org965976f">2.11.5. <span class="done DONE">DONE</span> drop</a></li>
<li><a href="#org7925ee4">2.11.6. <span class="done DONE">DONE</span> drop-while (skipper)</a></li>
<li><a href="#orge9eee7d">2.11.7. <span class="done DONE">DONE</span> take-while (catcher)</a></li>
<li><a href="#org3384ba8">2.11.8. <span class="done CANCELED">CANCELED</span> last</a></li>
<li><a href="#org8b8aad6">2.11.9. <span class="todo TODO">TODO</span> distinct</a></li>
<li><a href="#orgccc70ef">2.11.10. <span class="done DONE">DONE</span> partition</a></li>
<li><a href="#orged0f15f">2.11.11. <span class="done DONE">DONE</span> joiner (aka catenate)</a></li>
<li><a href="#org2348070">2.11.12. <span class="done DONE">DONE</span> groupby</a></li>
<li><a href="#orgf385257">2.11.13. <span class="done CANCELED">CANCELED</span> Map/filter can't access lower stack items</a>
<ul>
<li><a href="#org0772405">2.11.13.1. Problem</a></li>
<li><a href="#orgfba5c04">2.11.13.2. Debug session</a></li>
<li><a href="#orgfc2573b">2.11.13.3. Resolution</a></li>
<li><a href="#org75f5344">2.11.13.4. <span class="done DONE">DONE</span> Add functions to help capture environment for map/filter fns</a></li>
</ul>
</li>
<li><a href="#org16fb6db">2.11.14. <span class="done DONE">DONE</span> Reduce</a></li>
<li><a href="#orgf02eaf6">2.11.15. <span class="done CANCELED">CANCELED</span> Generator combinators?</a></li>
<li><a href="#orgc3221c4">2.11.16. <span class="done DONE">DONE</span> Applying generator to an existing container</a></li>
<li><a href="#orgb063731">2.11.17. <span class="todo INPROGRESS">INPROGRESS</span> Combinations</a></li>
<li><a href="#orgbdee382">2.11.18. <span class="done DONE">DONE</span> Frequencies</a></li>
</ul>
</li>
<li><a href="#org908621e">2.12. <span class="todo TODO">TODO</span> Make floats hashable</a></li>
<li><a href="#org13896d2">2.13. <span class="done DONE">DONE</span> Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#org4bf7b7f">2.13.1. <span class="done DONE">DONE</span> Implement partialord</a></li>
<li><a href="#orgfdbbfa4">2.13.2. <span class="done DONE">DONE</span> Implement compare</a></li>
</ul>
</li>
<li><a href="#org5232eb7">2.14. <span class="todo TODO">TODO</span> Stream transformation</a></li>
<li><a href="#orge87707f">2.15. <span class="todo INPROGRESS">INPROGRESS</span> Select from multiple pipes</a>
<ul>
<li><a href="#org3c28e60">2.15.1. <span class="todo TODO">TODO</span> Attend should leave the pipe list argument</a></li>
<li><a href="#org4adf4ea">2.15.2. <span class="todo TODO">TODO</span> Better error handling</a></li>
</ul>
</li>
<li><a href="#orgfecb77f">2.16. <span class="todo TODO">TODO</span> Monitoring tools</a>
<ul>
<li><a href="#orgc4587f5">2.16.1. <span class="todo TODO">TODO</span> Reporting back to the mothership</a></li>
<li><a href="#org3439282">2.16.2. <span class="todo TODO">TODO</span> Monitoring UI</a></li>
</ul>
</li>
<li><a href="#org9021608">2.17. <span class="todo INPROGRESS">INPROGRESS</span> Native REPL</a>
<ul>
<li><a href="#orgd19ff83">2.17.1. <span class="done DONE">DONE</span> Main mode of reading program from cmdline or file</a></li>
<li><a href="#orgb6544eb">2.17.2. <span class="todo INPROGRESS">INPROGRESS</span> REPL as a kcats program</a></li>
</ul>
</li>
<li><a href="#orgfb4b2fb">2.18. <span class="done CANCELED">CANCELED</span> Words that quote programs instead of executing them</a>
<ul>
<li><a href="#org8711905">2.18.1. <span class="todo TODO">TODO</span> Get rid of self-inserting programs (esp with generators)</a></li>
</ul>
</li>
<li><a href="#orgce36eb7">2.19. <span class="todo TODO">TODO</span> Data compression</a></li>
<li><a href="#org2103fb8">2.20. <span class="todo TODO">TODO</span> Multimethod improvements</a>
<ul>
<li><a href="#org416c504">2.20.1. <span class="todo TODO">TODO</span> Convert to multi</a></li>
<li><a href="#org6e2b994">2.20.2. <span class="done DONE">DONE</span> Refactor addmethod</a></li>
<li><a href="#org90496d7">2.20.3. <span class="done DONE">DONE</span> ismulti?</a></li>
</ul>
</li>
<li><a href="#org409ee52">2.21. <span class="done CANCELED">CANCELED</span> run multiple programs on same argument to get list</a></li>
<li><a href="#org3c973ba">2.22. <span class="todo INPROGRESS">INPROGRESS</span> pairwise operations</a></li>
<li><a href="#org6ec3d40">2.23. <span class="done DONE">DONE</span> Non-generator filter</a></li>
<li><a href="#org3838901">2.24. <span class="todo INPROGRESS">INPROGRESS</span> Modules</a>
<ul>
<li><a href="#orgfbc4bed">2.24.1. Problem statement</a>
<ul>
<li><a href="#orgefe91c7">2.24.1.1. <span class="todo TODO">TODO</span> Efficient use</a></li>
<li><a href="#orgb35d0cc">2.24.1.2. <span class="todo TODO">TODO</span> Modification happens once per program</a></li>
<li><a href="#orga33f450">2.24.1.3. <span class="todo TODO">TODO</span> Nested library calls need to work</a></li>
<li><a href="#org2794c67">2.24.1.4. <span class="todo TODO">TODO</span> Code should be shareable</a></li>
<li><a href="#org61943b5">2.24.1.5. <span class="todo TODO">TODO</span> Building vocabulary and the programs that use that vocabulary need to be separable</a></li>
<li><a href="#org37f7235">2.24.1.6. <span class="todo TODO">TODO</span> Sandboxing</a></li>
</ul>
</li>
<li><a href="#org576999d">2.24.2. Discussion</a>
<ul>
<li><a href="#org6f80e4b">2.24.2.1. pairs of program/dictionary.</a></li>
<li><a href="#org27108fb">2.24.2.2. not having to recalculate the whole dictionary each time we want to use a module.</a></li>
<li><a href="#orgfc1b56e">2.24.2.3. Separate manifest</a></li>
<li><a href="#org1066d22">2.24.2.4. Use of names</a></li>
<li><a href="#orgb37214a">2.24.2.5. How to implement let</a></li>
<li><a href="#org5d43eca">2.24.2.6. Sandboxing</a></li>
</ul>
</li>
<li><a href="#org6ef13a4">2.24.3. Implementation</a>
<ul>
<li><a href="#org1c5d278">2.24.3.1. <span class="todo TODO">TODO</span> take a dictionary and a program and execute the program with that dict</a></li>
<li><a href="#org5af3a00">2.24.3.2. <span class="todo TODO">TODO</span> take a mapping of name to module and return a dictionary with those modules</a></li>
<li><a href="#org1df36eb">2.24.3.3. <span class="todo TODO">TODO</span> One module depends on another, loads it</a></li>
<li><a href="#orgfa5cbcc">2.24.3.4. <span class="todo TODO">TODO</span> Revert back to namespaces</a></li>
<li><a href="#org1e8579a">2.24.3.5. <span class="todo TODO">TODO</span> Fix partition module logic</a></li>
</ul>
</li>
<li><a href="#org64fd185">2.24.4. <span class="todo INPROGRESS">INPROGRESS</span> inscribe currently re-defines words repeatedly at runtime</a>
<ul>
<li><a href="#orgbceaf77">2.24.4.1. <span class="todo INPROGRESS">INPROGRESS</span> Current design</a></li>
<li><a href="#org72bec5a">2.24.4.2. <span class="todo INPROGRESS">INPROGRESS</span> Library loading</a></li>
<li><a href="#org2a5f565">2.24.4.3. <span class="todo INPROGRESS">INPROGRESS</span> Nesting scopes</a></li>
<li><a href="#org9d456d8">2.24.4.4. <span class="todo TODO">TODO</span> Stack escape protection</a></li>
<li><a href="#org9b54973">2.24.4.5. <span class="todo INPROGRESS">INPROGRESS</span> Sandboxing support</a></li>
<li><a href="#org66aaa4f">2.24.4.6. <span class="todo INPROGRESS">INPROGRESS</span> Access control</a></li>
<li><a href="#orgf5e4da6">2.24.4.7. <span class="todo INPROGRESS">INPROGRESS</span> Words can refer to other words in the same library</a></li>
<li><a href="#orgee457f2">2.24.4.8. <span class="todo TODO">TODO</span> Convenient module definition</a></li>
<li><a href="#org6a84f6c">2.24.4.9. <span class="todo TODO">TODO</span> convenient 'let'</a></li>
<li><a href="#org491360d">2.24.4.10. <span class="todo INPROGRESS">INPROGRESS</span> Break up the standard library</a></li>
<li><a href="#org24b0c7f">2.24.4.11. <span class="done CANCELED">CANCELED</span> Disallow module alias overwriting</a></li>
<li><a href="#org305eb29">2.24.4.12. <span class="todo TODO">TODO</span> Store data sources</a></li>
<li><a href="#org061c5ec">2.24.4.13. <span class="todo TODO">TODO</span> Find stdlib by alias</a></li>
<li><a href="#orgf8aa469">2.24.4.14. <span class="todo TODO">TODO</span> LIbrary loading should be in order of decreasing trust</a></li>
</ul>
</li>
<li><a href="#org6c679e2">2.24.5. <span class="todo TODO">TODO</span> Debugger needs special handling to work with nested environments</a></li>
</ul>
</li>
<li><a href="#org4d0d9ab">2.25. <span class="todo INPROGRESS">INPROGRESS</span> Database</a>
<ul>
<li><a href="#org0bff99a">2.25.1. Books db</a></li>
<li><a href="#orgf3f0ae0">2.25.2. Schema</a></li>
<li><a href="#orgb55251e">2.25.3. Implementation and experiments</a></li>
<li><a href="#org8e45118">2.25.4. Tests database module</a></li>
</ul>
</li>
<li><a href="#org1664184">2.26. <span class="todo TODO">TODO</span> Reduce CPU cost of `shield`&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></a></li>
<li><a href="#orgd762b82">2.27. <span class="todo TODO">TODO</span> Sort out feature dependencies</a></li>
<li><a href="#org7427fb8">2.28. <span class="todo TODO">TODO</span> Improved error messages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="errorHandling">errorHandling</span></span></a>
<ul>
<li><a href="#org7a3a533">2.28.1. <span class="todo TODO">TODO</span> Source mapping&#xa0;&#xa0;&#xa0;<span class="tag"><span class="debugging">debugging</span>&#xa0;<span class="errorHandling">errorHandling</span></span></a></li>
<li><a href="#org7d6983e">2.28.2. <span class="todo TODO">TODO</span> Causal chaining</a></li>
</ul>
</li>
<li><a href="#orga4b348c">2.29. <span class="todo INPROGRESS">INPROGRESS</span> Generate word dependency graph</a></li>
<li><a href="#org58396d8">2.30. <span class="todo INPROGRESS">INPROGRESS</span> Let doesn't inherit the current resolver</a></li>
<li><a href="#orgdab592a">2.31. <span class="done DONE">DONE</span> Make templating a rust function</a></li>
<li><a href="#org13e5763">2.32. <span class="todo INPROGRESS">INPROGRESS</span> Add description to each example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="testing">testing</span></span></a></li>
<li><a href="#orgdd47502">2.33. <span class="todo TODO">TODO</span> Add integration tests&#xa0;&#xa0;&#xa0;<span class="tag"><span class="testing">testing</span></span></a></li>
<li><a href="#org4322269">2.34. <span class="todo TODO">TODO</span> Size of option enums</a></li>
<li><a href="#org832d852">2.35. <span class="todo TODO">TODO</span> Support converting Association to Set</a></li>
<li><a href="#org6e24e11">2.36. <span class="todo INPROGRESS">INPROGRESS</span> Debug nested envs</a>
<ul>
<li><a href="#org61af6e1">2.36.1. <span class="done DONE">DONE</span> write environment? word</a></li>
</ul>
</li>
<li><a href="#org9ef94be">2.37. <span class="todo INPROGRESS">INPROGRESS</span> Emoji</a>
<ul>
<li><a href="#org0499c21">2.37.1. <span class="todo INPROGRESS">INPROGRESS</span> Choose emoji aliases for combinators</a></li>
<li><a href="#orgd3ea916">2.37.2. <span class="todo INPROGRESS">INPROGRESS</span> Automatic conversion of english -&gt; emoji</a></li>
<li><a href="#org582a561">2.37.3. <span class="done DONE">DONE</span> Decide standard syntax</a></li>
<li><a href="#org439e43c">2.37.4. <span class="todo INPROGRESS">INPROGRESS</span> Emit emoji for empty list</a></li>
</ul>
</li>
<li><a href="#orga76f642">2.38. <span class="done DONE">DONE</span> Change yes to nonempty container</a></li>
<li><a href="#org6de996a">2.39. <span class="todo INPROGRESS">INPROGRESS</span> Combinators</a>
<ul>
<li><a href="#org9a57038">2.39.1. <span class="todo TODO">TODO</span> Discussion</a></li>
<li><a href="#org83beb8a">2.39.2. <span class="done DONE">DONE</span> Update branch behavior to keep conditional</a></li>
<li><a href="#orgb00d301">2.39.3. <span class="todo INPROGRESS">INPROGRESS</span> Update generators to compose more naturally</a></li>
<li><a href="#org61b2afe">2.39.4. <span class="done DONE">DONE</span> Fix recur logic</a></li>
<li><a href="#orgc8f1255">2.39.5. <span class="done DONE">DONE</span> Every</a></li>
<li><a href="#org063293f">2.39.6. <span class="todo INPROGRESS">INPROGRESS</span> Recover</a></li>
</ul>
</li>
<li><a href="#org34edec9">2.40. <span class="todo TODO">TODO</span> Rename combinators to noun-based</a></li>
<li><a href="#org4444a82">2.41. <span class="done DONE">DONE</span> Support 'doc' field of dictionary entries</a></li>
<li><a href="#org95536d9">2.42. <span class="todo INPROGRESS">INPROGRESS</span> Back to stacking generators with optional encapsulation</a>
<ul>
<li><a href="#orgd2b4d28">2.42.1. <span class="todo INPROGRESS">INPROGRESS</span> See if we can wrap state with generator</a></li>
<li><a href="#orgf188a7e">2.42.2. <span class="todo INPROGRESS">INPROGRESS</span> Convert some generators to not wrap</a>
<ul>
<li><a href="#orgefc56a9">2.42.2.1. each</a></li>
<li><a href="#org96114d4">2.42.2.2. joiner</a></li>
<li><a href="#org8534841">2.42.2.3. skipper</a></li>
<li><a href="#orgf7dbba5">2.42.2.4. keep</a></li>
<li><a href="#org06b0205">2.42.2.5. dropper</a></li>
<li><a href="#orga22c272">2.42.2.6. catcher</a></li>
<li><a href="#orgdaa5aa8">2.42.2.7. produce</a></li>
<li><a href="#orga5e75c1">2.42.2.8. cram</a></li>
<li><a href="#orgacc5d4d">2.42.2.9. indexer</a></li>
<li><a href="#orgf411ec8">2.42.2.10. flatten</a></li>
<li><a href="#orgdb01225">2.42.2.11. siphon</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org2d053d1">2.43. <span class="todo TODO">TODO</span> max-by min-by</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgc914b4b" class="outline-2">
<h2 id="orgc914b4b"><span class="section-number-2">1.</span> Production implementation</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3786925" class="outline-3">
<h3 id="org3786925"><span class="section-number-3">1.1.</span> Base Language</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Built in Rust - it's fast and modern, its memory allocation model
seems well suited to kcats.
</p>
</div>
</div>
<div id="outline-container-org8f7bde1" class="outline-3">
<h3 id="org8f7bde1"><span class="section-number-3">1.2.</span> Status</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Unstable - code written in kcats now will likely require modification to work
with future versions of the interpreter.
</p>
</div>
</div>
<div id="outline-container-org7c32313" class="outline-3">
<h3 id="org7c32313"><span class="section-number-3">1.3.</span> Building</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org9f8b24c" class="outline-4">
<h4 id="org9f8b24c"><span class="section-number-4">1.3.1.</span> Dependencies</h4>
<div class="outline-text-4" id="text-1-3-1">
<ul class="org-ul">
<li>rustc</li>
<li>cargo</li>
</ul>
</div>
</div>
<div id="outline-container-org501b3d6" class="outline-4">
<h4 id="org501b3d6"><span class="section-number-4">1.3.2.</span> Build</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Run <code>cargo build --release</code>, the binary will be placed in <code>./target/release</code> by
default.
</p>
</div>
</div>
</div>
<div id="outline-container-using" class="outline-3">
<h3 id="using"><span class="section-number-3">1.4.</span> Using</h3>
<div class="outline-text-3" id="text-using">
</div>
<div id="outline-container-orgf5f6fb5" class="outline-4">
<h4 id="orgf5f6fb5"><span class="section-number-4">1.4.1.</span> Command line REPL</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
This is the easiest way to get started. Run <code>kcats -r</code> and it will print
a prompt and wait for you to input items (as many as you like, on a
single line). It will then evaluate all the items and print the
resulting stack. You can then enter more items. It keeps the stack
intact so you're not starting fresh with each input. If you want to
clear the stack, you can use <code>[] restore</code>.
</p>

<p>
Use Ctrl-C to quit.
</p>

<p>
Example session:
</p>
<div class="org-src-container">
<pre class="src src-fundamental">~/workspace/kcats $ kcats -r
kcats&gt; 1
1
kcats&gt; 2
2 1
kcats&gt; +
3
kcats&gt; [7 8 9] [*] step
1512
kcats&gt; 
</pre>
</div>
</div>
</div>
<div id="outline-container-org49ce2e9" class="outline-4">
<h4 id="org49ce2e9"><span class="section-number-4">1.4.2.</span> Command line</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
Execute <code>kcats</code>. It will read a program from stdin and execute it,
then print the resulting stack to stdout. You can pass input to it via stdin via
</p>
<ul class="org-ul">
<li>interactive typing (end input with CTRL-D on most platforms): <code>kcats</code></li>
<li>Piping from a file eg: <code>kcats &lt; myprog.kcats</code></li>
<li>Using echo: <code>echo "[1 2 3] [inc] map" | kcats</code></li>
</ul>
</div>
</div>
<div id="outline-container-orgf1539ea" class="outline-4">
<h4 id="orgf1539ea"><span class="section-number-4">1.4.3.</span> Emacs Interactive REPL</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
See <code>emacs-ide.org</code> in the source tree. The elisp files you need to
evaluate are there. Evaluate them, then run <code>M-x kcats-repl</code>. You may
need to run <code>M-x customize-variable</code>, <code>kcats-babel-executable</code>, and enter
the location where you installed the kcats binary.
</p>
</div>
</div>
</div>
<div id="outline-container-source" class="outline-3">
<h3 id="source"><span class="section-number-3">1.5.</span> Source</h3>
<div class="outline-text-3" id="text-source">
</div>
<div id="outline-container-org366c5eb" class="outline-4">
<h4 id="org366c5eb"><span class="section-number-4">1.5.1.</span> Project File</h4>
<div class="outline-text-4" id="text-1-5-1">
<div class='tangle-wrapper' data-tangle='Cargo.toml'><div class="org-src-container">
<pre class="src src-toml">[<span class="org-type">package</span>]
<span class="org-variable-name">name</span> = <span class="org-string">"kcats"</span>
<span class="org-variable-name">version</span> = <span class="org-string">"1.0.0"</span>
<span class="org-variable-name">edition</span> = <span class="org-string">"2021"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>

[<span class="org-type">workspace.dependencies</span>]
<span class="org-variable-name">rand_core</span> = <span class="org-string">"0.5.1"</span>
<span class="org-variable-name">rand</span> = <span class="org-string">"0.8.5"</span>

[<span class="org-type">dependencies</span>]
<span class="org-comment-delimiter"># </span><span class="org-comment">serialization</span>
<span class="org-variable-name">edn-format</span> = {path = <span class="org-string">"./edn-format"</span>}
<span class="org-variable-name">serde</span> = <span class="org-string">"1"</span>
<span class="org-variable-name">serde_json</span> = <span class="org-string">"1"</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">edn-format = { path = "../edn-format" }</span>
<span class="org-variable-name">base64</span> = <span class="org-string">"0.22"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">String literals</span>
<span class="org-variable-name">internment</span> = {version = <span class="org-string">"0.6.0"</span>, features = [<span class="org-string">"serde"</span>]}
<span class="org-variable-name">lazy_static</span> = <span class="org-string">"1"</span>

<span class="org-variable-name">num-integer</span> = <span class="org-string">"0"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">String format</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">dyn-fmt = "0.4.0" </span>
<span class="org-variable-name">dynfmt</span> = { version = <span class="org-string">"0"</span>, features = [<span class="org-string">"curly"</span>] }

<span class="org-comment-delimiter"># </span><span class="org-comment">crypto stuff</span>
<span class="org-variable-name">ed25519-dalek</span> = {version=<span class="org-string">"1"</span>, features=[<span class="org-string">"batch_deterministic"</span>, <span class="org-string">"std"</span>, <span class="org-string">"rand"</span>]}
<span class="org-variable-name">sha2</span> = {version=<span class="org-string">"0"</span>, features=[<span class="org-string">"std"</span>]}
<span class="org-variable-name">rand_core.workspace</span> = <span class="org-keyword">true</span>
<span class="org-variable-name">rand.workspace</span> = <span class="org-keyword">true</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">multithreading</span>
<span class="org-variable-name">futures</span> = <span class="org-string">"0"</span>
<span class="org-variable-name">tokio</span> = { version = <span class="org-string">"1"</span>, features = [<span class="org-string">"full"</span>] }
<span class="org-comment-delimiter"># </span><span class="org-comment">multiple-consumer channels</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">crossbeam-channel = "0.5" # doesn't support async send/recv</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">async-channel = "1.8.0"</span>
<span class="org-variable-name">flume</span> = <span class="org-string">"0"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">debugging</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">backtrace = "0.3.61"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">database</span>
<span class="org-comment-delimiter">## </span><span class="org-comment">Figure out best place to store the db and stdlib files</span>
<span class="org-variable-name">directories</span> = <span class="org-string">"5"</span>

<span class="org-variable-name">rusqlite</span> = { version = <span class="org-string">"0"</span>, optional = <span class="org-keyword">true</span>, features = [<span class="org-string">"uuid"</span>, <span class="org-string">"bundled"</span>] }

<span class="org-comment-delimiter"># </span><span class="org-comment">memoized functions</span>
<span class="org-variable-name">once_cell</span> = <span class="org-string">"1"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">The blob cache</span>
<span class="org-variable-name">cache</span> = {path = <span class="org-string">"./cache"</span>}

<span class="org-comment-delimiter"># </span><span class="org-comment">Android</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">android logging</span>
<span class="org-variable-name">libc</span> = <span class="org-string">"0.2"</span>
<span class="org-variable-name">jni</span> = <span class="org-string">"0.21"</span>

[<span class="org-type">dependencies.uuid</span>]
<span class="org-variable-name">version</span> = <span class="org-string">"1"</span>
<span class="org-variable-name">features</span> = [
    <span class="org-string">"v4"</span>,                <span class="org-comment-delimiter"># </span><span class="org-comment">Lets you generate random UUIDs</span>
    <span class="org-string">"v7"</span>,
    <span class="org-string">"fast-rng"</span>,          <span class="org-comment-delimiter"># </span><span class="org-comment">Use a faster (but still sufficiently random) RNG</span>
]
<span class="org-comment-delimiter">#</span><span class="org-comment">chrono = "0.4.31"</span>

[<span class="org-type">dev-dependencies</span>]
<span class="org-variable-name">test-case</span> = <span class="org-string">"2"</span>

[<span class="org-type">build-dependencies</span>]
<span class="org-variable-name">directories</span> = <span class="org-string">"5"</span>
<span class="org-variable-name">sha2</span> = <span class="org-string">"0"</span>
<span class="org-variable-name">base64</span> = <span class="org-string">"0.22"</span>
<span class="org-variable-name">cache</span> = {path = <span class="org-string">"./cache"</span>}

[<span class="org-type">features</span>]
<span class="org-variable-name">database</span> = [<span class="org-string">"rusqlite"</span>]

[<span class="org-type">lib</span>]
<span class="org-variable-name">name</span> = <span class="org-string">"kcats"</span>
<span class="org-variable-name">crate-type</span> = [<span class="org-string">"cdylib"</span>, <span class="org-string">"rlib"</span>]
<span class="org-variable-name">path</span> = <span class="org-string">"src/lib.rs"</span>

[[<span class="org-type">bin</span>]]
<span class="org-variable-name">name</span> = <span class="org-string">"kcats"</span>
<span class="org-variable-name">path</span> = <span class="org-string">"src/main.rs"</span>
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orgef06597" class="outline-4">
<h4 id="orgef06597"><span class="section-number-4">1.5.2.</span> Internal traits</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
Because of Rust's orphan rule (you can't implement a trait on a type
unless you own either the trait or the type), we'll opt for making our
own traits rather than using the "newtype" pattern of making our own
types to wrap stdlib types.
</p>
<div class='tangle-wrapper' data-tangle='src/traits.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Define custom traits that mimic std ones</span>
<span class="org-doc">/// a trait similar to [std::convert::From]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Derive</span>&lt;<span class="org-type">T</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">value</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Self</span>;
}

<span class="org-doc">/// a trait similar to [std::convert::TryFrom]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">T</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">value</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt;;
}

<span class="org-doc">/// a trait similar to [std::convert::Into]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Fit</span>&lt;<span class="org-type">T</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">T</span>;
}

<span class="org-doc">/// a trait similar to [std::convert::TryInto]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">TryFit</span>&lt;<span class="org-type">T</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_fit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt;;
}

<span class="org-doc">/// a trait that marks iterable types that can return arbitrary</span>
<span class="org-doc">/// numbers of items. For example lists, maps, etc. But not things</span>
<span class="org-doc">/// like Result or Option.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">IntoList</span> {}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">ToIterator</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span>;
    <span class="org-keyword">type</span> <span class="org-variable-name">IntoIter</span>: <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">to_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span>;
}

<span class="org-comment-delimiter">// </span><span class="org-comment">impl&lt;T&gt; ToIterator for Vec&lt;T&gt; {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Item = T;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type IntoIter = std::vec::IntoIter&lt;T&gt;;</span>

<span class="org-comment-delimiter">//     </span><span class="org-comment">fn to_iter(self) -&gt; Self::IntoIter {</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">self.into_iter()</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">A</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">A</span>&gt;&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Self</span>;
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">TryDeriveIterator</span>&lt;<span class="org-type">A</span>&gt;: <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">try_from_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">l</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">A</span>&gt;;
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-variable-name">MyCollect</span>: <span class="org-type">Iterator</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">my_collect</span>&lt;<span class="org-type">B</span>&gt;(<span class="org-keyword">self</span>) -&gt; <span class="org-type">B</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">B</span>: <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;,
        <span class="org-variable-name">Self</span>: <span class="org-type">Sized</span>,
    {
        <span class="org-type">B</span>::derive_iter(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-variable-name">I</span>: <span class="org-type">Iterator</span>&gt; <span class="org-type">MyCollect</span> <span class="org-keyword">for</span> <span class="org-type">I</span> {}

<span class="org-comment-delimiter">//</span><span class="org-comment">blanket impl</span>
<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>&gt; <span class="org-type">Fit</span>&lt;<span class="org-type">U</span>&gt; <span class="org-keyword">for</span> <span class="org-type">T</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">U</span>: <span class="org-type">Derive</span>&lt;<span class="org-type">T</span>&gt;,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">fit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">U</span> {
        <span class="org-type">U</span>::derive(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>&gt; <span class="org-type">TryFit</span>&lt;<span class="org-type">U</span>&gt; <span class="org-keyword">for</span> <span class="org-type">T</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">U</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">T</span>&gt;,
{
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">U</span>::<span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_fit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">U</span>, <span class="org-type">U</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-type">U</span>::try_derive(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">Derive</span>&lt;<span class="org-type">T</span>&gt; <span class="org-keyword">for</span> <span class="org-type">T</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">value</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">T</span> {
        value
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">TryDerive</span>&lt;<span class="org-type">T</span>&gt; <span class="org-keyword">for</span> <span class="org-type">T</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">value</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-type">Ok</span>(value)
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Fresh</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fresh</span>() -&gt; <span class="org-type">Self</span>;
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orgba8e7e0" class="outline-4">
<h4 id="orgba8e7e0"><span class="section-number-4">1.5.3.</span> Internal data types</h4>
<div class="outline-text-4" id="text-1-5-3">
</div>
<div id="outline-container-org2a25d15" class="outline-5">
<h5 id="org2a25d15"><span class="section-number-5">1.5.3.1.</span> Basic internal types</h5>
<div class="outline-text-5" id="text-1-5-3-1">
<p>
We'll start by defining the basic data structures that kcats will use
internally, to keep track of things like the stack, program, lists etc.
</p>
<div class='tangle-wrapper' data-tangle='src/types.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Defines kcats internal data types.</span>
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Emit</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> coll;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::dictionary <span class="org-keyword">as</span> dict;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::environment <span class="org-keyword">as</span> env;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-type">Mutey</span>;

<span class="org-keyword">use</span> <span class="org-constant">core</span>::<span class="org-constant">default</span>::<span class="org-type">Default</span>;
<span class="org-keyword">use</span> <span class="org-constant">core</span>::fmt;
<span class="org-keyword">use</span> <span class="org-constant">internment</span>::<span class="org-type">Intern</span>;
<span class="org-keyword">use</span> <span class="org-constant">lazy_static</span>::lazy_static;
<span class="org-keyword">use</span> <span class="org-constant">number</span>::<span class="org-type">Number</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::{<span class="org-type">HashMap</span>, <span class="org-type">VecDeque</span>};

<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">hash</span>::<span class="org-type">Hash</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">marker</span>::<span class="org-type">Sync</span>;

<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">pin</span>::<span class="org-type">Pin</span>;

<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">container</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">number</span>;

<span class="org-doc">/// A Word causes a kcats program to do something, usually taking some</span>
<span class="org-doc">/// items derive the top of the stack, and using them to create new</span>
<span class="org-doc">/// stack items. (examples: `swap`, `+`, `dip`).</span>
<span class="org-preprocessor">#[derive(Clone, Eq, PartialOrd, Ord, Default, Hash, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Word</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">data</span>: <span class="org-type">Intern</span>&lt;<span class="org-type">String</span>&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">quoted</span>: <span class="org-type">bool</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">namespace</span>: <span class="org-constant">dict</span>::<span class="org-type">Namespace</span>,
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Word</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.quoted {
            <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"[</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">]"</span>, <span class="org-type">Item</span>::<span class="org-type">Word</span>(<span class="org-keyword">self</span>.clone()).emit())
        } <span class="org-keyword">else</span> {
            <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-type">Item</span>::<span class="org-type">Word</span>(<span class="org-keyword">self</span>.clone()).emit())
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Word</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Word</span>::derive(s.as_str())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Word</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Word</span> {
            <span class="org-variable-name">data</span>: <span class="org-type">Intern</span>::&lt;<span class="org-type">String</span>&gt;::from(s),
            <span class="org-variable-name">quoted</span>: <span class="org-keyword">false</span>,
            <span class="org-variable-name">namespace</span>: <span class="org-type">None</span>,
        }
    }
}

<span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">a</span>&gt; <span class="org-type">Derive</span>&lt;<span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-type">Word</span>&gt; <span class="org-keyword">for</span> <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-type">str</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-type">Word</span>) -&gt; <span class="org-type">Self</span> {
        s.data.as_str()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Word</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Self</span> {
        s.data.to_string()
    }
}

<span class="org-doc">/// Represents a stack (the part of an</span>
<span class="org-doc">/// [crate::types::container::environment::Environment] that holds the data</span>
<span class="org-doc">/// values being manipulated by the program).</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Stack</span> = <span class="org-constant">container</span>::<span class="org-type">List</span>;

<span class="org-doc">/// A byte array type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Bytes</span> = <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;;

<span class="org-doc">/// A character type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Char</span> = <span class="org-type">char</span>;

<span class="org-comment-delimiter">// </span><span class="org-comment">Some static values for commonly used words</span>
<span class="org-preprocessor">lazy_static!</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_ASSOC</span>: <span class="org-type">Word</span> = <span class="org-string">"association"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_BOOLEAN</span>: <span class="org-type">Word</span> = <span class="org-string">"boolean"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_BYTES</span>: <span class="org-type">Word</span> = <span class="org-string">"bytes"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_CHAR</span>: <span class="org-type">Word</span> = <span class="org-string">"character"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_DICTIONARY</span>: <span class="org-type">Word</span> = <span class="org-string">"dictionary"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_DISPENSER</span>: <span class="org-type">Word</span> = <span class="org-string">"dispenser"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_ENVIRONMENT</span>: <span class="org-type">Word</span> = <span class="org-string">"environment"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_ERROR</span>: <span class="org-type">Word</span> = <span class="org-string">"error"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_FLOAT</span>: <span class="org-type">Word</span> = <span class="org-string">"float"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_INTEGER</span>: <span class="org-type">Word</span> = <span class="org-string">"integer"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_ITEM</span>: <span class="org-type">Word</span> = <span class="org-string">"item"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_LIST</span>: <span class="org-type">Word</span> = <span class="org-string">"list"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_NUMBER</span>: <span class="org-type">Word</span> = <span class="org-string">"number"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_ORDERED</span>: <span class="org-type">Word</span> = <span class="org-string">"ordered"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_PIPE</span>: <span class="org-type">Word</span> = <span class="org-string">"pipe"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_PROGRAM</span>: <span class="org-type">Word</span> = <span class="org-string">"program"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_RECEPTACLE</span>: <span class="org-type">Word</span> = <span class="org-string">"receptacle"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_SIZED</span>: <span class="org-type">Word</span> = <span class="org-string">"sized"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_STRING</span>: <span class="org-type">Word</span> = <span class="org-string">"string"</span>.fit();
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">S_WORD</span>: <span class="org-type">Word</span> = <span class="org-string">"word"</span>.fit();
}

<span class="org-doc">/// A kcats data value.</span>
<span class="org-preprocessor">#[derive(Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Item</span> {
    <span class="org-doc">/// A number value</span>
    <span class="org-type">Number</span>(<span class="org-constant">number</span>::<span class="org-type">Number</span>),
    <span class="org-doc">/// A word value. Words are atomic, they can't be broken down into</span>
    <span class="org-doc">/// characters like Strings.</span>
    <span class="org-type">Word</span>(<span class="org-type">Word</span>),
    <span class="org-doc">/// A character value, like 'a', or '\n'.</span>
    <span class="org-type">Char</span>(<span class="org-type">Char</span>),
    <span class="org-doc">/// A builtin function</span>
    <span class="org-type">Builtin</span>(<span class="org-constant">axiom</span>::<span class="org-type">Builtin</span>),
    <span class="org-doc">/// A container value (that [Item]s can be taken from)</span>
    <span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>),
    <span class="org-doc">/// A container value (that [Item]s can be put into)</span>
    <span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>),
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>&lt;'<span class="org-variable-name">_</span>&gt;) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(n) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, n),
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, w),
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"Char</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, c),
            <span class="org-type">Item</span>::<span class="org-type">Builtin</span>(b) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"Builtin</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, b.name),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(d) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, d),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(r) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, r),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Item</span> {
    <span class="org-doc">/// Returns whether the item is empty - only containers can be empty.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_empty</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)) =&gt; s.is_empty(),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s)) =&gt; s.is_empty(),
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-doc">/// A Future value, used for async execution, which is how</span>
<span class="org-doc">/// multithreading is implemented in kcats.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Future</span>&lt;<span class="org-type">T</span>&gt; = <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">T</span>&gt; + <span class="org-type">Send</span>&gt;&gt;;

<span class="org-doc">/// A type for a function that advances the execution of a kcats</span>
<span class="org-doc">/// [env::Environment] by one step.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">StepFn</span> = <span class="org-keyword">dyn</span> <span class="org-type">Fn</span>(<span class="org-constant">env</span>::<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-constant">env</span>::<span class="org-type">Environment</span>&gt; + <span class="org-type">Sync</span> + <span class="org-type">Send</span>;

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            <span class="org-comment-delimiter">// </span><span class="org-comment">same types, just use their own eq</span>
            (<span class="org-type">Item</span>::<span class="org-type">Number</span>(a), <span class="org-type">Item</span>::<span class="org-type">Number</span>(b)) =&gt; a == b,
            (<span class="org-type">Item</span>::<span class="org-type">Word</span>(a), <span class="org-type">Item</span>::<span class="org-type">Word</span>(b)) =&gt; a == b,
            (
                <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(a)),
                <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(b)),
            ) =&gt; a == b,
            (
                <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(a)),
                <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(b)),
            ) =&gt; a == b,
            (<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(a), <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(b)) =&gt; a == b,
            (<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(a), <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(b)) =&gt; a == b,

            (<span class="org-type">Item</span>::<span class="org-type">Char</span>(a), <span class="org-type">Item</span>::<span class="org-type">Char</span>(b)) =&gt; a == b,
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-doc">/// The default Item is empty list.</span>
<span class="org-keyword">impl</span> <span class="org-type">Default</span> <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">default</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::default().fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"string"</span>, i)),
        }
    }
}

<span class="org-doc">/// Converts Item to Word but also considers a quoted word as a word,</span>
<span class="org-doc">/// eg \[foo\] -&gt; foo.</span>
<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Word</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">match</span> s {
                    <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-type">Ok</span>(s.fit()),
                    s =&gt; {
                        <span class="org-keyword">let</span> <span class="org-variable-name">i2</span> = s.clone();
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(s);
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(<span class="org-keyword">mut</span> l) =&gt; {
                                <span class="org-keyword">if</span> l.len() == 1 {
                                    <span class="org-keyword">let</span> <span class="org-variable-name">lm</span> = l.mutate();

                                    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = lm.pop_front().unwrap();
                                    i.try_fit()
                                } <span class="org-keyword">else</span> {
                                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"word"</span>, l))
                                }
                            }
                            <span class="org-type">Err</span>(_) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"word"</span>, i2)),
                        }
                    }
                }
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Bytes</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; <span class="org-type">Ok</span>(b),
            b =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"bytes"</span>, b)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">char</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-type">Ok</span>(c),
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)) =&gt; <span class="org-keyword">match</span> <span class="org-type">char</span>::from_u32(i <span class="org-keyword">as</span> <span class="org-type">u32</span>) {
                <span class="org-type">Some</span>(c) =&gt; <span class="org-type">Ok</span>(c),
                <span class="org-type">None</span> =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"character-encoding"</span>, i)),
            },
            b =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"character"</span>, b)),
        }
    }
}

<span class="org-doc">/// As there are no real booleans, we use the word '&#9989;' but literally</span>
<span class="org-doc">/// any value except empty containers is truthy. If we read a value</span>
<span class="org-doc">/// 'false', that's not actually a boolean, it's just the [Word]</span>
<span class="org-doc">/// false. The fact that the word '&#9989;' is used in the language but</span>
<span class="org-doc">/// 'no' is not, is a known tradeoff.</span>
<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">bool</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">b</span>: <span class="org-type">bool</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">if</span> b {
            <span class="org-string">"&#9989;"</span>.fit()
        } <span class="org-keyword">else</span> {
            <span class="org-type">Item</span>::default()
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">std</span>::<span class="org-constant">io</span>::<span class="org-type">Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">err</span>: <span class="org-constant">std</span>::<span class="org-constant">io</span>::<span class="org-type">Error</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"io"</span>), <span class="org-rust-ampersand">&amp;</span>err.to_string(), <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Word</span>(<span class="org-type">Word</span>::derive(i))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(i)))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Bytes</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">b</span>: <span class="org-type">Bytes</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b)))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Word</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">w</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Word</span>(w)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Char</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Char</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Char</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;()&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">_</span>: ()) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::default()
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">Derive</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">T</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">Item</span>: <span class="org-type">Derive</span>&lt;<span class="org-type">T</span>&gt;,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">opt</span>: <span class="org-type">Option</span>&lt;<span class="org-type">T</span>&gt;) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">match</span> opt {
            <span class="org-type">Some</span>(t) =&gt; <span class="org-type">Item</span>::derive(t),
            <span class="org-type">None</span> =&gt; <span class="org-type">Item</span>::default(),
        }
    }
}

<span class="org-doc">/// A generic impl to convert an Item to a vec of the given</span>
<span class="org-doc">/// type. Assumes the Item is some sort of container and converts each</span>
<span class="org-doc">/// item in the container.</span>
<span class="org-keyword">impl</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span> = <span class="org-type">Error</span>&gt;&gt; <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">First try to convert the Item to an IntoIterator&lt;Item&gt;</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">it</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt; = i.try_fit()<span class="org-rust-question-mark">?</span>;
        it.map(<span class="org-type">T</span>::try_derive).collect()
    }
}

<span class="org-doc">/// A macro to build a kcats List, accepts any values that are</span>
<span class="org-doc">/// convertible to [Item].</span>
<span class="org-preprocessor">#[macro_export]</span>
<span class="org-preprocessor">macro_rules!</span> list {
      ( $( <span class="org-variable-name">$x</span>:expr ),* $(,)<span class="org-rust-question-mark">?</span> ) =&gt; {
          {
              <span class="org-keyword">use</span> $<span class="org-constant">crate</span>::<span class="org-constant">traits</span>::*;
              <span class="org-keyword">use</span> $<span class="org-constant">crate</span>::<span class="org-constant">types</span>::<span class="org-type">Item</span>;
              <span class="org-keyword">let</span> <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt; = <span class="org-preprocessor">vec!</span>[
                  $( $x.fit(), )*
              ];
              $<span class="org-constant">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-type">List</span>::derive(v)
          }
      };
  }

<span class="org-keyword">mod</span> <span class="org-constant">serde</span> {
    <span class="org-doc">//! Support for json serialization of kcats objects</span>
    <span class="org-keyword">use</span> <span class="org-keyword">super</span>::<span class="org-type">Item</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> coll;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::associative <span class="org-keyword">as</span> assoc;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::number;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-type">Error</span>;
    <span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">de</span>::{<span class="org-keyword">self</span>, <span class="org-type">Deserialize</span>, <span class="org-type">Deserializer</span>, <span class="org-type">Visitor</span>};
    <span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">ser</span>::{<span class="org-type">Serialize</span>, <span class="org-type">Serializer</span>};
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashMap</span>;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::fmt;

    <span class="org-keyword">struct</span> <span class="org-type">ItemVisitor</span>;

    <span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-type">Visitor</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-keyword">for</span> <span class="org-type">ItemVisitor</span> {
        <span class="org-keyword">type</span> <span class="org-type">Value</span> = <span class="org-type">Item</span>;

        <span class="org-keyword">fn</span> <span class="org-function-name">expecting</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">formatter</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
            formatter.write_str(<span class="org-string">"expected a specific representation for Item"</span>)
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_i64</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">value</span>: <span class="org-type">i64</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(value)))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_u64</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">value</span>: <span class="org-type">u64</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(value <span class="org-keyword">as</span> <span class="org-type">i64</span>)))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_f64</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">value</span>: <span class="org-type">f64</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Float</span>(value)))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_none</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::default())
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_bool</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">v</span>: <span class="org-type">bool</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::derive(v))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_str</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">v</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(
                <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(v.to_string()),
            )))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_byte_buf</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(
                v,
            ))))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_map</span>&lt;<span class="org-type">A</span>&gt;(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">ma</span>: <span class="org-type">A</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">A</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">A</span>: <span class="org-constant">de</span>::<span class="org-type">MapAccess</span>&lt;'<span class="org-variable-name">de</span>&gt;,
        {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">map</span> = <span class="org-type">HashMap</span>::new();
            <span class="org-keyword">while</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>((key, value)) = ma.next_entry::&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;()<span class="org-rust-question-mark">?</span> {
                map.insert(key, value);
            }
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(
                <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(map.fit())),
            )))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_seq</span>&lt;<span class="org-type">A</span>&gt;(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">seq</span>: <span class="org-type">A</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">A</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">A</span>: <span class="org-constant">de</span>::<span class="org-type">SeqAccess</span>&lt;'<span class="org-variable-name">de</span>&gt;,
        {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">items</span> = <span class="org-type">Vec</span>::new();
            <span class="org-keyword">while</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(item) = seq.next_element::&lt;<span class="org-type">Item</span>&gt;()<span class="org-rust-question-mark">?</span> {
                items.push(item);
            }
            <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive(items).fit())
        }
    }

    <span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-type">Deserialize</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">deserialize</span>&lt;<span class="org-type">D</span>&gt;(<span class="org-variable-name">deserializer</span>: <span class="org-type">D</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">D</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">D</span>: <span class="org-type">Deserializer</span>&lt;'<span class="org-variable-name">de</span>&gt;,
        {
            deserializer.deserialize_any(<span class="org-type">ItemVisitor</span>)
        }
    }

    <span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">serde_json</span>::<span class="org-type">Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">err</span>: <span class="org-constant">serde_json</span>::<span class="org-type">Error</span>) -&gt; <span class="org-type">Error</span> {
            <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"serialize"</span>), <span class="org-rust-ampersand">&amp;</span>err.to_string(), <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
        }
    }

    <span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">Item</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">S</span>: <span class="org-type">Serializer</span>,
        {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
                <span class="org-type">Item</span>::<span class="org-type">Number</span>(num) =&gt; num.serialize(serializer),
                <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; serializer.serialize_char(*c),
                <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; serializer.serialize_str(w.fit()),
                <span class="org-type">Item</span>::<span class="org-type">Builtin</span>(b) =&gt; {
                    serializer.serialize_str(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"builtin_</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, b.name).as_str())
                }
                <span class="org-comment-delimiter">// </span><span class="org-comment">Handle other variants</span>
                <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">dispenser</span>) =&gt; dispenser.serialize(serializer),
                <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">receptacle</span>) =&gt; receptacle.serialize(serializer),
            }
        }
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org1c94495" class="outline-5">
<h5 id="org1c94495"><span class="section-number-5">1.5.3.2.</span> Number types</h5>
<div class="outline-text-5" id="text-1-5-3-2">
<div class='tangle-wrapper' data-tangle='src/types/number.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Support for numbers in kcats. Currently just [i64] and [f64], but</span>
<span class="org-doc">//! this module will eventually support bignums and autopromotion.</span>
<span class="org-keyword">use</span> <span class="org-keyword">super</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> cont;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-type">Item</span>;
<span class="org-keyword">use</span> <span class="org-constant">num_integer</span>::<span class="org-type">Roots</span>;
<span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">ser</span>::{<span class="org-type">Serialize</span>, <span class="org-type">Serializer</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">num</span>::{<span class="org-type">ParseFloatError</span>, <span class="org-type">ParseIntError</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">ops</span>::<span class="org-type">Div</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">ops</span>::<span class="org-type">Rem</span>;
<span class="org-doc">/// An integer type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Int</span> = <span class="org-type">i64</span>;

<span class="org-doc">/// A floating point type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Float</span> = <span class="org-type">f64</span>;

<span class="org-preprocessor">#[derive(Clone, Debug)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Number</span> {
    <span class="org-type">Int</span>(<span class="org-type">Int</span>),
    <span class="org-type">Float</span>(<span class="org-type">Float</span>),
}

<span class="org-keyword">impl</span> <span class="org-type">Number</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">add</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Number</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Int</span>(i + j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i + j),
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(*i <span class="org-keyword">as</span> <span class="org-type">Float</span> + j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i + j <span class="org-keyword">as</span> <span class="org-type">Float</span>),
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">subtract</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Number</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Int</span>(i - j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i - j),
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(*i <span class="org-keyword">as</span> <span class="org-type">Float</span> - j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i - j <span class="org-keyword">as</span> <span class="org-type">Float</span>),
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">multiply</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Number</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Int</span>(i * j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i * j),
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(*i <span class="org-keyword">as</span> <span class="org-type">Float</span> * j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(i * j <span class="org-keyword">as</span> <span class="org-type">Float</span>),
        }
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">div</span>&lt;<span class="org-type">T</span>&gt;(<span class="org-variable-name">a</span>: <span class="org-type">T</span>, <span class="org-variable-name">b</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">T</span>: <span class="org-type">Div</span>&lt;<span class="org-type">Output</span> = <span class="org-type">T</span>&gt; + <span class="org-type">PartialEq</span> + <span class="org-type">From</span>&lt;<span class="org-type">i32</span>&gt; + <span class="org-type">Copy</span> + <span class="org-type">Fit</span>&lt;<span class="org-type">Number</span>&gt;,
    {
        <span class="org-keyword">if</span> b == <span class="org-type">T</span>::from(0) {
            <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::division_by_zero());
        }
        <span class="org-type">Ok</span>((a / b).fit())
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">rem</span>&lt;<span class="org-type">T</span>&gt;(<span class="org-variable-name">a</span>: <span class="org-type">T</span>, <span class="org-variable-name">b</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">T</span>: <span class="org-type">Rem</span>&lt;<span class="org-type">Output</span> = <span class="org-type">T</span>&gt; + <span class="org-type">PartialEq</span> + <span class="org-type">From</span>&lt;<span class="org-type">i32</span>&gt; + <span class="org-type">Copy</span> + <span class="org-type">Fit</span>&lt;<span class="org-type">Number</span>&gt;,
    {
        <span class="org-keyword">if</span> b == <span class="org-type">T</span>::from(0) {
            <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::division_by_zero());
        }
        <span class="org-type">Ok</span>((a % b).fit())
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">divide</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::div(i, j),
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::div(i <span class="org-keyword">as</span> <span class="org-type">Float</span>, j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::div(i, j <span class="org-keyword">as</span> <span class="org-type">Float</span>),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::div(i, j),
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">remainder</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::rem(i, j),
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::rem(i <span class="org-keyword">as</span> <span class="org-type">Float</span>, j),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; <span class="org-type">Number</span>::rem(i, j <span class="org-keyword">as</span> <span class="org-type">Float</span>),
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; <span class="org-type">Number</span>::rem(i, j),
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">gt</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &gt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; i &gt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; i <span class="org-keyword">as</span> <span class="org-type">Float</span> &gt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &gt; j <span class="org-keyword">as</span> <span class="org-type">Float</span>,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">lt</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &lt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; i &lt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; (i <span class="org-keyword">as</span> <span class="org-type">Float</span>) &lt; j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &lt; j <span class="org-keyword">as</span> <span class="org-type">Float</span>,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">gte</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &gt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; i &gt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; (i <span class="org-keyword">as</span> <span class="org-type">Float</span>) &gt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &gt;= j <span class="org-keyword">as</span> <span class="org-type">Float</span>,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">lte</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (i, j) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &lt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; i &lt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(i), <span class="org-type">Number</span>::<span class="org-type">Float</span>(j)) =&gt; (i <span class="org-keyword">as</span> <span class="org-type">Float</span>) &lt;= j,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(i), <span class="org-type">Number</span>::<span class="org-type">Int</span>(j)) =&gt; i &lt;= j <span class="org-keyword">as</span> <span class="org-type">Float</span>,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">abs</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Number</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Number</span>::<span class="org-type">Int</span>(i.abs()),
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(f) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(f.abs()),
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">sqrt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Number</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Number</span>::<span class="org-type">Int</span>(i.sqrt()),
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(f) =&gt; <span class="org-type">Number</span>::<span class="org-type">Float</span>(f.sqrt()),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Number</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(a), <span class="org-type">Number</span>::<span class="org-type">Int</span>(b)) =&gt; a == b,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(a), <span class="org-type">Number</span>::<span class="org-type">Float</span>(b)) =&gt; a == b,
            (<span class="org-type">Number</span>::<span class="org-type">Float</span>(a), <span class="org-type">Number</span>::<span class="org-type">Int</span>(b)) =&gt; *a == *b <span class="org-keyword">as</span> <span class="org-type">Float</span>,
            (<span class="org-type">Number</span>::<span class="org-type">Int</span>(a), <span class="org-type">Number</span>::<span class="org-type">Float</span>(b)) =&gt; *a <span class="org-keyword">as</span> <span class="org-type">Float</span> == *b,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Number</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Float</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"float"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Number</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Int</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"integer"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Int</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(c))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Float</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Float</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(c))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-type">ParseIntError</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">e</span>: <span class="org-type">ParseIntError</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Error</span>::parse(e.to_string().as_str())
    }
}
<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-type">ParseFloatError</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">e</span>: <span class="org-type">ParseFloatError</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Error</span>::parse(e.to_string().as_str())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Number</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">fromstr</span> = |<span class="org-variable-name">s</span>: <span class="org-type">String</span>| {
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = s
                .as_str()
                .parse::&lt;<span class="org-type">i64</span>&gt;()
                .map(<span class="org-type">Number</span>::<span class="org-type">Int</span>)
                .map_err(<span class="org-type">Error</span>::from);

            r.or_else(|_| s.as_str().parse::&lt;<span class="org-type">Float</span>&gt;().map(<span class="org-type">Number</span>::<span class="org-type">Float</span>))
                .map_err(<span class="org-type">Error</span>::from)
        };
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(c <span class="org-keyword">as</span> <span class="org-type">Int</span>)),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">cont</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">cont</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s))) =&gt; fromstr(s),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">cont</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">cont</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s))) =&gt; fromstr(s),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"number"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Int</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-type">Number</span>::try_derive(i)<span class="org-rust-question-mark">?</span> {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"integer"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Float</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-type">Number</span>::try_derive(i)<span class="org-rust-question-mark">?</span> {
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"float"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Number</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Number</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Int</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Number</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Number</span>::<span class="org-type">Int</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Float</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Number</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Float</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Number</span>::<span class="org-type">Float</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">Number</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">S</span>: <span class="org-type">Serializer</span>,
    {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; serializer.serialize_i64(*i),
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(f) =&gt; serializer.serialize_f64(*f),
        }
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org03c7a40" class="outline-5">
<h5 id="org03c7a40"><span class="section-number-5">1.5.3.3.</span> Container types</h5>
<div class="outline-text-5" id="text-1-5-3-3">
<div class='tangle-wrapper' data-tangle='src/types/container.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Support for containers in kcats. Includes types like [List],</span>
<span class="org-doc">//! [Set], [associative::Association], String, [pipe::In],</span>
<span class="org-doc">//! [pipe::Out], and Byte arrays. The container contract is you can</span>
<span class="org-doc">//! put things into, or take things out of them. [Receptacle]s are for</span>
<span class="org-doc">//! putting into, and [Dispenser]s are for taking out of. For</span>
<span class="org-doc">//! underlying types that support both operations (like [List]), we</span>
<span class="org-doc">//! can easily convert between [Receptacle] and [Dispenser] as needed.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">associative</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">dictionary</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">environment</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">error</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">pipe</span>;

<span class="org-keyword">use</span> <span class="org-constant">futures</span>::<span class="org-type">FutureExt</span>;

<span class="org-keyword">use</span> <span class="org-keyword">self</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Nested</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-type">FutureTake</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::{<span class="org-type">Int</span>, <span class="org-type">Number</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;

<span class="org-keyword">use</span> <span class="org-constant">core</span>::fmt;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::{<span class="org-constant">collections</span>::<span class="org-type">HashSet</span>, future, sync};
<span class="org-keyword">use</span> <span class="org-constant">sync</span>::<span class="org-type">Arc</span>;

<span class="org-doc">/// A generic Arc type that we control</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">pub type Arc&lt;T&gt; = Newtype&lt;sync::Arc&lt;T&gt;&gt;;</span>

<span class="org-doc">/// A generic List type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Listy</span>&lt;<span class="org-type">I</span>&gt; = <span class="org-type">VecDeque</span>&lt;<span class="org-type">I</span>&gt;;

<span class="org-doc">/// A generic Set type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Setty</span>&lt;<span class="org-type">I</span>&gt; = <span class="org-type">HashSet</span>&lt;<span class="org-type">I</span>&gt;;

<span class="org-doc">/// A specific List type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">ListContent</span> = <span class="org-type">Listy</span>&lt;<span class="org-type">Item</span>&gt;;

<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">List</span> = <span class="org-type">Arc</span>&lt;<span class="org-type">ListContent</span>&gt;;
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Set</span> = <span class="org-type">Arc</span>&lt;<span class="org-type">Setty</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;&gt;;

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">HashSet</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Set</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">h</span>: <span class="org-type">HashSet</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;) -&gt; <span class="org-type">Set</span> {
        <span class="org-type">Arc</span>::new(h)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">ListContent</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">ListContent</span>) -&gt; <span class="org-type">List</span> {
        <span class="org-type">Arc</span>::new(l)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">ListContent</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">ListContent</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-type">List</span>::derive(l).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;,
    {
        <span class="org-type">Arc</span>::new(iter.into_iter().collect::&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">Item</span>&gt;&gt;())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Char</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Char</span>&gt;,
    {
        <span class="org-type">Arc</span>::new(
            iter.into_iter()
                .map(<span class="org-type">Item</span>::derive)
                .collect::&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">Item</span>&gt;&gt;(),
        )
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">impl DeriveIterator&lt;assoc::KeyItem&gt; for Set {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">fn derive_iter&lt;I&gt;(iter: I) -&gt; Self</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">where</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">I: IntoIterator&lt;Item = assoc::KeyItem&gt;,</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">{</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">sync::Arc::new(iter.into_iter().collect::&lt;HashSet&lt;assoc::KeyItem&gt;&gt;())</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">Fresh</span> <span class="org-keyword">for</span> <span class="org-type">Arc</span>&lt;<span class="org-type">T</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">Default</span>,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">fresh</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Arc</span>::new(<span class="org-type">T</span>::default())
    }
}

<span class="org-doc">/// A trait for joining two values together. There are some precedence rules:</span>
<span class="org-doc">///</span>
<span class="org-doc">/// 1. If there are two different types being joined, the type that is</span>
<span class="org-doc">/// returned is either the most specialized types of the two being</span>
<span class="org-doc">/// joined, or the most specialized type that's possible to construct</span>
<span class="org-doc">/// given the two values. (For example, joining a Set with a List, or</span>
<span class="org-doc">/// vice versa, will always be a Set. Joining an Association with a</span>
<span class="org-doc">/// Dictionary will be an Associative enum but the variant will depend</span>
<span class="org-doc">/// on whether the Association data fits the schema of a</span>
<span class="org-doc">/// Dictionary. If so, it will be Dictionary, otherwise Assoc.)</span>
<span class="org-doc">///</span>
<span class="org-doc">/// 2. If the result type is keyed, (eg, Map or Set or struct types),</span>
<span class="org-doc">/// the RHS argument's keys take precedence over self's.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Join</span>&lt;<span class="org-type">RHS</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Output</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">RHS</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt;;
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">String</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.push_str(rhs);
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">char</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">String</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">char</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.push(rhs);
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">List</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining list to list");</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = <span class="org-keyword">self</span>.mutate();
        am.extend(rhs.iter().cloned());
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">Set</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Set</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Set</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">Set</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = <span class="org-keyword">self</span>.mutate();
        am.extend(rhs.iter().cloned());
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-doc">/// When joining a List with a String, which type we get back depends</span>
<span class="org-doc">/// on the contents of the list. If the list has non-char items in it,</span>
<span class="org-doc">/// we get a List. Otherwise, a string.</span>
<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Sized</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-type">String</span>::try_derive(<span class="org-keyword">self</span>.clone()) {
            <span class="org-type">Ok</span>(<span class="org-keyword">mut</span> s) =&gt; {
                s.push_str(rhs.as_str());
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">String</span>(s))
            }
            <span class="org-type">Err</span>(_) =&gt; {
                <span class="org-comment-delimiter">// </span><span class="org-comment">join as list</span>
                <span class="org-keyword">self</span>.mutate().extend(rhs.chars().map(<span class="org-type">Item</span>::derive));
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">self</span>))
            }
        }
    }
}

<span class="org-doc">/// When joining a String with a List, which type we get back depends</span>
<span class="org-doc">/// on the contents of the list. If the list has non-char items in it,</span>
<span class="org-doc">/// we get a List. Otherwise, a string.</span>
<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Sized</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">rhs</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-type">String</span>::try_derive(rhs.clone()) {
            <span class="org-type">Ok</span>(s) =&gt; {
                <span class="org-keyword">self</span>.push_str(s.as_str());
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-keyword">self</span>))
            }
            <span class="org-type">Err</span>(_) =&gt; {
                <span class="org-comment-delimiter">// </span><span class="org-comment">join as list</span>
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">sl</span>: <span class="org-type">List</span> = <span class="org-keyword">self</span>.fit();
                sl.mutate().extend(rhs.iter().cloned());
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">List</span>(sl))
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">assoc</span>::<span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, &lt;<span class="org-type">Self</span> <span class="org-keyword">as</span> <span class="org-type">Join</span>&lt;<span class="org-type">List</span>&gt;&gt;::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining list to associative");</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">la</span> =
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-constant">assoc</span>::<span class="org-type">Association</span>::try_from_iter(other.iter().cloned())<span class="org-rust-question-mark">?</span>);
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>.join(la).unwrap())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining associative to list");</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">sa</span> =
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-constant">assoc</span>::<span class="org-type">Association</span>::try_from_iter(<span class="org-keyword">self</span>.iter().cloned())<span class="org-rust-question-mark">?</span>);
        <span class="org-type">Ok</span>(sa.join(other).unwrap())
    }
}

<span class="org-doc">/// Joining a List with a Set will be a set.</span>
<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">Set</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Set</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">other</span>: <span class="org-type">Set</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">bm</span> = other.mutate();

        bm.extend(
            <span class="org-keyword">self</span>.iter()
                .cloned()
                .map(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive)
                .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
        );
        <span class="org-type">Ok</span>(other)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">String</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.push_str(<span class="org-rust-ampersand">&amp;</span>other);
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-doc">/// Joins two containers into one.</span>
<span class="org-keyword">impl</span> <span class="org-type">Join</span>&lt;<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Sized</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining sized {:?} to sized {:?}", self, other);</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.is_empty() {
            <span class="org-keyword">return</span> <span class="org-type">Ok</span>(other);
        } <span class="org-keyword">else</span> <span class="org-keyword">if</span> other.is_empty() {
            <span class="org-keyword">return</span> <span class="org-type">Ok</span>(<span class="org-keyword">self</span>);
        }
        <span class="org-type">Ok</span>(<span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), <span class="org-type">Sized</span>::<span class="org-type">List</span>(l)) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a.join(l)<span class="org-rust-question-mark">?</span>),
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(l), <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a)) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(l.join(a)<span class="org-rust-question-mark">?</span>),
            (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(b)) =&gt; {
                <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a.join(b).unwrap())
            }
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(a), <span class="org-type">Sized</span>::<span class="org-type">List</span>(b)) =&gt; <span class="org-type">Sized</span>::<span class="org-type">List</span>(a.join(b).unwrap()),
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Set</span>(b)) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Set</span>(a.join(b).unwrap()),
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Set</span>(b)) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Set</span>(a.join(b)<span class="org-rust-question-mark">?</span>),
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(<span class="org-keyword">mut</span> a), <span class="org-type">Sized</span>::<span class="org-type">List</span>(b)) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = a.mutate();

                am.extend(
                    b.iter()
                        .cloned()
                        .map(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive)
                        .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
                );
                <span class="org-type">Sized</span>::<span class="org-type">Set</span>(a)
            }
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-keyword">mut</span> a), <span class="org-type">Sized</span>::<span class="org-type">String</span>(b)) =&gt; {
                a.push_str(<span class="org-rust-ampersand">&amp;</span>b);
                <span class="org-type">Sized</span>::<span class="org-type">String</span>(a)
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-keyword">mut</span> a), <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b)) =&gt; {
                a.extend(b);
                <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(a)
            }
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(s), <span class="org-type">Sized</span>::<span class="org-type">List</span>(l)) =&gt; s.join(l).unwrap(),
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(l), <span class="org-type">Sized</span>::<span class="org-type">String</span>(s)) =&gt; l.join(s).unwrap(),
            (s, other) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"joinable"</span>, <span class="org-preprocessor">list!</span>(s, other)))<span class="org-rust-question-mark">?</span>,
        })
    }
}
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Container</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">has</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">item</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">T</span>) -&gt; <span class="org-type">bool</span>;
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Count</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">count</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span>;
}

<span class="org-doc">/// A trait for containers where you can take an item out "in-place"</span>
<span class="org-doc">/// without blocking. The container itself is mutated and the item is</span>
<span class="org-doc">/// returned.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">SimpleTake</span> {
    <span class="org-keyword">type</span> <span class="org-variable-name">Item</span>: <span class="org-type">Send</span> + <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;;
}

<span class="org-comment-delimiter">// </span><span class="org-comment">pub trait DemotingTake {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Item;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Output;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">fn take_demoting(self) -&gt; (Option&lt;Self::Item&gt;, Self::Output);</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Take</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span>;
    <span class="org-keyword">type</span> <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Future</span>&lt;(<span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;, <span class="org-type">Self</span>::<span class="org-type">Output</span>)&gt;;
}

<span class="org-doc">/// A blanket impl for Take, for any type that already implements SimpleTake.</span>
<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">Take</span> <span class="org-keyword">for</span> <span class="org-type">T</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">SimpleTake</span> + <span class="org-type">Send</span> + '<span class="org-keyword">static</span>,
{
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">T</span>;
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">take</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Future</span>&lt;(<span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;, <span class="org-type">Self</span>::<span class="org-type">Output</span>)&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">item</span> = <span class="org-keyword">self</span>.take_simple();
        <span class="org-keyword">let</span> <span class="org-variable-name">result</span> = <span class="org-constant">future</span>::ready((<span class="org-type">Ok</span>(item.map(|i| i.fit())), <span class="org-keyword">self</span>));
        <span class="org-type">Box</span>::pin(result)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Count</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">count</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Self</span>::<span class="org-type">Associative</span>(a) =&gt; a.len(),
            <span class="org-type">Self</span>::<span class="org-type">List</span>(l) =&gt; l.count(),
            <span class="org-type">Self</span>::<span class="org-type">String</span>(s) =&gt; s.len(),
            <span class="org-type">Self</span>::<span class="org-type">Bytes</span>(b) =&gt; b.len(),
            <span class="org-type">Self</span>::<span class="org-type">Set</span>(s) =&gt; s.len(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Container</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">has</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Has: {:?}\n{:?}", self, other);</span>
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), other) =&gt; {
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive(other.clone()).map_or(<span class="org-keyword">false</span>, |k| a.contains_key(<span class="org-rust-ampersand">&amp;</span>k))
            }
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(l), other) =&gt; l.contains(other),
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s), <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::<span class="org-type">Set</span>(other)))) =&gt; {
                other.is_subset(s)
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s), <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::<span class="org-type">Set</span>(other)))) =&gt; {
                other.is_subset(s)
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s), other) =&gt; {
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive(other.clone()).map_or(<span class="org-keyword">false</span>, |k| s.contains(<span class="org-rust-ampersand">&amp;</span>k))
            }
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(container), other) =&gt; <span class="org-keyword">match</span> other {
                <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; container.has(c),
                i =&gt; <span class="org-keyword">match</span> <span class="org-type">String</span>::try_derive(i.clone()) {
                    <span class="org-type">Ok</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">s</span>) =&gt; container.has(s),
                    <span class="org-type">Err</span>(_) =&gt; <span class="org-keyword">false</span>,
                },
            },
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-comment-delimiter">//</span><span class="org-comment">type Output = Self;</span>
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Taking! {:?}", self);</span>
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Self</span>::<span class="org-type">Associative</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">a</span>) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = a.take_simple();
                *<span class="org-keyword">self</span> = <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a.clone());
                v
            }
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">l</span>) =&gt; l.take_simple(),
            <span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">s</span>) =&gt; s.take_simple().map(<span class="org-type">Item</span>::derive),
            <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">b</span>) =&gt; b.take_simple().map(<span class="org-type">Item</span>::derive),
            <span class="org-type">Sized</span>::<span class="org-type">Set</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">s</span>) =&gt; s.take_simple(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Count</span> <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">count</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        <span class="org-keyword">self</span>.len()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Container</span>&lt;<span class="org-type">char</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">has</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">item</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">char</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.contains(*item)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Container</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">has</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">item</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">String</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.contains(item.as_str())
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Ordered</span> {
    <span class="org-doc">/// Appends the items to the beginning of this list, preserving</span>
    <span class="org-doc">/// their order. eg `[1, 2, 3].append([4, 5, 6])` -&gt; `[4, 5, 6, 1,</span>
    <span class="org-doc">/// 2, 3]`.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">prepend</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">items</span>: <span class="org-type">List</span>);

    <span class="org-doc">/// Appends the items in the iterator to the beginning of this</span>
    <span class="org-doc">/// list, preserving order.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">prepend_iter</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">items</span>: <span class="org-type">T</span>);

    <span class="org-doc">/// Reverses the order of the list.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">reverse</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>);
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Mutey</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">mutate</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">T</span>;
}

<span class="org-keyword">impl</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Clone</span>&gt; <span class="org-type">Mutey</span>&lt;<span class="org-type">T</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Arc</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">mutate</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">T</span> {
        <span class="org-type">Arc</span>::make_mut(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Count</span> <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">count</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        <span class="org-keyword">self</span>.len()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Container</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">has</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.contains(i)
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">impl Take for List {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Item = Item;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Output = List;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">fn take(mut self) -&gt; Future&lt;(Self::Output, Result&lt;Option&lt;Item&gt;, Error&gt;)&gt; {</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">let v = self.mutate().pop_front();</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">Box::pin(future::ready((self, Ok(v))))</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-comment-delimiter">//</span><span class="org-comment">impl Take for</span>

<span class="org-keyword">impl</span> <span class="org-type">Ordered</span> <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">prepend</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">items</span>: <span class="org-type">List</span>) {
        <span class="org-keyword">self</span>.prepend_iter(items.iter().cloned());
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">prepend_iter</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">items</span>: <span class="org-type">T</span>) {
        <span class="org-keyword">let</span> <span class="org-variable-name">m</span> = <span class="org-keyword">self</span>.mutate();
        <span class="org-keyword">let</span> <span class="org-variable-name">ct</span> = m.len();
        m.extend(items);
        m.rotate_left(ct);
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">reverse</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) {
        <span class="org-keyword">let</span> <span class="org-variable-name">m</span> = <span class="org-keyword">self</span>.mutate();
        m.make_contiguous().reverse();
    }
}

<span class="org-doc">/// A generic container type, all we know is it can contain multiple</span>
<span class="org-doc">/// items. Includes things like lists, sets, and IO channels. Items</span>
<span class="org-doc">/// can be taken out.</span>
<span class="org-preprocessor">#[derive(Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Dispenser</span> {
    <span class="org-doc">/// A container with a known number of items inside</span>
    <span class="org-type">Sized</span>(<span class="org-type">Sized</span>),
    <span class="org-doc">/// A pipe that dispenses an unknown number of items</span>
    <span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>),
    <span class="org-doc">/// Similar to Out but also convertible to [Receptacle]</span>
    <span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>),
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>&lt;'<span class="org-variable-name">_</span>&gt;) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(sized) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, sized),
            <span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(out) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, out),
            <span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(tunnel) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, tunnel),
        }
    }
}
<span class="org-doc">/// A generic container type, all we know is it can contain multiple</span>
<span class="org-doc">/// items. Includes things like lists, sets, and IO channels. Items</span>
<span class="org-doc">/// can be put in.</span>
<span class="org-preprocessor">#[derive(Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Receptacle</span> {
    <span class="org-doc">/// A container with a known number of items inside</span>
    <span class="org-type">Sized</span>(<span class="org-type">Sized</span>),
    <span class="org-doc">/// A pipe that can receive an arbitrary number of items</span>
    <span class="org-type">In</span>(<span class="org-constant">pipe</span>::<span class="org-type">In</span>),
    <span class="org-doc">/// Similar to In but also convertible to [Dispenser]</span>
    <span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>),
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Receptacle</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>&lt;'<span class="org-variable-name">_</span>&gt;) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(sized) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, sized),
            <span class="org-type">Receptacle</span>::<span class="org-type">In</span>(i) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, i),
            <span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(tunnel) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, tunnel),
        }
    }
}

<span class="org-doc">/// Collections that have a definite size that we can access. Implies</span>
<span class="org-doc">/// that it can also be appended to.</span>
<span class="org-preprocessor">#[derive(Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Sized</span> {
    <span class="org-doc">/// Associative containers associate Items in pairs, like Map or</span>
    <span class="org-doc">/// Dict in other languages.</span>
    <span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>),
    <span class="org-doc">/// List containers have multiple Items in a specific order.</span>
    <span class="org-type">List</span>(<span class="org-type">List</span>),
    <span class="org-doc">/// Set containers have multiple Items in no particular order, and</span>
    <span class="org-doc">/// each Item can only appear once.</span>
    <span class="org-type">Set</span>(<span class="org-type">Set</span>),
    <span class="org-comment-delimiter">//</span><span class="org-comment">TODO: these should be inside an Arc too</span>
    <span class="org-doc">/// A String is a chunk of text, like a list of individual</span>
    <span class="org-doc">/// characters.</span>
    <span class="org-type">String</span>(<span class="org-type">String</span>),
    <span class="org-doc">/// Bytes is the lowest common denominator form of data, useful</span>
    <span class="org-doc">/// for when no other type applies.</span>
    <span class="org-type">Bytes</span>(<span class="org-type">Bytes</span>),
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>&lt;'<span class="org-variable-name">_</span>&gt;) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, a),
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, l),
            <span class="org-type">Sized</span>::<span class="org-type">Set</span>(s) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, s),
            <span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, s),
            <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, b),
        }
    }
}

<span class="org-doc">/// Empty Sized containers are equal to each other.</span>
<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(b)) =&gt; a == b,
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(a), <span class="org-type">Sized</span>::<span class="org-type">List</span>(b)) =&gt; a == b,
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(a), <span class="org-type">Sized</span>::<span class="org-type">String</span>(b)) =&gt; a == b,
            (<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b)) =&gt; a == b,
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(a), <span class="org-type">Sized</span>::<span class="org-type">Set</span>(b)) =&gt; a == b,
            _ =&gt; <span class="org-keyword">self</span>.is_empty() &amp;&amp; other.is_empty(),
        }
    }
}

<span class="org-doc">/// Takes an item out of the [Dispenser], and returns a future</span>
<span class="org-doc">/// that gives a new [Dispenser], and the [Item] that was removed</span>
<span class="org-doc">/// (if there was one).</span>
<span class="org-keyword">impl</span> <span class="org-type">Take</span> <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Self</span>;
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Future</span>&lt;(<span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;, <span class="org-type">Self</span>::<span class="org-type">Output</span>)&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-keyword">mut</span> s) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = s.take_simple();
                <span class="org-comment-delimiter">//</span><span class="org-comment">let (r, s) = s.take();</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">i.map(|r| {</span>
                <span class="org-comment-delimiter">//     </span><span class="org-comment">(Dispenser::SIzed(s), Self::result_to_option(r))</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">})</span>

                <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready((<span class="org-type">Ok</span>(v), <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s))))
            }
            <span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-keyword">mut</span> o) =&gt; {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { (o.take_future().<span class="org-keyword">await</span>, <span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(o)) })
            }
            <span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(<span class="org-keyword">mut</span> t) =&gt; {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { (t.take_future().<span class="org-keyword">await</span>, <span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t)) })
            }
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">result_to_option</span>(<span class="org-variable-name">r</span>: <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
    <span class="org-keyword">match</span> r {
        <span class="org-type">Ok</span>(<span class="org-type">Some</span>(i)) =&gt; <span class="org-type">Some</span>(i),
        <span class="org-type">Ok</span>(<span class="org-type">None</span>) =&gt; <span class="org-type">None</span>,
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Some</span>(<span class="org-type">Item</span>::derive(e)),
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Dispenser</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">/// Takes an item out of the [Dispenser], and returns a future</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">/// that gives a new [Dispenser], and the [Item] that was removed</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">/// (if there was one).</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">pub fn take(self) -&gt; Future&lt;(Dispenser, Option&lt;Item&gt;)&gt; {</span>
    <span class="org-comment-delimiter">//     </span><span class="org-comment">match self {</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">Dispenser::Sized(mut s) =&gt; {</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">let v = s.take_simple();</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">//let (r, s) = s.take();</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">// i.map(|r| {</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">//     (Dispenser::SIzed(s), Self::result_to_option(r))</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">// })</span>

    <span class="org-comment-delimiter">//             </span><span class="org-comment">Box::pin(future::ready((Dispenser::Sized(s), v)))</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">}</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">Dispenser::Out(mut o) =&gt; Box::pin({</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">let i = o.take();</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">i.map(|r| (Dispenser::Out(o), Self::result_to_option(r)))</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">}),</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">Dispenser::Tunnel(mut t) =&gt; Box::pin({</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">let i = t.take();</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">i.map(|r| {</span>
    <span class="org-comment-delimiter">//                 </span><span class="org-comment">(</span>
    <span class="org-comment-delimiter">//                     </span><span class="org-comment">Dispenser::Tunnel(t),</span>
    <span class="org-comment-delimiter">//                     </span><span class="org-comment">match r {</span>
    <span class="org-comment-delimiter">//                         </span><span class="org-comment">Ok(Some(i)) =&gt; Some(i),</span>
    <span class="org-comment-delimiter">//                         </span><span class="org-comment">Ok(None) =&gt; None,</span>
    <span class="org-comment-delimiter">//                         </span><span class="org-comment">Err(e) =&gt; Some(Item::derive(e)),</span>
    <span class="org-comment-delimiter">//                     </span><span class="org-comment">},</span>
    <span class="org-comment-delimiter">//                 </span><span class="org-comment">)</span>
    <span class="org-comment-delimiter">//             </span><span class="org-comment">})</span>
    <span class="org-comment-delimiter">//         </span><span class="org-comment">}),</span>
    <span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">}</span>
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.is_empty() {
            <span class="org-type">None</span>
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">let</span> <span class="org-variable-name">lm</span> = <span class="org-keyword">self</span>.mutate();
            <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = lm.pop_front();
            i
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">char</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: this may perform badly</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">first_char</span> = <span class="org-keyword">self</span>.chars().next();
        <span class="org-keyword">self</span>.drain(..first_char.map(|s| s.len_utf8()).unwrap_or(0));
        first_char
    }
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Bytes</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Int</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.is_empty() {
            <span class="org-type">None</span>
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = <span class="org-type">Some</span>(<span class="org-keyword">self</span>[0] <span class="org-keyword">as</span> <span class="org-type">Int</span>);
            <span class="org-keyword">self</span>.drain(..1);
            i
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Set</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">sm</span> = <span class="org-keyword">self</span>.mutate();
        sm.iter().next().map(|v| v.clone().fit())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Sized</span> {
    <span class="org-doc">/// Returns whether the container is empty</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_empty</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.count() == 0
    }

    <span class="org-doc">/// Takes an item from the back (end) of the container.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">pop</span>(<span class="org-keyword">self</span>) -&gt; (<span class="org-type">Self</span>, <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;) {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-keyword">mut</span> a) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = a.take_simple();
                (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), v)
            }
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">mut</span> l) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">lm</span> = l.mutate();
                <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = lm.pop_back();
                (<span class="org-type">Sized</span>::<span class="org-type">List</span>(l), i)
            }
            <span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-keyword">mut</span> s) =&gt; s
                .pop()
                .map(|c| (<span class="org-type">Sized</span>::<span class="org-type">String</span>(s), <span class="org-type">Some</span>(c.fit())))
                .unwrap_or((<span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-type">String</span>::new()), <span class="org-type">None</span>)),
            <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-keyword">mut</span> b) =&gt; b
                .pop()
                .map(|c| (<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b), <span class="org-type">Some</span>((c <span class="org-keyword">as</span> <span class="org-type">Int</span>).fit())))
                .unwrap_or((<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-preprocessor">vec!</span>[]), <span class="org-type">None</span>)),
            <span class="org-type">Sized</span>::<span class="org-type">Set</span>(<span class="org-keyword">mut</span> s) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = s.iter().next().cloned();
                <span class="org-keyword">let</span> <span class="org-variable-name">sm</span> = s.mutate();
                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(i) = i.clone() {
                    sm.take(<span class="org-rust-ampersand">&amp;</span>i);
                }
                (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s), i.map(<span class="org-type">Item</span>::derive))
            }
        }
    }

    <span class="org-doc">/// Puts an item into the container, at the end.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Sized</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">mut</span> c), i) =&gt; {
                c.mutate().push_back(i);
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">List</span>(c))
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a), l) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a.put(l)<span class="org-rust-question-mark">?</span>)),
            (<span class="org-type">Sized</span>::<span class="org-type">Set</span>(<span class="org-keyword">mut</span> s), i) =&gt; {
                s.mutate().insert(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive(i)<span class="org-rust-question-mark">?</span>);
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s))
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-keyword">mut</span> b), <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i))) =&gt; {
                b.push(i <span class="org-keyword">as</span> <span class="org-type">u8</span>);
                <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))
            }
            (<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_), i) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"integer"</span>, i)),
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-keyword">mut</span> s), <span class="org-type">Item</span>::<span class="org-type">Char</span>(c)) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::<span class="org-type">String</span>({
                s.push(c);
                s
            })),
            (<span class="org-type">Sized</span>::<span class="org-type">String</span>(_), i) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"char"</span>, i)),
        }
    }

    <span class="org-doc">/// Returns a new empty version of this container. Does not</span>
    <span class="org-doc">/// modify this container. The new container will be the same</span>
    <span class="org-doc">/// type as this one (if this is a [Sized::String], you'll get an empty</span>
    <span class="org-doc">/// [Sized::String], etc)</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">empty</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Sized</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(_) =&gt; {
                <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-constant">assoc</span>::<span class="org-type">Association</span>::fresh()))
            }
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(_) =&gt; <span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-type">List</span>::default()),
            <span class="org-type">Sized</span>::<span class="org-type">Set</span>(_) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Set</span>(<span class="org-type">Set</span>::default()),
            <span class="org-type">Sized</span>::<span class="org-type">String</span>(_) =&gt; <span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-type">String</span>::new()),
            <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_) =&gt; <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(<span class="org-preprocessor">vec!</span>[]),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Receptacle</span> {
    <span class="org-doc">/// Puts the given [Item] into this container, items are added at</span>
    <span class="org-doc">/// the end.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Receptacle</span>, <span class="org-type">Error</span>&gt;&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(s.put(i).map(<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>))),
            <span class="org-type">Receptacle</span>::<span class="org-type">In</span>(<span class="org-keyword">mut</span> p) =&gt; <span class="org-type">Box</span>::pin(p.put(i).map(|r| r.map(|_| <span class="org-type">Receptacle</span>::<span class="org-type">In</span>(p)))),
            <span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(<span class="org-keyword">mut</span> t) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">p</span> = t.put(i);
                <span class="org-type">Box</span>::pin(p.map(|r| r.map(|_| <span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t))))
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoIterator</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">into_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(map) =&gt; <span class="org-type">Box</span>::new(map.to_iter().map(|kv| kv.fit())),
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(list) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;_&gt; = list.iter().cloned().collect();
                <span class="org-type">Box</span>::new(items.into_iter())
            }
            <span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">chars</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">char</span>&gt; = s.chars().collect();
                <span class="org-type">Box</span>::new(chars.into_iter().map(|c| c.fit()))
            }
            <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">vec</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt; = b
                    .into_iter()
                    .map(|byte| <span class="org-type">Item</span>::derive(byte <span class="org-keyword">as</span> <span class="org-type">Int</span>))
                    .collect();
                <span class="org-type">Box</span>::new(vec.into_iter())
            }
            <span class="org-type">Sized</span>::<span class="org-type">Set</span>(s) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;_&gt; = s.iter().cloned().map(|i| i.fit()).collect();
                <span class="org-type">Box</span>::new(items.into_iter())
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Dispenser</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Dispenser</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("from iterable {:?}", c);</span>
        <span class="org-keyword">match</span> c {
            <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s) =&gt; <span class="org-type">Ok</span>(s),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"sized"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Receptacle</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Receptacle</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> c {
            <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s) =&gt; <span class="org-type">Ok</span>(s),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"sized"</span>, <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(i))),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> s {
            <span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; <span class="org-type">Ok</span>(l),
            <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; <span class="org-type">Ok</span>(<span class="org-type">List</span>::derive_iter(a.to_iter().map(<span class="org-type">Item</span>::derive))),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"list"</span>, i)),
        }
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">Implement Derive for Item where T is an Iterator</span>
<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">I</span>&gt; <span class="org-type">Derive</span>&lt;<span class="org-type">T</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">ToIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">I</span>&gt; + <span class="org-type">IntoList</span>,
    <span class="org-variable-name">I</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">iter</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">l</span>: <span class="org-type">List</span> = iter.to_iter().map(<span class="org-type">Fit</span>::fit).my_collect();
        <span class="org-type">Item</span>::derive(l)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-constant">dict</span>::<span class="org-type">Namespace</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        l.iter().cloned().map(<span class="org-constant">dict</span>::<span class="org-type">Namespace</span>::try_derive).collect()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt;) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">List</span>::derive_iter(v)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">List</span>::derive_iter(s.chars())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">String</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = l
            .iter()
            .cloned()
            .map(|i| <span class="org-type">Char</span>::try_derive(i))
            .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">Char</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(v.iter().collect::&lt;<span class="org-type">String</span>&gt;())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Bytes</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = l
            .iter()
            .cloned()
            .map(|i| <span class="org-constant">number</span>::<span class="org-type">Int</span>::try_derive(i).map(|i| i <span class="org-keyword">as</span> <span class="org-type">u8</span>))
            .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(v)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">List</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(l) =&gt; <span class="org-type">Sized</span>::try_derive(l.clone())
                .caused(<span class="org-type">Error</span>::expected(<span class="org-string">"list"</span>, l))
                .and_then(<span class="org-type">List</span>::try_derive),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(l) =&gt; <span class="org-type">Sized</span>::try_derive(l).and_then(<span class="org-type">List</span>::try_derive),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"list"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">item</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> item {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(c) =&gt; c.try_fit(),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(p) =&gt; <span class="org-type">Dispenser</span>::try_derive(p.clone())
                .caused(<span class="org-type">Error</span>::expected(<span class="org-string">"sized"</span>, p))<span class="org-rust-question-mark">?</span>
                .try_fit(),
            i =&gt; {
                <span class="org-comment-delimiter">// </span><span class="org-comment">let bt = backtrace::Backtrace::new();</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">println!("try from item {:?},\n {:?}", i, bt);</span>
                <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"sized"</span>, i))
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Receptacle</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">item</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> item {
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(p) =&gt; <span class="org-type">Ok</span>(p),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(c) =&gt; c.try_fit(),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"receptacle"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Dispenser</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Receptacle</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Dispenser</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> c {
            <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s)),
            <span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t)),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"receptacle"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Receptacle</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Receptacle</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> c {
            <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)),
            <span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t)),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"iterable"</span>, <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(i))),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">item</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-type">Ok</span>(<span class="org-type">Sized</span>::try_derive(item)<span class="org-rust-question-mark">?</span>.into_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">sized</span>: <span class="org-type">Sized</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Box</span>::new(sized.into_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Sized</span>::<span class="org-type">List</span>(l)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">String</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Sized</span>::<span class="org-type">String</span>(s)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Bytes</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">b</span>: <span class="org-type">Bytes</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">Sized</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">List</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::<span class="org-type">List</span>(l)))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Set</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">l</span>: <span class="org-type">Set</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::<span class="org-type">Set</span>(l)))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Dispenser</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Dispenser</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Receptacle</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">c</span>: <span class="org-type">Receptacle</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(c)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">Sized</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">item</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> item {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(c) =&gt; <span class="org-type">Ok</span>(c),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(p) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Dispenser</span>::try_derive(p)<span class="org-rust-question-mark">?</span>),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"iterable"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Set</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">item</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-type">Sized</span>::try_derive(item)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">hs</span>: <span class="org-type">HashSet</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt; = s
            .into_iter()
            .map(|i| i.try_fit())
            .collect::&lt;<span class="org-type">Result</span>&lt;_, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(<span class="org-type">Set</span>::derive(hs))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Default</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">default</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-type">List</span>::default())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Default</span> <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">default</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::default())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Default</span> <span class="org-keyword">for</span> <span class="org-type">Receptacle</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">default</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-type">Sized</span>::default())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">ToIterator</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">to_iter</span>&lt;'<span class="org-variable-name">a</span>&gt;(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">self</span>.into_iter()
    }
}

<span class="org-keyword">mod</span> <span class="org-constant">serde</span> {
    <span class="org-keyword">use</span> <span class="org-keyword">super</span>::{<span class="org-type">Dispenser</span>, <span class="org-type">Receptacle</span>, <span class="org-type">Sized</span>};
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::associative <span class="org-keyword">as</span> assoc;
    <span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">ser</span>::{<span class="org-type">Serialize</span>, <span class="org-type">SerializeMap</span>, <span class="org-type">SerializeSeq</span>};

    <span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">Dispenser</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">S</span>: <span class="org-constant">serde</span>::<span class="org-type">Serializer</span>,
        {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
                <span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(o) =&gt; o.representation().serialize(serializer),
                <span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t) =&gt; t.representation().serialize(serializer),
                <span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s) =&gt; s.serialize(serializer),
            }
        }
    }

    <span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">Receptacle</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">S</span>: <span class="org-constant">serde</span>::<span class="org-type">Serializer</span>,
        {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
                <span class="org-type">Receptacle</span>::<span class="org-type">In</span>(i) =&gt; i.representation().serialize(serializer),
                <span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t) =&gt; t.representation().serialize(serializer),
                <span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s) =&gt; s.serialize(serializer),
            }
        }
    }

    <span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">Sized</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">S</span>: <span class="org-constant">serde</span>::<span class="org-type">Serializer</span>,
        {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
                <span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Start serializing a map</span>
                    <span class="org-keyword">let</span> <span class="org-variable-name">assoc</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive(a.clone());
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">map</span> = serializer.serialize_map(<span class="org-type">Some</span>(assoc.len()))<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">for</span> (key, value) <span class="org-keyword">in</span> assoc.iter() {
                        <span class="org-comment-delimiter">// </span><span class="org-comment">Serialize each entry in the map</span>
                        map.serialize_entry(<span class="org-rust-ampersand">&amp;</span>key, <span class="org-rust-ampersand">&amp;</span>value)<span class="org-rust-question-mark">?</span>;
                    }
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Finish serializing the map</span>
                    map.end()
                }

                <span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">l</span>) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Serialize a list (sequence)</span>
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">seq</span> = serializer.serialize_seq(<span class="org-type">Some</span>(l.len()))<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">for</span> <span class="org-variable-name">element</span> <span class="org-keyword">in</span> l.iter() {
                        seq.serialize_element(<span class="org-rust-ampersand">&amp;</span>element)<span class="org-rust-question-mark">?</span>;
                    }
                    seq.end()
                }
                <span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; serializer.serialize_bytes(b.as_slice()),
                <span class="org-type">Sized</span>::<span class="org-type">Set</span>(s) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Serialize a list (sequence)</span>
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">seq</span> = serializer.serialize_seq(<span class="org-type">Some</span>(s.len()))<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">for</span> <span class="org-variable-name">element</span> <span class="org-keyword">in</span> s.iter() {
                        seq.serialize_element(<span class="org-rust-ampersand">&amp;</span>element)<span class="org-rust-question-mark">?</span>;
                    }
                    seq.end()
                }
                <span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; serializer.serialize_str(s.as_str()),
            }
        }
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orge706abd" class="outline-5">
<h5 id="orge706abd"><span class="section-number-5">1.5.3.4.</span> Associative types</h5>
<div class="outline-text-5" id="text-1-5-3-4">
<div class='tangle-wrapper' data-tangle='src/types/container/associative.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Support for Associative data types (similar contract to Rust's</span>
<span class="org-doc">//! HashMap). Includes specific runtime data types like Errors,</span>
<span class="org-doc">//! Dictionaries, Environments, as well as generic maps (which are</span>
<span class="org-doc">//! called "associations" in kcats)</span>
<span class="org-keyword">use</span> <span class="org-keyword">super</span>::{dictionary <span class="org-keyword">as</span> dict, environment <span class="org-keyword">as</span> env};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> coll;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-type">Count</span>, <span class="org-type">Join</span>, <span class="org-type">Mutey</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::{<span class="org-type">Int</span>, <span class="org-type">Number</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashSet</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::{<span class="org-keyword">self</span>, <span class="org-type">Arc</span>};

<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Associationy</span>&lt;<span class="org-type">K</span>, <span class="org-type">V</span>&gt; = <span class="org-type">HashMap</span>&lt;<span class="org-type">K</span>, <span class="org-type">V</span>&gt;;
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">AssociationContent</span> = <span class="org-type">Associationy</span>&lt;<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;;
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Association</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>&lt;<span class="org-type">AssociationContent</span>&gt;;

<span class="org-doc">/// A KeyItem is all the Item types that can be used as a key in an</span>
<span class="org-doc">/// Associative structure. In order to be a key, the type has to be</span>
<span class="org-doc">/// hashable and have an ordering, so types like floating point</span>
<span class="org-doc">/// numbers or sets can't be used.</span>
<span class="org-preprocessor">#[derive(Debug, Clone, Eq, PartialEq, Hash, PartialOrd, Ord)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">KeyItem</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">Order matters here, for comparison purposes - changing the</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">order will change the result of how eg int compares to word.</span>
    <span class="org-type">Int</span>(<span class="org-type">Int</span>),
    <span class="org-type">Char</span>(<span class="org-type">Char</span>),
    <span class="org-type">Word</span>(<span class="org-type">Word</span>),
    <span class="org-type">Bytes</span>(<span class="org-type">Bytes</span>),
    <span class="org-type">String</span>(<span class="org-type">String</span>),
    <span class="org-type">List</span>(<span class="org-type">KeyList</span>),
}

<span class="org-doc">/// An Entry is a single pairing in an Associative type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Entry</span> = (<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>);

<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">KeyListContent</span> = <span class="org-constant">coll</span>::<span class="org-type">Listy</span>&lt;<span class="org-type">KeyItem</span>&gt;;
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">KeyList</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>&lt;<span class="org-type">KeyListContent</span>&gt;;

<span class="org-keyword">impl</span> <span class="org-type">TryDeriveIterator</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyList</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">try_from_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">l</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;,
    {
        <span class="org-type">Ok</span>(<span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(
            l.into_iter()
                .map(<span class="org-type">KeyItem</span>::try_derive)
                .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">KeyItem</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
        ))
    }
}

<span class="org-doc">/// An Associative is a container type that associates one Item (the</span>
<span class="org-doc">/// key) with another (the value). It has the property where you can</span>
<span class="org-doc">/// look up a value using the key, and you can update the value that a</span>
<span class="org-doc">/// key points to. Some Item types cannot be used as keys, only</span>
<span class="org-doc">/// [KeyItem] is accepted as an Associative key.</span>
<span class="org-preprocessor">#[derive(Debug, Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Associative</span> {
    <span class="org-doc">/// A generic associative structure where you can associate any</span>
    <span class="org-doc">/// [KeyItem] with any [Item].</span>
    <span class="org-type">Assoc</span>(<span class="org-type">Association</span>),
    <span class="org-doc">/// Represents an [dict::Dictionary] entry structure with</span>
    <span class="org-doc">/// specific keys.</span>
    <span class="org-type">DictEntry</span>(<span class="org-constant">dict</span>::<span class="org-type">Entry</span>),
    <span class="org-doc">/// Represents an execution environment, with specific keys</span>
    <span class="org-type">Env</span>(<span class="org-constant">env</span>::<span class="org-type">Environment</span>),
    <span class="org-doc">/// Represents a runtime Error value, with specific keys</span>
    <span class="org-type">Error</span>(<span class="org-type">Error</span>),
    <span class="org-doc">/// Represents the words available in to use</span>
    <span class="org-type">Words</span>(<span class="org-constant">dict</span>::<span class="org-type">Words</span>),
    <span class="org-doc">/// Represents a dictionary, including which modules have priority</span>
    <span class="org-type">Dictionary</span>(<span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>),
    <span class="org-type">Nothing</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">KeyItem</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> i {
            <span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)),
            <span class="org-type">KeyItem</span>::<span class="org-type">String</span>(i) =&gt; i.fit(),
            <span class="org-type">KeyItem</span>::<span class="org-type">List</span>(l) =&gt; <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(l.iter().cloned().map(<span class="org-type">Item</span>::derive)).fit(),
            <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Item</span>::<span class="org-type">Word</span>(w),
            <span class="org-type">KeyItem</span>::<span class="org-type">Bytes</span>(bs) =&gt; bs.fit(),
            <span class="org-type">KeyItem</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-type">Item</span>::<span class="org-type">Char</span>(c),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(<span class="org-type">Word</span>::derive(i))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Word</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(i)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)) =&gt; <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(i)),
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w)),
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Char</span>(c)),
            i =&gt; <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span> {
                <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(i) =&gt; <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">String</span>(i)),

                <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(i) =&gt; <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Bytes</span>(i)),

                <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; {
                    <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">List</span>(<span class="org-type">KeyList</span>::try_from_iter(l.iter().cloned())<span class="org-rust-question-mark">?</span>))
                }
                s =&gt; {
                    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Bad keyitem </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, s);
                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"KeyItem"</span>, s))
                }
            },
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">KeyItem</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Word</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">k</span>: <span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> k {
            <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Ok</span>(w),
            <span class="org-type">KeyItem</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-type">Ok</span>(s.fit()),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"word"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a), <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(b)) =&gt; a == b,
            (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(a), <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(b)) =&gt; a == b,
            (<span class="org-type">Associative</span>::<span class="org-type">Env</span>(a), <span class="org-type">Associative</span>::<span class="org-type">Env</span>(b)) =&gt; a == b,
            (<span class="org-type">Associative</span>::<span class="org-type">Error</span>(a), <span class="org-type">Associative</span>::<span class="org-type">Error</span>(b)) =&gt; a == b,
            (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(a), <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(b)) =&gt; a == b,
            (<span class="org-type">Associative</span>::<span class="org-type">Nothing</span>, <span class="org-type">Associative</span>::<span class="org-type">Nothing</span>) =&gt; <span class="org-keyword">true</span>,
            <span class="org-comment-delimiter">//</span><span class="org-comment">(Associative::Assoc(a), b) =&gt; Association::derive(a) == Association::derive(b),</span>
            <span class="org-comment-delimiter">//</span><span class="org-comment">(a, Associative::Assoc(b)) =&gt; Association::derive(a) == Association::derive(b),</span>
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Association</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining list to association");</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">la</span> = <span class="org-type">Association</span>::try_from_iter(other.iter().cloned())<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>.join(<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(la)).unwrap())
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">impl coll::Join&lt;Association&gt; for Associative {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Output = Associative;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">type Error = Infallible;</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">fn join(self, other: Association) -&gt; Result&lt;Self::Output, Error&gt; {</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">let la = Association::try_from_iter(other.iter().cloned())?;</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">self.join(Associative::Assoc(la))</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Association</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">thism</span> = <span class="org-keyword">self</span>.mutate();
        thism.extend(other.to_iter());
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-doc">/// The join operation is for generic containers, but we can join</span>
<span class="org-doc">/// two Associatives by merging them together. If both</span>
<span class="org-doc">/// Associatives are the same specific type, the type is</span>
<span class="org-doc">/// preserved. If `other` can be converted to the same specific</span>
<span class="org-doc">/// type as `self`, that conversion will be done and the specific</span>
<span class="org-doc">/// type of `self` is preserved. If they are different types and we</span>
<span class="org-doc">/// can't convert `other` to `self`s type, the result will be</span>
<span class="org-doc">/// demoted to a more generic form.</span>
<span class="org-doc">///</span>
<span class="org-doc">/// Keys in `other` have priority over those in `self` - if a key</span>
<span class="org-doc">/// is in both containers, the result will have only the value</span>
<span class="org-doc">/// from `other`.</span>
<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Associative</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, &lt;<span class="org-type">Self</span> <span class="org-keyword">as</span> <span class="org-type">Join</span>&lt;<span class="org-type">Associative</span>&gt;&gt;::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Joining associative to associative");</span>
        <span class="org-type">Ok</span>(<span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            <span class="org-comment-delimiter">// </span><span class="org-comment">same type means 2nd one wins.</span>
            <span class="org-comment-delimiter">//</span><span class="org-comment">TODO: a little more complex for types that can be extended</span>
            (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(_), <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(other)) =&gt; {
                <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(other)
            }
            (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(this), <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(other)) =&gt; {
                <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(this.join(other).unwrap())
            }
            <span class="org-comment-delimiter">//</span><span class="org-comment">(Associative::Dictionary(this), Associative::Assoc(other)) =&gt; {}</span>
            (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(this), <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(other)) =&gt; this.join(other).unwrap(),
            (<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(this), <span class="org-type">Associative</span>::<span class="org-type">Words</span>(other)) =&gt; this.join(other).unwrap(),
            (<span class="org-type">Associative</span>::<span class="org-type">Error</span>(_), <span class="org-type">Associative</span>::<span class="org-type">Error</span>(other)) =&gt; <span class="org-type">Associative</span>::<span class="org-type">Error</span>(other),
            (<span class="org-type">Associative</span>::<span class="org-type">Env</span>(_), <span class="org-type">Associative</span>::<span class="org-type">Env</span>(other)) =&gt; <span class="org-type">Associative</span>::<span class="org-type">Env</span>(other),
            (<span class="org-type">Associative</span>::<span class="org-type">Nothing</span>, <span class="org-type">Associative</span>::<span class="org-type">Nothing</span>) =&gt; <span class="org-type">Associative</span>::<span class="org-type">Nothing</span>,
            <span class="org-comment-delimiter">// </span><span class="org-comment">This is infallible so .unwrap should be safe</span>
            (<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(this), other) =&gt; <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(this.join(other).unwrap()),
            (this, other) =&gt; {
                <span class="org-preprocessor">unimplemented!</span>(<span class="org-string">"Join between associatives: {:?} \n\n{:?}"</span>, this, other)
            }
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Entry</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">maybe_key</span> = <span class="org-keyword">self</span>.keys().next().cloned();
        <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = <span class="org-keyword">self</span>.mutate();
        <span class="org-keyword">let</span> <span class="org-variable-name">maybe_value</span> = maybe_key.as_ref().and_then(|key| am.remove(key));

        maybe_key.map(|key| (key, maybe_value.unwrap_or_default()))
    }
}

<span class="org-doc">/// The take operation is for generic containers but we can</span>
<span class="org-doc">/// perform it on an Associative by removing an arbitrary pair and</span>
<span class="org-doc">/// returning it.</span>
<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">a</span>) =&gt; a.take_simple().map(<span class="org-type">Item</span>::derive),
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">d</span>) =&gt; d.take_simple().map(<span class="org-type">Item</span>::derive),
            <span class="org-comment-delimiter">// </span><span class="org-comment">The remaining impls may require auto-demotion (eg,</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">removing a required field from say, Error). We'll just</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">demote all of them whether the field that is removed is</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">required or not, since the caller cannot know in</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">advance which it will be.</span>
            <span class="org-keyword">ref</span> <span class="org-variable-name">a</span> =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">assoc</span>: <span class="org-type">Association</span> = (*a).clone().fit();
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = assoc.take_simple().map(<span class="org-type">Item</span>::derive);
                *<span class="org-keyword">self</span> = <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(assoc);
                v
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Associative</span> {
    <span class="org-doc">/// Retuns the number of associations in the container</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">len</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; a.len(),
            <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(a) =&gt; a.len(),
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; e.len(),
            <span class="org-type">Associative</span>::<span class="org-type">Error</span>(e) =&gt; e.len(),
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(d) =&gt; d.len(),
            <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d) =&gt; d.len(),
            <span class="org-type">Associative</span>::<span class="org-type">Nothing</span> =&gt; 0,
        }
    }

    <span class="org-doc">/// Returns true if the container is empty</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_empty</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.len() == 0
    }

    <span class="org-doc">/// Inserts a new association of a [KeyItem] to [Item]. If the key</span>
    <span class="org-doc">/// already exists, the value is replaced and the old value is</span>
    <span class="org-doc">/// returned. If the key doesn't exist, a new one is created with</span>
    <span class="org-doc">/// the new value and no old value is returned. The overall return</span>
    <span class="org-doc">/// value is tuple of an updated Associative, and an optional old</span>
    <span class="org-doc">/// value.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// The Associative returned is not necessarily the same type as</span>
    <span class="org-doc">/// self, as sometimes there is auto-demotion, eg from Error to</span>
    <span class="org-doc">/// Association. Demotion typically happens when you insert a key</span>
    <span class="org-doc">/// into a type that doesn't support that key, you'll get a more</span>
    <span class="org-doc">/// generic type back instead.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">insert</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">k</span>: <span class="org-type">KeyItem</span>, <span class="org-variable-name">v</span>: <span class="org-type">Item</span>) -&gt; (<span class="org-type">Associative</span>, <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;) {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Insert! {:?}", self);</span>
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-keyword">mut</span> a) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> a);
                <span class="org-keyword">let</span> <span class="org-variable-name">e</span> = am.insert(k, v);
                (<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a), e)
            }
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">mut</span> d) =&gt; <span class="org-keyword">match</span> (k, v) {
                (<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w), e) =&gt; {
                    <span class="org-keyword">let</span> <span class="org-variable-name">e2</span> = e.clone();
                    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Ok</span>(e) = <span class="org-constant">dict</span>::<span class="org-type">Entry</span>::try_derive(e) {
                        <span class="org-keyword">let</span> <span class="org-variable-name">dm</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> d);
                        <span class="org-keyword">let</span> <span class="org-variable-name">e</span> = dm.insert(w.fit(), e).map(<span class="org-type">Item</span>::derive);
                        (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(d), e)
                    } <span class="org-keyword">else</span> {
                        <span class="org-comment-delimiter">// </span><span class="org-comment">TODO silently failing to insert here is bad</span>
                        <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Warning, failed to insert into dictionary: </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, e2);
                        (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(d), <span class="org-type">None</span>)
                    }
                }
                _ =&gt; (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(d), <span class="org-type">None</span>),
            },
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; e.insert(k, v),
            <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(<span class="org-keyword">mut</span> de) =&gt; <span class="org-keyword">match</span> k {
                <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>) =&gt; {
                    <span class="org-keyword">let</span> <span class="org-variable-name">w</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span> = w.fit();
                    <span class="org-keyword">if</span> w == <span class="org-string">"definition"</span> {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(v);
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(l) =&gt; {
                                de.definition = <span class="org-constant">dict</span>::<span class="org-type">Executable</span>::<span class="org-type">Derived</span>(l);
                                (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: return the old def</span>
                            }
                            <span class="org-type">Err</span>(_) =&gt; (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>),
                        }
                    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> w == <span class="org-string">"examples"</span> {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(v);
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(l) =&gt; {
                                de.examples = <span class="org-type">Some</span>(l);
                                (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: return the old examples</span>
                            }
                            <span class="org-type">Err</span>(_) =&gt; (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>),
                        }
                    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> w == <span class="org-string">"spec"</span> {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(v);
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(l) =&gt; {
                                de.spec = l.try_fit().ok();
                                (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: return the old spec</span>
                            }
                            <span class="org-type">Err</span>(_) =&gt; (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>),
                        }
                    } <span class="org-keyword">else</span> {
                        (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>)
                    }
                }
                _ =&gt; (<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(de), <span class="org-type">None</span>),
            },
            <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(<span class="org-keyword">mut</span> d) =&gt; <span class="org-keyword">match</span> k {
                <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>) =&gt; {
                    <span class="org-keyword">let</span> <span class="org-variable-name">w</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span> = w.fit();
                    <span class="org-keyword">if</span> w == <span class="org-string">"words"</span> {
                        <span class="org-keyword">let</span> <span class="org-variable-name">e</span> = <span class="org-constant">dict</span>::<span class="org-type">Words</span>::try_derive(v);
                        <span class="org-keyword">match</span> e {
                            <span class="org-type">Ok</span>(words) =&gt; {
                                d.words = words;
                                (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: return the old entries</span>
                            }
                            <span class="org-type">Err</span>(_) =&gt; (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>),
                        }
                    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> w == <span class="org-string">"modules"</span> {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-type">Vec</span>::&lt;<span class="org-constant">dict</span>::<span class="org-type">Namespace</span>&gt;::try_derive(v);
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(modules) =&gt; {
                                d.modules = modules;
                                (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: return the old modules</span>
                            }
                            <span class="org-type">Err</span>(_) =&gt; (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>),
                        }
                    } <span class="org-keyword">else</span> {
                        (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>)
                    }
                }
                _ =&gt; (<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d), <span class="org-type">None</span>),
            },
            _ =&gt; <span class="org-preprocessor">todo!</span>(<span class="org-string">"insert Implementations for error, dictionary, env etc"</span>),
        }
    }

    <span class="org-doc">/// The put operation is for generic containers, adding a new Item</span>
    <span class="org-doc">/// to the container. In the case of Associative, we can still do</span>
    <span class="org-doc">/// this if the Item is the right type: a key/value pair. If it's</span>
    <span class="org-doc">/// the right type, we [Self::insert] the value using the key,</span>
    <span class="org-doc">/// otherwise return an error.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Associative</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">mut</span> this), other) =&gt; {
                <span class="org-keyword">let</span> (word, entry) = &lt;(<span class="org-type">Word</span>, <span class="org-constant">dict</span>::<span class="org-type">Entry</span>)&gt;::try_derive(other)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">let</span> <span class="org-variable-name">thismut</span> = this.mutate();
                thismut.insert(word.fit(), entry.fit());
                <span class="org-type">Ok</span>(<span class="org-type">Associative</span>::<span class="org-type">Words</span>(this))
            }
            (this, other) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">entry</span>: (<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>) = other.try_fit()<span class="org-rust-question-mark">?</span>;
                <span class="org-type">Ok</span>(this.insert(entry.0, entry.1).0)
            }
        }
    }

    <span class="org-doc">/// Retrieves a value from the container using the key</span>
    <span class="org-doc">/// `k`. Returns [None] if the key is not present.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">k</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; a.get(k).cloned(),
            <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d) =&gt; d.get(k),
            <span class="org-type">Associative</span>::<span class="org-type">Error</span>(e) =&gt; e.data.get(k).cloned(),
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; e.get(k),
            <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(d) =&gt; d.get(k),
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(d) =&gt; <span class="org-keyword">match</span> k {
                <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; d.get(<span class="org-rust-ampersand">&amp;</span>w.clone().fit()).map(|x| x.clone().fit()),
                _ =&gt; <span class="org-type">None</span>,
            },
            <span class="org-rust-ampersand">&amp;</span><span class="org-type">Associative</span>::<span class="org-type">Nothing</span> =&gt; <span class="org-type">None</span>,
        }
    }

    <span class="org-doc">/// Returns true if the key `k` is present in the container.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">contains_key</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">k</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">KeyItem</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; a.contains_key(k),
            <span class="org-type">Associative</span>::<span class="org-type">Error</span>(e) =&gt; e.data.contains_key(k),
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; e.contains_key(k),
            <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(d) =&gt; d.contains_key(k),
            <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d) =&gt; d.contains_key(k),
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(d) =&gt; <span class="org-keyword">match</span> k {
                <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; d.contains_key(<span class="org-rust-ampersand">&amp;</span>w.clone().fit()),
                _ =&gt; <span class="org-keyword">false</span>,
            },
            <span class="org-rust-ampersand">&amp;</span><span class="org-type">Associative</span>::<span class="org-type">Nothing</span> =&gt; <span class="org-keyword">false</span>,
        }
    }

    <span class="org-doc">/// Removes the key `k` from the container, returning a tuple of a</span>
    <span class="org-doc">/// new [Associative] and an optional value if the key was</span>
    <span class="org-doc">/// present.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">remove</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">k</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">KeyItem</span>) -&gt; (<span class="org-type">Associative</span>, <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;) {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-keyword">mut</span> a) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> a);
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = am.remove(k);
                (<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a), v)
            }
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">mut</span> d) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">dm</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> d);
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = dm.remove(<span class="org-rust-ampersand">&amp;</span><span class="org-type">Word</span>::try_derive(k.clone()).unwrap_or_default());
                (<span class="org-type">Associative</span>::<span class="org-type">Words</span>(d), v.map(|v| v.fit()))
            }
            <span class="org-type">Associative</span>::<span class="org-type">Error</span>(<span class="org-keyword">mut</span> e) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = e.data.mutate();
                <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = a.remove(k);
                (<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e), v)
            }
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = <span class="org-type">Association</span>::derive_iter(e);
                <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a).remove(k)
            }
            _ =&gt; <span class="org-preprocessor">todo!</span>(<span class="org-string">"Removing from other associative types"</span>),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">ToIterator</span> <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Entry</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Entry</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">to_iter</span>&lt;'<span class="org-variable-name">a</span>&gt;(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;_&gt; = a.iter().map(|(k, v)| (k.clone(), v.clone())).collect();
                <span class="org-type">Box</span>::new(items.into_iter())
            }
            <span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(e) =&gt; <span class="org-type">Box</span>::new(e.into_iter()),
            <span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d) =&gt; <span class="org-type">Box</span>::new(d.into_iter()),
            <span class="org-type">Associative</span>::<span class="org-type">Words</span>(d) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;_&gt; = d
                    .iter()
                    .map(|(k, v)| (<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(k.clone().fit()), v.clone().fit()))
                    .collect();
                <span class="org-type">Box</span>::new(items.into_iter())
            }
            <span class="org-type">Associative</span>::<span class="org-type">Error</span>(e) =&gt; e.into_iter(),
            <span class="org-type">Associative</span>::<span class="org-type">Env</span>(e) =&gt; e.into_iter(),
            <span class="org-type">Associative</span>::<span class="org-type">Nothing</span> =&gt; <span class="org-type">Box</span>::new(<span class="org-constant">std</span>::<span class="org-constant">iter</span>::empty()),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">coll</span>::<span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(a.to_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">Sized</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">s</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; <span class="org-type">Ok</span>(a),
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(i) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"associative"</span>, i)),
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(i) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"associative"</span>, i)),
            s =&gt; <span class="org-type">Ok</span>(<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-type">Association</span>::try_from_iter(s)<span class="org-rust-question-mark">?</span>)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Associative</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Associative</span>::try_derive(s)
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">Convert anything that can be iterated over as Items, to an</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Association. The items must be pairs that are</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">convertable to Entry, otherwise it will return an error.</span>
<span class="org-keyword">impl</span> <span class="org-type">TryDeriveIterator</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">try_from_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">l</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;,
    {
        <span class="org-type">Ok</span>(<span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(
            l.into_iter()
                .map(|i| <span class="org-type">Entry</span>::try_derive(i.clone()))
                .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
        ))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">h</span>: <span class="org-type">HashMap</span>&lt;<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;) -&gt; <span class="org-type">Self</span> {
        <span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(h)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Entry</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Entry</span>&gt;,
    {
        <span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(iter.into_iter().collect::&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>&gt;&gt;())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Entry</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">coll</span>::<span class="org-type">List</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Entry</span>&gt;,
    {
        <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::new(
            iter.into_iter()
                .map(|e| e.fit())
                .collect::&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">Item</span>&gt;&gt;(),
        )
    }
}

<span class="org-keyword">impl</span> <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">KeyItem</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyList</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span>
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">KeyItem</span>&gt;,
    {
        <span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(iter.into_iter().collect::&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">KeyItem</span>&gt;&gt;())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Entry</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">e</span>: <span class="org-type">Entry</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter([<span class="org-type">Item</span>::derive(e.0), e.1]).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">if</span> s.count() != 2 {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"pair"</span>, s))
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">iter</span> = s.into_iter();
            <span class="org-keyword">let</span> <span class="org-variable-name">key</span>: <span class="org-type">KeyItem</span> = iter.next().unwrap().try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-variable-name">value</span> = iter.next().unwrap();
            <span class="org-type">Ok</span>((key, value))
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Association</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-type">Association</span> {
        <span class="org-keyword">match</span> a {
            <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; a,
            a =&gt; <span class="org-type">Association</span>::derive_iter(a.to_iter()),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">AssociationContent</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">AssociationContent</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">sync</span>::<span class="org-type">Arc</span>::new(a).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Association</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Association</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;(<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>((k, _): (<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)) -&gt; <span class="org-type">KeyItem</span> {
        k
    }
}

<span class="org-doc">/// Converting Associative to Set just returns the keys.</span>
<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">coll</span>::<span class="org-type">Set</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Associative</span>) -&gt; <span class="org-constant">coll</span>::<span class="org-type">Set</span> {
        <span class="org-type">Arc</span>::new(<span class="org-type">HashSet</span>::from_iter(a.to_iter().map(|(k, _)| k)))
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">E</span>, <span class="org-type">C</span>&gt; <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">E</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Result</span>&lt;<span class="org-type">C</span>, <span class="org-type">E</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">C</span>: <span class="org-type">DeriveIterator</span>&lt;<span class="org-type">T</span>&gt;,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">derive_iter</span>&lt;<span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">E</span>&gt;&gt;&gt;(<span class="org-variable-name">iter</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">result</span> = <span class="org-type">Vec</span>::new();

        <span class="org-keyword">for</span> <span class="org-variable-name">item</span> <span class="org-keyword">in</span> iter {
            <span class="org-keyword">match</span> item {
                <span class="org-type">Ok</span>(value) =&gt; result.push(value),
                <span class="org-type">Err</span>(e) =&gt; <span class="org-keyword">return</span> <span class="org-type">Err</span>(e),
            }
        }

        <span class="org-type">Ok</span>(<span class="org-type">C</span>::derive_iter(result))
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Convert</span>&lt;<span class="org-type">KA</span>, <span class="org-type">VA</span>&gt; {
    <span class="org-doc">/// Convert from any type of hashmap to any other, assuming the keys</span>
    <span class="org-doc">/// and values convert</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">convert</span>&lt;<span class="org-type">KB</span>, <span class="org-type">VB</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">KB</span>, <span class="org-type">VB</span>&gt;, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">KB</span>: <span class="org-type">Clone</span> + <span class="org-type">Eq</span> + <span class="org-type">Hash</span> + <span class="org-type">TryDerive</span>&lt;<span class="org-type">KA</span>, <span class="org-type">Error</span> = <span class="org-type">Error</span>&gt;,
        <span class="org-variable-name">VB</span>: <span class="org-type">Clone</span> + <span class="org-type">TryDerive</span>&lt;<span class="org-type">VA</span>, <span class="org-type">Error</span> = <span class="org-type">Error</span>&gt;,
        <span class="org-variable-name">KA</span>: <span class="org-type">Clone</span> + <span class="org-type">Eq</span> + <span class="org-type">Hash</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">Assuming Clone is needed for TryFrom</span>
        <span class="org-variable-name">VA</span>: <span class="org-type">Clone</span>;
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">KA</span>, <span class="org-type">VA</span>&gt; <span class="org-type">Convert</span>&lt;<span class="org-type">KA</span>, <span class="org-type">VA</span>&gt; <span class="org-keyword">for</span> <span class="org-type">HashMap</span>&lt;<span class="org-type">KA</span>, <span class="org-type">VA</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">KA</span>: <span class="org-type">Eq</span> + <span class="org-type">Hash</span> + <span class="org-type">Clone</span>,
    <span class="org-variable-name">VA</span>: <span class="org-type">Clone</span>,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">convert</span>&lt;<span class="org-type">KB</span>, <span class="org-type">VB</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">KB</span>, <span class="org-type">VB</span>&gt;, <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">KB</span>: <span class="org-type">Clone</span> + <span class="org-type">Eq</span> + <span class="org-type">Hash</span> + <span class="org-type">TryDerive</span>&lt;<span class="org-type">KA</span>, <span class="org-type">Error</span> = <span class="org-type">Error</span>&gt;,
        <span class="org-variable-name">VB</span>: <span class="org-type">Clone</span> + <span class="org-type">TryDerive</span>&lt;<span class="org-type">VA</span>, <span class="org-type">Error</span> = <span class="org-type">Error</span>&gt;,
        <span class="org-variable-name">KA</span>: <span class="org-type">Clone</span> + <span class="org-type">Eq</span> + <span class="org-type">Hash</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">Assuming Clone is needed for TryFrom</span>
        <span class="org-variable-name">VA</span>: <span class="org-type">Clone</span>,
    {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">new_hashmap</span> = <span class="org-type">HashMap</span>::new();

        <span class="org-keyword">for</span> (key, value) <span class="org-keyword">in</span> <span class="org-keyword">self</span>.iter().map(|(k, v)| (k.clone(), v.clone())) {
            <span class="org-keyword">let</span> <span class="org-variable-name">new_key</span>: <span class="org-type">KB</span> = key.try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-variable-name">new_value</span>: <span class="org-type">VB</span> = value.try_fit()<span class="org-rust-question-mark">?</span>;
            new_hashmap.insert(new_key, new_value);
        }

        <span class="org-type">Ok</span>(new_hashmap)
    }
}

<span class="org-keyword">mod</span> <span class="org-constant">serde</span> {
    <span class="org-keyword">use</span> <span class="org-keyword">super</span>::{<span class="org-type">KeyItem</span>, <span class="org-type">KeyList</span>};
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
    <span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">de</span>::{<span class="org-keyword">self</span>, <span class="org-type">Deserialize</span>, <span class="org-type">Deserializer</span>, <span class="org-type">Visitor</span>};
    <span class="org-keyword">use</span> <span class="org-constant">serde</span>::<span class="org-constant">ser</span>::{<span class="org-type">Serialize</span>, <span class="org-type">SerializeSeq</span>};
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::fmt;

    <span class="org-keyword">struct</span> <span class="org-type">KeyItemVisitor</span>;

    <span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-type">Visitor</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItemVisitor</span> {
        <span class="org-keyword">type</span> <span class="org-type">Value</span> = <span class="org-type">KeyItem</span>;

        <span class="org-keyword">fn</span> <span class="org-function-name">expecting</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">formatter</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
            formatter.write_str(<span class="org-string">"expected a specific representation for Item"</span>)
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_i64</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">value</span>: <span class="org-type">i64</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(value))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_u64</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">value</span>: <span class="org-type">u64</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(value <span class="org-keyword">as</span> <span class="org-type">i64</span>))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_str</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">v</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">String</span>(v.to_string()))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_byte_buf</span>&lt;<span class="org-type">E</span>&gt;(<span class="org-keyword">self</span>, <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">E</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">E</span>: <span class="org-constant">de</span>::<span class="org-type">Error</span>,
        {
            <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">Bytes</span>(v))
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">visit_seq</span>&lt;<span class="org-type">A</span>&gt;(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">seq</span>: <span class="org-type">A</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Value</span>, <span class="org-type">A</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">A</span>: <span class="org-constant">de</span>::<span class="org-type">SeqAccess</span>&lt;'<span class="org-variable-name">de</span>&gt;,
        {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">KeyItem</span>&gt; = <span class="org-type">Vec</span>::new();
            <span class="org-keyword">while</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(item) = seq.next_element::&lt;<span class="org-type">KeyItem</span>&gt;()<span class="org-rust-question-mark">?</span> {
                items.push(item);
            }
            <span class="org-type">Ok</span>(<span class="org-type">KeyItem</span>::<span class="org-type">List</span>(<span class="org-type">KeyList</span>::derive_iter(items)))
        }
    }

    <span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-type">Deserialize</span>&lt;'<span class="org-variable-name">de</span>&gt; <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">deserialize</span>&lt;<span class="org-type">D</span>&gt;(<span class="org-variable-name">deserializer</span>: <span class="org-type">D</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">D</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">D</span>: <span class="org-type">Deserializer</span>&lt;'<span class="org-variable-name">de</span>&gt;,
        {
            deserializer.deserialize_any(<span class="org-type">KeyItemVisitor</span>)
        }
    }

    <span class="org-keyword">impl</span> <span class="org-type">Serialize</span> <span class="org-keyword">for</span> <span class="org-type">KeyItem</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">serialize</span>&lt;<span class="org-type">S</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">serializer</span>: <span class="org-type">S</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">S</span>::<span class="org-type">Ok</span>, <span class="org-type">S</span>::<span class="org-type">Error</span>&gt;
        <span class="org-keyword">where</span>
            <span class="org-variable-name">S</span>: <span class="org-constant">serde</span>::<span class="org-type">Serializer</span>,
        {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
                <span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(i) =&gt; serializer.serialize_i64(*i),
                <span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; serializer.serialize_str(w.fit()),
                <span class="org-type">KeyItem</span>::<span class="org-type">Char</span>(c) =&gt; serializer.serialize_char(*c),
                <span class="org-type">KeyItem</span>::<span class="org-type">Bytes</span>(b) =&gt; serializer.serialize_bytes(b.as_slice()),
                <span class="org-type">KeyItem</span>::<span class="org-type">List</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">l</span>) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Serialize a list (sequence)</span>
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">seq</span> = serializer.serialize_seq(<span class="org-type">Some</span>(l.len()))<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">for</span> <span class="org-variable-name">element</span> <span class="org-keyword">in</span> l.iter() {
                        seq.serialize_element(<span class="org-rust-ampersand">&amp;</span>element)<span class="org-rust-question-mark">?</span>;
                    }
                    seq.end()
                }
                <span class="org-type">KeyItem</span>::<span class="org-type">String</span>(s) =&gt; serializer.serialize_str(s.as_str()),
            }
        }
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org5fbbd44" class="outline-5">
<h5 id="org5fbbd44"><span class="section-number-5">1.5.3.5.</span> Error types</h5>
<div class="outline-text-5" id="text-1-5-3-5">
<div class='tangle-wrapper' data-tangle='src/types/container/error.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">super</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, <span class="org-type">Mutey</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Int</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-type">Item</span>, <span class="org-type">Word</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;

<span class="org-doc">/// Represents a runtime error type. Contains generic fields to hold</span>
<span class="org-doc">/// things like what type of error, the actual vs expected conditions,</span>
<span class="org-doc">/// etc. Also holds whether the error has been handled or not, which</span>
<span class="org-doc">/// the runtime uses to decide whether to keep unwinding the program</span>
<span class="org-doc">/// looking for something to handle the error. An error that has been</span>
<span class="org-doc">/// handled is inert, it is just another data value.</span>
<span class="org-preprocessor">#[derive(Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Error</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">data</span>: <span class="org-constant">assoc</span>::<span class="org-type">Association</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">is_handled</span>: <span class="org-type">bool</span>,
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Nested</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">caused</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Error</span>) -&gt; <span class="org-type">Self</span>;
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">E</span>&gt; <span class="org-type">Nested</span> <span class="org-keyword">for</span> <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">E</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">E</span>: <span class="org-type">Nested</span>,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">caused</span>(<span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Error</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">self</span>.map_err(|e| e.caused(other))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Nested</span> <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">caused</span>(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">e</span>: <span class="org-type">Error</span>) -&gt; <span class="org-type">Error</span> {
        e.data.mutate().insert(<span class="org-string">"cause"</span>.fit(), <span class="org-keyword">self</span>.fit());
        e
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Error</span> {
    <span class="org-doc">/// Creates a new error.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">create</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;&gt;(<span class="org-variable-name">asked</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">reason</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-variable-name">actual</span>: <span class="org-type">Option</span>&lt;<span class="org-type">T</span>&gt;) -&gt; <span class="org-type">Error</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">let bt = backtrace::Backtrace::new();</span>
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">data</span>: <span class="org-type">Vec</span>&lt;(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt; = <span class="org-preprocessor">vec!</span>[
            (<span class="org-string">"type"</span>.fit(), <span class="org-string">"error"</span>.fit()),
            (<span class="org-string">"asked"</span>.fit(), asked.fit()),
            (<span class="org-string">"reason"</span>.fit(), reason.to_string().fit()),
            <span class="org-comment-delimiter">//</span><span class="org-comment">("backtrace".fit(), Item::String(format!("{:?}", bt))),</span>
        ];
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(actual) = actual {
            data.push((<span class="org-string">"actual"</span>.fit(), actual.fit()));
        }
        <span class="org-type">Error</span> {
            <span class="org-variable-name">is_handled</span>: <span class="org-keyword">false</span>,
            <span class="org-variable-name">data</span>: <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter(data),
        }
    }

    <span class="org-doc">/// Creates a stack underflow error for when the current word</span>
    <span class="org-doc">/// needs more items than there are on the stack.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">stack_underflow</span>() -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(
            <span class="org-preprocessor">list!</span>(<span class="org-string">"consume"</span>),
            <span class="org-string">"not enough items on stack"</span>,
            <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>,
        )
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">overflow</span>() -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"arithmetic"</span>), <span class="org-string">"number overflow"</span>, <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">undefined</span>(<span class="org-variable-name">w</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(w), <span class="org-string">"word is not defined"</span>, <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">type_mismatch</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;&gt;(<span class="org-variable-name">asked</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">actual</span>: <span class="org-type">Option</span>&lt;<span class="org-type">T</span>&gt;) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(asked, <span class="org-string">"type mismatch"</span>, actual)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">division_by_zero</span>() -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"/"</span>), <span class="org-string">"division by zero"</span>, <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">expected</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;&gt;(<span class="org-variable-name">typestr</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-variable-name">actual</span>: <span class="org-type">T</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::type_mismatch(<span class="org-preprocessor">list!</span>(typestr), <span class="org-type">Some</span>(actual))
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">short_list</span>(<span class="org-variable-name">expected</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(
            <span class="org-preprocessor">list!</span>(<span class="org-string">"count"</span>, expected, <span class="org-string">"&gt;="</span>),
            <span class="org-string">"list had too few items"</span>,
            <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>,
        )
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">list_count</span>(<span class="org-variable-name">expected</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(
            <span class="org-preprocessor">list!</span>(<span class="org-string">"count"</span>, expected, <span class="org-string">"="</span>),
            <span class="org-string">"list had wrong number of items"</span>,
            <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>,
        )
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">negative</span>(<span class="org-variable-name">actual</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::too_small(actual, 0)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">too_small</span>(<span class="org-variable-name">actual</span>: <span class="org-type">Int</span>, <span class="org-variable-name">expected</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(expected, <span class="org-string">"&gt;="</span>), <span class="org-string">"number too small"</span>, <span class="org-type">Some</span>(actual))
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">too_large</span>(<span class="org-variable-name">actual</span>: <span class="org-type">Int</span>, <span class="org-variable-name">expected</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(expected, <span class="org-string">"&lt;="</span>), <span class="org-string">"number too large"</span>, <span class="org-type">Some</span>(actual))
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">parse</span>(<span class="org-variable-name">reason</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"read"</span>), reason, <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">test_assertion</span>(<span class="org-variable-name">program</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">expected</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">actual</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">e</span> = <span class="org-type">Error</span>::create(program, <span class="org-string">"assertion failed"</span>, <span class="org-type">Some</span>(actual));
        <span class="org-keyword">let</span> <span class="org-variable-name">d</span> = e.data.mutate();
        d.insert(<span class="org-string">"expected-program"</span>.fit(), expected.fit());
        e
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">len</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        <span class="org-keyword">self</span>.data.len()
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">push</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-variable-name">value</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">self</span>.data.mutate().insert(key, value)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Infallible</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">_x</span>: <span class="org-type">Infallible</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> _x {} <span class="org-comment-delimiter">// </span><span class="org-comment">Since Infallible can never be instantiated, this will never run</span>
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Infallible</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">_x</span>: <span class="org-type">Infallible</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> _x {} <span class="org-comment-delimiter">// </span><span class="org-comment">Since Infallible can never be instantiated, this will never run</span>
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Error</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">assoc</span>::<span class="org-type">Association</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">e</span>: <span class="org-type">Error</span>) -&gt; <span class="org-constant">assoc</span>::<span class="org-type">Association</span> {
        e.data
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e),
            ))) =&gt; <span class="org-type">Ok</span>(e),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_))) =&gt; {
                <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"error"</span>, <span class="org-type">Item</span>::default()))
            }
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(c)) =&gt; c.into_iter().try_fit(),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"error"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">TODO: this can't fail, can just be a From.</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">Really though, Error should have predefined fields like Environment.</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">data</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::try_from_iter(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(<span class="org-type">Error</span> {
            data,
            <span class="org-variable-name">is_handled</span>: <span class="org-keyword">false</span>,
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">a</span>: <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> a {
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e) =&gt; <span class="org-type">Ok</span>(e),
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a) =&gt; {
                <span class="org-keyword">if</span> a.get(<span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::derive(<span class="org-string">"type"</span>)) != <span class="org-type">Some</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(<span class="org-string">"error"</span>)) {
                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"error"</span>, a))
                } <span class="org-keyword">else</span> {
                    <span class="org-type">Ok</span>(<span class="org-type">Error</span> {
                        <span class="org-variable-name">data</span>: a.clone(),
                        <span class="org-variable-name">is_handled</span>: <span class="org-keyword">true</span>,
                    })
                }
            }
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"error"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">e</span>: <span class="org-type">Error</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoIterator</span> <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">into_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">items</span>: <span class="org-type">Vec</span>&lt;_&gt; = <span class="org-keyword">self</span>
            .data
            .iter()
            .map(|(k, v)| (k.clone(), v.clone()))
            .chain(<span class="org-constant">std</span>::<span class="org-constant">iter</span>::once((<span class="org-string">"handled"</span>.fit(), <span class="org-keyword">self</span>.is_handled.fit())))
            .collect();
        <span class="org-type">Box</span>::new(items.into_iter())
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org0d595b4" class="outline-5">
<h5 id="org0d595b4"><span class="section-number-5">1.5.3.6.</span> Dictionary types</h5>
<div class="outline-text-5" id="text-1-5-3-6">
<div class='tangle-wrapper' data-tangle='src/types/container/dictionary.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">super</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">axiom</span>::<span class="org-type">BUILTIN_FUNCTIONS</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::serialize;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">associative</span>::<span class="org-type">Convert</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, <span class="org-type">Count</span>, <span class="org-type">Mutey</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, <span class="org-type">Bytes</span>, <span class="org-type">Error</span>, <span class="org-type">Item</span>, <span class="org-type">Word</span>};
<span class="org-keyword">use</span> <span class="org-constant">core</span>::fmt;
<span class="org-keyword">use</span> <span class="org-constant">internment</span>::<span class="org-type">Intern</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashMap</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashSet</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">hash</span>::<span class="org-type">Hash</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::ptr;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">OnceLock</span>;

<span class="org-doc">/// The definition of a [Word], contains its actual code (the</span>
<span class="org-doc">/// definition), and also documentation like specs and examples.</span>
<span class="org-preprocessor">#[derive(Debug, Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">examples</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">spec</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Spec</span>&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">definition</span>: <span class="org-type">Executable</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">namespace</span>: <span class="org-type">Namespace</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">doc</span>: <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt;,
}

<span class="org-keyword">impl</span> <span class="org-type">Eq</span> <span class="org-keyword">for</span> <span class="org-type">Entry</span> {}
<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: move specs to their own module</span>
<span class="org-doc">/// An element of a [Spec], either an input or an output. Holds the</span>
<span class="org-doc">/// type and optional name of the input/output.</span>
<span class="org-preprocessor">#[derive(Debug, Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">SpecElement</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">elemtype</span>: <span class="org-constant">types</span>::<span class="org-type">Word</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">name</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">types</span>::<span class="org-type">Word</span>&gt;,
}

<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">StackSpec</span> = <span class="org-type">Vec</span>&lt;<span class="org-type">SpecElement</span>&gt;;

<span class="org-doc">/// The spec of a [Word] consists of the input spec and the output</span>
<span class="org-doc">/// spec, that shows what the stack should look like before and after</span>
<span class="org-doc">/// the [Word] is invoked.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Spec</span> = (<span class="org-type">StackSpec</span>, <span class="org-type">StackSpec</span>);

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">SpecElement</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">SpecElement</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Ok</span>(<span class="org-type">SpecElement</span> {
                <span class="org-variable-name">elemtype</span>: w,
                <span class="org-variable-name">name</span>: <span class="org-type">None</span>,
            }),
            i =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">if</span> s.len() != 2 {
                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::list_count(2))
                } <span class="org-keyword">else</span> {
                    <span class="org-keyword">let</span> <span class="org-variable-name">t</span> = <span class="org-constant">types</span>::<span class="org-type">Word</span>::try_derive(s.front().unwrap().clone())<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">let</span> <span class="org-variable-name">n</span> = <span class="org-constant">types</span>::<span class="org-type">Word</span>::try_derive(s.get(1).unwrap().clone())<span class="org-rust-question-mark">?</span>;
                    <span class="org-type">Ok</span>(<span class="org-type">SpecElement</span> {
                        <span class="org-variable-name">elemtype</span>: t,
                        <span class="org-variable-name">name</span>: <span class="org-type">Some</span>(n),
                    })
                }
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">StackSpec</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">s</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">StackSpec</span>, <span class="org-type">Error</span>&gt; {
        s.iter()
            .cloned()
            .map(<span class="org-type">SpecElement</span>::try_derive)
            <span class="org-comment-delimiter">//</span><span class="org-comment">.map(|r| r.and_then(SpecElement::try_derive))</span>
            .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">StackSpec</span>, <span class="org-type">Error</span>&gt;&gt;()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Spec</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">s</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Spec</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">if</span> s.len() != 2 {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::list_count(2))
        } <span class="org-keyword">else</span> {
            <span class="org-type">Ok</span>((
                <span class="org-type">StackSpec</span>::try_derive(<span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(s.front().unwrap().clone())<span class="org-rust-question-mark">?</span>)<span class="org-rust-question-mark">?</span>,
                <span class="org-type">StackSpec</span>::try_derive(<span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(s.get(1).unwrap().clone())<span class="org-rust-question-mark">?</span>)<span class="org-rust-question-mark">?</span>,
            ))
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Spec</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Spec</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-type">Spec</span>::try_derive(<span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i)<span class="org-rust-question-mark">?</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">SpecElement</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">se</span>: <span class="org-type">SpecElement</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">if</span> se.name.is_some() {
            <span class="org-preprocessor">list!</span>(se.elemtype, se.name).fit()
        } <span class="org-keyword">else</span> {
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(se.elemtype)
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Spec</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">s</span>: <span class="org-type">Spec</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-preprocessor">list!</span>(s.0, s.1).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">ToIterator</span> <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-type">SpecElement</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">SpecElement</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-constant">std</span>::<span class="org-constant">vec</span>::<span class="org-type">IntoIter</span>&lt;<span class="org-type">SpecElement</span>&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">to_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">self</span>.into_iter()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">ToIterator</span> <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-type">Namespace</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Namespace</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-constant">std</span>::<span class="org-constant">vec</span>::<span class="org-type">IntoIter</span>&lt;<span class="org-type">Namespace</span>&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">to_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">self</span>.into_iter()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Namespace</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">ns</span>: <span class="org-type">Namespace</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">match</span> ns {
            <span class="org-type">Some</span>(ns) =&gt; (*ns).clone().fit(),
            <span class="org-type">None</span> =&gt; <span class="org-type">Item</span>::default(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoList</span> <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-type">Namespace</span>&gt; {}
<span class="org-keyword">impl</span> <span class="org-type">IntoList</span> <span class="org-keyword">for</span> <span class="org-type">Vec</span>&lt;<span class="org-type">SpecElement</span>&gt; {}

<span class="org-comment-delimiter">//</span><span class="org-comment">impl Derive&lt;Intern&lt;Vec&lt;u8&gt;&gt;&gt; for</span>

<span class="org-keyword">impl</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">len</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        3 <span class="org-comment-delimiter">// </span><span class="org-comment">3 fields</span>
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">match</span> key {
            <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-keyword">match</span> w.data.as_str() {
                <span class="org-string">"spec"</span> =&gt; <span class="org-keyword">self</span>.spec.clone().map(|x| x.fit()),
                <span class="org-string">"examples"</span> =&gt; <span class="org-keyword">self</span>.examples.clone().map(|x| x.fit()),
                <span class="org-string">"definition"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">match</span> <span class="org-keyword">self</span>.definition.clone() {
                    <span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(a) =&gt; a.clone().fit(),
                    <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(d) =&gt; d.fit(),
                }),
                <span class="org-string">"namespace"</span> =&gt; <span class="org-keyword">self</span>.namespace.map(|x| x.as_ref().clone().fit()),
                <span class="org-string">"doc"</span> =&gt; <span class="org-keyword">self</span>.doc.clone().map(|x| x.fit()),
                _ =&gt; <span class="org-type">None</span>,
            },
            _ =&gt; <span class="org-type">None</span>,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">contains_key</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-constant">types</span>::<span class="org-type">Word</span>::try_derive(key.clone()).map_or(<span class="org-keyword">false</span>, |<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>| {
            <span class="org-preprocessor">matches!</span>(w.fit(), <span class="org-string">"examples"</span> | <span class="org-string">"spec"</span> | <span class="org-string">"definition"</span> | <span class="org-string">"doc"</span>)
        })
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">TODO: Use the builtin Bytes type</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Namespace</span> = <span class="org-type">Option</span>&lt;<span class="org-type">Intern</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;&gt;&gt;;

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">bytes_to_ns</span>(<span class="org-variable-name">b</span>: <span class="org-type">Bytes</span>) -&gt; <span class="org-type">Namespace</span> {
    <span class="org-keyword">if</span> b.is_empty() {
        <span class="org-type">Default</span>::default()
    } <span class="org-keyword">else</span> {
        <span class="org-type">Some</span>(<span class="org-type">Intern</span>::new(b))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Namespace</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Namespace</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))) =&gt; <span class="org-type">Ok</span>(bytes_to_ns(b)),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))) =&gt; <span class="org-type">Ok</span>(bytes_to_ns(b)),

            i =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">if</span> s.is_empty() {
                    <span class="org-type">Ok</span>(<span class="org-type">Default</span>::default())
                } <span class="org-keyword">else</span> {
                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"namespace"</span>, s))
                }
            }
        }
    }
}

<span class="org-doc">/// Holds [Word]s and their definitions.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">Words</span> = <span class="org-constant">coll</span>::<span class="org-type">Arc</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">Word</span>, <span class="org-type">Entry</span>&gt;&gt;;

<span class="org-doc">/// One of the main components of an</span>
<span class="org-doc">/// [crate::types::container::environment::Environment]. Provides</span>
<span class="org-doc">/// definitions of words and a resolver, which decides which</span>
<span class="org-doc">/// definition of the same word to use (based on which module it comes</span>
<span class="org-doc">/// from).</span>
<span class="org-preprocessor">#[derive(Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">words</span>: <span class="org-type">Words</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">lingo</span>: <span class="org-type">Words</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">modules</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">Namespace</span>&gt;,
}

<span class="org-doc">/// A namespace for the core functions</span>
<span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-variable-name">CORE</span>: <span class="org-type">OnceLock</span>&lt;<span class="org-type">Namespace</span>&gt; = <span class="org-type">OnceLock</span>::new();

<span class="org-doc">/// A custom impl for Dictionary that doesn't dump a massive data</span>
<span class="org-doc">/// structure. comment this out to get access to the full debug output.</span>
<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        f.debug_struct(<span class="org-string">"Dictionary"</span>)
            .field(<span class="org-string">"words"</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-preprocessor">format_args!</span>(<span class="org-string">"Words(len={})"</span>, <span class="org-keyword">self</span>.words.len()))
            .field(<span class="org-string">"modules"</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.modules)
            .finish()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Dictionary</span> {
    <span class="org-doc">/// Treats the [Dictionary] as an associative structure,</span>
    <span class="org-doc">/// returning one of its fields, or [None].</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">match</span> key {
            <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-keyword">match</span> w.data.as_str() {
                <span class="org-string">"words"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.words.clone().fit()),
                <span class="org-string">"modules"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.modules.clone().fit()),
                <span class="org-string">"lingo"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.lingo.clone().fit()),
                _ =&gt; <span class="org-type">None</span>,
            },
            _ =&gt; <span class="org-type">None</span>,
        }
    }

    <span class="org-doc">/// Get an [Entry] from the dictionary, doing namespace</span>
    <span class="org-doc">/// resolution.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get_entry</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">types</span>::<span class="org-type">Word</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Entry</span>&gt; {
        <span class="org-keyword">self</span>.lingo.get(key).cloned()
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">len</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        2
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">merge</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">new</span>: <span class="org-type">Self</span>, <span class="org-variable-name">namespace</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Namespace</span>) {
        <span class="org-keyword">self</span>.words.merge(new.words, namespace);
        <span class="org-comment-delimiter">//</span><span class="org-comment">self.resolve();</span>
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">contains_key</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-constant">types</span>::<span class="org-type">Word</span>::try_derive(key.clone()).map_or(<span class="org-keyword">false</span>, |<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>| {
            <span class="org-preprocessor">matches!</span>(w.fit(), <span class="org-string">"modules"</span> | <span class="org-string">"words"</span> | <span class="org-string">"lingo"</span>)
        })
    }

    <span class="org-doc">/// Produce an [Words] map that is pre-resolved using the</span>
    <span class="org-doc">/// modules from this dictionary. Saves computation at runtime</span>
    <span class="org-doc">/// because resolution is already done.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">resolve</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) {
        <span class="org-keyword">fn</span> <span class="org-function-name">group_by_namespace</span>(<span class="org-variable-name">words</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Words</span>) -&gt; <span class="org-type">HashMap</span>&lt;<span class="org-type">Namespace</span>, <span class="org-type">Vec</span>&lt;(<span class="org-constant">types</span>::<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt;&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">grouped</span>: <span class="org-type">HashMap</span>&lt;<span class="org-type">Namespace</span>, <span class="org-type">Vec</span>&lt;(<span class="org-constant">types</span>::<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt;&gt; = <span class="org-type">HashMap</span>::new();

            <span class="org-keyword">for</span> (k, v) <span class="org-keyword">in</span> words.iter() {
                grouped.entry(k.namespace).or_insert_with(<span class="org-type">Vec</span>::new).push((
                    {
                        <span class="org-comment-delimiter">// </span><span class="org-comment">Block out the namespace, since we want to</span>
                        <span class="org-comment-delimiter">// </span><span class="org-comment">find the word using no namespace</span>
                        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">kk</span> = k.clone();
                        kk.namespace = <span class="org-type">None</span>;
                        kk
                    },
                    v.clone(),
                ));
            }

            grouped
        }
        <span class="org-keyword">let</span> <span class="org-variable-name">by_ns</span> = group_by_namespace(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.words);
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("by namespace: {:?}", by_ns);</span>
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">cache</span> = <span class="org-type">Words</span>::fresh();
        <span class="org-keyword">let</span> <span class="org-variable-name">mcache</span> = cache.mutate();
        <span class="org-comment-delimiter">// </span><span class="org-comment">first all the non-namespaced core words that can be overridden</span>
        mcache.extend(by_ns.get(<span class="org-rust-ampersand">&amp;</span><span class="org-type">None</span>).cloned().unwrap_or_default());
        <span class="org-keyword">for</span> <span class="org-variable-name">module</span> <span class="org-keyword">in</span> <span class="org-keyword">self</span>.modules.iter() {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Adding {:?} to cache", module);</span>
            mcache.extend(by_ns.get(module).cloned().unwrap_or_default())
        }

        <span class="org-comment-delimiter">// </span><span class="org-comment">println!(</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">"Cache now selected {} words. modules: {:?}",</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">cache.len(),</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">by_ns.keys()</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">);</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("resolve: contains? {:?}", cache.get(&amp;"contains?".fit()));</span>
        <span class="org-keyword">self</span>.lingo = cache;
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("After resolve: {:?}", self);</span>
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Dict</span> {
    <span class="org-doc">/// Returns the difference between this dictionary and a "newer"</span>
    <span class="org-doc">/// one: The additions/updates, and the deletions.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">diff</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">newer</span>: <span class="org-type">Words</span>) -&gt; (<span class="org-type">Vec</span>&lt;(<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt;, <span class="org-type">Vec</span>&lt;<span class="org-type">Word</span>&gt;);

    <span class="org-doc">/// Takes a core module (in string form - should contain a series</span>
    <span class="org-doc">/// of word definitions, not wrapped in a single list), and</span>
    <span class="org-doc">/// inserts all the definitions into the dictionary, with an</span>
    <span class="org-doc">/// optional namespace.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">insert_core_module</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">lexicon</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;;

    <span class="org-doc">/// For stdlib words that are both built-in and part of a module</span>
    <span class="org-doc">/// that isn't necessarily loaded as part of the standard</span>
    <span class="org-doc">/// environment, we need to be able to link the word to its rust</span>
    <span class="org-doc">/// definition. Leaves other fields as None to be filled in later.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">builtins</span>() -&gt; <span class="org-type">Self</span>;

    <span class="org-doc">/// Merges this dictionary with the given new dictionary. The new</span>
    <span class="org-doc">/// words are added with the given namespace.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">merge</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">new</span>: <span class="org-type">Words</span>, <span class="org-variable-name">namespace</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Namespace</span>);
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = (<span class="org-type">Word</span>, <span class="org-type">Entry</span>);
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">k</span>) = <span class="org-keyword">self</span>.keys().next().cloned() {
            <span class="org-keyword">let</span> <span class="org-variable-name">dm</span> = <span class="org-keyword">self</span>.mutate();
            <span class="org-keyword">let</span> <span class="org-variable-name">v</span> = dm.remove(k).unwrap();
            <span class="org-type">Some</span>((k.clone(), v))
        } <span class="org-keyword">else</span> {
            <span class="org-type">None</span>
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Dict</span> <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">diff</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">newer</span>: <span class="org-type">Words</span>) -&gt; (<span class="org-type">Vec</span>&lt;(<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt;, <span class="org-type">Vec</span>&lt;<span class="org-type">Word</span>&gt;) {
        diff_hashmaps(<span class="org-keyword">self</span>, <span class="org-rust-ampersand">&amp;</span>newer)
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">merge</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">new</span>: <span class="org-type">Words</span>, <span class="org-variable-name">namespace</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Namespace</span>) {
        <span class="org-keyword">let</span> (adds, deletes) = <span class="org-keyword">self</span>.diff(new);
        <span class="org-comment-delimiter">// </span><span class="org-comment">add namepaces to the adds and deletes</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Merge {} adds, {} deletes", adds.len(), deletes.len());</span>

        <span class="org-keyword">let</span> <span class="org-variable-name">adds</span>: <span class="org-type">Vec</span>&lt;_&gt; = adds
            .into_iter()
            .map(|(<span class="org-keyword">mut</span> w, <span class="org-keyword">mut</span> e)| {
                w.namespace = *namespace;
                e.namespace = *namespace;
                <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Adding {:?}", w);</span>
                (w, e)
            })
            .collect();
        <span class="org-keyword">let</span> <span class="org-variable-name">deletes</span>: <span class="org-type">Vec</span>&lt;_&gt; = deletes
            .into_iter()
            .map(|<span class="org-keyword">mut</span> w| {
                w.namespace = *namespace;
                w
            })
            .collect();
        <span class="org-keyword">let</span> <span class="org-variable-name">d</span> = <span class="org-keyword">self</span>.mutate();

        d.extend(adds);
        d.extend(make_deletes(deletes));

        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Contains: {:?}", d.get(&amp;"contains?".fit()))</span>
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">insert_core_module</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">lexicon</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Parsing: {}", lexicon);</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">core</span> = <span class="org-type">CORE</span>.get().unwrap();
        <span class="org-keyword">let</span> <span class="org-variable-name">items</span> = <span class="org-constant">serialize</span>::parse(lexicon)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">for</span> <span class="org-variable-name">r</span> <span class="org-keyword">in</span> <span class="org-type">Box</span>::new(items.iter().cloned()) {
            <span class="org-keyword">let</span> (k, def): (<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>) = r.try_fit().unwrap();
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">word</span>: <span class="org-type">Word</span> = k.try_fit().unwrap();
            word.namespace = core.clone();
            <span class="org-keyword">let</span> <span class="org-variable-name">iter</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt; = def.try_fit().unwrap();
            <span class="org-keyword">let</span> <span class="org-variable-name">new_entry</span>: <span class="org-type">Entry</span> = iter.try_fit().unwrap();
            <span class="org-keyword">let</span> <span class="org-variable-name">new_entry2</span> = new_entry.clone();
            <span class="org-keyword">let</span> <span class="org-variable-name">dict</span> = <span class="org-keyword">self</span>.mutate();
            dict.entry(word)
                .and_modify(|e| {
                    e.examples = new_entry.examples;
                    e.spec = new_entry.spec;
                    e.doc = new_entry.doc;
                    e.namespace = core.clone();
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Don't overwrite the definition, this should be</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">an axiom word where we've left the</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">spec/examples temporarily blank and we're</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">filling them in now that we've read the</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">lexicon. The definition is the builtin and we</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">want to keep that.</span>
                    <span class="org-comment-delimiter">//</span><span class="org-comment">e.definition = new_entry.definition;</span>
                })
                .or_insert(new_entry2);
        }
        <span class="org-type">Ok</span>(())
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">builtins</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">core</span> = <span class="org-type">CORE</span>.get_or_init(|| <span class="org-type">Some</span>(<span class="org-type">Intern</span>::new(<span class="org-preprocessor">vec!</span>[114, 138, 222]))); <span class="org-comment-delimiter">// </span><span class="org-comment">base64 encodes to "core"</span>
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">dict</span> = <span class="org-type">HashMap</span>::new();
        <span class="org-keyword">for</span> (bw, bd) <span class="org-keyword">in</span> <span class="org-type">BUILTIN_FUNCTIONS</span>.iter() {
            <span class="org-keyword">let</span> <span class="org-variable-name">entry</span> = <span class="org-type">Entry</span> {
                <span class="org-variable-name">definition</span>: bd.clone(),
                <span class="org-variable-name">examples</span>: <span class="org-type">None</span>,
                <span class="org-variable-name">spec</span>: <span class="org-type">None</span>,
                <span class="org-variable-name">namespace</span>: <span class="org-type">None</span>,
                <span class="org-variable-name">doc</span>: <span class="org-type">None</span>,
            };
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">bw</span> = bw.clone();
            bw.namespace = core.clone();
            dict.insert(<span class="org-type">Word</span>::derive(bw.clone()), entry);
        }
        <span class="org-type">Arc</span>::new(dict)
    }
}

<span class="org-doc">/// Each word should run a program that calls fail (already namespaced</span>
<span class="org-doc">/// to the stdlib so that the word acts like it isn't in the dictionary</span>
<span class="org-doc">/// even though it is.)</span>
<span class="org-keyword">fn</span> <span class="org-function-name">make_deletes</span>(<span class="org-variable-name">words</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">Word</span>&gt;) -&gt; <span class="org-type">Vec</span>&lt;(<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt; {
    words
        .into_iter()
        .map(|word| {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Shadowing word: {:?}", word);</span>
            <span class="org-keyword">let</span> <span class="org-variable-name">err</span> = <span class="org-type">Error</span>::create(
                <span class="org-preprocessor">list!</span>(<span class="org-constant">types</span>::<span class="org-type">Word</span>::derive(word.clone())),
                <span class="org-string">"word removed by module"</span>,
                <span class="org-type">Some</span>(<span class="org-string">"access-denied"</span>),
            );
            <span class="org-keyword">let</span> <span class="org-variable-name">entry</span> = <span class="org-type">Entry</span> {
                <span class="org-variable-name">examples</span>: <span class="org-type">None</span>,
                <span class="org-variable-name">spec</span>: <span class="org-type">None</span>,
                <span class="org-variable-name">definition</span>: <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(<span class="org-preprocessor">list!</span>(err, <span class="org-string">"fail"</span>)),
                <span class="org-variable-name">namespace</span>: word.namespace.clone(),
                <span class="org-variable-name">doc</span>: <span class="org-type">None</span>,
            };
            (word, entry)
        })
        .collect()
}

<span class="org-doc">/// Returns an owned pair given a pair of references</span>
<span class="org-keyword">fn</span> <span class="org-function-name">owned</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Clone</span>, <span class="org-variable-name">U</span>: <span class="org-type">Clone</span>&gt;(<span class="org-variable-name">entry</span>: (<span class="org-rust-ampersand">&amp;</span><span class="org-type">T</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-type">U</span>)) -&gt; (<span class="org-type">T</span>, <span class="org-type">U</span>) {
    (entry.0.clone(), entry.1.clone())
}

<span class="org-doc">/// Returns the differences between two hashmaps, including the keys</span>
<span class="org-doc">/// that have been added or changed (including the new values), and</span>
<span class="org-doc">/// the keys that were deleted.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">diff_hashmaps</span>&lt;<span class="org-type">K</span>, <span class="org-type">V</span>&gt;(<span class="org-variable-name">a</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">HashMap</span>&lt;<span class="org-type">K</span>, <span class="org-type">V</span>&gt;, <span class="org-variable-name">b</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">HashMap</span>&lt;<span class="org-type">K</span>, <span class="org-type">V</span>&gt;) -&gt; (<span class="org-type">Vec</span>&lt;(<span class="org-type">K</span>, <span class="org-type">V</span>)&gt;, <span class="org-type">Vec</span>&lt;<span class="org-type">K</span>&gt;)
<span class="org-keyword">where</span>
    <span class="org-variable-name">K</span>: <span class="org-type">Eq</span> + <span class="org-type">Hash</span> + <span class="org-type">Clone</span>,
    <span class="org-variable-name">V</span>: <span class="org-type">PartialEq</span> + <span class="org-type">Clone</span>,
{
    <span class="org-keyword">let</span> <span class="org-variable-name">a_keys</span>: <span class="org-type">HashSet</span>&lt;<span class="org-type">K</span>&gt; = a.keys().cloned().collect();
    <span class="org-keyword">let</span> <span class="org-variable-name">b_keys</span>: <span class="org-type">HashSet</span>&lt;<span class="org-type">K</span>&gt; = b.keys().cloned().collect();

    <span class="org-comment-delimiter">// </span><span class="org-comment">Keys that are in `b` but not in `a` or have updated values in `b`</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">added_or_updated</span>: <span class="org-type">Vec</span>&lt;(<span class="org-type">K</span>, <span class="org-type">V</span>)&gt; = b
        .iter()
        .filter(|(k, v)| !a_keys.contains(k) || a.get(k) != <span class="org-type">Some</span>(v))
        .map(owned)
        .collect();

    <span class="org-comment-delimiter">// </span><span class="org-comment">Keys that are in `a` but not in `b`</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">deleted</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">K</span>&gt; = a_keys.difference(<span class="org-rust-ampersand">&amp;</span>b_keys).cloned().collect();

    (added_or_updated, deleted)
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-type">Words</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Words</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Words</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">sm</span> = <span class="org-keyword">self</span>.mutate();
        sm.extend(other.iter().map(owned));
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-type">Dictionary</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-type">Dictionary</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-type">Self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.words = <span class="org-keyword">self</span>.words.join(other.words)<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(<span class="org-keyword">self</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">Association</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-constant">assoc</span>::<span class="org-type">Association</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Try to convert to dictionary type</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("dict + assoc join");</span>
        <span class="org-keyword">match</span> other.convert::&lt;<span class="org-type">Word</span>, <span class="org-type">Entry</span>&gt;() {
            <span class="org-type">Ok</span>(d) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">tm</span> = <span class="org-keyword">self</span>.mutate();
                tm.extend(d);
                <span class="org-type">Ok</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">self</span>))
            }
            <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: convert the other way (to assoc) instead</span>
            <span class="org-type">Err</span>(_) =&gt; {
                <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Conversion error: {:?}", e);</span>
                <span class="org-type">Ok</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(<span class="org-keyword">self</span>))
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">coll</span>::<span class="org-type">Join</span>&lt;<span class="org-type">Words</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">assoc</span>::<span class="org-type">Association</span> {
    <span class="org-keyword">type</span> <span class="org-type">Output</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>;
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Infallible</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-keyword">self</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">other</span>: <span class="org-type">Words</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Output</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Try to convert to dictionary type</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("assoc + dict join");</span>
        <span class="org-type">Ok</span>(<span class="org-keyword">match</span> <span class="org-keyword">self</span>.convert::&lt;<span class="org-type">Word</span>, <span class="org-type">Entry</span>&gt;() {
            <span class="org-type">Ok</span>(d) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">tm</span> = other.mutate();
                tm.extend(d.iter().map(owned));
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(other)
            }
            <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: convert the other way (to assoc) instead</span>
            <span class="org-type">Err</span>(_) =&gt; <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(other),
        })
    }
}

<span class="org-doc">/// The actual code for what a [Word] should do.</span>
<span class="org-preprocessor">#[derive(Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Executable</span> {
    <span class="org-doc">/// A definition in the base language - a rust function that</span>
    <span class="org-doc">/// modifies the environment.</span>
    <span class="org-type">Axiom</span>(<span class="org-rust-ampersand">&amp;</span>'<span class="org-keyword">static</span> <span class="org-constant">axiom</span>::<span class="org-type">Builtin</span>),
    <span class="org-doc">/// A definition in terms of other [Word]s - a kcats program</span>
    <span class="org-type">Derived</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>),
}

<span class="org-comment-delimiter">// </span><span class="org-comment">dictionary words are equal if they have the same function reference,</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">no need to compare the function values</span>
<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Executable</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(s), <span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(o)) =&gt; <span class="org-constant">ptr</span>::eq(*s, *o),
            (<span class="org-type">Executable</span>::<span class="org-type">Derived</span>(s), <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(o)) =&gt; s == o,
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Executable</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(a) =&gt; f.write_str(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"builtin_</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, a.name).as_str()),
            <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(d) =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">ds</span> = f.debug_list();
                ds.entries(d.iter());
                ds.finish()
            }
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoIterator</span> <span class="org-keyword">for</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">into_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt; = <span class="org-preprocessor">vec!</span>[(<span class="org-string">"definition"</span>.fit(), {
            <span class="org-keyword">match</span> <span class="org-keyword">self</span>.definition {
                <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(l) =&gt; l.fit(),
                <span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(a) =&gt; a.clone().fit(),
            }
        })];
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(e) = <span class="org-keyword">self</span>.examples {
            v.push((<span class="org-string">"examples"</span>.fit(), e.fit()));
        }
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(s) = <span class="org-keyword">self</span>.spec {
            v.push((<span class="org-string">"spec"</span>.fit(), s.fit()))
        }
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(d) = <span class="org-keyword">self</span>.doc {
            v.push((<span class="org-string">"doc"</span>.fit(), d.fit()))
        }
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(n) = <span class="org-keyword">self</span>.namespace {
            v.push((<span class="org-string">"namespace"</span>.fit(), n.as_ref().clone().fit()))
        }
        <span class="org-type">Box</span>::new(v.into_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoIterator</span> <span class="org-keyword">for</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">into_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt; = <span class="org-preprocessor">vec!</span>[
            (<span class="org-string">"words"</span>.fit(), <span class="org-keyword">self</span>.words.fit()),
            (<span class="org-string">"modules"</span>.fit(), <span class="org-keyword">self</span>.modules.fit()),
            (<span class="org-string">"lingo"</span>.fit(), <span class="org-keyword">self</span>.lingo.fit()),
        ];
        <span class="org-type">Box</span>::new(v.into_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">iter</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">examples</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">definition</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Executable</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">spec</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Spec</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">namespace</span>: <span class="org-type">Namespace</span> = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">doc</span>: <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">for</span> <span class="org-variable-name">i</span> <span class="org-keyword">in</span> iter {
            <span class="org-keyword">let</span> (k, v): (<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>) = i.try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("k: {:?}, v: {:?}", k, v);</span>
            <span class="org-keyword">if</span> k == <span class="org-string">"examples"</span>.fit() {
                examples = <span class="org-type">Some</span>(v.try_fit()<span class="org-rust-question-mark">?</span>);
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"definition"</span>.fit() {
                definition = <span class="org-type">Some</span>(v.try_fit()<span class="org-rust-question-mark">?</span>);
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"spec"</span>.fit() {
                spec = v.try_fit().ok();
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"namespace"</span>.fit() {
                namespace = v.try_fit().unwrap_or_default();
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"doc"</span>.fit() {
                doc = v.try_fit().ok();
            } <span class="org-keyword">else</span> {
                <span class="org-keyword">continue</span>;
            }
        }
        <span class="org-type">Ok</span>(<span class="org-type">Entry</span> {
            examples,
            <span class="org-variable-name">definition</span>: definition.unwrap_or(<span class="org-type">Executable</span>::<span class="org-type">Derived</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::default())),
            spec,
            namespace,
            doc,
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">iter</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        iter.map(&lt;(<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt;::try_derive)
            .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">HashMap</span>&lt;<span class="org-type">Word</span>, <span class="org-type">Entry</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()
            .map(<span class="org-type">Arc</span>::new)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">iter</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">words</span> = <span class="org-type">Words</span>::default();
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">lingo</span> = <span class="org-type">Words</span>::default();
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">modules</span> = <span class="org-type">Vec</span>::&lt;<span class="org-type">Namespace</span>&gt;::default();

        <span class="org-keyword">for</span> <span class="org-variable-name">i</span> <span class="org-keyword">in</span> iter {
            <span class="org-keyword">let</span> (k, v): (<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>) = i.try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("k: {:?}, v: {:?}", k, v);</span>
            <span class="org-keyword">if</span> k == <span class="org-string">"words"</span>.fit() {
                words = v.try_fit()<span class="org-rust-question-mark">?</span>;
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"modules"</span>.fit() {
                modules = v.try_fit()<span class="org-rust-question-mark">?</span>;
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"lingo"</span>.fit() {
                lingo = v.try_fit()<span class="org-rust-question-mark">?</span>;
            } <span class="org-keyword">else</span> {
                <span class="org-keyword">continue</span>;
            }
        }
        <span class="org-type">Ok</span>(<span class="org-type">Dictionary</span> {
            words,
            modules,
            lingo,
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Executable</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i).map(<span class="org-type">Executable</span>::<span class="org-type">Derived</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Entry</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(d)) =&gt; <span class="org-type">Ok</span>(d),
            c =&gt; c.into_iter().try_fit(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Entry</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">assoc</span>::<span class="org-type">Associative</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">d</span>: <span class="org-type">Entry</span>) -&gt; <span class="org-constant">assoc</span>::<span class="org-type">Associative</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">assoc</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::fresh();
        <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = assoc.mutate();
        d.examples.and_then(|l| a.insert(<span class="org-string">"examples"</span>.fit(), l.fit()));
        d.spec.and_then(|l| a.insert(<span class="org-string">"spec"</span>.fit(), l.fit()));
        d.doc.and_then(|l| a.insert(<span class="org-string">"doc"</span>.fit(), l.fit()));
        d.namespace
            .and_then(|l| a.insert(<span class="org-string">"namespace"</span>.fit(), l.as_ref().clone().fit()));
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Executable</span>::<span class="org-type">Derived</span>(d) = d.definition {
            a.insert(<span class="org-string">"definition"</span>.fit(), d.fit());
        }

        <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(assoc)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Words</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(d)) =&gt; <span class="org-type">Ok</span>(d),
            c =&gt; c.into_iter().try_fit(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Dictionary</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d) =&gt; <span class="org-type">Ok</span>(d),
            <span class="org-comment-delimiter">//</span><span class="org-comment">assoc::Associative::Assoc(a) =&gt; a.into_iter().try_fit(),</span>
            a =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"dictionary"</span>, a)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Entry</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">e</span>: <span class="org-type">Entry</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">DictEntry</span>(e),
        )))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Words</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">e</span>: <span class="org-type">Words</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(e),
        )))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Dictionary</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">d</span>: <span class="org-type">Dictionary</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(d),
        )))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;(<span class="org-type">Word</span>, <span class="org-type">Entry</span>)&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>((k, v): (<span class="org-type">Word</span>, <span class="org-type">Entry</span>)) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter([<span class="org-type">Item</span>::<span class="org-type">Word</span>(k.fit()), <span class="org-type">Item</span>::derive(v.clone())]).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> (<span class="org-type">Word</span>, <span class="org-type">Entry</span>) {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">if</span> s.count() != 2 {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"pair"</span>, s))
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">iter</span> = s.into_iter();
            <span class="org-keyword">let</span> <span class="org-variable-name">key</span>: <span class="org-constant">types</span>::<span class="org-type">Word</span> = iter.next().unwrap().try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-variable-name">value</span>: <span class="org-type">Entry</span> = iter.next().unwrap().try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>((key.fit(), value))
        }
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org13398d0" class="outline-5">
<h5 id="org13398d0"><span class="section-number-5">1.5.3.7.</span> Environment types</h5>
<div class="outline-text-5" id="text-1-5-3-7">
<div class='tangle-wrapper' data-tangle='src/types/container/environment.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Functionality of a kcats execution environment.</span>
<span class="org-keyword">use</span> <span class="org-keyword">super</span>::{associative <span class="org-keyword">as</span> assoc, dictionary <span class="org-keyword">as</span> dict};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::serialize;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">dictionary</span>::<span class="org-type">Dict</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, <span class="org-type">Mutey</span>, <span class="org-type">Ordered</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Number</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;

<span class="org-keyword">use</span> <span class="org-constant">once_cell</span>::<span class="org-constant">sync</span>::<span class="org-type">Lazy</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::future;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">ops</span>::<span class="org-type">Range</span>;

<span class="org-doc">/// A struct to hold the state of an executing kcats program. The</span>
<span class="org-doc">/// `stack` is the data being manipulated, the `program` is program</span>
<span class="org-doc">/// remaining to be executed, and the `dictionary` is the set of</span>
<span class="org-doc">/// functions available to the program.</span>
<span class="org-preprocessor">#[derive(Clone, PartialEq)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">stack</span>: <span class="org-type">Stack</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">program</span>: <span class="org-type">Stack</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">dictionary</span>: <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">Environment</span> {
    <span class="org-doc">/// Push the [Item] onto the top of the stack.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">push</span>&lt;<span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">T</span>) {
        <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>.stack).push_front(i.fit());
    }

    <span class="org-doc">/// Pop the top [Item] from the stack, panicking if the stack is</span>
    <span class="org-doc">/// empty.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">pop</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>.stack).pop_front().unwrap()
    }

    <span class="org-doc">/// Pushes one item onto the front of the program (so that it</span>
    <span class="org-doc">/// executes first).</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">push_prog</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) {
        <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>.program).push_front(i);
    }

    <span class="org-doc">/// Pops an [Item] from the front of the program.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">pop_prog</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">coll</span>::<span class="org-type">Arc</span>::mutate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>.program).pop_front().unwrap()
    }

    <span class="org-doc">/// Returns a reference to the top stack [Item], or [None] if it's</span>
    <span class="org-doc">/// empty.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">tos</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>&gt; {
        <span class="org-keyword">self</span>.stack.front()
    }

    <span class="org-doc">/// Returns the length of this struct (as an associative</span>
    <span class="org-doc">/// structure), which is constant.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">len</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">usize</span> {
        3 <span class="org-comment-delimiter">// </span><span class="org-comment">3 fields</span>
    }

    <span class="org-doc">/// Treats the [Environment] as an associative structure,</span>
    <span class="org-doc">/// returning one of its fields, or [None].</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">match</span> key {
            <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-keyword">match</span> w.data.as_str() {
                <span class="org-string">"stack"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.stack.clone().fit()),
                <span class="org-string">"program"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.program.clone().fit()),
                <span class="org-string">"dictionary"</span> =&gt; <span class="org-type">Some</span>(<span class="org-keyword">self</span>.dictionary.clone().fit()),
                _ =&gt; <span class="org-type">None</span>,
            },
            _ =&gt; <span class="org-type">None</span>,
        }
    }

    <span class="org-doc">/// Returns true if the [Environment] contains the given key,</span>
    <span class="org-doc">/// which is only true for its fixed fields.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">contains_key</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-type">Word</span>::try_derive(key.clone()).map_or(<span class="org-keyword">false</span>, |<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>| {
            <span class="org-preprocessor">matches!</span>(w.fit(), <span class="org-string">"stack"</span> | <span class="org-string">"program"</span> | <span class="org-string">"dictionary"</span>)
        })
    }

    <span class="org-doc">/// Inserts the key/value into the [Environment]. If the key is</span>
    <span class="org-doc">/// not one of its fixed fields, return a demoted</span>
    <span class="org-doc">/// [assoc::Associative] value that's more generic and supports</span>
    <span class="org-doc">/// any key. Also optionally return any old value that might get</span>
    <span class="org-doc">/// overwritten.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">insert</span>(<span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">k</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-variable-name">v</span>: <span class="org-type">Item</span>) -&gt; (<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>, <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;) {
        <span class="org-keyword">let</span> <span class="org-variable-name">demote</span> = |<span class="org-variable-name">o</span>: <span class="org-type">Environment</span>, <span class="org-variable-name">k</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-variable-name">v</span>: <span class="org-type">Item</span>| {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Demotion!!! {:?}", o);</span>
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter(o);
            <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = a.mutate();
            <span class="org-keyword">let</span> <span class="org-variable-name">old</span> = am.insert(k, v);
            (<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(a), old)
        };
        <span class="org-keyword">match</span> k {
            <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Word</span>(<span class="org-keyword">ref</span> <span class="org-variable-name">w</span>) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">w</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span> = w.fit();
                <span class="org-keyword">match</span> w {
                    <span class="org-string">"stack"</span> =&gt; {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(v.clone());
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(l) =&gt; {
                                <span class="org-keyword">let</span> <span class="org-variable-name">old</span> = <span class="org-keyword">self</span>.stack.clone();
                                <span class="org-keyword">self</span>.stack = l;
                                (<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(<span class="org-keyword">self</span>), <span class="org-type">Some</span>(old.fit()))
                            }
                            <span class="org-type">Err</span>(_) =&gt; demote(<span class="org-keyword">self</span>, k, v),
                        }
                    }
                    <span class="org-string">"program"</span> =&gt; {
                        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(v.clone());
                        <span class="org-keyword">match</span> l {
                            <span class="org-type">Ok</span>(l) =&gt; {
                                <span class="org-keyword">let</span> <span class="org-variable-name">old</span> = <span class="org-keyword">self</span>.program.clone();
                                <span class="org-keyword">self</span>.program = l;
                                (<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(<span class="org-keyword">self</span>), <span class="org-type">Some</span>(old.fit()))
                            }
                            <span class="org-type">Err</span>(_) =&gt; demote(<span class="org-keyword">self</span>, k, v),
                        }
                    }
                    <span class="org-string">"dictionary"</span> =&gt; {
                        <span class="org-keyword">let</span> <span class="org-variable-name">d</span> = <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>::try_derive(v.clone());
                        <span class="org-keyword">match</span> d {
                            <span class="org-type">Ok</span>(d) =&gt; {
                                <span class="org-keyword">let</span> <span class="org-variable-name">old</span> = <span class="org-keyword">self</span>.dictionary.clone();
                                <span class="org-keyword">self</span>.dictionary = d;
                                (<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(<span class="org-keyword">self</span>), <span class="org-type">Some</span>(old.fit()))
                            }
                            <span class="org-type">Err</span>(_) =&gt; demote(<span class="org-keyword">self</span>, k, v),
                        }
                    }

                    k =&gt; demote(<span class="org-keyword">self</span>, k.fit(), v),
                }
            }
            _ =&gt; demote(<span class="org-keyword">self</span>, k, v),
        }
    }

    <span class="org-doc">/// Reads a stdlib module and updates the dictionary.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">load_builtin_module</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">module_alias</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.push(module_alias);
        <span class="org-constant">axiom</span>::read_blob(<span class="org-keyword">self</span>)
    }

    <span class="org-doc">/// Loads the core modules as part of preparing a standard</span>
    <span class="org-doc">/// environment.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">load_core_modules</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Assuming /project/core/ is in your project's root directory and part of the source</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">files</span>: <span class="org-type">Vec</span>&lt;<span class="org-rust-ampersand">&amp;</span>[<span class="org-type">u8</span>]&gt; = <span class="org-preprocessor">vec!</span>[
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/stack-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/motion-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/compare-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/math-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/boolean-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/serialize-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/encode-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/strings-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/errors-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/pipes-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/stack.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/motion.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/collections-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/execute-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/execute.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/dictionary-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/math.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/compare.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/collections.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/associations-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/associations.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/dictionary.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/environment-builtins.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/environment.kcats"</span>),
            <span class="org-preprocessor">include_bytes!</span>(<span class="org-string">"../../kcats/core/sets-builtins.kcats"</span>),
        ];

        <span class="org-keyword">for</span> <span class="org-rust-ampersand">&amp;</span>file_contents <span class="org-keyword">in</span> <span class="org-rust-ampersand">&amp;</span>files {
            <span class="org-keyword">let</span> <span class="org-variable-name">lexicon</span> = <span class="org-type">String</span>::from_utf8_lossy(file_contents).into_owned();
            <span class="org-keyword">match</span> <span class="org-keyword">self</span>.dictionary.words.insert_core_module(lexicon.clone()) {
                <span class="org-type">Ok</span>(_) =&gt; {}
                <span class="org-type">Err</span>(<span class="org-keyword">mut</span> e) =&gt; {
                    e.push(<span class="org-string">"content"</span>.fit(), lexicon.fit());
                    <span class="org-keyword">return</span> <span class="org-type">Err</span>(e);
                }
            }
        }
        <span class="org-type">Ok</span>(())
    }

    <span class="org-doc">/// Returns an error if the stack isn't at least `min_depth` deep.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">check_stack_depth</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">min_depth</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Checking stack has at least {} items", min_depth);</span>
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.stack.len() &lt; min_depth {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::stack_underflow())
        } <span class="org-keyword">else</span> {
            <span class="org-type">Ok</span>(())
        }
    }

    <span class="org-doc">/// Returns an error if the stack doesn't match the given input spec.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">check_input_spec</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">specs</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">dict</span>::<span class="org-type">StackSpec</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.check_stack_depth(specs.len())<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">indexes</span> = <span class="org-type">Range</span> {
            <span class="org-variable-name">start</span>: 0,
            <span class="org-variable-name">end</span>: specs.len(),
        };

        indexes.into_iter().try_for_each(|i| {
            <span class="org-keyword">let</span> <span class="org-variable-name">item</span> = <span class="org-keyword">self</span>.stack.get(i).unwrap();
            <span class="org-keyword">let</span> <span class="org-variable-name">spec</span> = specs.get(i).unwrap();
            check_type(item, <span class="org-rust-ampersand">&amp;</span>spec.elemtype)
        })
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_finished</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">self</span>.program.is_empty()
    }
}

<span class="org-doc">/// A reducing function that loads modules one at a time. Takes an</span>
<span class="org-doc">/// existing env, loads the given module and returns the new env with</span>
<span class="org-doc">/// the dictionary that the module built on the stack.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">load_module</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>, <span class="org-variable-name">module</span>: <span class="org-rust-ampersand">&amp;&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">Environment</span> {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Loading module {}", *module);</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Cache: {:?}", env.dictionary.lingo);</span>
    env.push(<span class="org-type">Word</span>::derive(*module));
    env.program.prepend(<span class="org-preprocessor">list!</span>(
        <span class="org-string">"dictionary"</span>,
        <span class="org-string">"&#128256;"</span>,
        <span class="org-preprocessor">list!</span>(<span class="org-string">"decache"</span>, <span class="org-string">"string"</span>, <span class="org-string">"read"</span>, <span class="org-preprocessor">list!</span>(<span class="org-string">"words"</span>), <span class="org-string">"&#128256;"</span>, <span class="org-string">"update"</span>),
        <span class="org-string">"&#8226;&#128737;&#65039;"</span>,
        <span class="org-string">"&#9654;&#65039;"</span>,
        <span class="org-string">"&#8226;&#128465;&#65039;"</span>
    ));
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Dictionary: {:?}", env.dictionary);</span>
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">new_env</span> = <span class="org-constant">futures</span>::<span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { <span class="org-constant">axiom</span>::eval(env).<span class="org-keyword">await</span> });
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Env: {:?}", new_env);</span>
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">dict</span>: <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span> = new_env.pop().try_fit().unwrap();
    dict.resolve();
    new_env.dictionary = dict;
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("loaded module {}: {:?}", module, new_env.dictionary);</span>
    new_env
}

<span class="org-keyword">impl</span> <span class="org-type">Default</span> <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-doc">/// Returns the default environment, which is the "standard"</span>
    <span class="org-doc">/// environment. It loads some standard libraries and core</span>
    <span class="org-doc">/// functions. The environment is only built once and memoized.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">default</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">static</span> <span class="org-variable-name">INST</span>: <span class="org-type">Lazy</span>&lt;<span class="org-type">Environment</span>&gt; = <span class="org-type">Lazy</span>::new(|| {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Env::default");</span>
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env</span> = <span class="org-type">Environment</span> {
                <span class="org-variable-name">dictionary</span>: <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span> {
                    <span class="org-variable-name">words</span>: <span class="org-constant">dict</span>::<span class="org-type">Words</span>::builtins(),
                    <span class="org-variable-name">modules</span>: <span class="org-type">Default</span>::default(),
                    <span class="org-variable-name">lingo</span>: <span class="org-constant">dict</span>::<span class="org-type">Words</span>::fresh(),
                },
                <span class="org-variable-name">stack</span>: <span class="org-type">Default</span>::default(),
                <span class="org-variable-name">program</span>: <span class="org-type">Default</span>::default(),
            };

            env.load_core_modules()
                .expect(<span class="org-string">"failed to load core modules"</span>);
            <span class="org-comment-delimiter">// </span><span class="org-comment">add core module as default module</span>
            env.dictionary
                .modules
                .push(<span class="org-constant">dict</span>::<span class="org-type">CORE</span>.get().unwrap().clone());
            env.dictionary.resolve();
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Dict has {} words", env.dictionary.entries.len());</span>
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env</span> = [
                <span class="org-string">"errors"</span>,
                <span class="org-string">"encode"</span>,
                <span class="org-string">"time"</span>, <span class="org-comment-delimiter">// </span><span class="org-comment">good candidate for lib</span>
                <span class="org-string">"pipes"</span>,
                <span class="org-string">"methods"</span>,
                <span class="org-string">"generators"</span>,
                <span class="org-string">"debug"</span>,
                <span class="org-comment-delimiter">//</span><span class="org-comment">"more-generators",</span>
                <span class="org-comment-delimiter">//</span><span class="org-comment">"database",</span>
            ]
            .iter()
            .fold(env, load_module);
            <span class="org-comment-delimiter">// </span><span class="org-comment">println!(</span>
            <span class="org-comment-delimiter">//     </span><span class="org-comment">"After loading modules Dict has {} words",</span>
            <span class="org-comment-delimiter">//     </span><span class="org-comment">env.dictionary.entries.len()</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">);</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">need to do this again because we loaded some builtins</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">above, need to add the rust definitions back that got</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">overwritten.</span>
            env.dictionary.resolve();
            <span class="org-comment-delimiter">//</span><span class="org-comment">print!("Env: {:?}", env);</span>
            env
        });
        <span class="org-type">INST</span>.clone()
    }
}

<span class="org-doc">/// Returns an error if the [Item] is not of the type specified by</span>
<span class="org-doc">/// [Word] `w`. This allows specs to have their own little type</span>
<span class="org-doc">/// hierarchy, eg, `integer` is a `number`, `list` is a `sized` etc.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">check_type</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>, <span class="org-variable-name">w</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Word</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Check {:?} is {:?}", w, i);</span>
    <span class="org-keyword">match</span> (w, i) {
        (w, _) <span class="org-keyword">if</span> *w == *<span class="org-type">S_ITEM</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(_) | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(_)) <span class="org-keyword">if</span> *w == *<span class="org-type">S_DISPENSER</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(_) | <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(_)) <span class="org-keyword">if</span> *w == *<span class="org-type">S_RECEPTACLE</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(_))) <span class="org-keyword">if</span> *w == *<span class="org-type">S_INTEGER</span> || *w == *<span class="org-type">S_NUMBER</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(_))) <span class="org-keyword">if</span> *w == *<span class="org-type">S_FLOAT</span> || *w == *<span class="org-type">S_NUMBER</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Char</span>(_)) <span class="org-keyword">if</span> *w == *<span class="org-type">S_CHAR</span> =&gt; <span class="org-type">Ok</span>(()),
        <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: also handle cases where bytes/string is a list</span>
        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_BYTES</span> || *w == *<span class="org-type">S_ORDERED</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_STRING</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, <span class="org-type">Item</span>::<span class="org-type">Word</span>(_)) <span class="org-keyword">if</span> *w == *<span class="org-type">S_WORD</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(_)),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_PIPE</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(_))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_LIST</span> || *w == *<span class="org-type">S_PROGRAM</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(_))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_ASSOC</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(_),
            )))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(_),
            ))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_ERROR</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(_),
            )))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Dictionary</span>(_),
            ))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_DICTIONARY</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(_)),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_SIZED</span> || *w == *<span class="org-type">S_ORDERED</span> =&gt; <span class="org-type">Ok</span>(()),

        (
            w,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(_),
            )))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(_),
            ))),
        ) <span class="org-keyword">if</span> *w == *<span class="org-type">S_ENVIRONMENT</span> =&gt; <span class="org-type">Ok</span>(()),
        (w, i) =&gt; {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Type check failed! wanted {} got {:?}", w.data, i);</span>
            <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">?"</span>, w.data);
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(expected.as_str(), i.clone()))
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">iter</span>: <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">stack</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">program</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">dictionary</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>&gt; = <span class="org-type">None</span>;
        <span class="org-keyword">for</span> <span class="org-variable-name">i</span> <span class="org-keyword">in</span> iter {
            <span class="org-keyword">let</span> (k, v): (<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>) = i.try_fit()<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">if</span> k == <span class="org-string">"stack"</span>.fit() {
                stack = <span class="org-type">Some</span>(v.try_fit()<span class="org-rust-question-mark">?</span>)
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"program"</span>.fit() {
                program = <span class="org-type">Some</span>(v.try_fit()<span class="org-rust-question-mark">?</span>)
            } <span class="org-keyword">else</span> <span class="org-keyword">if</span> k == <span class="org-string">"dictionary"</span>.fit() {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">d</span> = <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>::try_derive(v)<span class="org-rust-question-mark">?</span>;
                d.resolve();
                dictionary = <span class="org-type">Some</span>(d);
            } <span class="org-keyword">else</span> {
                <span class="org-keyword">continue</span>;
            }
        }

        <span class="org-keyword">let</span> <span class="org-variable-name">env</span> = <span class="org-type">Environment</span> {
            <span class="org-variable-name">stack</span>: stack.unwrap_or_default(),
            <span class="org-variable-name">program</span>: program.unwrap_or_default(),
            <span class="org-variable-name">dictionary</span>: dictionary.unwrap_or_else(|| <span class="org-type">Environment</span>::default().dictionary),
        };
        <span class="org-type">Ok</span>(env)
    }
}
<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Convert to env: {:?}", i);</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;

        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(e)) =&gt; <span class="org-type">Ok</span>(e),
            l =&gt; l.into_iter().try_fit(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Environment</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(env).fit()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Environment</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
        <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(env))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">IntoIterator</span> <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>;
    <span class="org-keyword">type</span> <span class="org-type">IntoIter</span> = <span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-constant">assoc</span>::<span class="org-type">Entry</span>&gt;&gt;;

    <span class="org-keyword">fn</span> <span class="org-function-name">into_iter</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span>::<span class="org-type">IntoIter</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">v</span>: <span class="org-type">Vec</span>&lt;(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt; = <span class="org-preprocessor">vec!</span>[
            (<span class="org-string">"stack"</span>.fit(), <span class="org-keyword">self</span>.stack.fit()),
            (<span class="org-string">"program"</span>.fit(), <span class="org-keyword">self</span>.program.fit()),
            (<span class="org-string">"dictionary"</span>.fit(), <span class="org-keyword">self</span>.dictionary.fit()),
        ];
        <span class="org-type">Box</span>::new(v.into_iter())
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">assoc</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter(<span class="org-keyword">self</span>.clone());
        <span class="org-comment-delimiter">//</span><span class="org-comment">let am = assoc.mutate();</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">am.remove(&amp;("dictionary".fit()));</span>
        assoc.fit()
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orgf4eeb2c" class="outline-5">
<h5 id="orgf4eeb2c"><span class="section-number-5">1.5.3.8.</span> Hash-based object cache</h5>
<div class="outline-text-5" id="text-1-5-3-8">
<p>
We will need to be able to fetch binary data via its hash, or a local
name. This will supplement the database, by storing larger objects
directly in the filesystem, which is more efficient. But it can also
be used by the kcats module system even if the optional database
feature is disabled. When the database is enabled, hashes or local
aliases can be stored in the db as values and then once those are
retrieved, the actual contents can be retrieved via the
cache. Currently there is no disk space management, so the cache grows
unbounded. 
</p>

<p>
We also want to pre-populate some cache items at build time
(some of the standard libraries), so we make the cache a separate
crate so we can use it at both build time and runtime.
</p>

<div class='tangle-wrapper' data-tangle='cache/Cargo.toml'><div class="org-src-container">
<pre class="src src-toml">[<span class="org-type">package</span>]
<span class="org-variable-name">name</span> = <span class="org-string">"cache"</span>
<span class="org-variable-name">version</span> = <span class="org-string">"0.1.0"</span>
<span class="org-variable-name">edition</span> = <span class="org-string">"2021"</span>

[<span class="org-type">dependencies</span>]
<span class="org-variable-name">base64</span> = <span class="org-string">"0.13.0"</span>
<span class="org-variable-name">sha2</span> = {version=<span class="org-string">"0.10.6"</span>, features=[<span class="org-string">"std"</span>]}
<span class="org-variable-name">directories</span> = <span class="org-string">"5.0"</span>
<span class="org-variable-name">rand_core.workspace</span> = <span class="org-keyword">true</span>
<span class="org-variable-name">rand.workspace</span> = <span class="org-keyword">true</span>

[<span class="org-type">dependencies.uuid</span>]
<span class="org-variable-name">version</span> = <span class="org-string">"1.6.1"</span>
<span class="org-variable-name">features</span> = [
    <span class="org-string">"v4"</span>,                <span class="org-comment-delimiter"># </span><span class="org-comment">Lets you generate random UUIDs</span>
    <span class="org-string">"v7"</span>,
    <span class="org-string">"fast-rng"</span>,          <span class="org-comment-delimiter"># </span><span class="org-comment">Use a faster (but still sufficiently random) RNG</span>
]
</pre>
</div></div>

<div class='tangle-wrapper' data-tangle='cache/src/lib.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">cache</span> {
    <span class="org-keyword">use</span> <span class="org-constant">base64</span>::<span class="org-type">URL_SAFE_NO_PAD</span>;
    <span class="org-keyword">use</span> <span class="org-constant">io</span>::<span class="org-type">Error</span>;
    <span class="org-keyword">use</span> <span class="org-constant">sha2</span>::<span class="org-type">Sha256</span>;
    <span class="org-keyword">use</span> <span class="org-constant">sha2</span>::{<span class="org-keyword">self</span>, <span class="org-type">Digest</span>};
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">fs</span>::{<span class="org-keyword">self</span>, <span class="org-type">File</span>};
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">io</span>::{<span class="org-keyword">self</span>, <span class="org-type">Read</span>, <span class="org-type">Write</span>};
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">io</span>::{<span class="org-type">BufReader</span>, <span class="org-type">BufWriter</span>};
    <span class="org-preprocessor">#[cfg(windows)]</span>
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">os</span>::<span class="org-constant">windows</span>::<span class="org-constant">fs</span>::{symlink_dir, symlink_file}; <span class="org-comment-delimiter">// </span><span class="org-comment">For Windows</span>
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">path</span>::{<span class="org-type">Path</span>, <span class="org-type">PathBuf</span>};
    <span class="org-keyword">use</span> <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>;

    <span class="org-keyword">type</span> <span class="org-type">Bytes</span> = <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;;

    <span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Key</span> {
        <span class="org-type">Hash</span>(<span class="org-type">Bytes</span>),
        <span class="org-type">Alias</span>(<span class="org-type">String</span>),
    }

    <span class="org-preprocessor">#[derive(Clone, PartialEq, Debug)]</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Cache</span> {
        <span class="org-variable-name">path</span>: <span class="org-type">PathBuf</span>,
    }

    <span class="org-keyword">impl</span> <span class="org-type">Cache</span> {
        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">new</span>(<span class="org-variable-name">path</span>: <span class="org-type">PathBuf</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Error</span>&gt; {
            <span class="org-keyword">if</span> path.exists() &amp;&amp; path.is_dir() {
                <span class="org-constant">fs</span>::create_dir_all(<span class="org-rust-ampersand">&amp;</span>path)<span class="org-rust-question-mark">?</span>;
                <span class="org-type">Ok</span>(<span class="org-type">Cache</span> { <span class="org-variable-name">path</span>: path })
            } <span class="org-keyword">else</span> {
                <span class="org-type">Err</span>(<span class="org-type">Error</span>::new(<span class="org-constant">io</span>::<span class="org-type">ErrorKind</span>::<span class="org-type">NotFound</span>, <span class="org-string">"Cache dir not found"</span>))
            }
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">path</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Key</span>) -&gt; <span class="org-type">PathBuf</span> {
            <span class="org-comment-delimiter">// </span><span class="org-comment">Look up the file</span>

            <span class="org-keyword">let</span> <span class="org-variable-name">filename</span> = <span class="org-keyword">match</span> key {
                <span class="org-type">Key</span>::<span class="org-type">Hash</span>(hash) =&gt; <span class="org-constant">base64</span>::encode_config(hash, <span class="org-constant">base64</span>::<span class="org-type">URL_SAFE_NO_PAD</span>),
                <span class="org-type">Key</span>::<span class="org-type">Alias</span>(word) =&gt; word.to_string(),
            };

            <span class="org-keyword">let</span> <span class="org-variable-name">file</span> = <span class="org-keyword">self</span>.path.join(filename);

            file
        }

        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Key</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-type">Error</span>&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">content</span> = <span class="org-type">Bytes</span>::new();
            fetch_link(<span class="org-keyword">self</span>.path(key).as_path()).and_then(|<span class="org-keyword">mut</span> f| f.read_to_end(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> content))<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>(content)
        }

        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">deref</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">key</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Key</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-constant">io</span>::<span class="org-type">Error</span>&gt; {
            <span class="org-keyword">match</span> key {
                <span class="org-type">Key</span>::<span class="org-type">Hash</span>(h) =&gt; <span class="org-type">Ok</span>(h.clone()),
                <span class="org-type">Key</span>::<span class="org-type">Alias</span>(a) =&gt; <span class="org-keyword">self</span>
                    .target(a.clone())
                    .and_then(|t| <span class="org-type">Ok</span>(<span class="org-constant">base64</span>::decode_config(t, <span class="org-constant">base64</span>::<span class="org-type">URL_SAFE_NO_PAD</span>).unwrap())),
            }
        }

        <span class="org-keyword">fn</span> <span class="org-function-name">target</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">alias</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">String</span>, <span class="org-constant">io</span>::<span class="org-type">Error</span>&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">path</span> = <span class="org-keyword">self</span>.path(<span class="org-rust-ampersand">&amp;</span><span class="org-type">Key</span>::<span class="org-type">Alias</span>(alias));
            <span class="org-keyword">match</span> get_link_type() {
                <span class="org-type">Link</span>::<span class="org-type">Symlink</span> =&gt; <span class="org-constant">fs</span>::read_link(path)
                    .map(|p| p.file_name().unwrap().to_str().unwrap().to_string()),
                <span class="org-type">Link</span>::<span class="org-type">Manual</span> =&gt; {
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">link_file</span> = <span class="org-type">File</span>::open(path)<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">target_path</span> = <span class="org-type">String</span>::new();
                    link_file.read_to_string(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> target_path)<span class="org-rust-question-mark">?</span>;
                    <span class="org-type">Ok</span>(target_path)
                }
            }
        }

        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">content</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Bytes</span>, <span class="org-variable-name">alias</span>: <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-type">Error</span>&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">hash</span> = <span class="org-constant">sha2</span>::<span class="org-type">Sha256</span>::digest(<span class="org-rust-ampersand">&amp;</span>content);
            <span class="org-keyword">let</span> <span class="org-variable-name">hashfilename</span> = <span class="org-constant">base64</span>::encode_config(hash, <span class="org-constant">base64</span>::<span class="org-type">URL_SAFE_NO_PAD</span>);
            <span class="org-keyword">let</span> <span class="org-variable-name">target</span> = <span class="org-keyword">self</span>.path.join(hashfilename.clone());
            <span class="org-comment-delimiter">// </span><span class="org-comment">only write the file if it doesn't exist</span>
            <span class="org-keyword">if</span> !target.exists() {
                <span class="org-constant">std</span>::<span class="org-constant">fs</span>::write(target.clone(), content)<span class="org-rust-question-mark">?</span>;
            }

            <span class="org-comment-delimiter">// </span><span class="org-comment">Create the alias if necessary</span>
            <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(alias) = alias {
                <span class="org-keyword">let</span> <span class="org-variable-name">alias_path</span> = <span class="org-keyword">self</span>.path.join(<span class="org-type">PathBuf</span>::from(alias.to_string()));
                create_link(<span class="org-type">Path</span>::new(<span class="org-rust-ampersand">&amp;</span>hashfilename), alias_path.as_path())<span class="org-rust-question-mark">?</span>;
            }
            <span class="org-type">Ok</span>(hash.to_vec())
        }

        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put_from_path</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">path</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Path</span>, <span class="org-variable-name">alias</span>: <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt;) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-type">Error</span>&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">unique_temp_file</span> = <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"temp_</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-type">Uuid</span>::new_v4()); <span class="org-comment-delimiter">// </span><span class="org-comment">Generate a unique temporary filename</span>
            <span class="org-keyword">let</span> <span class="org-variable-name">temp_file_path</span> = <span class="org-keyword">self</span>.path.join(unique_temp_file);
            <span class="org-keyword">let</span> <span class="org-variable-name">file</span> = <span class="org-type">File</span>::open(path)<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">reader</span> = <span class="org-type">BufReader</span>::new(file);
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">hasher</span> = <span class="org-type">Sha256</span>::new();
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buffer</span> = [0<span class="org-type">u8</span>; 4096]; <span class="org-comment-delimiter">// </span><span class="org-comment">4 KiB buffer</span>
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">writer</span> = <span class="org-type">BufWriter</span>::new(<span class="org-type">File</span>::create(<span class="org-rust-ampersand">&amp;</span>temp_file_path)<span class="org-rust-question-mark">?</span>);

            <span class="org-comment-delimiter">// </span><span class="org-comment">Read, hash, and write in chunks</span>
            <span class="org-keyword">loop</span> {
                <span class="org-keyword">let</span> <span class="org-variable-name">count</span> = reader.read(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> buffer)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">if</span> count == 0 {
                    <span class="org-keyword">break</span>;
                }
                hasher.update(<span class="org-rust-ampersand">&amp;</span>buffer[..count]);
                writer.write_all(<span class="org-rust-ampersand">&amp;</span>buffer[..count])<span class="org-rust-question-mark">?</span>;
            }
            writer.flush()<span class="org-rust-question-mark">?</span>;

            <span class="org-comment-delimiter">// </span><span class="org-comment">Compute the final hash and rename the file according to the hash</span>
            <span class="org-keyword">let</span> <span class="org-variable-name">hash</span> = hasher.finalize();
            <span class="org-keyword">let</span> <span class="org-variable-name">file_name</span> = <span class="org-constant">base64</span>::encode_config(<span class="org-rust-ampersand">&amp;</span>hash, <span class="org-type">URL_SAFE_NO_PAD</span>);
            <span class="org-keyword">let</span> <span class="org-variable-name">final_path</span> = <span class="org-keyword">self</span>.path.join(file_name.clone());

            <span class="org-comment-delimiter">// </span><span class="org-comment">Move to final destination, overwriting anything there</span>
            <span class="org-constant">fs</span>::rename(temp_file_path.clone(), final_path.clone())<span class="org-rust-question-mark">?</span>;
            <span class="org-comment-delimiter">// </span><span class="org-comment">Create the alias if necessary</span>

            <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(alias) = alias {
                <span class="org-keyword">let</span> <span class="org-variable-name">alias_path</span> = <span class="org-keyword">self</span>.path.join(alias);
                <span class="org-keyword">let</span> <span class="org-variable-name">target_path</span> = <span class="org-type">Path</span>::new(<span class="org-string">"."</span>).join(file_name);
                create_link(<span class="org-rust-ampersand">&amp;</span>target_path, <span class="org-rust-ampersand">&amp;</span>alias_path)<span class="org-rust-question-mark">?</span>;
            }
            <span class="org-type">Ok</span>(hash.to_vec())
        }
    }

    <span class="org-keyword">enum</span> <span class="org-type">Link</span> {
        <span class="org-type">Manual</span>,
        <span class="org-type">Symlink</span>,
    }

    <span class="org-doc">/// Determines the appropriate link type based on the operating system.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">get_link_type</span>() -&gt; <span class="org-type">Link</span> {
        <span class="org-keyword">if</span> <span class="org-preprocessor">cfg!</span>(target_os = <span class="org-string">"linux"</span>)
            || <span class="org-preprocessor">cfg!</span>(target_os = <span class="org-string">"macos"</span>)
            || <span class="org-preprocessor">cfg!</span>(target_os = <span class="org-string">"windows"</span>)
            || <span class="org-preprocessor">cfg!</span>(target_os = <span class="org-string">"android"</span>)
        {
            <span class="org-type">Link</span>::<span class="org-type">Symlink</span>
        } <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-preprocessor">cfg!</span>(target_os = <span class="org-string">"ios"</span>) {
            <span class="org-type">Link</span>::<span class="org-type">Manual</span>
        } <span class="org-keyword">else</span> {
            <span class="org-preprocessor">panic!</span>(<span class="org-string">"Unsupported operating system for linking"</span>);
        }
    }

    <span class="org-doc">/// Creates a link based on the specified link type.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Arguments</span>
    <span class="org-doc">/// * `target` - The target file or directory to link to.</span>
    <span class="org-doc">/// * `link_name` - The name of the symlink or link file to create.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Returns</span>
    <span class="org-doc">/// A `Result` indicating success or failure.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">create_link</span>(<span class="org-variable-name">target</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Path</span>, <span class="org-variable-name">link_name</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Path</span>) -&gt; <span class="org-constant">io</span>::<span class="org-type">Result</span>&lt;()&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Creating link from {:?} to {:?}", link_name, target);</span>

        <span class="org-keyword">if</span> link_name.exists() {
            <span class="org-constant">fs</span>::remove_file(link_name)<span class="org-rust-question-mark">?</span>;
        }

        <span class="org-keyword">match</span> get_link_type() {
            <span class="org-type">Link</span>::<span class="org-type">Symlink</span> =&gt; {
                <span class="org-preprocessor">#[cfg(unix)]</span>
                <span class="org-constant">std</span>::<span class="org-constant">os</span>::<span class="org-constant">unix</span>::<span class="org-constant">fs</span>::symlink(target, link_name)<span class="org-rust-question-mark">?</span>;

                <span class="org-preprocessor">#[cfg(windows)]</span>
                {
                    <span class="org-keyword">if</span> target.is_dir() {
                        <span class="org-constant">std</span>::<span class="org-constant">os</span>::<span class="org-constant">windows</span>::<span class="org-constant">fs</span>::symlink_dir(target, link_name)<span class="org-rust-question-mark">?</span>
                    } <span class="org-keyword">else</span> {
                        <span class="org-constant">std</span>::<span class="org-constant">os</span>::<span class="org-constant">windows</span>::<span class="org-constant">fs</span>::symlink_file(target, link_name)<span class="org-rust-question-mark">?</span>
                    }
                }
            }

            <span class="org-type">Link</span>::<span class="org-type">Manual</span> =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">link_file</span> = <span class="org-type">File</span>::create(link_name)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">let</span> <span class="org-variable-name">path</span> = target.canonicalize()<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">let</span> <span class="org-variable-name">target_path</span> = path.to_str().ok_or(<span class="org-type">Error</span>::new(
                    <span class="org-constant">io</span>::<span class="org-type">ErrorKind</span>::<span class="org-type">Other</span>,
                    <span class="org-string">"Failed to convert path to string"</span>,
                ))<span class="org-rust-question-mark">?</span>;
                <span class="org-rust-builtin-formatting-macro">writeln!</span>(link_file, <span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, target_path)<span class="org-rust-question-mark">?</span>;
            }
        }
        <span class="org-type">Ok</span>(())
    }

    <span class="org-doc">/// Fetches the target of a link.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Arguments</span>
    <span class="org-doc">/// * `link_name` - The link file or symlink to fetch.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Returns</span>
    <span class="org-doc">/// A `Result` containing the target `File`.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">fetch_link</span>(<span class="org-variable-name">link_name</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Path</span>) -&gt; <span class="org-constant">io</span>::<span class="org-type">Result</span>&lt;<span class="org-type">File</span>&gt; {
        <span class="org-keyword">match</span> get_link_type() {
            <span class="org-type">Link</span>::<span class="org-type">Symlink</span> =&gt; <span class="org-type">File</span>::open(link_name),
            <span class="org-type">Link</span>::<span class="org-type">Manual</span> =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">link_file</span> = <span class="org-type">File</span>::open(link_name)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">target_path</span> = <span class="org-type">String</span>::new();
                link_file.read_to_string(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> target_path)<span class="org-rust-question-mark">?</span>;
                <span class="org-type">File</span>::open(target_path)
            }
        }
    }

    <span class="org-doc">/// Deletes a link.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Arguments</span>
    <span class="org-doc">/// * `link_name` - The link file or symlink to delete.</span>
    <span class="org-doc">///</span>
    <span class="org-doc">/// # Returns</span>
    <span class="org-doc">/// A `Result` indicating success or failure.</span>
    <span class="org-preprocessor">#[allow(dead_code)]</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">delete_link</span>(<span class="org-variable-name">link_name</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Path</span>) -&gt; <span class="org-constant">io</span>::<span class="org-type">Result</span>&lt;()&gt; {
        <span class="org-constant">fs</span>::remove_file(link_name)
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orgf780a71" class="outline-5">
<h5 id="orgf780a71"><span class="section-number-5">1.5.3.9.</span> Cryptographic primitives</h5>
<div class="outline-text-5" id="text-1-5-3-9">
<p>
We'll implement certain cryptography functions in rust and make kcats
words for them (hashing, encryption, signing)
</p>
<div class='tangle-wrapper' data-tangle='src/crypto.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{associative <span class="org-keyword">as</span> assoc, <span class="org-constant">error</span>::<span class="org-type">Error</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Int</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-type">Bytes</span>, <span class="org-type">Item</span>};
<span class="org-keyword">use</span> <span class="org-constant">core</span>::<span class="org-constant">ops</span>::<span class="org-type">Deref</span>;
<span class="org-keyword">use</span> <span class="org-constant">ed25519_dalek</span> <span class="org-keyword">as</span> signing;
<span class="org-keyword">use</span> <span class="org-constant">ed25519_dalek</span>::{<span class="org-type">Signer</span>, <span class="org-type">Verifier</span>};
<span class="org-keyword">use</span> <span class="org-constant">rand</span>::<span class="org-constant">rngs</span>::<span class="org-type">OsRng</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Import OsRng</span>
<span class="org-keyword">use</span> <span class="org-constant">rand</span>::<span class="org-type">RngCore</span> <span class="org-keyword">as</span> <span class="org-type">RandRngCore</span>;
<span class="org-keyword">use</span> <span class="org-constant">rand_core</span>::{<span class="org-type">CryptoRng</span>, <span class="org-type">RngCore</span>};
<span class="org-keyword">use</span> <span class="org-constant">sha2</span>::{<span class="org-keyword">self</span>, <span class="org-type">Digest</span>}; <span class="org-comment-delimiter">// </span><span class="org-comment">Import RngCore for the fill_bytes method</span>

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">hash</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">b</span> = <span class="org-type">Bytes</span>::try_derive(i).unwrap();
    <span class="org-type">Ok</span>(<span class="org-constant">sha2</span>::<span class="org-type">Sha256</span>::digest(<span class="org-rust-ampersand">&amp;</span>b).deref().to_vec().fit())
}

<span class="org-keyword">type</span> <span class="org-type">Value</span> = <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;;

<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">SeededRNG</span> {
    <span class="org-variable-name">seed</span>: <span class="org-type">Value</span>,
    <span class="org-variable-name">salt</span>: <span class="org-type">Value</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">SeededRNG</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">Hash of seed|value</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">hash</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">v</span> = <span class="org-keyword">self</span>.seed.clone();
        v.extend(<span class="org-keyword">self</span>.salt.clone());
        <span class="org-constant">sha2</span>::<span class="org-type">Sha256</span>::digest(v.as_slice()).deref().to_vec()
    }
}

<span class="org-keyword">impl</span> <span class="org-type">RngCore</span> <span class="org-keyword">for</span> <span class="org-type">SeededRNG</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">next_u32</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">u32</span> {
        <span class="org-constant">rand_core</span>::<span class="org-constant">impls</span>::next_u32_via_fill(<span class="org-keyword">self</span>)
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">next_u64</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">u64</span> {
        <span class="org-constant">rand_core</span>::<span class="org-constant">impls</span>::next_u64_via_fill(<span class="org-keyword">self</span>)
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">fill_bytes</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">dest</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> [<span class="org-type">u8</span>]) {
        <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = dest.len();
        dest.copy_from_slice(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.hash()[..l]);
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">try_fill_bytes</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">dest</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> [<span class="org-type">u8</span>]) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-constant">rand_core</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">self</span>.fill_bytes(dest);
        <span class="org-type">Ok</span>(())
    }
}

<span class="org-preprocessor">#[allow(dead_code)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">hash_bytes</span>(<span class="org-variable-name">contents</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-type">u8</span>]) -&gt; <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">hasher</span> = <span class="org-constant">sha2</span>::<span class="org-type">Sha256</span>::new();
    <span class="org-comment-delimiter">//</span><span class="org-comment">let mut buffer = [0; 1024]; // Read in chunks of 1024 bytes</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">count</span> = contents.len();
    hasher.update(<span class="org-rust-ampersand">&amp;</span>contents[..count]);

    hasher.finalize().to_vec()
}

<span class="org-keyword">impl</span> <span class="org-type">CryptoRng</span> <span class="org-keyword">for</span> <span class="org-type">SeededRNG</span> {}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">key</span>(<span class="org-variable-name">seed</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">sbs</span>: <span class="org-type">Bytes</span> = seed.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">kp</span> = <span class="org-constant">signing</span>::<span class="org-type">Keypair</span>::generate(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">SeededRNG</span> {
        <span class="org-variable-name">seed</span>: <span class="org-preprocessor">vec!</span>[],
        <span class="org-variable-name">salt</span>: sbs,
    });
    <span class="org-type">Ok</span>(<span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
        (<span class="org-string">"type"</span>.fit(), <span class="org-string">"elliptic-curve-key"</span>.fit()),
        (<span class="org-string">"secret"</span>.fit(), kp.secret.as_ref().to_vec().fit()),
        (<span class="org-string">"public"</span>.fit(), kp.public.as_ref().to_vec().fit()),
    ])
    .fit())
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">signing</span>::<span class="org-type">Keypair</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">sk</span>: <span class="org-constant">signing</span>::<span class="org-type">SecretKey</span> = i.try_fit()<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">pk</span>: <span class="org-constant">signing</span>::<span class="org-type">PublicKey</span> = (<span class="org-rust-ampersand">&amp;</span>sk).into();
        <span class="org-type">Ok</span>(<span class="org-constant">signing</span>::<span class="org-type">Keypair</span> {
            <span class="org-variable-name">secret</span>: sk,
            <span class="org-variable-name">public</span>: pk,
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">signing</span>::<span class="org-type">SecretKey</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">if</span> a.get(&amp;<span class="org-string">"type"</span>.fit()) == <span class="org-type">Some</span>(<span class="org-string">"elliptic-curve-key"</span>.fit()) {
            <span class="org-keyword">let</span> <span class="org-variable-name">sk</span> = <span class="org-constant">signing</span>::<span class="org-type">SecretKey</span>::from_bytes(
                <span class="org-rust-ampersand">&amp;</span><span class="org-type">Bytes</span>::try_derive(
                    a.get(&amp;<span class="org-string">"secret"</span>.fit())
                        .ok_or_else(|| <span class="org-type">Error</span>::expected(<span class="org-string">"secret"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))<span class="org-rust-question-mark">?</span>,
                )<span class="org-rust-question-mark">?</span>[..],
            )
            .map_err(|_e| <span class="org-type">Error</span>::expected(<span class="org-string">"valid-secret-key"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>(sk)
        } <span class="org-keyword">else</span> {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"keypair"</span>, a))
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">signing</span>::<span class="org-type">PublicKey</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">if</span> a.get(&amp;<span class="org-string">"type"</span>.fit()) == <span class="org-type">Some</span>(<span class="org-string">"elliptic-curve-key"</span>.fit()) {
            <span class="org-keyword">let</span> <span class="org-variable-name">pk</span> = <span class="org-constant">signing</span>::<span class="org-type">PublicKey</span>::from_bytes(
                <span class="org-rust-ampersand">&amp;</span><span class="org-type">Bytes</span>::try_derive(
                    a.get(&amp;<span class="org-string">"public"</span>.fit())
                        .ok_or_else(|| <span class="org-type">Error</span>::expected(<span class="org-string">"public"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))<span class="org-rust-question-mark">?</span>,
                )<span class="org-rust-question-mark">?</span>[..],
            )
            .map_err(|_e| <span class="org-type">Error</span>::expected(<span class="org-string">"valid-public-key"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>(pk)
        } <span class="org-keyword">else</span> {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"public-key"</span>, a))
        }
    }
}
<span class="org-comment-delimiter">//</span><span class="org-comment">TODO: we can only call sign from a keypair, so we may want to assume</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">that we have either the kp, or just the secret key.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">sign</span>(<span class="org-variable-name">k</span>: <span class="org-type">Item</span>, <span class="org-variable-name">m</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">kp</span>: <span class="org-constant">signing</span>::<span class="org-type">Keypair</span> = k.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">message</span>: <span class="org-type">Bytes</span> = m.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">signature</span>: <span class="org-constant">signing</span>::<span class="org-type">Signature</span> = kp.sign(<span class="org-rust-ampersand">&amp;</span>message);
    <span class="org-type">Ok</span>(signature.as_ref().to_vec().fit())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">verify</span>(<span class="org-variable-name">k</span>: <span class="org-type">Item</span>, <span class="org-variable-name">m</span>: <span class="org-type">Item</span>, <span class="org-variable-name">s</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">mret</span> = m.clone();
    <span class="org-keyword">let</span> <span class="org-variable-name">pk</span>: <span class="org-constant">signing</span>::<span class="org-type">PublicKey</span> = k.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">mbs</span>: <span class="org-type">Bytes</span> = m.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">sbs</span>: <span class="org-type">Bytes</span> = s.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">sig</span> = <span class="org-constant">signing</span>::<span class="org-type">Signature</span>::from_bytes(<span class="org-rust-ampersand">&amp;</span>sbs)
        .map_err(|_e| <span class="org-type">Error</span>::expected(<span class="org-string">"signature"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(pk.verify(<span class="org-rust-ampersand">&amp;</span>mbs, <span class="org-rust-ampersand">&amp;</span>sig).map(|_| mret).unwrap_or_default())
}

<span class="org-keyword">fn</span> <span class="org-function-name">random_bytes</span>(<span class="org-variable-name">n</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">bytes</span> = <span class="org-preprocessor">vec!</span>[0<span class="org-type">u8</span>; n]; <span class="org-comment-delimiter">// </span><span class="org-comment">Create a vector of n zeros</span>
    <span class="org-type">OsRng</span>.fill_bytes(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> bytes); <span class="org-comment-delimiter">// </span><span class="org-comment">Fill the vector with random bytes</span>
    bytes
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">random</span>(<span class="org-variable-name">n</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">n</span>: <span class="org-type">Int</span> = n.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(random_bytes(n <span class="org-keyword">as</span> <span class="org-type">usize</span>).fit())
}
</pre>
</div></div>
</div>
</div>
</div>
<div id="outline-container-org39730eb" class="outline-4">
<h4 id="org39730eb"><span class="section-number-4">1.5.4.</span> Serialization</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
We'll define how kcats data structure are parsed and written (for
example, in order to read/write to/from disk).
</p>
<div class='tangle-wrapper' data-tangle='src/serialize.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! Serializes and parses kcats data. kcats serialization is inspired</span>
<span class="org-doc">//! by Joy, and implemented as a subset of edn (where only vector</span>
<span class="org-doc">//! containers from edn are used, no lists, maps or sets). Currently</span>
<span class="org-doc">//! one custom tag is used for encoding byte arrays, but this is</span>
<span class="org-doc">//! subject to change.</span>
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-type">Mutey</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{
    <span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, associative <span class="org-keyword">as</span> assoc, <span class="org-constant">environment</span>::<span class="org-type">Environment</span>, <span class="org-constant">error</span>::<span class="org-type">Error</span>,
};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Number</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;

<span class="org-keyword">use</span> <span class="org-constant">base64</span>::<span class="org-constant">prelude</span>::<span class="org-type">BASE64_URL_SAFE_NO_PAD</span>;
<span class="org-keyword">use</span> <span class="org-constant">base64</span>::<span class="org-type">Engine</span>;
<span class="org-keyword">use</span> <span class="org-constant">edn_format</span>::<span class="org-type">ParserOptions</span>;
<span class="org-keyword">use</span> <span class="org-constant">internment</span>::<span class="org-type">Intern</span>;

<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">VecDeque</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::fmt;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::string;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Display</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span>;
}

<span class="org-keyword">const</span> <span class="org-variable-name">BYTE_TAG</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span> = <span class="org-string">"b64"</span>;

<span class="org-doc">/// Parses a serialized value into an [Item].</span>
<span class="org-keyword">fn</span> <span class="org-function-name">to_item</span>(<span class="org-variable-name">item</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">edn_format</span>::<span class="org-type">Value</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("to item {:?}", item);</span>
    <span class="org-keyword">match</span> item {
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Integer</span>(i) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(*i))),
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Vector</span>(v) =&gt; <span class="org-type">Ok</span>({
            <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(
                v.iter()
                    .map(to_item)
                    .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">VecDeque</span>&lt;<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
            )
            .fit()
        }),
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Symbol</span>(s) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Word</span>(<span class="org-type">Word</span> {
            <span class="org-variable-name">data</span>: <span class="org-type">Intern</span>::new(s.name().to_string()),
            <span class="org-variable-name">namespace</span>: s
                .namespace()
                .map(|ns| <span class="org-type">BASE64_URL_SAFE_NO_PAD</span>.decode(ns.to_string()))
                .transpose()<span class="org-rust-question-mark">?</span>
                .map(|decoded| <span class="org-type">Intern</span>::new(decoded)),
            <span class="org-variable-name">quoted</span>: <span class="org-keyword">false</span>,
        })),
        <span class="org-comment-delimiter">// </span><span class="org-comment">we don't have booleans in kcats, so if we see 'false' that</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">is the word false which is not defined in the base</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">language, but might be user-defined later.</span>
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Boolean</span>(b) =&gt; <span class="org-type">Ok</span>(<span class="org-keyword">if</span> *b { <span class="org-string">"yes"</span>.fit() } <span class="org-keyword">else</span> { <span class="org-string">"false"</span>.fit() }),
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-type">Ok</span>(s.to_string().fit()),
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Float</span>(f) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(f.into_inner()))),
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">TaggedElement</span>(tag, e) =&gt; {
            <span class="org-keyword">if</span> *tag == <span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_name(<span class="org-type">BYTE_TAG</span>) {
                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-variable-name">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">String</span>(s) = <span class="org-rust-ampersand">&amp;</span>**e {
                    <span class="org-type">Ok</span>(<span class="org-type">BASE64_URL_SAFE_NO_PAD</span>
                        .decode(s.clone().into_bytes())
                        .unwrap()
                        .fit())
                } <span class="org-keyword">else</span> {
                    <span class="org-type">Err</span>(<span class="org-type">Error</span>::parse(<span class="org-string">"Invalid tag datatype for byte literal"</span>))
                }
            } <span class="org-keyword">else</span> {
                <span class="org-type">Err</span>(<span class="org-type">Error</span>::parse(<span class="org-string">"Unsupported tag"</span>))
            }
        }
        <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Character</span>(c) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Char</span>(*c)),
        _ =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::parse(<span class="org-string">"Unsupported data literal"</span>)),
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">from_sized</span>(<span class="org-variable-name">s</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span> {
    <span class="org-keyword">match</span> s {
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Words</span>(e)) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Symbol</span>(
            <span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_name(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">_entries"</span>, e.len()).as_str()),
        ),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(e)) =&gt; (<span class="org-rust-ampersand">&amp;</span>e.representation()).into(),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">String</span>(s.to_string()),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(bs) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">TaggedElement</span>(
            <span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_name(<span class="org-string">"b64"</span>),
            <span class="org-type">Box</span>::new(<span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">String</span>(<span class="org-type">BASE64_URL_SAFE_NO_PAD</span>.encode(bs))),
        ),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">av</span> = a.clone().to_iter().collect::&lt;<span class="org-type">Vec</span>&lt;(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>, <span class="org-type">Item</span>)&gt;&gt;();
            av.sort_by(|(ka, _), (kb, _)| ka.cmp(kb));
            <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Vector</span>(
                av.into_iter()
                    .map(|i| (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(i)).into())
                    .collect::&lt;<span class="org-type">Vec</span>&lt;<span class="org-constant">edn_format</span>::<span class="org-type">Value</span>&gt;&gt;(),
            )
        }
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s) =&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">v</span> = s.iter().cloned().collect::&lt;<span class="org-type">Vec</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>&gt;&gt;();
            v.sort();
            <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Vector</span>(v.into_iter().map(|ki| (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(ki)).into()).collect())
        }
        v =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Vector</span>(
            v.clone()
                .into_iter()
                .map(|i| (<span class="org-rust-ampersand">&amp;</span>i).into())
                .collect::&lt;<span class="org-type">Vec</span>&lt;<span class="org-constant">edn_format</span>::<span class="org-type">Value</span>&gt;&gt;(),
        ),
    }
}

<span class="org-doc">/// Serializes the item deterministically. Certain data is lost in</span>
<span class="org-doc">/// serialization, including the type of container (sets/maps/lists</span>
<span class="org-doc">/// all are serialized as vectors)</span>
<span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">a</span>&gt; <span class="org-type">From</span>&lt;<span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">edn_format</span>::<span class="org-type">Value</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">item</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> item {
            <span class="org-comment-delimiter">// </span><span class="org-comment">dictionaries are big and it's ugly to print them for</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">environments.</span>
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Integer</span>(*i),
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(f)) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::from(*f),
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Character</span>(*c),
            <span class="org-type">Item</span>::<span class="org-type">Builtin</span>(b) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Symbol</span>(<span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_name(
                <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"builtin_</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, b.name).as_str(),
            )),
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-constant">edn_format</span>::<span class="org-type">Value</span>::<span class="org-type">Symbol</span>({
                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(ns) = w.namespace {
                    <span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_namespace_and_name(
                        <span class="org-type">BASE64_URL_SAFE_NO_PAD</span>.encode(ns.as_ref()).as_str(),
                        w.fit(),
                    )
                } <span class="org-keyword">else</span> {
                    <span class="org-constant">edn_format</span>::<span class="org-type">Symbol</span>::from_name(w.fit())
                }
            }),
            <span class="org-comment-delimiter">//</span><span class="org-comment">Item::Entry(w) =&gt; edn_format::Value::Symbol(edn_format::Symbol::from_name(&amp;w.word)),</span>
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(o)) =&gt; (<span class="org-rust-ampersand">&amp;</span>o.representation()).into(),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t)) =&gt; (<span class="org-rust-ampersand">&amp;</span>t.representation()).into(),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(i)) =&gt; (<span class="org-rust-ampersand">&amp;</span>i.representation()).into(),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t)) =&gt; (<span class="org-rust-ampersand">&amp;</span>t.representation()).into(),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)) =&gt; from_sized(s),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s)) =&gt; from_sized(s),
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">parse</span>(<span class="org-variable-name">s</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">parser</span> = <span class="org-constant">edn_format</span>::<span class="org-type">Parser</span>::from_iter(s.chars(), <span class="org-constant">edn_format</span>::<span class="org-type">ParserOptions</span>::default());
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(
        parser
            .map(<span class="org-keyword">move</span> |r| <span class="org-keyword">match</span> r {
                <span class="org-type">Ok</span>(expr) =&gt; <span class="org-type">Ok</span>(to_item(<span class="org-rust-ampersand">&amp;</span>expr)<span class="org-rust-question-mark">?</span>),
                <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::from(e)),
            })
            .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>,
    ))
}

<span class="org-doc">/// A streaming parser function that takes the state of the parsing</span>
<span class="org-doc">/// off the stack and uses the edn-format crate to do the heavy</span>
<span class="org-doc">/// lifting. Reads all the remaining objects and returns a list of</span>
<span class="org-doc">/// them plus whatever string is leftover (empty string if nothing</span>
<span class="org-doc">/// left)</span>
<span class="org-doc">/// Note: This implementation is primarily designed for parsing</span>
<span class="org-doc">/// complete EDN data structures (lists, vectors, maps, etc).</span>
<span class="org-doc">/// When parsing raw tokens (symbols, numbers, etc) at chunk</span>
<span class="org-doc">/// boundaries, it may occasionally fail to properly join tokens</span>
<span class="org-doc">/// that span multiple chunks.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">parse_edn</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">obj_buffer</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">next_input</span>: <span class="org-type">String</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">state</span>: <span class="org-type">String</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;

    state.push_str(next_input.as_str());

    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">parser</span> = <span class="org-constant">edn_format</span>::<span class="org-type">Parser</span> {
        <span class="org-variable-name">opts</span>: <span class="org-type">ParserOptions</span>::default(),
        <span class="org-variable-name">iter</span>: state.chars().peekable(),
    };

    <span class="org-comment-delimiter">// </span><span class="org-comment">Collect items until we hit the end or can't parse anymore</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">forms</span> = obj_buffer.mutate();

    <span class="org-keyword">loop</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Save iterator state before attempting parse</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">before_parse</span> = parser.iter.clone();

        <span class="org-keyword">match</span> parser.next() {
            <span class="org-type">Some</span>(<span class="org-type">Ok</span>(v)) =&gt; {
                forms.push_back(to_item(<span class="org-rust-ampersand">&amp;</span>v)<span class="org-rust-question-mark">?</span>);
            }
            <span class="org-type">Some</span>(<span class="org-type">Err</span>(<span class="org-constant">edn_format</span>::<span class="org-type">ParserError</span>::<span class="org-type">UnexpectedEndOfInput</span>)) =&gt; {
                <span class="org-comment-delimiter">// </span><span class="org-comment">Restore iterator to state before failed parse</span>
                parser.iter = before_parse;
                <span class="org-keyword">break</span>;
            }
            <span class="org-type">Some</span>(<span class="org-type">Err</span>(e)) =&gt; <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::from(e)),
            <span class="org-type">None</span> =&gt; <span class="org-keyword">break</span>,
        }
    }
    env.pop_prog();
    <span class="org-keyword">let</span> <span class="org-variable-name">remaining</span>: <span class="org-type">String</span> = parser.iter.collect();
    env.push(<span class="org-type">Item</span>::derive(remaining));
    env.push(<span class="org-type">Item</span>::derive(obj_buffer));
    <span class="org-type">Ok</span>(())
}

<span class="org-doc">/// A function to use with a streaming parser, converting from byte</span>
<span class="org-doc">/// arrays to strings. Returns whatever couldn't be parsed from the</span>
<span class="org-doc">/// byte array, in the event a utf8 character is incomplete.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">split_at_utf8_boundary</span>(<span class="org-variable-name">bytes</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-type">u8</span>]) -&gt; (<span class="org-type">String</span>, <span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;) {
    <span class="org-keyword">match</span> <span class="org-constant">std</span>::<span class="org-type">str</span>::from_utf8(bytes) {
        <span class="org-type">Ok</span>(s) =&gt; (s.to_string(), <span class="org-type">Vec</span>::new()),
        <span class="org-type">Err</span>(e) =&gt; {
            <span class="org-comment-delimiter">// </span><span class="org-comment">e.valid_up_to() tells us the position where valid UTF-8 ends</span>
            <span class="org-keyword">let</span> <span class="org-variable-name">valid_str</span> = <span class="org-type">String</span>::from_utf8_lossy(<span class="org-rust-ampersand">&amp;</span>bytes[..e.valid_up_to()]).into_owned();
            <span class="org-keyword">let</span> <span class="org-variable-name">remainder</span> = bytes[e.valid_up_to()..].to_vec();
            (valid_str, remainder)
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">parse_utf8</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">buffer</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">next_input</span>: <span class="org-type">Bytes</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">state</span>: <span class="org-type">Bytes</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;

    state.extend(next_input);

    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">obj_buffer</span>: <span class="org-type">String</span> = <span class="org-type">Default</span>::default();
    <span class="org-keyword">if</span> !buffer.is_empty() {
        obj_buffer = buffer.try_fit()<span class="org-rust-question-mark">?</span>;
    }
    <span class="org-keyword">let</span> (parsed, remaining) = split_at_utf8_boundary(<span class="org-rust-ampersand">&amp;</span>state);
    env.pop_prog();
    obj_buffer.push_str(parsed.as_str());
    env.push(<span class="org-type">Item</span>::derive(remaining));
    env.push(<span class="org-type">Item</span>::derive(obj_buffer));
    <span class="org-type">Ok</span>(())
}

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">Emit</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">emit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">String</span>;
}

<span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">a</span>&gt; <span class="org-type">Emit</span> <span class="org-keyword">for</span> <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">emit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">String</span> {
        <span class="org-constant">edn_format</span>::emit_str(<span class="org-rust-ampersand">&amp;</span>(<span class="org-keyword">self</span>).into())
    }
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">I</span>, <span class="org-type">T</span>&gt; <span class="org-type">Emit</span> <span class="org-keyword">for</span> <span class="org-type">I</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">I</span>: <span class="org-type">Iterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">T</span>&gt;,
    <span class="org-variable-name">T</span>: <span class="org-type">Emit</span>,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">emit</span>(<span class="org-keyword">self</span>) -&gt; <span class="org-type">String</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">s</span>: <span class="org-type">String</span> = <span class="org-type">String</span>::new();
        <span class="org-keyword">for</span> <span class="org-variable-name">i</span> <span class="org-keyword">in</span> <span class="org-keyword">self</span> {
            s.push_str(i.emit().as_str());
            s.push(<span class="org-string">' '</span>);
        }
        s.pop();
        s.to_string()
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">print out envs in error messages</span>
<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Environment</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-preprocessor">write!</span>(
            f,
            <span class="org-string">"{{ stack: {}, program: {} }}"</span>,
            (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(<span class="org-keyword">self</span>.stack.clone())).emit(),
            (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(<span class="org-keyword">self</span>.program.clone())).emit(),
        )
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">fmt</span>::<span class="org-type">Debug</span> <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">fmt</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-constant">fmt</span>::<span class="org-type">Formatter</span>) -&gt; <span class="org-constant">fmt</span>::<span class="org-type">Result</span> {
        <span class="org-rust-builtin-formatting-macro">write!</span>(f, <span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(<span class="org-keyword">self</span>.data.clone())).emit())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">edn_format</span>::<span class="org-type">ParserError</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">e</span>: <span class="org-constant">edn_format</span>::<span class="org-type">ParserError</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-keyword">match</span> e {
            <span class="org-constant">edn_format</span>::<span class="org-type">ParserError</span>::<span class="org-type">UnexpectedCharacter</span>(c) =&gt; {
                <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Unexpected Character: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, c)
            }
            e =&gt; e.to_string(),
        };
        <span class="org-type">Error</span>::parse(s.as_str())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">string</span>::<span class="org-type">FromUtf8Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">e</span>: <span class="org-constant">string</span>::<span class="org-type">FromUtf8Error</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Error</span>::parse(e.to_string().as_str())
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">base64</span>::<span class="org-type">DecodeError</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">e</span>: <span class="org-constant">base64</span>::<span class="org-type">DecodeError</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Error</span>::parse(e.to_string().as_str())
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">insert_line_breaks</span>(<span class="org-variable-name">input</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-variable-name">max_items</span>: <span class="org-type">usize</span>, <span class="org-variable-name">max_chars</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">String</span> {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">result</span> = <span class="org-type">String</span>::new();
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">current_line_length</span> = 0;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">open_list_stack</span>: <span class="org-type">Vec</span>&lt;(<span class="org-type">usize</span>, <span class="org-type">usize</span>)&gt; = <span class="org-type">Vec</span>::new();
    open_list_stack.push((0, 0));
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">last_char</span>: <span class="org-type">char</span> = <span class="org-string">'\n'</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">in_string</span>: <span class="org-type">bool</span> = <span class="org-keyword">false</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">in_tag</span> = <span class="org-keyword">false</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">chars</span> = input.chars().peekable(); <span class="org-comment-delimiter">// </span><span class="org-comment">Convert to a Peekable iterator</span>

    <span class="org-keyword">while</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(c) = chars.next() {
        current_line_length += 1;

        <span class="org-keyword">match</span> c {
            <span class="org-string">'"'</span> =&gt; {
                <span class="org-keyword">if</span> last_char != <span class="org-string">'\\'</span> {
                    in_string = !in_string;
                }
                result.push(c);
            }
            <span class="org-string">'['</span> =&gt; {
                <span class="org-keyword">if</span> !in_string &amp;&amp; last_char != <span class="org-string">'\\'</span> {
                    open_list_stack.push((0, 0)); <span class="org-comment-delimiter">// </span><span class="org-comment">Start a new list</span>
                }
                result.push(c);
            }
            <span class="org-string">']'</span> =&gt; {
                result.push(c);
                <span class="org-keyword">if</span> !in_string &amp;&amp; last_char != <span class="org-string">'\\'</span> {
                    <span class="org-keyword">let</span> (last_count, break_count) = open_list_stack.pop().unwrap();
                    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("items, breaks: {}, {}", last_count, break_count);</span>
                    <span class="org-keyword">if</span> (last_count == 1 || last_count &gt;= 6 || break_count &gt; 0)
                        &amp;&amp; chars.peek() != <span class="org-type">Some</span>(&amp;<span class="org-string">']'</span>)
                    {
                        <span class="org-comment-delimiter">// </span><span class="org-comment">Only add a newline if the next character is not a closing bracket</span>
                        result.push(<span class="org-string">'\n'</span>);
                        <span class="org-keyword">let</span> (_, break_count) = open_list_stack.last_mut().unwrap();
                        *break_count += 1;
                        current_line_length = 0;
                    }
                }
            }
            <span class="org-string">' '</span> =&gt; {
                <span class="org-keyword">if</span> !in_string {
                    <span class="org-keyword">let</span> (last_count, break_count) = open_list_stack.last_mut().unwrap();
                    <span class="org-keyword">if</span> in_tag {
                        in_tag = <span class="org-keyword">false</span>;
                    } <span class="org-keyword">else</span> {
                        *last_count += 1;
                    }
                    <span class="org-keyword">if</span> (*last_count &gt; 0 &amp;&amp; (*last_count % max_items) == 0)
                        || current_line_length &gt; max_chars
                    {
                        result.push(<span class="org-string">'\n'</span>);
                        *break_count += 1;
                        current_line_length = 0;
                        <span class="org-comment-delimiter">//</span><span class="org-comment">*last_count = 0;</span>
                    }
                }
                result.push(c);
            }
            <span class="org-string">'#'</span> =&gt; {
                <span class="org-keyword">if</span> !in_string {
                    in_tag = <span class="org-keyword">true</span>;
                }
                result.push(c);
            }
            _ =&gt; {
                result.push(c);
            }
        }
        last_char = c;
    }
    <span class="org-keyword">if</span> result.ends_with(<span class="org-string">'\n'</span>) {
        result.pop();
    }
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("broken output: {:?}", result);</span>
    result
}

<span class="org-keyword">fn</span> <span class="org-function-name">parse_indent</span>(<span class="org-variable-name">stack</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Vec</span>&lt;<span class="org-type">usize</span>&gt;, <span class="org-variable-name">input</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">in_string</span> = <span class="org-keyword">false</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">escaped</span> = <span class="org-keyword">false</span>;

    <span class="org-keyword">for</span> (idx, c) <span class="org-keyword">in</span> input.chars().enumerate() {
        <span class="org-keyword">if</span> in_string {
            <span class="org-keyword">match</span> c {
                <span class="org-string">'"'</span> <span class="org-keyword">if</span> !escaped =&gt; in_string = <span class="org-keyword">false</span>,
                <span class="org-comment-delimiter">// </span><span class="org-comment">TODO handle \\ (escaped backslash char)</span>
                <span class="org-string">'\\'</span> <span class="org-keyword">if</span> !escaped =&gt; escaped = <span class="org-keyword">true</span>,
                _ =&gt; escaped = <span class="org-keyword">false</span>,
            }
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">match</span> c {
                <span class="org-string">'['</span> <span class="org-keyword">if</span> !escaped =&gt; {
                    escaped = <span class="org-keyword">false</span>;
                    stack.push(idx);
                }
                <span class="org-string">']'</span> <span class="org-keyword">if</span> !escaped =&gt; {
                    escaped = <span class="org-keyword">false</span>;
                    stack.pop();
                }
                <span class="org-string">'"'</span> =&gt; {
                    escaped = <span class="org-keyword">false</span>;
                    in_string = <span class="org-keyword">true</span>;
                }
                <span class="org-string">';'</span> =&gt; {
                    <span class="org-keyword">break</span>;
                }
                <span class="org-string">'\\'</span> =&gt; {
                    escaped = <span class="org-keyword">true</span>;
                }
                _ =&gt; {
                    escaped = <span class="org-keyword">false</span>;
                }
            }
        }
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">format_indentation</span>(<span class="org-variable-name">input</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) -&gt; <span class="org-type">String</span> {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">result</span> = <span class="org-type">String</span>::new();
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">indentations</span> = <span class="org-type">Vec</span>::&lt;<span class="org-type">usize</span>&gt;::new();

    <span class="org-keyword">for</span> <span class="org-variable-name">line</span> <span class="org-keyword">in</span> input.lines() {
        <span class="org-keyword">let</span> <span class="org-variable-name">trimmed</span> = line.trim();

        <span class="org-comment-delimiter">// </span><span class="org-comment">Deduce the new indentation based on the last item in the indentations stack</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">new_indent</span> = indentations.last().copied().map(|x| x + 1).unwrap_or(0);
        <span class="org-keyword">let</span> <span class="org-variable-name">padded_line</span> = <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{}{}</span><span class="org-string">\n"</span>, <span class="org-string">" "</span>.repeat(new_indent), trimmed);
        result.push_str(padded_line.as_str());
        parse_indent(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> indentations, <span class="org-rust-ampersand">&amp;</span>padded_line);
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("indentations: {:?}: {:?}", padded_line, indentations);</span>
    }
    result.pop(); <span class="org-comment-delimiter">// </span><span class="org-comment">Remove the last newline</span>
    result
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">auto_format</span>(<span class="org-variable-name">input</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-variable-name">max_items</span>: <span class="org-type">usize</span>, <span class="org-variable-name">max_chars</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">String</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">with_breaks</span> = insert_line_breaks(input, max_items, max_chars);
    format_indentation(<span class="org-rust-ampersand">&amp;</span>with_breaks)
}

<span class="org-doc">/// a function that takes an env, and an input string. Parses the</span>
<span class="org-doc">/// string, if it parses, returns the env with the input added to the</span>
<span class="org-doc">/// program. Otherwise returns Error.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">parse_input</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>, <span class="org-variable-name">input</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">parsed</span> = parse(input)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">expr</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env.program);
    expr.extend(<span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> parsed).drain(..));
    <span class="org-type">Ok</span>(())
}

<span class="org-preprocessor">#[cfg(test)]</span>
<span class="org-keyword">mod</span> <span class="org-constant">tests</span> {
    <span class="org-keyword">use</span> <span class="org-keyword">super</span>::*;

    <span class="org-preprocessor">#[test]</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">test_insert_line_breaks</span>() {
        <span class="org-keyword">let</span> <span class="org-variable-name">input</span> = <span class="org-string">"[[foo bar][baz [[quux floop][toop poop]]]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-string">"[[foo bar]\n[baz [[quux floop]\n[toop poop]]]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">output</span> = insert_line_breaks(input, 6, 80);
        <span class="org-preprocessor">assert_eq!</span>(output, expected);

        <span class="org-keyword">let</span> <span class="org-variable-name">input</span> = <span class="org-string">"[[[1 2 3] b][c d]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-string">"[[[1 2 3] b]\n[c d]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">output</span> = insert_line_breaks(input, 6, 80);
        <span class="org-preprocessor">assert_eq!</span>(output, expected);

        <span class="org-comment-delimiter">// </span><span class="org-comment">multiline list</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">input</span> = <span class="org-string">"[[a b] [c d]] 5"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-string">"[[a b]\n [c d]]\n 5"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">output</span> = insert_line_breaks(input, 6, 80);
        <span class="org-preprocessor">assert_eq!</span>(output, expected);
    }

    <span class="org-preprocessor">#[test]</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">test_indentation</span>() {
        <span class="org-keyword">let</span> <span class="org-variable-name">input</span> = <span class="org-string">"[[foo bar]\n[baz [[quux floop]\n[toop poop]]]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-string">"[[foo bar]\n [baz [[quux floop]\n       [toop poop]]]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">output</span> = format_indentation(input);
        <span class="org-preprocessor">assert_eq!</span>(output, expected);

        <span class="org-keyword">let</span> <span class="org-variable-name">input</span> = <span class="org-string">"\"hello\" [[a b]\n[c d]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">expected</span> = <span class="org-string">"\"hello\" [[a b]\n         [c d]]"</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">output</span> = format_indentation(input);
        <span class="org-preprocessor">assert_eq!</span>(output, expected);
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org1475d19" class="outline-4">
<h4 id="org1475d19"><span class="section-number-4">1.5.5.</span> Builtin words</h4>
<div class="outline-text-4" id="text-1-5-5">
<p>
We'll define some words as axioms (not in terms of other words, only defined in Rust). 
</p>
<div class='tangle-wrapper' data-tangle='src/axiom.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! All the core functions of kcats: Words that are implemented in</span>
<span class="org-doc">//! rust, instead of in terms of other kcats words.</span>
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::{<span class="org-keyword">self</span>, <span class="org-type">Emit</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;

<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::config;
<span class="org-preprocessor">#[cfg(feature = </span><span class="org-string">"database"</span><span class="org-preprocessor">)]</span>
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::db;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{
    <span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, associative <span class="org-keyword">as</span> assoc, dictionary <span class="org-keyword">as</span> dict, <span class="org-constant">environment</span>::<span class="org-type">Environment</span>, <span class="org-constant">error</span>::<span class="org-type">Error</span>,
    pipe, <span class="org-type">Container</span>, <span class="org-type">Count</span>, <span class="org-type">Join</span>, <span class="org-type">Mutey</span>, <span class="org-type">Ordered</span>, <span class="org-type">Take</span>,
};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::{<span class="org-type">Float</span>, <span class="org-type">Int</span>, <span class="org-type">Number</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;
<span class="org-keyword">use</span> <span class="org-constant">cache</span>::cache;
<span class="org-keyword">use</span> <span class="org-constant">dynfmt</span>::{<span class="org-type">Format</span>, <span class="org-type">SimpleCurlyFormat</span>};
<span class="org-keyword">use</span> <span class="org-constant">futures</span>::<span class="org-constant">future</span>::<span class="org-type">FutureExt</span>;
<span class="org-keyword">use</span> <span class="org-constant">internment</span>::<span class="org-type">Intern</span>;
<span class="org-keyword">use</span> <span class="org-constant">lazy_static</span>::lazy_static;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">cmp</span>::max;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashMap</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">VecDeque</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">convert</span>::<span class="org-type">Infallible</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">default</span>::<span class="org-type">Default</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::mem;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-type">str</span>::<span class="org-type">Utf8Error</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-comment-delimiter">//</span><span class="org-comment">#[cfg(feature = "httpclient")]</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">use surf;</span>

<span class="org-keyword">pub</span> <span class="org-keyword">type</span> <span class="org-type">ItemResult</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;;

<span class="org-doc">/// Convert results into Items, for use when we intend to put the</span>
<span class="org-doc">/// result on the stack whether it's an [Error] or some other [Item].</span>
<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>&gt; <span class="org-type">Derive</span>&lt;<span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span>
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-variable-name">U</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
{
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>&gt;) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Ok</span>(i) =&gt; i.fit(),
            <span class="org-type">Err</span>(e) =&gt; e.fit(),
        }
    }
}

<span class="org-doc">/// A higher order function that executes a simpler function `f`,</span>
<span class="org-doc">/// where `f` takes a stack item and returns a [Result] of another</span>
<span class="org-doc">/// stack item.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">f_stack1</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>, <span class="org-type">R</span>&gt;(<span class="org-variable-name">f</span>: <span class="org-keyword">fn</span>(<span class="org-type">U</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">R</span>&gt;) -&gt; <span class="org-keyword">impl</span> <span class="org-type">Fn</span>(<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-variable-name">U</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">U</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">R</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
{
    <span class="org-keyword">move</span> |<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>| {
        <span class="org-keyword">let</span> <span class="org-variable-name">x</span> = env
            .tos()
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|x| <span class="org-type">U</span>::try_derive(x.clone()).map_err(<span class="org-type">Fit</span>::fit));
        <span class="org-keyword">match</span> x {
            <span class="org-type">Ok</span>(x) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">res</span> = f(x);
                <span class="org-keyword">match</span> res {
                    <span class="org-type">Ok</span>(r) =&gt; {
                        env.pop_prog();
                        env.pop();
                        env.push(r);
                    }
                    <span class="org-type">Err</span>(e) =&gt; {
                        <span class="org-keyword">let</span> <span class="org-variable-name">err</span>: <span class="org-type">Error</span> = e.fit();
                        env.push(err);
                    }
                }
            }
            <span class="org-type">Err</span>(e) =&gt; {
                env.push(e);
            }
        }
        env.fit()
    }
}

<span class="org-doc">/// A higher order function that executes a simpler function `f`,</span>
<span class="org-doc">/// where `f` takes two stack items and returns a [Result] of another</span>
<span class="org-doc">/// stack item.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">f_stack2</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>, <span class="org-type">V</span>, <span class="org-type">R</span>&gt;(<span class="org-variable-name">f</span>: <span class="org-keyword">fn</span>(<span class="org-type">U</span>, <span class="org-type">V</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">R</span>&gt;) -&gt; <span class="org-keyword">impl</span> <span class="org-type">Fn</span>(<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-variable-name">U</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">U</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">V</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">V</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">R</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
{
    <span class="org-keyword">move</span> |<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>| {
        <span class="org-keyword">let</span> <span class="org-variable-name">x</span> = env
            .tos()
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|x| <span class="org-type">V</span>::try_derive(x.clone()).map_err(<span class="org-type">Fit</span>::fit));
        <span class="org-keyword">let</span> <span class="org-variable-name">y</span> = env
            .stack
            .get(1)
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|y| <span class="org-type">U</span>::try_derive(y.clone()).map_err(<span class="org-type">Fit</span>::fit));

        <span class="org-keyword">match</span> (x, y) {
            (<span class="org-type">Ok</span>(x), <span class="org-type">Ok</span>(y)) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">res</span> = f(y, x);
                <span class="org-keyword">match</span> res {
                    <span class="org-type">Ok</span>(r) =&gt; {
                        env.pop_prog();
                        env.pop();
                        env.pop();
                        env.push(r);
                    }
                    <span class="org-type">Err</span>(e) =&gt; {
                        env.push(e.fit());
                    }
                }
            }
            (<span class="org-type">Err</span>(e), _) =&gt; {
                env.push(e);
            }
            (_, <span class="org-type">Err</span>(e)) =&gt; {
                env.push(e);
            }
        }
        env.fit()
    }
}

<span class="org-doc">/// A higher order function that executes a simpler function `f`,</span>
<span class="org-doc">/// where `f` takes 3 stack items and returns a [Result] of another</span>
<span class="org-doc">/// stack item.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">f_stack3</span>&lt;<span class="org-type">T</span>, <span class="org-type">U</span>, <span class="org-type">V</span>, <span class="org-type">W</span>, <span class="org-type">R</span>&gt;(
    <span class="org-variable-name">f</span>: <span class="org-keyword">fn</span>(<span class="org-type">U</span>, <span class="org-type">V</span>, <span class="org-type">W</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">T</span>, <span class="org-type">R</span>&gt;,
) -&gt; <span class="org-keyword">impl</span> <span class="org-type">Fn</span>(<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">T</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-variable-name">U</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">U</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">V</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">V</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">W</span>: <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt;,
    <span class="org-type">W</span>::<span class="org-variable-name">Error</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
    <span class="org-variable-name">R</span>: <span class="org-type">Fit</span>&lt;<span class="org-type">Error</span>&gt;,
{
    <span class="org-keyword">move</span> |<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>| {
        <span class="org-keyword">let</span> <span class="org-variable-name">x</span> = env
            .tos()
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|x| <span class="org-type">W</span>::try_derive(x.clone()).map_err(<span class="org-type">Fit</span>::fit));
        <span class="org-keyword">let</span> <span class="org-variable-name">y</span> = env
            .stack
            .get(1)
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|y| <span class="org-type">V</span>::try_derive(y.clone()).map_err(<span class="org-type">Fit</span>::fit));
        <span class="org-keyword">let</span> <span class="org-variable-name">z</span> = env
            .stack
            .get(2)
            .ok_or_else(<span class="org-type">Error</span>::stack_underflow)
            .and_then(|z| <span class="org-type">U</span>::try_derive(z.clone()).map_err(<span class="org-type">Fit</span>::fit));
        <span class="org-keyword">match</span> (x, y, z) {
            (<span class="org-type">Ok</span>(x), <span class="org-type">Ok</span>(y), <span class="org-type">Ok</span>(z)) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">res</span> = f(z, y, x);
                <span class="org-keyword">match</span> res {
                    <span class="org-type">Ok</span>(r) =&gt; {
                        env.pop_prog();
                        env.pop();
                        env.pop();
                        env.pop();
                        env.push(r);
                    }
                    <span class="org-type">Err</span>(e) =&gt; {
                        env.push(e.fit());
                    }
                }
            }
            (<span class="org-type">Err</span>(e), _, _) =&gt; {
                env.push(e);
            }
            (_, <span class="org-type">Err</span>(e), _) =&gt; {
                env.push(e);
            }
            (_, _, <span class="org-type">Err</span>(e)) =&gt; {
                env.push(e);
            }
        }
        env.fit()
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">f_stack2_async</span>(
    <span class="org-variable-name">f</span>: <span class="org-keyword">fn</span>(<span class="org-type">Item</span>, <span class="org-type">Item</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">ItemResult</span>&gt;,
) -&gt; <span class="org-keyword">impl</span> <span class="org-type">Fn</span>(<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">move</span> |<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>| {
        <span class="org-keyword">let</span> <span class="org-variable-name">x</span> = env.pop();
        <span class="org-keyword">let</span> <span class="org-variable-name">y</span> = env.pop();
        <span class="org-type">Box</span>::pin(f(x, y).map(|r| {
            <span class="org-keyword">if</span> r.is_ok() {
                env.pop_prog();
            }
            env.push(r);
            env
        }))
    }
}

<span class="org-doc">/// Wrapper function that allows you to use the ? operator in your own</span>
<span class="org-doc">/// functions. If that function returns an error result, it will</span>
<span class="org-doc">/// append that error to the env. The function `f` should return</span>
<span class="org-doc">/// either unit or an Error. If it returns an [Error] it will be</span>
<span class="org-doc">/// pushed onto the stack.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">f_result</span>&lt;<span class="org-type">F</span>&gt;(<span class="org-variable-name">f</span>: <span class="org-type">F</span>) -&gt; <span class="org-keyword">impl</span> <span class="org-type">Fn</span>(<span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt;
<span class="org-keyword">where</span>
    <span class="org-variable-name">F</span>: <span class="org-type">Fn</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;,
{
    <span class="org-keyword">move</span> |<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>| {
        <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = f(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env);
        <span class="org-keyword">match</span> r {
            <span class="org-type">Ok</span>(_) =&gt; env.fit(),
            <span class="org-type">Err</span>(e) =&gt; {
                env.push(e);
                env.fit()
            }
        }
    }
}

<span class="org-preprocessor">#[derive(Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Builtin</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">f</span>: <span class="org-rust-ampersand">&amp;</span>'<span class="org-keyword">static</span> <span class="org-type">StepFn</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">name</span>: <span class="org-rust-ampersand">&amp;</span>'<span class="org-keyword">static</span> <span class="org-type">str</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Builtin</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">a</span>: <span class="org-type">Builtin</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-type">Item</span>::<span class="org-type">Builtin</span>(a)
    }
}

<span class="org-preprocessor">lazy_static!</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">BUILTIN_FUNCTIONS</span>: <span class="org-type">HashMap</span>&lt;<span class="org-type">Word</span>, <span class="org-constant">dict</span>::<span class="org-type">Executable</span>&gt; = {
<span class="org-preprocessor">#[cfg(not(feature = </span><span class="org-string">"database"</span><span class="org-preprocessor">))]</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">entries</span>: <span class="org-type">Vec</span>&lt;(<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-rust-ampersand">&amp;</span>'<span class="org-keyword">static</span> <span class="org-type">StepFn</span>)&gt;;
    <span class="org-preprocessor">#[cfg(feature = </span><span class="org-string">"database"</span><span class="org-preprocessor">)]</span>
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">entries</span>: <span class="org-type">Vec</span>&lt;(<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-rust-ampersand">&amp;</span>'<span class="org-keyword">static</span> <span class="org-type">StepFn</span>)&gt;;
    entries = <span class="org-preprocessor">vec!</span>[
        (<span class="org-string">"*"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(mult)))),
        (<span class="org-string">"+"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(plus)))),
        (<span class="org-string">"get"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(lookup)))),
        (<span class="org-string">"sort-indexed"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(sort_by_key)))),
        (<span class="org-string">"-"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(minus)))),
        (<span class="org-string">"/"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(div)))),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("&lt;", Box::leak(Box::new(f_stack2(lt)))),</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">("&lt;=", Box::leak(Box::new(f_stack2(lte)))),</span>
        (<span class="org-string">"="</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(eq))),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("&gt;", Box::leak(Box::new(f_stack2(gt)))),</span>
        <span class="org-comment-delimiter">//</span><span class="org-comment">("&gt;=", Box::leak(Box::new(f_stack2(gte)))),</span>
        (<span class="org-string">"abs"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(abs)))),
        (<span class="org-string">"and"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(and)))),
        (<span class="org-string">"animate"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(animate))),
        (<span class="org-string">"assign"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack3(assign)))),
        (
            <span class="org-string">"association"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-constant">assoc</span>::<span class="org-type">Associative</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive,
            ))),
        ),
        (
            <span class="org-string">"association?"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_association))),
        ),
        (
            <span class="org-string">"attend"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">channel</span>::select))),
        ),
        (<span class="org-string">"autoformat"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(autoformat)))),
        (<span class="org-string">"&#8596;&#65039;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(branch))),
        (<span class="org-string">"bytes?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_bytes)))),
        (<span class="org-string">"cache"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(write_blob)))),
        (
            <span class="org-string">"character"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-type">Char</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
                <span class="org-type">Char</span>::try_derive,
            ))),
        ),
        (<span class="org-string">"&#128101;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(clone))),
        (<span class="org-string">"contains?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(contains)))),
        (<span class="org-string">"ceiling"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(ceiling)))),
        (<span class="org-string">"compare"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(compare)))),
        (<span class="org-string">"&#128207;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(count)))),
        (<span class="org-string">"dec"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(dec)))),
        (<span class="org-string">"decache"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(read_blob)))),
       <span class="org-comment-delimiter">// </span><span class="org-comment">("decide", Box::leak(Box::new(decide))),</span>
        (<span class="org-string">"decodejson"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(decode_json)))),
        (<span class="org-string">"dictmerge"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(dictmerge)))),
        (<span class="org-string">"&#129668;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(dip))),
        (<span class="org-string">"dictionary"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(dictionary))),
        (<span class="org-string">"&#8226;&#129668;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(dipdown))),
        (<span class="org-string">"&#128465;&#65039;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(drop))),
        (<span class="org-string">"emit"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(emit)))),
        (<span class="org-string">"empty"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(empty)))),
        (<span class="org-string">"empty?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_empty)))),
        (<span class="org-string">"encodeitem"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(encode_item)))),
        (<span class="org-string">"encodejson"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(encode_json)))),
        (
            <span class="org-string">"environment"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-type">Environment</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
                <span class="org-type">Environment</span>::try_derive,
            ))),
        ),
        (<span class="org-string">"environment?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_environment)))),
        (<span class="org-string">"error?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_error)))),
        (<span class="org-string">"eval-step"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(eval_step_outer))),
        (<span class="org-string">"evaluate"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(evaluate))),
        (<span class="org-string">"even?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_even)))),
        (<span class="org-string">"&#129510;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(evert))),
        (<span class="org-string">"&#9654;&#65039;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(execute))),
        (<span class="org-string">"exp"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(exp)))),
        (<span class="org-string">"fail"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(fail)))),
        (
            <span class="org-string">"file-in"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">fs</span>::file_in))),
        ),
        (
            <span class="org-string">"file-out"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">fs</span>::file_out))),
        ),
        (<span class="org-string">"finished?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_finished)))),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("first", Box::leak(Box::new(f_stack1(first)))),</span>
        (<span class="org-string">"&#128735;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(float))),
        (<span class="org-string">"floor"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(floor)))),
        (<span class="org-string">"format"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(format)))),
        (<span class="org-string">"handle"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(handle))),
        (
            <span class="org-string">"handoff"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">channel</span>::handoff)),
        ),
        (
            <span class="org-string">"hashbytes"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">crypto</span>::hash))),
        ),
        (<span class="org-string">"inc"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(inc)))),
        (<span class="org-string">"integer?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_integer)))),
        (<span class="org-string">"intersection"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(intersection)))),
        (<span class="org-string">"inspect"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(inspect)))),
        (<span class="org-string">"&#128279;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(join)))),
        (<span class="org-string">"key"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">crypto</span>::key)))),
        (<span class="org-string">"last"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(last)))),
        (<span class="org-string">"list?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_list)))),
        (<span class="org-string">"log"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(log)))),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("&#127744;", Box::leak(Box::new(loop_))),</span>
        (<span class="org-string">"mod"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(mod_)))),
        (<span class="org-string">"&#9775;&#65039;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(not)))),
        (<span class="org-string">"namespace"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(namespace)))),
        (<span class="org-string">"number"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-type">Number</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
            <span class="org-type">Number</span>::try_derive,
        )))),
        (<span class="org-string">"number?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_number)))),
        (<span class="org-string">"odd?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_odd)))),
        (<span class="org-string">"or"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(or)))),
        (<span class="org-string">"&#127890;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(pack)))),
        (<span class="org-string">"parse-edn"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(<span class="org-constant">serialize</span>::parse_edn)))),
        (<span class="org-string">"parse-utf8"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(<span class="org-constant">serialize</span>::parse_utf8)))),
        (<span class="org-string">"pop"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(pop))),
        (<span class="org-string">"&#128238;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(put))),
        (<span class="org-string">"pipe?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_pipe)))),
        (<span class="org-string">"quot"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(div)))),
        (
            <span class="org-string">"random"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">crypto</span>::random))),
        ),
        (<span class="org-string">"range"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack3(range)))),
        (<span class="org-string">"read"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-constant">serialize</span>::parse)))),
        (
            <span class="org-string">"receiver"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">channel</span>::receiver))),
        ),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("recur", Box::leak(Box::new(recur))),</span>
        (<span class="org-string">"resolve"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(resolve))),
        (<span class="org-string">"resume"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(identity))),
        (<span class="org-string">"reverse"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(reverse)))),
        (<span class="org-string">"round"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(round)))),
        (<span class="org-string">"second"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(second)))),
        (
            <span class="org-string">"sender"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">channel</span>::sender))),
        ),
        (
            <span class="org-string">"serversocket"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2_async(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">net</span>::server_socket))),
        ),
        (
            <span class="org-string">"set"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-constant">coll</span>::<span class="org-type">Set</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
                <span class="org-constant">coll</span>::<span class="org-type">Set</span>::try_derive,
            ))),
        ),
        (<span class="org-string">"set?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_set)))),
        (<span class="org-string">"sign"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(<span class="org-keyword">crate</span>::<span class="org-constant">crypto</span>::sign)))),
        (<span class="org-string">"&#9875;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(sink))),
        (<span class="org-string">"slice"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack3(slice)))),
        (
            <span class="org-string">"socket"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2_async(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">net</span>::socket))),
        ),
        (<span class="org-string">"sqrt"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(sqrt)))),
        (<span class="org-string">"standard"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(standard))),
        (<span class="org-string">"string"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(string)))),
        (<span class="org-string">"string?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_string)))),
        (<span class="org-string">"&#128256;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(swap))),
        (<span class="org-string">"&#8226;&#128256;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(swapdown))),
        (
            <span class="org-string">"timer"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-constant">channel</span>::timer))),
        ),
        (<span class="org-string">"timestamps"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(timestamps))),
        (<span class="org-string">"unassign"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(unassign)))),
        (<span class="org-string">"unnamespace"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(unnamespace))),
        (<span class="org-string">"&#128228;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(take))),
        (<span class="org-string">"&#127851;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(unwrap))),
        (<span class="org-string">"using"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_result(using)))),
        (
            <span class="org-string">"verify"</span>,
            <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack3(<span class="org-keyword">crate</span>::<span class="org-constant">crypto</span>::verify))),
        ),
        <span class="org-comment-delimiter">//</span><span class="org-comment">("version", Box::leak(Box::new(f_stack2(version)))),</span>
        (<span class="org-string">"word"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1::&lt;<span class="org-type">Word</span>, <span class="org-type">Item</span>, <span class="org-type">Error</span>&gt;(
            <span class="org-type">Word</span>::try_derive,
        )))),
        (<span class="org-string">"word?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_word)))),
        (<span class="org-string">"&#127873;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(wrap))),
        (<span class="org-string">"xor"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(xor)))),
        (<span class="org-string">"&#9989;"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(yes))),
        (<span class="org-string">"zero?"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(is_zero)))),
    ];

    <span class="org-preprocessor">#[cfg(feature = </span><span class="org-string">"database"</span><span class="org-preprocessor">)]</span>
    {
        entries.push((<span class="org-string">"database"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack2(<span class="org-constant">db</span>::query)))));
        entries.push((<span class="org-string">"persist"</span>, <span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(f_stack1(<span class="org-constant">db</span>::insert_object)))));
    }
        <span class="org-type">HashMap</span>::from_iter(entries.into_iter().map(|(s, f)| (<span class="org-type">Word</span>::derive(s), <span class="org-constant">dict</span>::<span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(<span class="org-type">Box</span>::leak(<span class="org-type">Box</span>::new(<span class="org-type">Builtin</span> {<span class="org-variable-name">name</span>: s, f}))))))
    };
}

<span class="org-keyword">fn</span> <span class="org-function-name">pair</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Item</span> {
    <span class="org-preprocessor">list!</span>(i, j).fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">plus</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(i.add(j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">minus</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(i.subtract(j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">mult</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(i.multiply(j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">div</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Number</span>::divide(i, j).map(<span class="org-type">Number</span>::derive)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">mod_</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Number</span>::remainder(i, j).map(<span class="org-type">Number</span>::derive)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">floor</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i),
        <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i.floor() <span class="org-keyword">as</span> <span class="org-type">Int</span>),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">ceiling</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i),
        <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i.ceil() <span class="org-keyword">as</span> <span class="org-type">Int</span>),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">round</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i),
        <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i.round() <span class="org-keyword">as</span> <span class="org-type">Int</span>),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">exp</span>(<span class="org-variable-name">base</span>: <span class="org-type">Number</span>, <span class="org-variable-name">exponent</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> (base, exponent) {
        (<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(b), <span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(e)) =&gt; b
            .checked_pow(e <span class="org-keyword">as</span> <span class="org-type">u32</span>)
            .ok_or(<span class="org-type">Error</span>::overflow())
            .map(<span class="org-type">Number</span>::derive),
        (<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Float</span>(b), <span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Float</span>(e)) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Number</span>::derive(b.powf(e))),
        (<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Float</span>(b), <span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(e)) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Number</span>::derive(b.powi(e <span class="org-keyword">as</span> <span class="org-type">i32</span>))),
        (<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(b), <span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Float</span>(e)) =&gt; {
            <span class="org-type">Ok</span>(<span class="org-type">Number</span>::derive((b <span class="org-keyword">as</span> <span class="org-type">f64</span>).powf(e)))
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">log</span>(<span class="org-variable-name">value</span>: <span class="org-type">Int</span>, <span class="org-variable-name">base</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Float</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">if</span> base &lt;= 1 {
        <span class="org-type">Err</span>(<span class="org-type">Error</span>::too_small(base, 1))
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> value &lt;= 0 {
        <span class="org-type">Err</span>(<span class="org-type">Error</span>::too_small(value, 0))
    } <span class="org-keyword">else</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">base</span> = base <span class="org-keyword">as</span> <span class="org-type">Float</span>;
        <span class="org-keyword">let</span> <span class="org-variable-name">value</span> = value <span class="org-keyword">as</span> <span class="org-type">Float</span>;
        <span class="org-type">Ok</span>(value.log(base))
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">inc</span>(<span class="org-variable-name">i</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i + 1)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">dec</span>(<span class="org-variable-name">i</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i - 1)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_zero</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; <span class="org-type">Ok</span>(i == 0),
        <span class="org-type">Number</span>::<span class="org-type">Float</span>(i) =&gt; <span class="org-type">Ok</span>(i == 0.0),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_empty</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i.is_empty())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">gt</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-type">Number</span>::gt(i, j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">lt</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-type">Number</span>::lt(i, j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">gte</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-type">Number</span>::gte(i, j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">lte</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>, <span class="org-variable-name">j</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-type">Number</span>::lte(i, j))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">join</span>(<span class="org-variable-name">i</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>, <span class="org-variable-name">j</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">Sized</span>, <span class="org-type">Error</span>&gt; {
    i.join(j)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">j</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">i2</span> = i.clone();
    <span class="org-keyword">let</span> <span class="org-variable-name">pr</span> = <span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::try_derive(i);
    <span class="org-keyword">match</span> pr {
        <span class="org-type">Ok</span>(p) =&gt; <span class="org-type">Box</span>::pin(p.put(j).map(|f| {
            <span class="org-keyword">match</span> f {
                <span class="org-type">Ok</span>(p) =&gt; {
                    env.pop_prog();
                    env.push(<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(p))
                }
                <span class="org-type">Err</span>(e) =&gt; {
                    env.push(i2);
                    env.push(e)
                }
            };
            env
        })),
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(i2);
            env.push(e);
            env.fit()
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">clone</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">clone</span> = env.stack.front().unwrap().clone();
    env.pop_prog();
    env.push(clone);
    env.fit()
}

<span class="org-keyword">fn</span> <span class="org-function-name">swap2</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>, <span class="org-variable-name">offset</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.stack.mutate().swap(offset, offset + 1);
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">swap</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    swap2(env, 0)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">swapdown</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    swap2(env, 1)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">sink</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">stack</span> = env.stack.mutate();
    stack.swap(0, 2);
    stack.swap(0, 1);
    env.pop_prog();
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">float</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">stack</span> = env.stack.mutate();
    stack.swap(0, 2);
    stack.swap(1, 2);
    env.pop_prog();
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">drop</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop();
    env.pop_prog();
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">j</span> = env.pop();
    env.pop_prog();
    env.push(i == j);
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">count</span>(<span class="org-variable-name">i</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Int</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i.count() <span class="org-keyword">as</span> <span class="org-type">Int</span>)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_string</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(
        i,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_)))
    ))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_bytes</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(
        i,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_)))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_)))
    ))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_error</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(
        i,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(_),
        )))
    ))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_word</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(i, <span class="org-type">Item</span>::<span class="org-type">Word</span>(_)))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_environment</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(
        i,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(_)
        ))) | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Env</span>(_)
        )))
    ))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_pipe</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(
        i,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(_))
            | <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(_))
    ))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_number</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(i, <span class="org-type">Item</span>::<span class="org-type">Number</span>(_)))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_integer</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-preprocessor">matches!</span>(i, <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-constant">number</span>::<span class="org-type">Number</span>::<span class="org-type">Int</span>(_))))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_list</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)
        .map(|s| <span class="org-preprocessor">matches!</span>(s, <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(_)))
        .unwrap_or(<span class="org-keyword">false</span>))
}

<span class="org-comment-delimiter">// </span><span class="org-comment">pub fn first(c: coll::Sized) -&gt; ItemResult {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">let (_, i) = c.take();</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">Ok(i.fit())</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">second</span>(<span class="org-variable-name">c</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(c.get(1).cloned().unwrap_or_default())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">last</span>(<span class="org-variable-name">c</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(c.into_iter().last().unwrap_or_default())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">execute</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop();
    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Item</span>::<span class="org-type">Builtin</span>(b) = i {
        <span class="org-keyword">return</span> (*b.f)(env).fit();
    } <span class="org-keyword">else</span> {
        <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i) {
            <span class="org-type">Ok</span>(program) =&gt; {
                env.pop_prog();
                env.program.prepend(program);
            }
            <span class="org-type">Err</span>(e) =&gt; {
                env.push(e);
            }
        }
        env.fit()
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">wrap</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">item</span> = env.pop();
    env.pop_prog();
    env.push(<span class="org-preprocessor">list!</span>(item));
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">unwrap</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()) {
        <span class="org-type">Ok</span>(l) =&gt; {
            env.pop_prog();
            env.stack.prepend_iter(l.iter().cloned().rev());
        }
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(e);
        }
    };
    env.fit()
}

<span class="org-doc">/// If it's a word, don't bother wrapping and</span>
<span class="org-doc">/// unwrapping, just flag it as quoted, and the</span>
<span class="org-doc">/// evaluator will just push it unexamined.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">dip_quote</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Item</span>) {
    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Item</span>::<span class="org-type">Word</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">w</span>) = i {
        w.quoted = <span class="org-keyword">true</span>;
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">dip</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()) {
        <span class="org-type">Ok</span>(program) =&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">item</span> = env.pop();
            <span class="org-keyword">let</span> <span class="org-variable-name">expr</span> = env.program.mutate();
            expr.pop_front();
            dip_quote(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> item);
            expr.push_front(item);
            env.program.prepend(program)
        }
        <span class="org-type">Err</span>(e) =&gt; env.push(e),
    }
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">dipdown</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()) {
        <span class="org-type">Ok</span>(program) =&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">item1</span> = env.pop();
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">item2</span> = env.pop();
            <span class="org-keyword">let</span> <span class="org-variable-name">prog</span> = env.program.mutate();
            prog.pop_front();
            dip_quote(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> item1);
            dip_quote(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> item2);
            prog.push_front(item1);
            prog.push_front(item2);
            env.program.prepend(program)
        }
        <span class="org-type">Err</span>(e) =&gt; env.push(e),
    }
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">take</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: handle Nothing case</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">i2</span> = i.clone();
    <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = <span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::try_derive(i);
    <span class="org-keyword">match</span> r {
        <span class="org-type">Ok</span>(d) =&gt; <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
            <span class="org-keyword">let</span> (i, c) = d.take().<span class="org-keyword">await</span>;
            env.pop_prog();
            <span class="org-keyword">let</span> <span class="org-variable-name">stack</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env.stack);
            stack.push_front(c.fit());
            stack.push_front(<span class="org-constant">coll</span>::result_to_option(i).unwrap_or_default());
            env
        }),
        <span class="org-type">Err</span>(e) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">stack</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env.stack);
            stack.push_front(i2);
            stack.push_front(e.fit());
            env.fit()
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">pop</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">i2</span> = i.clone();
    <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i);

    <span class="org-keyword">match</span> s {
        <span class="org-type">Ok</span>(it) =&gt; {
            <span class="org-keyword">let</span> (c, i) = it.pop();
            env.pop_prog();
            env.push(c);
            env.push(i.unwrap_or_default());
        }
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(i2);
            env.push(e);
        }
    }
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_truthy</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>) -&gt; <span class="org-type">bool</span> {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(d)) =&gt; !d.is_empty(),
        <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(r)) =&gt; !r.is_empty(),
        _ =&gt; <span class="org-keyword">true</span>,
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">branch</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">match</span> (
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()),
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()),
    ) {
        (<span class="org-type">Ok</span>(false_branch), <span class="org-type">Ok</span>(true_branch)) =&gt; {
            env.pop_prog();
            <span class="org-keyword">let</span> <span class="org-variable-name">b</span> = env.stack.front().unwrap();

            <span class="org-keyword">let</span> <span class="org-variable-name">selected_branch</span> = <span class="org-keyword">if</span> is_truthy(b) {
                true_branch
            } <span class="org-keyword">else</span> {
                <span class="org-comment-delimiter">// </span><span class="org-comment">A falsey value is useless, so drop it</span>
                env.pop();
                false_branch
            };
            env.program.prepend(selected_branch)
        }
        (<span class="org-type">Err</span>(e), _) =&gt; env.push(e),
        (_, <span class="org-type">Err</span>(e)) =&gt; env.push(e),
    }
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">step</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">p</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    <span class="org-keyword">let</span> <span class="org-variable-name">dispenser</span> = <span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::try_derive(env.pop()).unwrap();
    <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
        <span class="org-keyword">let</span> (r, dispenser) = dispenser.take().<span class="org-keyword">await</span>;
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(litem) = <span class="org-constant">coll</span>::result_to_option(r) {
            <span class="org-keyword">let</span> <span class="org-variable-name">prog</span> = env.program.mutate();
            <span class="org-comment-delimiter">// </span><span class="org-comment">prepare the next iteration, even if the iterator is now</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">empty. step is still the next instruction, so we don't</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">pop it off.</span>
            prog.push_front(p.clone().fit());
            prog.push_front(dispenser.fit());
            env.program.prepend(p);

            env.push(litem);
        } <span class="org-keyword">else</span> {
            <span class="org-comment-delimiter">// </span><span class="org-comment">if the container is empty, just pop off 'step' and we're done</span>
            env.pop_prog();
        }
        env
    })
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">range</span>(<span class="org-variable-name">from</span>: <span class="org-type">Int</span>, <span class="org-variable-name">to</span>: <span class="org-type">Int</span>, <span class="org-variable-name">stepby</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(
        (from..to).step_by(stepby <span class="org-keyword">as</span> <span class="org-type">usize</span>).map(<span class="org-type">Item</span>::derive),
    ))
}

<span class="org-comment-delimiter">// </span><span class="org-comment">(effect [rec2 rec1 then pred]</span>
<span class="org-comment-delimiter">//                   </span><span class="org-comment">['[if]</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">[(concat rec1</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">[[pred then rec1 rec2 'recur]] rec2)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">then pred]])</span>

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">recur</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">rec2</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">rec1</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    <span class="org-keyword">let</span> <span class="org-variable-name">then</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    <span class="org-keyword">let</span> <span class="org-variable-name">pred</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    env.pop_prog();
    env.push_prog(<span class="org-string">"if"</span>.fit());
    <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = <span class="org-preprocessor">list!</span>(
        pred.clone(),
        then.clone(),
        rec1.clone(),
        rec2.clone(),
        <span class="org-string">"recur"</span>,
    )
    .fit();
    <span class="org-comment-delimiter">// </span><span class="org-comment">I think i did this right - used to create a new list and extend</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">it with rec1, then push r, then extend again with rec2. now</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">start with rec1 (copied on write), then push r, then extend</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">with rec2.  That should be equivalent.</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">rm</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> rec1);
    rm.push_back(r);
    rm.extend(<span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> rec2).drain(..));
    <span class="org-comment-delimiter">//</span><span class="org-comment">env.pop_expr();</span>
    env.push(pred);
    env.push(then);
    env.push(rec1);
    env.fit()
}

<span class="org-comment-delimiter">//</span><span class="org-comment">(fn [{[l &amp; others] 'stack :as env}]</span>
<span class="org-comment-delimiter">//            </span><span class="org-comment">(assoc env 'stack (apply list (vec others) l)))</span>

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">evert</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(env.pop()).unwrap();
    <span class="org-constant">mem</span>::swap(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env.stack, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> l);
    env.pop_prog();
    env.push(l);
    env.fit()
}

<span class="org-keyword">fn</span> <span class="org-function-name">assoc_in</span>(<span class="org-variable-name">i</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;, <span class="org-variable-name">ks</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>], <span class="org-variable-name">v</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">assoc_vec</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">l</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">ks</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>], <span class="org-variable-name">k</span>: <span class="org-type">Int</span>, <span class="org-variable-name">v</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">lm</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> l);
        <span class="org-keyword">let</span> <span class="org-variable-name">idx</span> = k <span class="org-keyword">as</span> <span class="org-type">usize</span>;
        <span class="org-comment-delimiter">// </span><span class="org-comment">extend the size of the vector to be big enough</span>
        <span class="org-keyword">if</span> lm.len() &lt;= idx {
            lm.resize(idx + 1, <span class="org-type">Item</span>::default());
        }

        lm[idx] = <span class="org-keyword">if</span> ks.is_empty() {
            v
        } <span class="org-keyword">else</span> {
            assoc_in(lm.get(idx).cloned(), ks, v)<span class="org-rust-question-mark">?</span>
        };

        <span class="org-type">Ok</span>(l.fit())
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">assoc_map</span>(
        <span class="org-variable-name">a</span>: <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>,
        <span class="org-variable-name">ks</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>],
        <span class="org-variable-name">k</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>,
        <span class="org-variable-name">v</span>: <span class="org-type">Item</span>,
    ) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">inner</span> = a.get(<span class="org-rust-ampersand">&amp;</span>k).clone();
        <span class="org-keyword">if</span> ks.is_empty() {
            <span class="org-type">Ok</span>(a.insert(k.clone(), v).0.fit())
        } <span class="org-keyword">else</span> {
            <span class="org-type">Ok</span>(a.insert(k.clone(), assoc_in(inner, ks, v)<span class="org-rust-question-mark">?</span>).0.fit())
        }
    }

    <span class="org-keyword">if</span> <span class="org-keyword">let</span> [k, ks @ ..] = ks {
        <span class="org-keyword">match</span> (i, k) {
            <span class="org-comment-delimiter">// </span><span class="org-comment">An int key for a list means update that index</span>
            (
                <span class="org-type">Some</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l)))),
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k),
            ) =&gt; assoc_vec(l, ks, *k, v),

            (
                <span class="org-type">Some</span>(<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l)))),
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k),
            ) =&gt; assoc_vec(l, ks, *k, v),

            <span class="org-comment-delimiter">// </span><span class="org-comment">An int key for an associative means an integer key, which is uncommon</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">but we'll support it</span>
            (
                <span class="org-type">Some</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a)))),
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k),
            ) =&gt; assoc_map(a, ks, <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(*k), v),
            (
                <span class="org-type">Some</span>(<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a)))),
                <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k),
            ) =&gt; assoc_map(a, ks, <span class="org-rust-ampersand">&amp;</span><span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(*k), v),

            <span class="org-comment-delimiter">// </span><span class="org-comment">An int key for a non-sized type means we're overwriting</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">whatever it is with a list, with the value at that index</span>
            (_, <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k)) =&gt; assoc_vec(<span class="org-constant">coll</span>::<span class="org-type">List</span>::fresh(), ks, *k, v),

            <span class="org-comment-delimiter">// </span><span class="org-comment">Where there was nothing at a given index/key, and a non-int</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">key, create a map</span>
            (<span class="org-type">None</span>, k) =&gt; assoc_map(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Assoc</span>(<span class="org-constant">assoc</span>::<span class="org-type">Association</span>::fresh()),
                ks,
                k,
                v,
            ),

            <span class="org-comment-delimiter">// </span><span class="org-comment">Whatever it is, treat it as a map if possible</span>
            (<span class="org-type">Some</span>(i), k) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
                assoc_map(a, ks, k, v)
            }
        }
    } <span class="org-keyword">else</span> {
        <span class="org-type">Ok</span>(i.unwrap())
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">unassoc_in</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">ks</span>: <span class="org-rust-ampersand">&amp;</span>[<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>]) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Item</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">if</span> <span class="org-keyword">let</span> [k, ks @ ..] = ks {
        <span class="org-keyword">if</span> ks.is_empty() {
            <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>(a.remove(k).0.fit())
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">match</span> (i, k) {
                (
                    <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">mut</span> l))),
                    <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k),
                ) =&gt; {
                    <span class="org-keyword">let</span> <span class="org-variable-name">lm</span> = l.mutate();
                    <span class="org-keyword">let</span> <span class="org-variable-name">old_value</span> = <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(item) = lm.get_mut(*k <span class="org-keyword">as</span> <span class="org-type">usize</span>) {
                        <span class="org-constant">mem</span>::take(item)
                    } <span class="org-keyword">else</span> {
                        <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::short_list(*k)); <span class="org-comment-delimiter">// </span><span class="org-comment">replace with your error</span>
                    };
                    <span class="org-keyword">let</span> <span class="org-variable-name">new_value</span> = unassoc_in(old_value, ks)<span class="org-rust-question-mark">?</span>;
                    lm[*k <span class="org-keyword">as</span> <span class="org-type">usize</span>] = new_value;
                    <span class="org-type">Ok</span>(l.fit())
                }
                (a, k) =&gt; {
                    <span class="org-keyword">let</span> <span class="org-variable-name">a</span>: <span class="org-constant">assoc</span>::<span class="org-type">Associative</span> = a.try_fit()<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">a</span> = <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter(a.to_iter());
                    <span class="org-keyword">let</span> <span class="org-variable-name">am</span> = a.mutate();
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">res</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Result</span>&lt;_, <span class="org-type">Error</span>&gt;&gt; = <span class="org-type">None</span>;
                    am.entry(k.clone()).and_modify(|v| {
                        <span class="org-keyword">let</span> <span class="org-variable-name">new_value</span> = unassoc_in(v.clone(), ks);
                        res = <span class="org-type">Some</span>(new_value.map(|nv| {
                            *v = nv;
                        }));
                    });
                    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(<span class="org-type">Err</span>(e)) = res {
                        <span class="org-keyword">return</span> <span class="org-type">Err</span>(e);
                    }
                    <span class="org-type">Ok</span>(a.fit())
                }
            }
        }
    } <span class="org-keyword">else</span> {
        <span class="org-type">Ok</span>(i)
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">assign</span>(<span class="org-variable-name">m</span>: <span class="org-type">Item</span>, <span class="org-variable-name">ks</span>: <span class="org-type">Item</span>, <span class="org-variable-name">v</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Assign! {:?}", m);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">kit</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(ks)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">ksvec</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyList</span> = <span class="org-constant">assoc</span>::<span class="org-type">KeyList</span>::try_from_iter(kit.iter().cloned())<span class="org-rust-question-mark">?</span>;
    ksvec.mutate().make_contiguous();
    <span class="org-keyword">let</span> (ks, _) = ksvec.as_slices();
    assoc_in(<span class="org-type">Some</span>(m), ks, v)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">unassign</span>(<span class="org-variable-name">m</span>: <span class="org-type">Item</span>, <span class="org-variable-name">ks</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">kit</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(ks)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">ksvec</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyList</span> = <span class="org-constant">assoc</span>::<span class="org-type">KeyList</span>::try_from_iter(kit.iter().cloned())<span class="org-rust-question-mark">?</span>;
    ksvec.mutate().make_contiguous();
    <span class="org-keyword">let</span> (ks, _) = ksvec.as_slices();
    unassoc_in(m, ks)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">lookup</span>(<span class="org-variable-name">i</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>, <span class="org-variable-name">k</span>: <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("lookup {:?} \n {:?}", i, k);</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">let k = assoc::KeyItem::try_derive(k)?;</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">let i = coll::Sized::try_derive(i)?;</span>
    <span class="org-keyword">match</span> (i, k) {
        (<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l), <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k)) =&gt; {
            <span class="org-type">Ok</span>(l.get(k <span class="org-keyword">as</span> <span class="org-type">usize</span>).cloned().unwrap_or_default())
        }
        (<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s), <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k)) =&gt; {
            <span class="org-comment-delimiter">//</span><span class="org-comment">let s = s.inner();</span>
            s.chars()
                .nth(k <span class="org-keyword">as</span> <span class="org-type">usize</span>)
                .map_or(<span class="org-type">Ok</span>(<span class="org-type">Item</span>::default()), |c| <span class="org-type">Ok</span>(c.fit()))
        }
        (<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b), <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">Int</span>(k)) =&gt; b
            .get(k <span class="org-keyword">as</span> <span class="org-type">usize</span>)
            .cloned()
            .map_or(<span class="org-type">Ok</span>(<span class="org-type">Item</span>::default()), |c| <span class="org-type">Ok</span>((c <span class="org-keyword">as</span> <span class="org-type">i64</span>).fit())),
        (i, k) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">m</span> = <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
            <span class="org-type">Ok</span>(m.get(<span class="org-rust-ampersand">&amp;</span>k).unwrap_or_default())
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">contains</span>(<span class="org-variable-name">c</span>: <span class="org-type">Item</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(c) {
        <span class="org-type">Ok</span>(c) =&gt; <span class="org-type">Ok</span>(c.has(<span class="org-rust-ampersand">&amp;</span>i)),
        <span class="org-type">Err</span>(_) =&gt; <span class="org-type">Ok</span>(<span class="org-keyword">false</span>),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">or</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(<span class="org-keyword">if</span> is_truthy(<span class="org-rust-ampersand">&amp;</span>i) {
        i
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> is_truthy(<span class="org-rust-ampersand">&amp;</span>j) {
        j
    } <span class="org-keyword">else</span> {
        <span class="org-type">Item</span>::default()
    })
    <span class="org-comment-delimiter">//</span><span class="org-comment">Ok(Item::derive(is_truthy(i) || is_truthy(j)))</span>
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">and</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(<span class="org-keyword">if</span> is_truthy(<span class="org-rust-ampersand">&amp;</span>i) &amp;&amp; is_truthy(<span class="org-rust-ampersand">&amp;</span>j) {
        j
    } <span class="org-keyword">else</span> {
        <span class="org-type">Item</span>::default()
    })
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">not</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::derive(!is_truthy(<span class="org-rust-ampersand">&amp;</span>i)))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_association</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)
        .map(|s| <span class="org-preprocessor">matches!</span>(s, <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(_)))
        .unwrap_or(<span class="org-keyword">false</span>))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_set</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)
        .map(|s| <span class="org-preprocessor">matches!</span>(s, <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Set</span>(_)))
        .unwrap_or(<span class="org-keyword">false</span>))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_odd</span>(<span class="org-variable-name">i</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(i &amp; 1 == 1)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_even</span>(<span class="org-variable-name">i</span>: <span class="org-type">Int</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-type">Ok</span>(i &amp; 1 == 0)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">emit</span>(<span class="org-variable-name">l</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(l.iter().emit()),
    )))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">autoformat</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-type">String</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(<span class="org-constant">serialize</span>::auto_format(s.as_str(), 20, 80)),
    )))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">eval_step</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("{:?}", env);</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Dictionary size: {}", env.dictionary.len());</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">next_item</span> = env.program.front();

    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(val) = next_item {
        <span class="org-keyword">match</span> val {
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(word) =&gt; {
                <span class="org-keyword">if</span> word.quoted {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">word was quoted (see axiom::dip), just push onto stack</span>
                    <span class="org-comment-delimiter">// </span><span class="org-comment">and remove the quotedness</span>
                    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">w</span> = word.clone();
                    env.pop_prog();

                    w.quoted = <span class="org-keyword">false</span>;
                    env.push(w);
                    env.fit()
                } <span class="org-keyword">else</span> {
                    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(dfn) = env.dictionary.lingo.get(<span class="org-rust-ampersand">&amp;</span>word) {
                        {
                            <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(spec) = <span class="org-rust-ampersand">&amp;</span>dfn.spec {
                                <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Checking spec for {:?}: {:?}", word, spec.0);</span>
                                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Err</span>(e) = env.check_input_spec(<span class="org-rust-ampersand">&amp;</span>spec.0) {
                                    env.push(e);
                                    <span class="org-keyword">return</span> env.fit();
                                }
                            } <span class="org-keyword">else</span> {
                                <span class="org-comment-delimiter">//  </span><span class="org-comment">println!("No spec for {}!", word);</span>
                            }

                            <span class="org-keyword">match</span> <span class="org-rust-ampersand">&amp;</span>dfn.definition {
                                <span class="org-constant">dict</span>::<span class="org-type">Executable</span>::<span class="org-type">Axiom</span>(a) =&gt; (*a.f)(env),
                                <span class="org-constant">dict</span>::<span class="org-type">Executable</span>::<span class="org-type">Derived</span>(d) =&gt; {
                                    <span class="org-keyword">let</span> <span class="org-variable-name">items</span> = d.clone();
                                    env.pop_prog();
                                    env.program.prepend(items);
                                    env.fit()
                                }
                            }
                        }
                    } <span class="org-keyword">else</span> {
                        <span class="org-comment-delimiter">//</span><span class="org-comment">let w = word.clone();</span>
                        <span class="org-keyword">if</span> *word == <span class="org-type">Word</span>::derive(<span class="org-string">"times5"</span>) {
                            <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Failed dict lookup: </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string"> "</span>, env.dictionary.lingo);
                        }
                        env.push(<span class="org-type">Error</span>::undefined(word.clone().fit()));
                        env.fit()
                    }
                }
            }
            _ =&gt; {
                <span class="org-comment-delimiter">// </span><span class="org-comment">not a word, just push onto stack</span>
                <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop_prog();
                env.push(i);
                env.fit()
            }
        }
    } <span class="org-keyword">else</span> {
        env.push(<span class="org-type">Error</span>::short_list(1));
        env.fit()
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">reverse</span>(<span class="org-variable-name">s</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">Sized</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> s {
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(<span class="org-keyword">mut</span> l) =&gt; <span class="org-type">Ok</span>({
            l.reverse();
            l.fit()
        }),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-type">Ok</span>(s.chars().rev().collect::&lt;<span class="org-type">String</span>&gt;().fit()),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; <span class="org-type">Ok</span>(b.into_iter().rev().collect::&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;&gt;().fit()),
        s =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"ordered"</span>, s)),
    }
}

<span class="org-doc">/// The default method of encoding items into byte arrays.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">encode_item</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Bytes</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-keyword">match</span> i {
        <span class="org-type">Item</span>::<span class="org-type">Number</span>(n) =&gt; <span class="org-keyword">match</span> n {
            <span class="org-type">Number</span>::<span class="org-type">Int</span>(i) =&gt; i.to_be_bytes().to_vec(),
            <span class="org-type">Number</span>::<span class="org-type">Float</span>(f) =&gt; f.to_be_bytes().to_vec(),
        },
        <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-preprocessor">vec!</span>[c <span class="org-keyword">as</span> <span class="org-type">u8</span>],
        i =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i.clone());
            <span class="org-keyword">match</span> r {
                <span class="org-type">Ok</span>(s) =&gt; <span class="org-keyword">match</span> s {
                    <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s) =&gt; s.as_bytes().to_vec(),
                    <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; b,
                    <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; <span class="org-type">Bytes</span>::try_derive(l.clone()).unwrap_or_else(|_| {
                        (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l))))
                            .emit()
                            .as_bytes()
                            .to_vec()
                    }),
                    s =&gt; (<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)))
                        .emit()
                        .as_bytes()
                        .to_vec(),
                },
                <span class="org-type">Err</span>(_) =&gt; (<span class="org-rust-ampersand">&amp;</span>i).emit().as_bytes().to_vec(),
            }
        }
    })
}

<span class="org-keyword">fn</span> <span class="org-function-name">string</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">String</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">match</span> i {
        i =&gt; <span class="org-keyword">match</span> <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i.clone()) {
            <span class="org-type">Ok</span>(s) =&gt; {
                <span class="org-keyword">if</span> s.is_empty() {
                    <span class="org-type">Ok</span>(<span class="org-string">""</span>.to_string())
                } <span class="org-keyword">else</span> {
                    <span class="org-keyword">match</span> s {
                        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b) =&gt; <span class="org-type">Ok</span>(<span class="org-constant">std</span>::<span class="org-type">str</span>::from_utf8(<span class="org-rust-ampersand">&amp;</span>b)<span class="org-rust-question-mark">?</span>.to_string()),
                        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; {
                            <span class="org-type">String</span>::try_derive(l.clone()).or_else(|_| <span class="org-type">Ok</span>((<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(l)).emit()))
                        }
                        s =&gt; <span class="org-type">Ok</span>((<span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>::derive(s)).emit()),
                    }
                }
            }
            <span class="org-type">Err</span>(_) =&gt; <span class="org-type">Ok</span>(i.emit()),
        },
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">get_error</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Environment</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Error</span>&gt; {
    env.stack.front().and_then(|i| <span class="org-keyword">match</span> i {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e),
        ))) =&gt; <span class="org-type">Some</span>(e.clone()),
        <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(e),
        ))) =&gt; <span class="org-type">Some</span>(e.clone()),
        _ =&gt; <span class="org-type">None</span>,
    })
}

<span class="org-keyword">fn</span> <span class="org-function-name">unwind</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Environment</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">err</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">handle</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span> = &amp;<span class="org-string">"handle"</span>.fit();

    <span class="org-keyword">let</span> <span class="org-variable-name">err</span> = <span class="org-keyword">match</span> err {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
            <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(<span class="org-keyword">mut</span> e),
        ))) =&gt; {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">next</span> = env.program.front();
            <span class="org-keyword">let</span> <span class="org-variable-name">data</span> = e.data.mutate();
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">unwound_arc</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span> = data
                .remove(&amp;<span class="org-string">"unwound"</span>.fit())
                .unwrap_or_default()
                .try_fit()
                .unwrap_or_else(|_| <span class="org-preprocessor">list!</span>());
            <span class="org-keyword">let</span> <span class="org-variable-name">unwound</span> = unwound_arc.mutate();
            <span class="org-keyword">while</span> next.is_some() &amp;&amp; next.unwrap() != handle {
                <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = env.pop_prog();
                unwound.push_back(i);
                next = env.program.front();
            }
            <span class="org-keyword">if</span> next.is_some() {
                <span class="org-comment-delimiter">// </span><span class="org-comment">didn't unwind the whole program, handled error</span>
                env.pop_prog();
                <span class="org-comment-delimiter">// </span><span class="org-comment">set the is_handled bit</span>
                e.is_handled = <span class="org-keyword">true</span>;
            }
            <span class="org-keyword">let</span> <span class="org-variable-name">em</span> = <span class="org-type">Arc</span>::make_mut(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> e.data);
            em.insert(<span class="org-string">"unwound"</span>.fit(), unwound_arc.fit());
            e.fit()
        }
        i =&gt; i,
    };
    env.push(err);
    env
}

<span class="org-keyword">pub</span> <span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">eval</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Environment</span> {
    <span class="org-keyword">loop</span> {
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(err) = get_error(<span class="org-rust-ampersand">&amp;</span>env) {
            <span class="org-keyword">if</span> !err.is_handled {
                env = unwind(env); <span class="org-comment-delimiter">// </span><span class="org-comment">TODO: this should be done in eval_step</span>
            };
        }
        <span class="org-keyword">if</span> !env.program.is_empty() {
            env = eval_step(env).<span class="org-keyword">await</span>;
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">break</span>;
        }
    }
    env
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">eval_step_outer</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">tos</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">inner_env</span> = <span class="org-type">Environment</span>::try_derive(tos);

    <span class="org-keyword">match</span> inner_env {
        <span class="org-type">Ok</span>(inner) =&gt; {
            env.pop_prog();
            <span class="org-keyword">if</span> inner.program.is_empty() {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                    env.push(<span class="org-type">Item</span>::default());
                    env
                })
            } <span class="org-keyword">else</span> {
                <span class="org-type">Box</span>::pin(eval_step(inner).map(|inner_next| {
                    env.push(inner_next);
                    env
                }))
            }
        }
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(e);
            env.fit()
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">evaluate</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">tos</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">inner_env</span> = <span class="org-type">Environment</span>::try_derive(tos);
    <span class="org-keyword">match</span> inner_env {
        <span class="org-type">Ok</span>(inner) =&gt; <span class="org-type">Box</span>::pin(eval(inner).map(|inner_done| {
            env.pop_prog();
            env.push(inner_done);
            env
        })),
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(e);
            env.fit()
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">identity</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">dictionary</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("adding dictionary");</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">d</span> = env.dictionary.clone();
    env.pop_prog();
    env.push(d);
    env.fit()
}

<span class="org-keyword">fn</span> <span class="org-function-name">sqrt</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i.sqrt())
}

<span class="org-keyword">fn</span> <span class="org-function-name">abs</span>(<span class="org-variable-name">i</span>: <span class="org-type">Number</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Number</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(i.abs())
}

<span class="org-doc">/// If there's an unhandled error on the stack, handle it, otherwise</span>
<span class="org-doc">/// no-op.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">handle</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    <span class="org-keyword">match</span> env.stack.mutate().pop_front() {
        <span class="org-type">None</span> =&gt; {}
        <span class="org-type">Some</span>(i) =&gt; <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(<span class="org-keyword">mut</span> e),
            ))) =&gt; {
                e.is_handled = <span class="org-keyword">true</span>;
                env.push(e);
            }
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(
                <span class="org-constant">assoc</span>::<span class="org-type">Associative</span>::<span class="org-type">Error</span>(<span class="org-keyword">mut</span> e),
            ))) =&gt; {
                e.is_handled = <span class="org-keyword">true</span>;
                env.push(e);
            }
            i =&gt; env.push(i),
        },
    };
    env.fit()
}

<span class="org-doc">/// Makes '&#9989;' a word that doesn't have to be quoted, just pushes</span>
<span class="org-doc">/// itself onto the stack.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">yes</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">t</span> = env.pop_prog();
    env.push(t);
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">fail</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">err</span> = <span class="org-type">Error</span>::try_derive(env.pop())<span class="org-rust-question-mark">?</span>;
    err.is_handled = <span class="org-keyword">false</span>;
    env.pop_prog();
    env.push(err);
    <span class="org-type">Ok</span>(())
}

<span class="org-doc">/// Takes a dictionary diff, merges it into an existing dictionary,</span>
<span class="org-doc">/// with all the changes marked with the given namespace.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">dictmerge</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("dictmerge: {:?}", env);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">modified</span> = <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>::try_derive(env.pop())<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">existing</span> = <span class="org-constant">dict</span>::<span class="org-type">Dictionary</span>::try_derive(env.pop())<span class="org-rust-question-mark">?</span>;

    <span class="org-keyword">let</span> <span class="org-variable-name">ns</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">namespace</span> = <span class="org-constant">dict</span>::<span class="org-type">Namespace</span>::try_derive(ns)<span class="org-rust-question-mark">?</span>;

    existing.merge(modified, <span class="org-rust-ampersand">&amp;</span>namespace);
    <span class="org-comment-delimiter">// </span><span class="org-comment">not sure if this is really needed - was here for use during</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">bootstrapping when some builtins are not yet loaded but need to</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">be</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">if namespace.is_none() {</span>
    <span class="org-comment-delimiter">//     </span><span class="org-comment">env.dictionary.words.add_builtins();</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">}</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">pop the word dictmerge</span>
    env.pop_prog();
    env.push(existing);
    <span class="org-type">Ok</span>(())
}

<span class="org-doc">/// Fetches a binary blob from the cache. The top of stack should be</span>
<span class="org-doc">/// either the hash of the content or its alias (a [Word]).</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">read_blob</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Env: {:?}", env);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">cache</span> = <span class="org-constant">config</span>::<span class="org-type">PlatformConfig</span>::get()<span class="org-rust-question-mark">?</span>.cache;
    <span class="org-keyword">let</span> <span class="org-variable-name">contents</span> = <span class="org-keyword">match</span> env.pop() {
        <span class="org-type">Item</span>::<span class="org-type">Word</span>(alias) =&gt; cache.get(<span class="org-rust-ampersand">&amp;</span><span class="org-constant">cache</span>::<span class="org-type">Key</span>::<span class="org-type">Alias</span>(alias.fit()))<span class="org-rust-question-mark">?</span>,
        i =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">hash</span> = <span class="org-type">Bytes</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
            cache.get(<span class="org-rust-ampersand">&amp;</span><span class="org-constant">cache</span>::<span class="org-type">Key</span>::<span class="org-type">Hash</span>(hash))<span class="org-rust-question-mark">?</span>
        }
    };
    env.pop_prog();
    env.push(contents);
    <span class="org-type">Ok</span>(())
}

<span class="org-doc">/// Writes a given binary object to the cache. Supports [Bytes], and</span>
<span class="org-doc">/// certain kinds of pipes. The top of stack should be the alias to</span>
<span class="org-doc">/// store the contents under, which should be either a [Word] or</span>
<span class="org-doc">/// nothing. If nothing, the object will only be available via its</span>
<span class="org-doc">/// hash. Returns the hash.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">write_blob</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">alias</span> = <span class="org-keyword">match</span> env.pop() {
        <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Some</span>(w.fit()),
        _ =&gt; <span class="org-type">None</span>,
    };
    <span class="org-keyword">match</span> env.pop() {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">cache</span> = <span class="org-constant">config</span>::<span class="org-type">PlatformConfig</span>::get()<span class="org-rust-question-mark">?</span>.cache;
            <span class="org-keyword">let</span> <span class="org-variable-name">hash</span> = cache.put(<span class="org-rust-ampersand">&amp;</span>b, alias)<span class="org-rust-question-mark">?</span>;
            env.push(hash);
            env.pop_prog();
            <span class="org-type">Ok</span>(())
        }
        i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"bytes"</span>, i)),
    }
}

<span class="org-doc">/// Takes an inner environment from the top of the stack, and spawns a</span>
<span class="org-doc">/// tokio task to evaluate that environment.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">animate</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">tos</span> = env.pop();
    <span class="org-keyword">let</span> <span class="org-variable-name">inner_env</span> = <span class="org-type">Environment</span>::try_derive(tos);
    <span class="org-keyword">match</span> inner_env {
        <span class="org-type">Ok</span>(inner) =&gt; {
            env.pop_prog();
            <span class="org-constant">tokio</span>::spawn(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { eval(inner).<span class="org-keyword">await</span> });
            env.fit()
        }
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(e);
            env.fit()
        }
    }
}
<span class="org-keyword">fn</span> <span class="org-function-name">xor_</span>(<span class="org-variable-name">i</span>: <span class="org-type">Bytes</span>, <span class="org-variable-name">j</span>: <span class="org-type">Bytes</span>) -&gt; <span class="org-type">Bytes</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">len</span> = <span class="org-constant">std</span>::<span class="org-constant">cmp</span>::max(i.len(), j.len());
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">result</span> = <span class="org-type">Vec</span>::with_capacity(len);
    <span class="org-keyword">for</span> (byte_i, byte_j) <span class="org-keyword">in</span> i
        .iter()
        .chain(<span class="org-constant">std</span>::<span class="org-constant">iter</span>::repeat(<span class="org-rust-ampersand">&amp;</span>0).take(len - i.len()))
        .zip(j.iter().chain(<span class="org-constant">std</span>::<span class="org-constant">iter</span>::repeat(<span class="org-rust-ampersand">&amp;</span>0).take(len - j.len())))
    {
        result.push(byte_i ^ byte_j);
    }
    result
}
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">xor</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">match</span> (i, j) {
        (<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)), <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(j))) =&gt; {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i ^ j)))
        }
        (
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(i))),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(j))),
        ) =&gt; <span class="org-type">Ok</span>(xor_(i, j).fit()),
        (
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(i))),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(j))),
        ) =&gt; <span class="org-type">Ok</span>(xor_(i, j).fit()),
        (i, j) =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"integers"</span>, pair(i, j))),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">inspect</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">String</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, i))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">timestamps</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    env.push(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Time</span>)));
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">standard</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    env.push(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(
        <span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Standard</span>,
    )));
    env.fit()
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">intersection</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = <span class="org-constant">coll</span>::<span class="org-type">Set</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">j</span> = <span class="org-constant">coll</span>::<span class="org-type">Set</span>::try_derive(j)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">ij</span> = i.intersection(<span class="org-rust-ampersand">&amp;</span>j);
    <span class="org-keyword">let</span> <span class="org-variable-name">h</span> = <span class="org-constant">std</span>::<span class="org-constant">collections</span>::<span class="org-type">HashSet</span>::from_iter(ij.cloned());
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">Set</span>::derive(h).fit())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">compare</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">res</span>(<span class="org-variable-name">r</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">std</span>::<span class="org-constant">cmp</span>::<span class="org-type">Ordering</span>&gt;, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
        <span class="org-keyword">match</span> r {
            <span class="org-type">Some</span>(<span class="org-constant">std</span>::<span class="org-constant">cmp</span>::<span class="org-type">Ordering</span>::<span class="org-type">Less</span>) =&gt; <span class="org-type">Ok</span>(<span class="org-string">"less"</span>.fit()),
            <span class="org-type">Some</span>(<span class="org-constant">std</span>::<span class="org-constant">cmp</span>::<span class="org-type">Ordering</span>::<span class="org-type">Equal</span>) =&gt; <span class="org-type">Ok</span>(<span class="org-string">"equal"</span>.fit()),
            <span class="org-type">Some</span>(<span class="org-constant">std</span>::<span class="org-constant">cmp</span>::<span class="org-type">Ordering</span>::<span class="org-type">Greater</span>) =&gt; <span class="org-type">Ok</span>(<span class="org-string">"greater"</span>.fit()),
            <span class="org-type">None</span> =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"comparable"</span>, pair(i, j))),
        }
    }
    <span class="org-keyword">match</span> (i, j) {
        (<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(fi)), <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(fj))) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = fi.partial_cmp(<span class="org-rust-ampersand">&amp;</span>fj);
            res(r, fi.fit(), fj.fit())
        }
        (<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(fi)), <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(fj))) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = (fi <span class="org-keyword">as</span> <span class="org-type">f64</span>).partial_cmp(<span class="org-rust-ampersand">&amp;</span>fj);
            res(r, fi.fit(), fj.fit())
        }
        (<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(fi)), <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(fj))) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = fi.partial_cmp(<span class="org-rust-ampersand">&amp;</span>(fj <span class="org-keyword">as</span> <span class="org-type">f64</span>));
            res(r, fi.fit(), fj.fit())
        }
        (i, j) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">ki</span> = <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-variable-name">kj</span> = <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive(j)<span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = ki.partial_cmp(<span class="org-rust-ampersand">&amp;</span>kj);
            res(r, ki.fit(), kj.fit())
        }
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">as_pair</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;(<span class="org-type">Item</span>, <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">i</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">im</span> = i.mutate();
    <span class="org-keyword">let</span> <span class="org-variable-name">j</span> = im.pop_front().ok_or(<span class="org-type">Error</span>::short_list(1))<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">k</span> = im
        .pop_front()
        .ok_or(<span class="org-type">Error</span>::short_list(2))
        .and_then(<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::try_derive)<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>((j, k))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">sort_by_key</span>(<span class="org-variable-name">l</span>: <span class="org-constant">coll</span>::<span class="org-type">Sized</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">it</span> = l.into_iter().map(as_pair);
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">it</span> = it.collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;(<span class="org-type">Item</span>, <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>)&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;
    it.sort_unstable_by(|(_, a), (_, b)| a.partial_cmp(b).unwrap_or(<span class="org-constant">std</span>::<span class="org-constant">cmp</span>::<span class="org-type">Ordering</span>::<span class="org-type">Less</span>));
    <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(it.into_iter().map(|(k, _)| k)))
}

<span class="org-keyword">fn</span> <span class="org-function-name">slice</span>(<span class="org-variable-name">arr</span>: <span class="org-type">Item</span>, <span class="org-variable-name">start</span>: <span class="org-type">Item</span>, <span class="org-variable-name">end</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Start: {:?}, End: {:?}", start, end);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">arr</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(arr)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">start</span> = <span class="org-type">Int</span>::try_derive(start)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">end</span> = <span class="org-type">Int</span>::try_derive(end)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">if</span> start &lt; 0 {
        start += arr.count() <span class="org-keyword">as</span> <span class="org-type">i64</span>;
    }
    <span class="org-keyword">if</span> end &lt;= 0 {
        end += arr.count() <span class="org-keyword">as</span> <span class="org-type">i64</span>;
    }
    <span class="org-keyword">if</span> start &lt; 0 {
        <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::negative(start));
    }
    <span class="org-keyword">if</span> end &lt; 0 {
        <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::negative(end));
    }
    <span class="org-keyword">if</span> start &gt; end {
        <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::create(
            <span class="org-preprocessor">list!</span>(<span class="org-string">"&lt;="</span>),
            <span class="org-string">"invalid index range"</span>,
            <span class="org-type">Some</span>(pair(start.fit(), end.fit())),
        ));
    }
    <span class="org-keyword">match</span> arr {
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(arr) =&gt; <span class="org-type">Ok</span>(arr
            .get(start <span class="org-keyword">as</span> <span class="org-type">usize</span>..end <span class="org-keyword">as</span> <span class="org-type">usize</span>)
            .map(|a| a.to_vec())
            .fit()),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(arr) =&gt; <span class="org-type">Ok</span>(arr
            .get(start <span class="org-keyword">as</span> <span class="org-type">usize</span>..end <span class="org-keyword">as</span> <span class="org-type">usize</span>)
            .map(|a| a.to_string())
            .fit()),
        <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(arr) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">owned_subset</span>: <span class="org-type">VecDeque</span>&lt;<span class="org-type">Item</span>&gt; = arr
                .iter()
                .skip(start <span class="org-keyword">as</span> <span class="org-type">usize</span>)
                .take(end <span class="org-keyword">as</span> <span class="org-type">usize</span> - start <span class="org-keyword">as</span> <span class="org-type">usize</span>)
                .cloned()
                .collect();
            <span class="org-type">Ok</span>(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive(owned_subset).fit())
        }
        i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"ordered"</span>, i)),
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">empty</span>(<span class="org-variable-name">s</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(s)<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(s.empty().fit())
}

<span class="org-keyword">fn</span> <span class="org-function-name">format</span>(<span class="org-variable-name">fstr</span>: <span class="org-type">Item</span>, <span class="org-variable-name">items</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">fstr</span> = <span class="org-type">String</span>::try_derive(fstr)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">items</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(items)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">strings</span> = items
        .iter()
        .cloned()
        .map(<span class="org-type">String</span>::try_derive)
        .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">String</span>&gt;, <span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(<span class="org-type">SimpleCurlyFormat</span>
        .format(fstr.as_str(), strings.as_slice())<span class="org-rust-question-mark">?</span>
        .into_owned()
        .fit())
}

<span class="org-keyword">impl</span>&lt;'<span class="org-variable-name">a</span>&gt; <span class="org-type">From</span>&lt;<span class="org-constant">dynfmt</span>::<span class="org-type">Error</span>&lt;'<span class="org-variable-name">a</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">err</span>: <span class="org-constant">dynfmt</span>::<span class="org-type">Error</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"format"</span>), <span class="org-rust-ampersand">&amp;</span>err.to_string(), <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-type">Utf8Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">err</span>: <span class="org-type">Utf8Error</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"decode"</span>), <span class="org-rust-ampersand">&amp;</span>err.to_string(), <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">decode_json</span>(<span class="org-variable-name">s</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-type">String</span>::try_derive(s)<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(<span class="org-constant">serde_json</span>::from_str::&lt;<span class="org-type">Item</span>&gt;(s.as_str())<span class="org-rust-question-mark">?</span>)
}

<span class="org-keyword">fn</span> <span class="org-function-name">encode_json</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::derive(<span class="org-constant">serde_json</span>::to_string(<span class="org-rust-ampersand">&amp;</span>i)<span class="org-rust-question-mark">?</span>))
}

<span class="org-keyword">fn</span> <span class="org-function-name">namespace</span>(<span class="org-variable-name">word</span>: <span class="org-type">Word</span>, <span class="org-variable-name">ns</span>: <span class="org-type">Bytes</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Word</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">word</span> = word;
    word.namespace = <span class="org-type">Some</span>(<span class="org-type">Intern</span>::new(ns));
    <span class="org-type">Ok</span>(word.fit())
}

<span class="org-keyword">fn</span> <span class="org-function-name">unnamespace</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">w</span>: <span class="org-type">Word</span> = env.pop().try_fit().unwrap();
    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(ns) = w.namespace {
        w.namespace = <span class="org-type">None</span>;
        env.push(w);
        env.push(<span class="org-type">Item</span>::derive(ns.as_ref().clone()));
    } <span class="org-keyword">else</span> {
        env.push(w);
        env.push(<span class="org-type">Item</span>::default())
    }
    env.fit()
}

<span class="org-keyword">fn</span> <span class="org-function-name">resolve</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">w</span>: <span class="org-type">Word</span> = env.pop().try_fit().unwrap();

    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(e) = env.dictionary.lingo.get(<span class="org-rust-ampersand">&amp;</span>w) {
        w.namespace = e.namespace.clone();
    }
    env.push(w);
    env.fit()
}

<span class="org-keyword">fn</span> <span class="org-function-name">is_finished</span>(<span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">bool</span>, <span class="org-type">Infallible</span>&gt; {
    <span class="org-type">Ok</span>(env.is_finished())
}

<span class="org-keyword">fn</span> <span class="org-function-name">using</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">namespaces</span>: <span class="org-type">Vec</span>&lt;<span class="org-constant">dict</span>::<span class="org-type">Namespace</span>&gt; = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">inner_env</span>: <span class="org-type">Environment</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    env.pop_prog();
    <span class="org-constant">mem</span>::swap(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> inner_env.dictionary.modules, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> namespaces);
    inner_env.dictionary.modules.extend(namespaces);
    env.push(inner_env);
    <span class="org-type">Ok</span>(())
}

<span class="org-keyword">fn</span> <span class="org-function-name">pack</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">Environment</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">template</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span> = env.pop().try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">last_stack_item_used</span> = 0;

    <span class="org-keyword">fn</span> <span class="org-function-name">stackpoint</span>(<span class="org-variable-name">w</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Option</span>&lt;(<span class="org-type">usize</span>, <span class="org-type">bool</span>)&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-type">String</span>::derive(w.clone());

        <span class="org-comment-delimiter">// </span><span class="org-comment">Define mappings for number emojis</span>
        <span class="org-keyword">const</span> <span class="org-variable-name">NUMBER_EMOJIS</span>: [<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>; 9] = [<span class="org-string">"1&#65039;&#8419;"</span>, <span class="org-string">"2&#65039;&#8419;"</span>, <span class="org-string">"3&#65039;&#8419;"</span>, <span class="org-string">"4&#65039;&#8419;"</span>, <span class="org-string">"5&#65039;&#8419;"</span>, <span class="org-string">"6&#65039;&#8419;"</span>, <span class="org-string">"7&#65039;&#8419;"</span>, <span class="org-string">"8&#65039;&#8419;"</span>, <span class="org-string">"9&#65039;&#8419;"</span>];

        <span class="org-comment-delimiter">// </span><span class="org-comment">Check for splice (scissors + number)</span>
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(rest) = s.strip_prefix(<span class="org-string">"&#9986;&#65039;"</span>) {
            <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(position) = <span class="org-type">NUMBER_EMOJIS</span>.iter().position(|<span class="org-rust-ampersand">&amp;</span>emoji| emoji == rest) {
                <span class="org-keyword">return</span> <span class="org-type">Some</span>((position + 1, <span class="org-keyword">true</span>));
            }
        <span class="org-comment-delimiter">// </span><span class="org-comment">Check for just the number (insert operation)</span>
        } <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(position) = <span class="org-type">NUMBER_EMOJIS</span>.iter().position(|<span class="org-rust-ampersand">&amp;</span>emoji| emoji == s) {
            <span class="org-keyword">return</span> <span class="org-type">Some</span>((position + 1, <span class="org-keyword">false</span>));
        }

        <span class="org-type">None</span>
    }

    <span class="org-doc">/// Takes an accumulator that is a pair of the stack and the</span>
    <span class="org-doc">/// compiled result so far, and then an item to incorporate. If</span>
    <span class="org-doc">/// the item is a template placeholder, inserts or splices the</span>
    <span class="org-doc">/// item from the stack.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">splice</span>(
        <span class="org-variable-name">acc</span>: <span class="org-type">Result</span>&lt;(<span class="org-type">Stack</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">usize</span>, <span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt;), <span class="org-type">Error</span>&gt;,
        <span class="org-variable-name">i</span>: <span class="org-type">Item</span>,
    ) -&gt; <span class="org-type">Result</span>&lt;(<span class="org-type">Stack</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-type">usize</span>, <span class="org-type">Vec</span>&lt;<span class="org-type">Item</span>&gt;), <span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> acc {
            <span class="org-type">Ok</span>((stack, last_stack_item_used, <span class="org-keyword">mut</span> list)) =&gt; <span class="org-keyword">match</span> i {
                <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; {
                    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>((n, is_splice)) = stackpoint(w.clone()) {
                        *last_stack_item_used = max(n, *last_stack_item_used);
                        <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = stack
                            .get(n - 1)
                            .ok_or_else(|| <span class="org-type">Error</span>::list_count(n <span class="org-keyword">as</span> <span class="org-type">Int</span>))
                            .cloned();
                        <span class="org-keyword">match</span> r {
                            <span class="org-type">Ok</span>(item) =&gt; {
                                <span class="org-keyword">if</span> is_splice {
                                    <span class="org-keyword">match</span> item {
                                        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(s)) =&gt; {
                                            list.extend(s)
                                        }
                                        <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(s)) =&gt; {
                                            list.extend(s)
                                        }
                                        i =&gt; <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"sized"</span>, i)),
                                    }
                                } <span class="org-keyword">else</span> {
                                    list.push(item);
                                }
                                <span class="org-type">Ok</span>((stack, last_stack_item_used, list))
                            }
                            <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Err</span>(e),
                        }
                    } <span class="org-keyword">else</span> {
                        list.push(<span class="org-type">Item</span>::<span class="org-type">Word</span>(w.clone()));
                        <span class="org-type">Ok</span>((stack, last_stack_item_used, list))
                    }
                }
                <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l))) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">recurse</span>
                    <span class="org-keyword">let</span> (stack, last_stack_item_used, filled) = l.iter().cloned().fold(
                        <span class="org-type">Ok</span>((stack.clone(), last_stack_item_used, <span class="org-type">Vec</span>::new())),
                        splice,
                    )<span class="org-rust-question-mark">?</span>;
                    list.push(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive(filled).fit());
                    <span class="org-type">Ok</span>((stack, last_stack_item_used, list))
                }
                i =&gt; {
                    list.push(i);
                    <span class="org-type">Ok</span>((stack, last_stack_item_used, list))
                }
            },
            <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Err</span>(e),
        }
    }

    <span class="org-keyword">let</span> (_, last_stack_item_used, filled) = template.iter().cloned().fold(
        <span class="org-type">Ok</span>((env.stack.clone(), <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> last_stack_item_used, <span class="org-type">Vec</span>::new())),
        splice,
    )<span class="org-rust-question-mark">?</span>;
    env.pop_prog();
    <span class="org-comment-delimiter">// </span><span class="org-comment">pop all the used items</span>
    <span class="org-keyword">for</span> <span class="org-variable-name">_</span> <span class="org-keyword">in</span> 0..*last_stack_item_used {
        env.pop();
    }
    env.push(<span class="org-constant">coll</span>::<span class="org-type">List</span>::derive(filled));
    <span class="org-type">Ok</span>(())
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org18c6b15" class="outline-4">
<h4 id="org18c6b15"><span class="section-number-4">1.5.6.</span> Top level library</h4>
<div class="outline-text-4" id="text-1-5-6">
<p>
Here is the top level for using kcats as a library, either in another
rust project or some other language through FFI.
</p>

<div class='tangle-wrapper' data-tangle='src/lib.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">axiom</span>;
<span class="org-keyword">mod</span> <span class="org-constant">crypto</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">serialize</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">traits</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">types</span>;

<span class="org-preprocessor">#[cfg(target_os = </span><span class="org-string">"android"</span><span class="org-preprocessor">)]</span>
<span class="org-keyword">mod</span> <span class="org-constant">android</span> {
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">config</span>::<span class="org-type">PlatformConfig</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::{<span class="org-keyword">self</span>, <span class="org-type">Emit</span>};
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">environment</span>::<span class="org-type">Environment</span>;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">ffi</span>::<span class="org-type">CString</span>;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">path</span>::<span class="org-type">PathBuf</span>;

    <span class="org-keyword">use</span> <span class="org-constant">cache</span>::cache;
    <span class="org-keyword">use</span> <span class="org-constant">jni</span>::<span class="org-constant">objects</span>::{<span class="org-type">JClass</span>, <span class="org-type">JString</span>};
    <span class="org-keyword">use</span> <span class="org-constant">jni</span>::<span class="org-constant">sys</span>::jstring;
    <span class="org-keyword">use</span> <span class="org-constant">jni</span>::<span class="org-type">JNIEnv</span>;
    <span class="org-keyword">use</span> <span class="org-constant">libc</span>::c_char <span class="org-keyword">as</span> lc_char;
    <span class="org-keyword">use</span> <span class="org-constant">once_cell</span>::<span class="org-constant">sync</span>::<span class="org-type">Lazy</span>;
    <span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">runtime</span>::<span class="org-type">Runtime</span>;

    <span class="org-keyword">static</span> <span class="org-variable-name">RUNTIME</span>: <span class="org-type">Lazy</span>&lt;<span class="org-type">Runtime</span>&gt; =
        <span class="org-type">Lazy</span>::new(|| <span class="org-type">Runtime</span>::new().expect(<span class="org-string">"Failed to create Tokio runtime"</span>));

    <span class="org-preprocessor">#[link(name = </span><span class="org-string">"log"</span><span class="org-preprocessor">)]</span>
    <span class="org-keyword">extern</span> <span class="org-string">"C"</span> {
        <span class="org-keyword">fn</span> <span class="org-function-name">__android_log_print</span>(<span class="org-variable-name">prio</span>: <span class="org-type">i32</span>, <span class="org-variable-name">tag</span>: *<span class="org-keyword">const</span> lc_char, <span class="org-variable-name">fmt</span>: *<span class="org-keyword">const</span> lc_char, ...) -&gt; <span class="org-type">i32</span>;
    }

    <span class="org-keyword">const</span> <span class="org-variable-name">ANDROID_LOG_INFO</span>: <span class="org-type">i32</span> = 4;

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">log</span>(<span class="org-variable-name">message</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) {
        <span class="org-keyword">let</span> <span class="org-variable-name">tag</span> = <span class="org-type">CString</span>::new(<span class="org-string">"kcats"</span>).unwrap();
        <span class="org-keyword">let</span> <span class="org-variable-name">message</span> = <span class="org-type">CString</span>::new(message).unwrap();

        <span class="org-rust-unsafe">unsafe</span> {
            __android_log_print(<span class="org-type">ANDROID_LOG_INFO</span>, tag.as_ptr(), message.as_ptr());
        }
    }

    <span class="org-preprocessor">#[no_mangle]</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">extern</span> <span class="org-string">"system"</span> <span class="org-keyword">fn</span> <span class="org-type">Java_org_skyrod_subverse_MainActivity_kcatsEval</span>&lt;'<span class="org-variable-name">local</span>&gt;(
        <span class="org-keyword">mut</span> <span class="org-variable-name">jnienv</span>: <span class="org-type">JNIEnv</span>&lt;'<span class="org-variable-name">local</span>&gt;,
        <span class="org-variable-name">_class</span>: <span class="org-type">JClass</span>&lt;'<span class="org-variable-name">local</span>&gt;,
        <span class="org-variable-name">env</span>: *<span class="org-keyword">mut</span> <span class="org-type">Environment</span>,
        <span class="org-variable-name">program</span>: <span class="org-type">JString</span>,
    ) -&gt; jstring {
        log(<span class="org-string">"Starting eval"</span>);
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">program</span>: <span class="org-type">String</span> = jnienv
            .get_string(<span class="org-rust-ampersand">&amp;</span>program)
            .expect(<span class="org-string">"Couldn't get java string!"</span>)
            .into();
        <span class="org-comment-delimiter">// </span><span class="org-comment">to ensure errors are handled by the repl- so that the</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">user can continue with more input.</span>
        program.push_str(<span class="org-string">" handle"</span>);

        log(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Got program </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, program).as_str());
        <span class="org-keyword">if</span> env.is_null() {
            <span class="org-keyword">return</span> jnienv
                .new_string(<span class="org-string">"Invalid environment pointer"</span>)
                .unwrap()
                .as_raw();
        }

        log(<span class="org-string">"Taking pointer ownership"</span>);
        <span class="org-comment-delimiter">// </span><span class="org-comment">Take ownership of the Environment</span>
        <span class="org-rust-unsafe">unsafe</span> {
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env_val</span> = <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::read(env);
            log(<span class="org-string">"Parsing input"</span>);
            <span class="org-keyword">match</span> <span class="org-constant">serialize</span>::parse_input(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env_val, program) {
                <span class="org-type">Ok</span>(_) =&gt; {
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Execute the eval and re-assign the result back to the env pointer</span>
                    log(<span class="org-string">"Executing environment"</span>);
                    env_val = <span class="org-type">RUNTIME</span>.block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { <span class="org-constant">axiom</span>::eval(env_val).<span class="org-keyword">await</span> });
                    log(<span class="org-string">"Formatting result"</span>);
                    <span class="org-keyword">let</span> <span class="org-variable-name">result</span> =
                        <span class="org-constant">serialize</span>::auto_format(env_val.stack.iter().emit().as_str(), 20, 80);
                    <span class="org-comment-delimiter">// </span><span class="org-comment">Write the updated environment back to the pointer</span>
                    <span class="org-constant">std</span>::<span class="org-constant">ptr</span>::write(env, env_val);

                    <span class="org-comment-delimiter">// </span><span class="org-comment">Convert the evaluation result back to a C string</span>
                    jnienv.new_string(result).unwrap().as_raw()
                }
                <span class="org-type">Err</span>(e) =&gt; jnienv
                    .new_string(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Error: </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, e))
                    .unwrap()
                    .as_raw(),
            }
        }
    }

    <span class="org-preprocessor">#[no_mangle]</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">extern</span> <span class="org-string">"system"</span> <span class="org-keyword">fn</span> <span class="org-type">Java_org_skyrod_subverse_MainActivity_kcatsNew</span>&lt;'<span class="org-variable-name">local</span>&gt;(
        <span class="org-keyword">mut</span> <span class="org-variable-name">jnienv</span>: <span class="org-type">JNIEnv</span>&lt;'<span class="org-variable-name">local</span>&gt;,
        <span class="org-variable-name">_class</span>: <span class="org-type">JClass</span>&lt;'<span class="org-variable-name">local</span>&gt;,
        <span class="org-variable-name">cachepath</span>: <span class="org-type">JString</span>,
        <span class="org-variable-name">dbfile</span>: <span class="org-type">JString</span>,
    ) -&gt; *<span class="org-keyword">mut</span> <span class="org-type">Environment</span> {
        <span class="org-comment-delimiter">//</span><span class="org-comment">set panic hook to log panics</span>
        <span class="org-constant">std</span>::<span class="org-constant">panic</span>::set_hook(<span class="org-type">Box</span>::new(|panic_info| {
            <span class="org-comment-delimiter">// </span><span class="org-comment">Log panic info</span>
            log(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Rust panic: </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, panic_info).as_str());
        }));

        log(<span class="org-string">"creating new kcats env"</span>);
        <span class="org-keyword">let</span> <span class="org-variable-name">cacheloc</span>: <span class="org-type">String</span> = jnienv
            .get_string(<span class="org-rust-ampersand">&amp;</span>cachepath)
            .expect(<span class="org-string">"Couldn't get java string!"</span>)
            .into();
        log(<span class="org-string">"creating new cache"</span>);
        <span class="org-keyword">let</span> <span class="org-variable-name">cache</span> = <span class="org-constant">cache</span>::<span class="org-type">Cache</span>::new(<span class="org-type">PathBuf</span>::from(cacheloc)).expect(<span class="org-string">"Valid cache location"</span>);
        <span class="org-keyword">let</span> <span class="org-variable-name">dbloc</span>: <span class="org-type">String</span> = jnienv
            .get_string(<span class="org-rust-ampersand">&amp;</span>dbfile)
            .expect(<span class="org-string">"Couldn't get java string!"</span>)
            .into();
        log(<span class="org-string">"setting platform config"</span>);

        <span class="org-keyword">let</span> <span class="org-variable-name">result</span> = <span class="org-constant">std</span>::<span class="org-constant">panic</span>::catch_unwind(|| {
            <span class="org-comment-delimiter">// </span><span class="org-comment">Your potentially panicking code here</span>

            <span class="org-type">PlatformConfig</span>::init(<span class="org-type">PathBuf</span>::from(dbloc), cache).expect(<span class="org-string">"Failed platform init"</span>);
            <span class="org-type">Box</span>::into_raw(<span class="org-type">Box</span>::new(<span class="org-type">Environment</span>::default()))
        });

        <span class="org-keyword">match</span> result {
            <span class="org-type">Ok</span>(value) =&gt; <span class="org-keyword">return</span> value,
            <span class="org-type">Err</span>(e) =&gt; {
                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(s) = e.downcast_ref::&lt;<span class="org-type">String</span>&gt;() {
                    log(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Panic occurred: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, s).as_str());
                } <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(s) = e.downcast_ref::&lt;<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>&gt;() {
                    log(<span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"Panic occurred: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, s).as_str());
                }
                <span class="org-comment-delimiter">// </span><span class="org-comment">Handle the panic</span>
            }
        }
        <span class="org-preprocessor">panic!</span>(<span class="org-string">"uh oh"</span>);
    }

    <span class="org-preprocessor">#[no_mangle]</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">extern</span> <span class="org-string">"C"</span> <span class="org-keyword">fn</span> <span class="org-type">Java_org_skyrod_subverse_MainActivity_katsFree</span>(<span class="org-variable-name">env</span>: *<span class="org-keyword">mut</span> <span class="org-type">Environment</span>) {
        log(<span class="org-string">"FREE"</span>);
        <span class="org-keyword">if</span> !env.is_null() {
            <span class="org-rust-unsafe">unsafe</span> {
                drop(<span class="org-type">Box</span>::from_raw(env));
            }
        }
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">config</span> {
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-type">Item</span>;
    <span class="org-keyword">use</span> <span class="org-constant">cache</span>::cache;
    <span class="org-keyword">use</span> <span class="org-constant">directories</span>::<span class="org-type">ProjectDirs</span>;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">path</span>::<span class="org-type">Path</span>;

    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">path</span>::<span class="org-type">PathBuf</span>;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;

    <span class="org-keyword">use</span> <span class="org-constant">lazy_static</span>::lazy_static;
    <span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">RwLock</span>;

    <span class="org-preprocessor">lazy_static!</span> {
        <span class="org-keyword">pub</span> <span class="org-keyword">static</span> <span class="org-keyword">ref</span> <span class="org-variable-name">PLATFORM_CONFIG</span>: <span class="org-type">RwLock</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">PlatformConfig</span>&gt;&gt; = {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Creating PLATFORM_CONFIG at {}:{}", file!(), line!());</span>
            <span class="org-type">RwLock</span>::new(<span class="org-type">None</span>)
        };
    }

    <span class="org-doc">/// A configuration struct for the platform we're running on,</span>
    <span class="org-doc">/// specifies where some filesystem resources are located. On some</span>
    <span class="org-doc">/// platforms (like android) we can't guess and will only know at</span>
    <span class="org-doc">/// runtime.</span>
    <span class="org-preprocessor">#[derive(Clone, Debug)]</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">PlatformConfig</span> {
        <span class="org-keyword">pub</span> <span class="org-variable-name">database</span>: <span class="org-type">Option</span>&lt;<span class="org-type">Arc</span>&lt;<span class="org-type">PathBuf</span>&gt;&gt;,
        <span class="org-keyword">pub</span> <span class="org-variable-name">cache</span>: <span class="org-type">Arc</span>&lt;<span class="org-constant">cache</span>::<span class="org-type">Cache</span>&gt;,
    }

    <span class="org-keyword">impl</span> <span class="org-type">PlatformConfig</span> {
        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">init</span>(<span class="org-variable-name">database</span>: <span class="org-type">PathBuf</span>, <span class="org-variable-name">cache</span>: <span class="org-constant">cache</span>::<span class="org-type">Cache</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt; {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Initializing with {:?} and {:?}", database, cache);</span>
            <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">config</span> = <span class="org-type">PLATFORM_CONFIG</span>.write().unwrap();
            *config = <span class="org-type">Some</span>(<span class="org-type">PlatformConfig</span> {
                <span class="org-variable-name">database</span>: <span class="org-type">Some</span>(<span class="org-type">Arc</span>::new(database)),
                <span class="org-variable-name">cache</span>: <span class="org-type">Arc</span>::new(cache),
            });
            <span class="org-type">Ok</span>(())
        }

        <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get</span>() -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">PlatformConfig</span>, <span class="org-type">Error</span>&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">config</span> = <span class="org-type">PLATFORM_CONFIG</span>.read().unwrap();
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Getting platform config: {:?}", config);</span>
            config
                .as_ref()
                .ok_or(<span class="org-type">Error</span>::expected(<span class="org-string">"initialization"</span>, <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;))
                .map(|c| c.clone())
        }
    }
    <span class="org-doc">/// If we call this function it's because kcats is running as a binary</span>
    <span class="org-doc">/// and we can figure out storage locations without outside input.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">configure_platform</span>() {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Configure platform");</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">project_dirs</span> = <span class="org-type">ProjectDirs</span>::from(<span class="org-string">"org"</span>, <span class="org-string">"skyrod"</span>, <span class="org-string">"kcats"</span>).unwrap();
        <span class="org-keyword">let</span> <span class="org-variable-name">project_dir</span> = project_dirs.data_dir();
        <span class="org-constant">std</span>::<span class="org-constant">fs</span>::create_dir_all(project_dir).unwrap();
        <span class="org-keyword">let</span> <span class="org-variable-name">db_file</span> = project_dir.join(<span class="org-string">"kcats-database.db"</span>);

        <span class="org-keyword">let</span> <span class="org-variable-name">cache_dir</span> = <span class="org-type">ProjectDirs</span>::from(<span class="org-string">"org"</span>, <span class="org-string">"skyrod"</span>, <span class="org-string">"kcats"</span>)
            .map(|proj_dirs| proj_dirs.data_dir().join(<span class="org-string">"cache"</span>))
            .unwrap_or_else(|| <span class="org-type">Path</span>::new(<span class="org-string">"."</span>).join(<span class="org-string">"cache"</span>));

        <span class="org-type">PlatformConfig</span>::init(db_file, <span class="org-constant">cache</span>::<span class="org-type">Cache</span>::new(cache_dir).unwrap()).unwrap();
    }
}

<span class="org-preprocessor">#[cfg(test)]</span>
<span class="org-keyword">mod</span> <span class="org-constant">tests</span> {
    <span class="org-doc">//! Unit tests, in the form of all the examples of usage of the</span>
    <span class="org-doc">//! different lexicon words. Examples are all in the form of two</span>
    <span class="org-doc">//! programs that should be equivalent, something like `2 3 +` and</span>
    <span class="org-doc">//! `5`. Runs both programs in separate environments, compares the</span>
    <span class="org-doc">//! resulting stack to ensure they are equal.</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">Note this useful idiom: importing names from outer (for mod tests) scope.</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">use super::error::Error;</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">use super::*;</span>
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Emit</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> coll;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-type">Ordered</span>;
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-constant">environment</span>::<span class="org-type">Environment</span>, <span class="org-constant">error</span>::<span class="org-type">Error</span>};
    <span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-type">Item</span>, <span class="org-type">Word</span>};

    <span class="org-keyword">use</span> <span class="org-constant">test_case</span>::test_case;

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">get_item</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-constant">coll</span>::<span class="org-type">List</span>, <span class="org-variable-name">index</span>: <span class="org-type">usize</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt; {
        i.get(index).cloned()
    }

    <span class="org-preprocessor">#[tokio::main]</span>
    <span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">test_example</span>(
        <span class="org-keyword">mut</span> <span class="org-variable-name">prog_env</span>: <span class="org-type">Environment</span>,
        <span class="org-variable-name">program</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>,
        <span class="org-variable-name">expected</span>: <span class="org-constant">coll</span>::<span class="org-type">List</span>,
        <span class="org-variable-name">description</span>: <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt;,
    ) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">exp_env</span> = prog_env.clone();
        prog_env.program.prepend(program.clone());
        exp_env.program.prepend(expected.clone());

        <span class="org-keyword">let</span> <span class="org-variable-name">p_fut</span> = <span class="org-constant">tokio</span>::spawn(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { <span class="org-constant">axiom</span>::eval(prog_env).<span class="org-keyword">await</span> });

        <span class="org-keyword">let</span> <span class="org-variable-name">exp_fut</span> = <span class="org-constant">tokio</span>::spawn(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { <span class="org-constant">axiom</span>::eval(exp_env).<span class="org-keyword">await</span> });
        <span class="org-keyword">let</span> (prog_env, exp_env) = <span class="org-constant">tokio</span>::<span class="org-preprocessor">join!</span>(p_fut, exp_fut);
        <span class="org-keyword">let</span> <span class="org-variable-name">prog_env</span> = prog_env.unwrap();
        <span class="org-keyword">let</span> <span class="org-variable-name">exp_env</span> = exp_env.unwrap();

        <span class="org-keyword">if</span> prog_env.stack == exp_env.stack {
            <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(description) = description {
                <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"PASSED: '</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">'"</span>, description);
            } <span class="org-keyword">else</span> {
                <span class="org-rust-builtin-formatting-macro">println!</span>(
                    <span class="org-string">"PASSED: expected </span><span class="org-rust-string-interpolation">{}</span><span class="org-string"> got </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>,
                    (exp_env.stack.iter().emit()),
                    (prog_env.stack.iter().emit())
                );
            }
            <span class="org-type">None</span>
        } <span class="org-keyword">else</span> {
            <span class="org-rust-builtin-formatting-macro">println!</span>(
                <span class="org-string">"\nFAILED: '</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">'\nEXPECTED: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">\nACTUAL:   </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">\n"</span>,
                description.unwrap_or_default(),
                (exp_env.stack.iter().emit()),
                (prog_env.stack.iter().emit())
            );
            <span class="org-comment-delimiter">// </span><span class="org-comment">println!(</span>
            <span class="org-comment-delimiter">//     </span><span class="org-comment">"Debug: expected {:?} got {:?}",</span>
            <span class="org-comment-delimiter">//     </span><span class="org-comment">exp_env.stack, prog_env.stack</span>
            <span class="org-comment-delimiter">// </span><span class="org-comment">);</span>
            <span class="org-type">Some</span>(<span class="org-type">Error</span>::test_assertion(program, expected, prog_env.stack))
        }
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">test_word</span>(<span class="org-variable-name">standard_env</span>: <span class="org-type">Environment</span>, <span class="org-variable-name">w</span>: <span class="org-type">Word</span>) -&gt; <span class="org-type">Vec</span>&lt;<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(d) = standard_env.dictionary.lingo.get(<span class="org-rust-ampersand">&amp;</span>w.clone().fit()) {
            d.examples
                .clone()
                .unwrap()
                .iter()
                .filter_map(|ex| {
                    <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(ex.clone()).unwrap();
                    <span class="org-keyword">let</span> <span class="org-variable-name">p</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(get_item(<span class="org-rust-ampersand">&amp;</span>l, 0).unwrap());
                    <span class="org-keyword">let</span> <span class="org-variable-name">exp</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(get_item(<span class="org-rust-ampersand">&amp;</span>l, 1).unwrap());
                    <span class="org-keyword">let</span> <span class="org-variable-name">description</span> = get_item(<span class="org-rust-ampersand">&amp;</span>l, 2).and_then(|i| <span class="org-type">String</span>::try_derive(i).ok());
                    <span class="org-keyword">match</span> (p, exp) {
                        (<span class="org-type">Ok</span>(p), <span class="org-type">Ok</span>(exp)) =&gt; test_example(standard_env.clone(), p, exp, description),
                        (<span class="org-type">Err</span>(e), _) =&gt; <span class="org-type">Some</span>(e),
                        (_, <span class="org-type">Err</span>(e)) =&gt; <span class="org-type">Some</span>(e),
                    }
                })
                .collect::&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">Error</span>&gt;&gt;()
        } <span class="org-keyword">else</span> {
            <span class="org-preprocessor">vec!</span>[<span class="org-type">Error</span>::create(
                <span class="org-preprocessor">list!</span>(<span class="org-string">"dictionary"</span>, <span class="org-preprocessor">list!</span>(w.clone()), <span class="org-string">"lookup"</span>),
                <span class="org-string">"word is not defined"</span>,
                <span class="org-type">None</span>::&lt;<span class="org-type">Item</span>&gt;,
            )]
        }
    }

    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"+"</span><span class="org-preprocessor"> ; </span><span class="org-string">"plus"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"-"</span><span class="org-preprocessor"> ; </span><span class="org-string">"minus"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"="</span><span class="org-preprocessor"> ; </span><span class="org-string">"eq"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&gt;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"gt"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&gt;="</span><span class="org-preprocessor"> ; </span><span class="org-string">"gte"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&lt;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"lt"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&lt;="</span><span class="org-preprocessor"> ; </span><span class="org-string">"lte"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"*"</span><span class="org-preprocessor"> ; </span><span class="org-string">"mult"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"/"</span><span class="org-preprocessor"> ; </span><span class="org-string">"divide"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"abs"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"addmethod"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"and"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128227;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_any"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"assemble"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"assign"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"association"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"association?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_association"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"bail"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"bailer"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"bits"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"both?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_both"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"both"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8596;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"branch"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"butlast"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"bytes?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_bytes"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"catcher"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"ceiling"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"character"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128101;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"clone"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#128101;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"clonedown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#8226;&#128101;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"clonedeep"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"collect"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"compare"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"compare-by"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#127917;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"complement"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"contains?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"contains"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128207;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"count"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"cram"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"cut"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"dec"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"decide"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"decodejson"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"definition"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129668;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dip"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#129668;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dipdown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#8226;&#129668;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dipdeep"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128011;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dive"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#128011;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"divedown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#8226;&#128011;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"divedeep"</span><span class="org-preprocessor">)]</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">#[test_case("draft")]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128465;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"drop"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#128465;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dropdown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#8226;&#128465;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"dropdeep"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"dropper"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"each"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"emit"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"ends?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_ends"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"encode"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"encodejson"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"encodeitem"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"environment"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"environment?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_environment"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"evaluate"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"eval-step"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"even?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_even"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129510;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"evert"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128175;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_every"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#9654;&#65039;"</span><span class="org-preprocessor">; </span><span class="org-string">"execute"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"exp"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129522;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"filter"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"finished?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_finished"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"first"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"flatten"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"flip"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128735;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"float"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"floor"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"fold"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"format"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"frequencies"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"future"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"get"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"group"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"hashbytes"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#9878;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"_if"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"inc"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"indexed"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"indexer"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"indexof"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128137;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"inject"</span><span class="org-preprocessor">)]</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">#[test_case("inscribe")]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"integer?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_integer"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"intersection"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129529;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"into"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128279;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"join"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"keep"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"label"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"let"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"list?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_list"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128269;"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#127744;"</span><span class="org-preprocessor">; </span><span class="org-string">"_loop"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"log"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128668;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"map"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"max"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"max-by"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"min"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"min-by"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"mod"</span><span class="org-preprocessor">)]</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">#[test_case("module")]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#9775;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"not"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"empty?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_empty"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"namespace"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"number"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"number?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_number"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"odd?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_odd"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"or"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"over"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#127890;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"pack"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"pad"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"pair?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_pair"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"parse"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"parse-edn"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"parse-utf8"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"partition"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"pipe?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_pipe"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128238;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"put"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"prepend"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"primrec"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"produce"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"radix"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"range"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"reap"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129657;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"recovery"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129670;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"recur"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"repetition"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"rest"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"resolve"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"restore"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"retry"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"reverse"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"round"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"set"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"set?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_set"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128737;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"shield"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#128737;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"shielddown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#8226;&#128737;&#65039;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"shielddeep"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#9875;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"sink"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"skipper"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"slice"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128248;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"snapshot"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"something?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_something"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"sqrt"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"starts?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_starts"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#129692;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"step"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"string"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"string?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_string"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"spawn"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"splitter"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128256;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"swap"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#8226;&#128256;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"swapdown"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#128228;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"take"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"taker"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"times"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"type"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"unassign"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"under"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"unnamespace"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"until"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#127851;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"unwrap"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"update"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"value"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"walk"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"when"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#9203;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"_while"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"within?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_within"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"word"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"word?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_word"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"&#127873;"</span><span class="org-preprocessor"> ; </span><span class="org-string">"wrap"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"xor"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"zero?"</span><span class="org-preprocessor"> ; </span><span class="org-string">"is_zero"</span><span class="org-preprocessor">)]</span>
    <span class="org-preprocessor">#[test_case(</span><span class="org-string">"zip"</span><span class="org-preprocessor">)]</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">test_lexicon</span>(<span class="org-variable-name">word</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>) {
        <span class="org-keyword">crate</span>::<span class="org-constant">config</span>::configure_platform();
        <span class="org-keyword">let</span> <span class="org-variable-name">e</span> = <span class="org-type">Environment</span>::default();

        <span class="org-keyword">let</span> <span class="org-variable-name">r</span> = test_word(e.clone(), word.fit());
        <span class="org-preprocessor">assert!</span>(r.is_empty(), <span class="org-string">"{:?}"</span>, r);
    }
}
</pre>
</div></div>
</div>
</div>
<div id="outline-container-org5c0639a" class="outline-4">
<h4 id="org5c0639a"><span class="section-number-4">1.5.7.</span> Top level execution</h4>
<div class="outline-text-4" id="text-1-5-7">
<p>
We'll define the main module which reads input for the kcats
interpreter process, and prints output.
</p>

<p>
We'll also define how to run unit tests.
</p>
<div class='tangle-wrapper' data-tangle='src/main.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-doc">//! The main kcats module, that executes the kcats interpreter. See [main]</span>
<span class="org-comment-delimiter">//</span><span class="org-comment">mod default;</span>

<span class="org-keyword">use</span> <span class="org-constant">kcats</span>::axiom;
<span class="org-keyword">use</span> <span class="org-constant">kcats</span>::<span class="org-constant">config</span>::configure_platform;
<span class="org-keyword">use</span> <span class="org-constant">kcats</span>::<span class="org-constant">serialize</span>::{<span class="org-keyword">self</span>, <span class="org-type">Emit</span>};
<span class="org-keyword">pub</span> <span class="org-keyword">use</span> <span class="org-constant">kcats</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-constant">kcats</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">environment</span>::<span class="org-type">Environment</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">io</span>::{<span class="org-keyword">self</span>, <span class="org-type">BufRead</span>, <span class="org-type">Read</span>, <span class="org-type">Write</span>};

<span class="org-keyword">fn</span> <span class="org-function-name">print_result</span>(<span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) {
    <span class="org-keyword">if</span> env.program.is_empty() {
        <span class="org-rust-builtin-formatting-macro">println!</span>(
            <span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>,
            <span class="org-constant">serialize</span>::auto_format(env.stack.iter().emit().as_str(), 20, 80)
        );
    } <span class="org-keyword">else</span> {
        <span class="org-rust-builtin-formatting-macro">println!</span>(
            <span class="org-string">"stack: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">\nprogram: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>,
            <span class="org-constant">serialize</span>::auto_format(env.stack.iter().emit().as_str(), 20, 80),
            <span class="org-constant">serialize</span>::auto_format(env.program.iter().emit().as_str(), 20, 80)
        )
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">get_stdin</span>() -&gt; <span class="org-type">String</span> {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buf</span> = <span class="org-type">String</span>::new();
    <span class="org-keyword">for</span> <span class="org-variable-name">line</span> <span class="org-keyword">in</span> <span class="org-constant">io</span>::stdin().lock().lines() {
        buf.push_str(<span class="org-rust-ampersand">&amp;</span>line.unwrap());
        buf.push(<span class="org-string">'\n'</span>);
    }
    buf
}

<span class="org-doc">/// Evaluates the program in the context of the env, and handles any</span>
<span class="org-doc">/// unhandled errors. Good for interactive programming.</span>
<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">repl_eval</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>, <span class="org-keyword">mut</span> <span class="org-variable-name">program</span>: <span class="org-type">String</span>) -&gt; <span class="org-type">Environment</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">to ensure errors are handled by the repl- so that the</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">user can continue with more input.</span>
    program.push_str(<span class="org-string">" handle"</span>);

    <span class="org-keyword">match</span> <span class="org-constant">serialize</span>::parse_input(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env, program) {
        <span class="org-type">Ok</span>(_) =&gt; <span class="org-constant">axiom</span>::eval(env).<span class="org-keyword">await</span>,
        <span class="org-type">Err</span>(e) =&gt; {
            env.push(e);
            env
        }
    }
}
<span class="org-comment-delimiter">// </span><span class="org-comment">A function that takes a handle to stdin. It reads a length from</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">stdin, then reads that many bytes and returns a string.</span>
<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">read_input</span>() -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">String</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">spawn a thread to read from stdin</span>
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Reading input");</span>
    <span class="org-constant">tokio</span>::spawn(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">stdin</span> = <span class="org-constant">io</span>::stdin().lock();
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buf</span> = <span class="org-type">String</span>::new();
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Err</span>(e) = stdin.read_line(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> buf) {
            <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Error reading content length </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, e);
            <span class="org-keyword">return</span> <span class="org-type">None</span>;
        }
        <span class="org-comment-delimiter">// </span><span class="org-comment">parse an integer from buf</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">read_len</span> = buf.trim();
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Read length {}", read_len);</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">len</span> = read_len.parse::&lt;<span class="org-type">usize</span>&gt;().unwrap_or_default();
        <span class="org-keyword">if</span> len == 0 {
            <span class="org-keyword">return</span> <span class="org-type">None</span>;
        }
        <span class="org-comment-delimiter">// </span><span class="org-comment">read len bytes from stdin</span>
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buf</span> = <span class="org-preprocessor">vec!</span>[0; len];
        stdin.read_exact(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> buf).unwrap();

        <span class="org-comment-delimiter">// </span><span class="org-comment">convert the bytes to a string</span>
        <span class="org-type">Some</span>(<span class="org-type">String</span>::from_utf8(buf).unwrap())
    })
    .<span class="org-keyword">await</span>
    .unwrap()
}

<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">print_with_length</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Environment</span>) {
    <span class="org-keyword">let</span> <span class="org-variable-name">result</span> = <span class="org-constant">serialize</span>::auto_format(env.stack.iter().emit().as_str(), 20, 80);

    <span class="org-comment-delimiter">// </span><span class="org-comment">first print the length of the result</span>
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">\n</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, result.len(), result);
}

<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">print</span>(<span class="org-variable-name">env</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Environment</span>) {
    <span class="org-keyword">let</span> <span class="org-variable-name">result</span> = <span class="org-constant">serialize</span>::auto_format(env.stack.iter().emit().as_str(), 20, 80);
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, result);
}

<span class="org-comment-delimiter">//</span><span class="org-comment">It converts the bytes to a</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">string, and then evaluates that string as a kcats program. It then</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">prints the length of the result, and then the result itself.</span>
<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">interactive_mode</span>() {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env</span> = <span class="org-type">Environment</span>::default();

    <span class="org-keyword">loop</span> {
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(program) = read_input().<span class="org-keyword">await</span> {
            env = repl_eval(env, program).<span class="org-keyword">await</span>;
            print_with_length(<span class="org-rust-ampersand">&amp;</span>env).<span class="org-keyword">await</span>;
        }
    }
}

<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">repl</span>() {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env</span> = <span class="org-type">Environment</span>::default();

    <span class="org-keyword">loop</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Print the prompt and flush it to stdout immediately</span>
        <span class="org-rust-builtin-formatting-macro">print!</span>(<span class="org-string">"kcats&gt; "</span>);
        <span class="org-constant">io</span>::stdout().flush().unwrap();

        <span class="org-comment-delimiter">// </span><span class="org-comment">Read a line from stdin</span>
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">line</span> = <span class="org-type">String</span>::new();
        <span class="org-constant">io</span>::stdin().read_line(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> line).unwrap();

        <span class="org-comment-delimiter">// </span><span class="org-comment">Check if the input is empty, if so, continue to the next loop iteration</span>
        <span class="org-keyword">if</span> line.trim().is_empty() {
            <span class="org-keyword">continue</span>;
        }

        env = repl_eval(env, line).<span class="org-keyword">await</span>;
        print(<span class="org-rust-ampersand">&amp;</span>env).<span class="org-keyword">await</span>;
    }
}

<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">read_eval_print</span>(<span class="org-variable-name">program</span>: <span class="org-type">String</span>) {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">env</span> = <span class="org-type">Environment</span>::default();
    <span class="org-keyword">match</span> <span class="org-constant">serialize</span>::parse_input(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> env, program) {
        <span class="org-type">Ok</span>(_) =&gt; {
            print_result(<span class="org-constant">axiom</span>::eval(env).<span class="org-keyword">await</span>);
        }
        <span class="org-type">Err</span>(e) =&gt; {
            <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Error parsing input: </span><span class="org-rust-string-interpolation">{:?}</span><span class="org-string">"</span>, e);
        }
    }
}

<span class="org-doc">/// The main intepreter entry function that can start the interpreter</span>
<span class="org-doc">/// in several different modes.</span>
<span class="org-preprocessor">#[tokio::main]</span>
<span class="org-keyword">async</span> <span class="org-keyword">fn</span> <span class="org-function-name">main</span>() {
    <span class="org-comment-delimiter">// </span><span class="org-comment">Set up process-wide paths and panic if this fails</span>
    configure_platform();
    <span class="org-comment-delimiter">// </span><span class="org-comment">read command line options, to look for -i switch</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">args</span>: <span class="org-type">Vec</span>&lt;<span class="org-type">String</span>&gt; = <span class="org-constant">std</span>::<span class="org-constant">env</span>::args().collect();
    <span class="org-comment-delimiter">// </span><span class="org-comment">if args contains "-i", read via handle_stdin</span>
    <span class="org-keyword">if</span> args.contains(&amp;<span class="org-string">"-i"</span>.to_string()) {
        interactive_mode().<span class="org-keyword">await</span>;
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> args.contains(&amp;<span class="org-string">"-r"</span>.to_string()) {
        repl().<span class="org-keyword">await</span>;
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> args.contains(&amp;<span class="org-string">"-f"</span>.to_string()) {
        <span class="org-keyword">let</span> <span class="org-variable-name">filename</span> = args.get(2).unwrap();
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">file</span> = <span class="org-constant">std</span>::<span class="org-constant">fs</span>::<span class="org-type">File</span>::open(filename).unwrap();
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buf</span> = <span class="org-type">String</span>::new();
        file.read_to_string(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> buf).unwrap();
        read_eval_print(buf).<span class="org-keyword">await</span>;
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> args.contains(&amp;<span class="org-string">"-p"</span>.to_string()) {
        <span class="org-keyword">let</span> <span class="org-variable-name">program</span> = args.get(2).unwrap();
        read_eval_print(program.clone()).<span class="org-keyword">await</span>;
    } <span class="org-keyword">else</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">otherwise, read from stdin</span>
        read_eval_print(get_stdin()).<span class="org-keyword">await</span>;
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">if let (Item::List(program), Item::List(expected)) = (program, expected) {</span>

<span class="org-comment-delimiter">//     </span><span class="org-comment">} else {</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">Err(Error::from("Example should be a pair"))</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">for ex in d.examples().iter() {</span>
<span class="org-comment-delimiter">//             </span><span class="org-comment">let e = List::try_derive(*ex).ok().unwrap();</span>
<span class="org-comment-delimiter">//             </span><span class="org-comment">let p = List::try_derive(*e.get(0).unwrap()).ok().unwrap();</span>
<span class="org-comment-delimiter">//             </span><span class="org-comment">let exp = List::try_derive(*e.get(1).unwrap()).ok().unwrap();</span>

<span class="org-comment-delimiter">//             </span><span class="org-comment">test_example(axiom::standard_env.clone(), w, p,exp)</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">}.retain(|i| i.is_some()).collect::&lt;Vec&lt;Error&gt;&gt;()</span>
</pre>
</div></div>
</div>
</div>
<div id="outline-container-orgbe9061d" class="outline-4">
<h4 id="orgbe9061d"><span class="section-number-4">1.5.8.</span> Pipes (input/output)</h4>
<div class="outline-text-4" id="text-1-5-8">
<p>
Kcats will confine all i/o to pipes. You can put values into pipes and
they emerge elsewhere. Words that act on pipes are the only ones that
can be impure. Everything else is a value.
</p>
</div>
<ol class="org-ol">
<li><a id="orgc7373d1"></a>Basic Types<br />
<div class="outline-text-6" id="text-1-5-8-0-1">
<p>
The basic pipe contracts.
</p>
<div class='tangle-wrapper' data-tangle='src/types/container/pipe.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">super</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, <span class="org-type">SimpleTake</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, <span class="org-type">Item</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">pin</span>::<span class="org-type">Pin</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">sync</span>::<span class="org-type">RwLock</span>;

<span class="org-keyword">use</span> <span class="org-constant">futures</span>::{executor, future};
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">channel</span>;

<span class="org-preprocessor">#[cfg(feature = </span><span class="org-string">"database"</span><span class="org-preprocessor">)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">db</span>;

<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">fs</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">net</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">standard</span>;
<span class="org-keyword">pub</span> <span class="org-keyword">mod</span> <span class="org-constant">time</span>;

<span class="org-keyword">pub</span> <span class="org-keyword">trait</span> <span class="org-type">FutureTake</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;;
}

<span class="org-doc">/// A pipe that accepts items.</span>
<span class="org-preprocessor">#[derive(Debug, Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">In</span> {
    <span class="org-doc">/// A pipe that takes bytes to write to a file on disk</span>
    <span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">fs</span>::<span class="org-type">StaticFile</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that takes bytes to write to a TCP/IP socket</span>
    <span class="org-type">Socket</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">net</span>::<span class="org-type">Socket</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that takes items to send through a channel to another</span>
    <span class="org-doc">/// part of the running program</span>
    <span class="org-type">Handoff</span>(<span class="org-constant">channel</span>::<span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt;),
    <span class="org-doc">/// A pipe that takes bytes to write to standard out</span>
    <span class="org-type">Standard</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">In</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">In</span>::<span class="org-type">StaticFile</span>(s1), <span class="org-type">In</span>::<span class="org-type">StaticFile</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">In</span>::<span class="org-type">Socket</span>(s1), <span class="org-type">In</span>::<span class="org-type">Socket</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">In</span>::<span class="org-type">Handoff</span>(h1), <span class="org-type">In</span>::<span class="org-type">Handoff</span>(h2)) =&gt; h1 == h2,
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}
<span class="org-doc">/// A pipe that produces items.</span>
<span class="org-preprocessor">#[derive(Debug, Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Out</span> {
    <span class="org-doc">/// A pipe that produces bytes from a file on disk</span>
    <span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">fs</span>::<span class="org-type">StaticFile</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that produces bytes from a TCP/IP socket</span>
    <span class="org-type">Socket</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">net</span>::<span class="org-type">Socket</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that produces sockets from a TCP/IP server socket</span>
    <span class="org-type">ServerSocket</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">net</span>::<span class="org-type">ServerSocket</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that produces items from a channel that comes from</span>
    <span class="org-doc">/// another part of the program</span>
    <span class="org-type">Handoff</span>(<span class="org-constant">channel</span>::<span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt;),
    <span class="org-doc">/// A pipe that produces a dummy value after a given amount of</span>
    <span class="org-doc">/// time. Can be used as a timeout mechanism when waiting on</span>
    <span class="org-doc">/// multiple pipes at once.</span>
    <span class="org-type">Timer</span>(<span class="org-constant">channel</span>::<span class="org-type">Timer</span>),
    <span class="org-doc">/// A pipe that produces timestamps of the current UNIX time</span>
    <span class="org-type">Time</span>,
    <span class="org-doc">/// A pipe that produces bytes from standard in.</span>
    <span class="org-type">Standard</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Out</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(s1), <span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">Out</span>::<span class="org-type">Socket</span>(s1), <span class="org-type">Out</span>::<span class="org-type">Socket</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">Out</span>::<span class="org-type">ServerSocket</span>(s1), <span class="org-type">Out</span>::<span class="org-type">ServerSocket</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h1), <span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h2)) =&gt; h1 == h2,
            (<span class="org-type">Out</span>::<span class="org-type">Time</span>, <span class="org-type">Out</span>::<span class="org-type">Time</span>) =&gt; <span class="org-keyword">true</span>,
            (<span class="org-type">Out</span>::<span class="org-type">Standard</span>, <span class="org-type">Out</span>::<span class="org-type">Standard</span>) =&gt; <span class="org-keyword">true</span>,
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-doc">/// A bi-directional pipe that can accept and produce Items.</span>
<span class="org-preprocessor">#[derive(Debug, Clone)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">enum</span> <span class="org-type">Tunnel</span> {
    <span class="org-doc">/// A pipe that can both produce and accept bytes to read/write from a file.</span>
    <span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">fs</span>::<span class="org-type">StaticFile</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that can both produce and accept bytes to read/write</span>
    <span class="org-doc">/// from a TCP/IP socket.</span>
    <span class="org-type">Socket</span>(<span class="org-type">Arc</span>&lt;<span class="org-type">RwLock</span>&lt;<span class="org-constant">net</span>::<span class="org-type">Socket</span>&gt;&gt;),
    <span class="org-doc">/// A pipe that produces or accepts values to/from a channel that</span>
    <span class="org-doc">/// connects to another part of the program.</span>
    <span class="org-type">Handoff</span>(<span class="org-constant">channel</span>::<span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt;),
    <span class="org-doc">/// A pipe to standard in/out that produces/accepts bytes.</span>
    <span class="org-type">Standard</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Tunnel</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-keyword">self</span>, other) {
            (<span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(s1), <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(s1), <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(s2)) =&gt; <span class="org-type">Arc</span>::ptr_eq(s1, s2),
            (<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h1), <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h2)) =&gt; h1 == h2,
            (<span class="org-type">Tunnel</span>::<span class="org-type">Standard</span>, <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span>) =&gt; <span class="org-keyword">true</span>,
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Tunnel</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Out</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">Tunnel</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> t {
            <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(f) =&gt; <span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(f),
            <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(s) =&gt; <span class="org-type">Out</span>::<span class="org-type">Socket</span>(s),
            <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h) =&gt; <span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h),
            <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span> =&gt; <span class="org-type">Out</span>::<span class="org-type">Standard</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Tunnel</span>&gt; <span class="org-keyword">for</span> <span class="org-type">In</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">Tunnel</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">match</span> t {
            <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(f) =&gt; <span class="org-type">In</span>::<span class="org-type">StaticFile</span>(f),
            <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(s) =&gt; <span class="org-type">In</span>::<span class="org-type">Socket</span>(s),
            <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h) =&gt; <span class="org-type">In</span>::<span class="org-type">Handoff</span>(h),
            <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span> =&gt; <span class="org-type">In</span>::<span class="org-type">Standard</span>,
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">In</span> {
    <span class="org-doc">/// Puts the [Item] into the pipe. Blocks if the pipe is full.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">In</span>::<span class="org-type">StaticFile</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = f.clone();
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.put(i).<span class="org-keyword">await</span> })
            }
            <span class="org-type">In</span>::<span class="org-type">Socket</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = f.clone();
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.put(i).<span class="org-keyword">await</span> })
            }
            <span class="org-type">In</span>::<span class="org-type">Handoff</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">h</span>) =&gt; <span class="org-type">Box</span>::pin(h.put(i)), <span class="org-comment-delimiter">//</span><span class="org-comment">_ =&gt; Err(Error::expected("foo")),</span>
            <span class="org-type">In</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::put(i),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">Tunnel</span> {
    <span class="org-doc">/// Takes an [Item] from the tunnel, blocks if the receive side of</span>
    <span class="org-doc">/// the tunnel is empty.</span>
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-doc">/// Takes an [Item] from the pipe, blocks if the pipe is empty.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(f) =&gt; <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                f.write()
                    .<span class="org-keyword">await</span>
                    .take_future()
                    .<span class="org-keyword">await</span>
                    .map(|i| <span class="org-type">Some</span>(<span class="org-type">Item</span>::derive(i)))
            }),
            <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(f) =&gt; <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                f.write()
                    .<span class="org-keyword">await</span>
                    .take_future()
                    .<span class="org-keyword">await</span>
                    .map(|i| <span class="org-type">Some</span>(<span class="org-type">Item</span>::derive(i)))
            }),

            <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h) =&gt; <span class="org-type">Box</span>::pin(h.take_future()),
            <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::take_future(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Tunnel</span> {
    <span class="org-doc">/// Puts the [Item] into the tunnel, blocks if the send side of</span>
    <span class="org-doc">/// the tunnel is full.</span>
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = f.clone();
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.put(i).<span class="org-keyword">await</span> })
            }
            <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = f.clone();
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.put(i).<span class="org-keyword">await</span> })
            }
            <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">h</span>) =&gt; <span class="org-type">Box</span>::pin(h.put(i)),
            <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::put(i),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">Out</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-doc">/// Takes an [Item] from the pipe, blocks if the pipe is empty.</span>
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(f) =&gt; {
                <span class="org-type">Box</span>::pin(
                    <span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.take_future().<span class="org-keyword">await</span>.map(|bs| <span class="org-type">Some</span>(bs.fit())) },
                )
            }
            <span class="org-type">Out</span>::<span class="org-type">Socket</span>(f) =&gt; {
                <span class="org-type">Box</span>::pin(
                    <span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.take_future().<span class="org-keyword">await</span>.map(|bs| <span class="org-type">Some</span>(bs.fit())) },
                )
            }
            <span class="org-type">Out</span>::<span class="org-type">ServerSocket</span>(f) =&gt; {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write().<span class="org-keyword">await</span>.take_future().<span class="org-keyword">await</span>.map(|s| <span class="org-type">Some</span>(s.fit())) })
            }
            <span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h) =&gt; <span class="org-type">Box</span>::pin(h.take_future()),
            <span class="org-type">Out</span>::<span class="org-type">Timer</span>(<span class="org-keyword">ref</span> <span class="org-keyword">mut</span> <span class="org-variable-name">t</span>) =&gt; <span class="org-type">Box</span>::pin(t.take_future()),
            <span class="org-type">Out</span>::<span class="org-type">Time</span> =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Ok</span>(<span class="org-constant">time</span>::<span class="org-type">Time</span>::new()
                .take_simple()
                .map(<span class="org-type">Item</span>::derive)))),
            <span class="org-type">Out</span>::<span class="org-type">Standard</span> =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">standard</span>::take_future()),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">In</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">In</span>::<span class="org-type">StaticFile</span>(f) =&gt; <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() }),
            <span class="org-type">In</span>::<span class="org-type">Socket</span>(f) =&gt; <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() }),
            <span class="org-type">In</span>::<span class="org-type">Handoff</span>(h) =&gt; h.representation(),
            <span class="org-type">In</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::representation(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Out</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(f) =&gt; {
                <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() })
            }
            <span class="org-type">Out</span>::<span class="org-type">Socket</span>(f) =&gt; <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() }),
            <span class="org-type">Out</span>::<span class="org-type">ServerSocket</span>(f) =&gt; {
                <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() })
            }
            <span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h) =&gt; h.representation(),
            <span class="org-type">Out</span>::<span class="org-type">Timer</span>(t) =&gt; t.representation(),
            <span class="org-type">Out</span>::<span class="org-type">Time</span> =&gt; <span class="org-constant">time</span>::representation(),
            <span class="org-type">Out</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::representation(),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Tunnel</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Tunnel</span>::<span class="org-type">StaticFile</span>(f) =&gt; {
                <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() })
            }
            <span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(f) =&gt; <span class="org-constant">executor</span>::block_on(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.read().<span class="org-keyword">await</span>.representation() }),
            <span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(h) =&gt; h.representation(),
            <span class="org-type">Tunnel</span>::<span class="org-type">Standard</span> =&gt; <span class="org-constant">standard</span>::representation(),
        }
    }
}
<span class="org-comment-delimiter">/* </span><span class="org-comment">Pipes can be "closed", from either end to signal that either the</span>
<span class="org-comment"> * putter or taker has gone away. Sometimes the type of pipe</span>
<span class="org-comment"> * may not really support this concept but an implementation is</span>
<span class="org-comment"> * required.  For example, files. When you open a file for writing and</span>
<span class="org-comment"> * then "close" it, that doesn't really do anything. Rust doesn't have</span>
<span class="org-comment"> * an explicit file close. You have to drop the reference to it, which</span>
<span class="org-comment"> * in kcats you can do by popping the pipe off the stack. Rust will</span>
<span class="org-comment"> * clean up automatically, other impls might have to reference count.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * The contract here is as follows:</span>
<span class="org-comment"> * 1. After calling close, put on the pipe returns an error</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * 2. After calling close, take on the pipe will return still-buffered</span>
<span class="org-comment"> * items (if the pipe has a buffer), but once buffer is exhausted it</span>
<span class="org-comment"> * will return error.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * 2. Errors cannot be put into a pipe (the taker can't distinguish</span>
<span class="org-comment"> * between io error and an error value). To work around this, wrap the</span>
<span class="org-comment"> * error value in a list to quote it. Putting error into a pipe will</span>
<span class="org-comment"> * return an io error.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * 3. Once closed pipes cannot be ever be put into again. closed? will always</span>
<span class="org-comment"> * return true thereafter.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * One use case that has to be handled specially is a file we've fully</span>
<span class="org-comment"> * read but later someone else might write more bytes to the end. Does</span>
<span class="org-comment"> * the pipe close when we reach EOF? I think we might need to support</span>
<span class="org-comment"> * both types (a type that closes when hitting eof and one that</span>
<span class="org-comment"> * doesn't). The former is the "normal" use case, which will be the</span>
<span class="org-comment"> * default.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * These two types are basically static vs dynamic content. Either all</span>
<span class="org-comment"> * the content is known now, or it isn't.</span>
<span class="org-comment"> *</span>
<span class="org-comment">*/</span>

<span class="org-keyword">fn</span> <span class="org-function-name">closed_error</span>(<span class="org-variable-name">on_take</span>: <span class="org-type">bool</span>) -&gt; <span class="org-type">Error</span> {
    <span class="org-type">Error</span>::create(
        <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter([
            <span class="org-type">Item</span>::derive(<span class="org-string">"close"</span>),
            <span class="org-keyword">if</span> on_take { <span class="org-string">"take"</span> } <span class="org-keyword">else</span> { <span class="org-string">"put"</span> }.fit(),
        ]),
        <span class="org-string">"attempt to use closed pipe"</span>,
        <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>,
    )
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Tunnel</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">Tunnel</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Out</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">Out</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(t))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">In</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">In</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(t))
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">In</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(i)) =&gt; <span class="org-type">Ok</span>(i),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t)) =&gt; <span class="org-type">Ok</span>(t.fit()),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t)) =&gt; <span class="org-type">Ok</span>(t.fit()),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"pipe"</span>, i)),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Out</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(o)) =&gt; <span class="org-type">Ok</span>(o),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(t)) =&gt; <span class="org-type">Ok</span>(t.fit()),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(t)) =&gt; <span class="org-type">Ok</span>(t.fit()),
            i =&gt; <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"pipe"</span>, i)),
        }
    }
}
</pre>
</div></div>
</div>
</li>
<li><a id="org6fd34c1"></a>Files<br />
<div class="outline-text-6" id="text-1-5-8-0-2">
<p>
How to interact with files on disk
</p>
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/fs.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;

<span class="org-keyword">use</span> <span class="org-constant">std</span>::future;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">pin</span>::<span class="org-type">Pin</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::ptr;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">fs</span>::<span class="org-type">File</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">io</span>::{<span class="org-type">AsyncReadExt</span>, <span class="org-type">AsyncWriteExt</span>};
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">sync</span>::<span class="org-type">RwLock</span>;

<span class="org-keyword">use</span> <span class="org-keyword">super</span>::{closed_error, <span class="org-type">FutureTake</span>};

<span class="org-preprocessor">#[derive(Debug)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">StaticFile</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">file</span>: <span class="org-type">Option</span>&lt;<span class="org-type">File</span>&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">path</span>: <span class="org-type">String</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">StaticFile</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Check if the 'file' fields of both structs are the same by reference</span>
        <span class="org-constant">ptr</span>::eq(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.file, <span class="org-rust-ampersand">&amp;</span>other.file)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">StaticFile</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Bytes</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span>.file.as_mut() {
            <span class="org-type">Some</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">bs</span> = [0<span class="org-type">u8</span>; 102400];
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                    <span class="org-keyword">let</span> <span class="org-variable-name">ct</span> = f.read(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> bs).<span class="org-keyword">await</span><span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">if</span> ct == 0 {
                        <span class="org-comment-delimiter">// </span><span class="org-comment">EOF, no more takes since it's static</span>
                        <span class="org-type">Ok</span>(<span class="org-type">None</span>)
                    } <span class="org-keyword">else</span> {
                        <span class="org-type">Ok</span>(<span class="org-type">Some</span>(bs[0..ct].to_vec().fit()))
                    }
                })
            }
            <span class="org-type">None</span> =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(closed_error(<span class="org-keyword">false</span>)))),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">StaticFile</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
        <span class="org-variable-name">i</span>: <span class="org-type">Item</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span>.file.as_mut() {
            <span class="org-type">Some</span>(f) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">b</span> = <span class="org-type">Bytes</span>::try_derive(i);

                <span class="org-keyword">match</span> b {
                    <span class="org-type">Ok</span>(bs) =&gt; <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { f.write_all(<span class="org-rust-ampersand">&amp;</span>bs).<span class="org-keyword">await</span>.map_err(|e| e.into()) }),
                    <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(e))),
                }
            }
            <span class="org-type">None</span> =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(closed_error(<span class="org-keyword">false</span>)))),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">StaticFile</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
            (<span class="org-string">"type"</span>.fit(), <span class="org-string">"tunnel"</span>.fit()),
            (
                <span class="org-string">"values"</span>.fit(),
                <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([(<span class="org-string">"type"</span>.fit(), <span class="org-string">"bytes"</span>.fit())]).fit(),
            ),
            (
                <span class="org-string">"to"</span>.fit(),
                <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([(<span class="org-string">"file"</span>.fit(), <span class="org-keyword">self</span>.path.clone().fit())]).fit(),
            ),
        ])
        .fit()
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">file_in</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">path</span> = <span class="org-type">String</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">file</span> = <span class="org-constant">std</span>::<span class="org-constant">fs</span>::<span class="org-type">File</span>::options()
        .read(<span class="org-keyword">true</span>)
        .write(<span class="org-keyword">true</span>)
        .create_new(<span class="org-keyword">true</span>)
        .open(path.clone())<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(<span class="org-keyword">super</span>::<span class="org-type">In</span>::<span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>::new(<span class="org-type">RwLock</span>::new(<span class="org-type">StaticFile</span> {
        <span class="org-variable-name">file</span>: <span class="org-type">Some</span>(<span class="org-type">File</span>::from_std(file)),
        path,
    })))
    .fit())
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">file_out</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">path</span> = <span class="org-type">String</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">file</span> = <span class="org-constant">std</span>::<span class="org-constant">fs</span>::<span class="org-type">File</span>::open(path.clone())<span class="org-rust-question-mark">?</span>;
    <span class="org-type">Ok</span>(<span class="org-keyword">super</span>::<span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>::new(<span class="org-type">RwLock</span>::new(<span class="org-type">StaticFile</span> {
        <span class="org-variable-name">file</span>: <span class="org-type">Some</span>(<span class="org-type">File</span>::from_std(file)),
        path,
    })))
    .fit())
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">StaticFile</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">f</span>: <span class="org-type">StaticFile</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-keyword">super</span>::<span class="org-type">Out</span>::<span class="org-type">StaticFile</span>(<span class="org-type">Arc</span>::new(<span class="org-type">RwLock</span>::new(f))).fit()
    }
}
</pre>
</div></div>
</div>
</li>
<li><a id="org46b6248"></a>Network<br />
<div class="outline-text-6" id="text-1-5-8-0-3">
<p>
How to interact with the network (TCP/IP sockets)
</p>
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/net.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> cont;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::{<span class="org-keyword">self</span>, <span class="org-type">FutureTake</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Int</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, <span class="org-type">Bytes</span>, <span class="org-type">Item</span>};
<span class="org-keyword">use</span> <span class="org-constant">futures</span>::<span class="org-constant">future</span>::<span class="org-type">FutureExt</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::{<span class="org-keyword">self</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">net</span>::{<span class="org-type">Ipv4Addr</span>, <span class="org-type">SocketAddrV4</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">pin</span>::<span class="org-type">Pin</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::ptr;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-type">str</span>::<span class="org-type">FromStr</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">io</span>::{<span class="org-type">AsyncReadExt</span>, <span class="org-type">AsyncWriteExt</span>};
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">net</span>::{<span class="org-type">TcpListener</span>, <span class="org-type">TcpStream</span>};
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">sync</span>::<span class="org-type">RwLock</span>;

<span class="org-preprocessor">#[derive(Debug)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Socket</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">socket</span>: <span class="org-type">TcpStream</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">addr</span>: (<span class="org-type">String</span>, <span class="org-type">u16</span>),
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Socket</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Check if the 'socket' fields of both structs are the same by reference</span>
        <span class="org-constant">ptr</span>::eq(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.socket, <span class="org-rust-ampersand">&amp;</span>other.socket)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">Socket</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Bytes</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">bs</span> = [0<span class="org-type">u8</span>; 1024];
        <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
            <span class="org-keyword">let</span> <span class="org-variable-name">n</span> = <span class="org-keyword">self</span>.socket.read(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> bs).<span class="org-keyword">await</span><span class="org-rust-question-mark">?</span>;
            <span class="org-keyword">if</span> n == 0 {
                <span class="org-type">Ok</span>(<span class="org-type">None</span>)
            } <span class="org-keyword">else</span> {
                <span class="org-type">Ok</span>(<span class="org-type">Some</span>(bs[..n].to_vec()))
            }
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Socket</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
        <span class="org-variable-name">i</span>: <span class="org-type">Item</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt; {
        <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Putting {:?}", i);</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">b</span> = <span class="org-constant">types</span>::<span class="org-type">Bytes</span>::try_derive(i);
        <span class="org-keyword">match</span> b {
            <span class="org-type">Ok</span>(bs) =&gt; {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { <span class="org-keyword">self</span>.socket.write_all(<span class="org-rust-ampersand">&amp;</span>bs).<span class="org-keyword">await</span>.map_err(|e| e.into()) })
            }
            <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(e))),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Socket</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
            (<span class="org-string">"type"</span>.fit(), <span class="org-string">"tunnel"</span>.fit()),
            (<span class="org-string">"realm"</span>.fit(), <span class="org-string">"tcp"</span>.fit()),
            (<span class="org-string">"address"</span>.fit(), <span class="org-keyword">self</span>.addr.0.to_string().fit()),
            (<span class="org-string">"port"</span>.fit(), <span class="org-keyword">self</span>.addr.1.to_string().fit()),
        ])
        .fit()
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">Server sockets</span>
<span class="org-preprocessor">#[derive(Debug)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">ServerSocket</span> {
    <span class="org-keyword">pub</span> <span class="org-variable-name">socket</span>: <span class="org-type">TcpListener</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">ServerSocket</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-comment-delimiter">// </span><span class="org-comment">Check if the 'socket' fields of both structs are the same by reference</span>
        <span class="org-constant">ptr</span>::eq(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.socket, <span class="org-rust-ampersand">&amp;</span>other.socket)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">ServerSocket</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Socket</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
            <span class="org-keyword">let</span> (socket, addr) = <span class="org-keyword">self</span>.socket.accept().<span class="org-keyword">await</span><span class="org-rust-question-mark">?</span>;

            <span class="org-type">Ok</span>(<span class="org-type">Some</span>(<span class="org-type">Socket</span> {
                socket,
                <span class="org-variable-name">addr</span>: (addr.ip().to_string(), addr.port()),
            }))
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">ServerSocket</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
            (<span class="org-string">"type"</span>.fit(), <span class="org-string">"pipe"</span>.fit()),
            (
                <span class="org-string">"serversocket"</span>.fit(),
                <span class="org-string">"todo: fix serversocket local addr async issue"</span>.fit(), <span class="org-comment-delimiter">//</span><span class="org-comment">Item::String(self.socket.lock().await.local_addr().unwrap().to_string()),</span>
            ),
        ])
        .fit()
    }
}

<span class="org-keyword">fn</span> <span class="org-function-name">socket_addr</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">SocketAddrV4</span>, <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("socket: {:?} {:?}", i, j);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">addr</span> = <span class="org-type">Ipv4Addr</span>::from_str(<span class="org-type">String</span>::try_derive(j)<span class="org-rust-question-mark">?</span>.as_str())<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">port</span> = <span class="org-type">Int</span>::try_derive(i)<span class="org-rust-question-mark">?</span> <span class="org-keyword">as</span> <span class="org-type">u16</span>;
    <span class="org-type">Ok</span>(<span class="org-type">SocketAddrV4</span>::new(addr, port))
}

<span class="org-keyword">fn</span> <span class="org-function-name">host_addr</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;(<span class="org-type">String</span>, <span class="org-type">u16</span>), <span class="org-type">Error</span>&gt; {
    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("socket: {:?} {:?}", i, j);</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">addr</span> = <span class="org-type">String</span>::try_derive(j)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">port</span> = <span class="org-type">Int</span>::try_derive(i)<span class="org-rust-question-mark">?</span> <span class="org-keyword">as</span> <span class="org-type">u16</span>;
    <span class="org-type">Ok</span>((addr, port))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">server_socket</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">ItemResult</span>&gt; {
    <span class="org-keyword">match</span> socket_addr(i, j) {
        <span class="org-type">Ok</span>(addr) =&gt; {
            <span class="org-type">Box</span>::pin(<span class="org-type">TcpListener</span>::bind(addr).map(|l| {
                <span class="org-type">Ok</span>(<span class="org-keyword">super</span>::<span class="org-type">Out</span>::<span class="org-type">ServerSocket</span>(<span class="org-type">Arc</span>::new(<span class="org-type">RwLock</span>::new(<span class="org-type">ServerSocket</span> {
                    <span class="org-variable-name">socket</span>: l.unwrap(),
                })))
                .fit())
            }))
        }
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(e))),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">socket</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">j</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">ItemResult</span>&gt; {
    <span class="org-keyword">match</span> host_addr(i, j) {
        <span class="org-type">Ok</span>(addr) =&gt; <span class="org-type">Box</span>::pin(<span class="org-type">TcpStream</span>::connect(addr.clone()).map(<span class="org-keyword">move</span> |s| {
            <span class="org-type">Ok</span>(<span class="org-keyword">super</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(<span class="org-type">Arc</span>::new(<span class="org-type">RwLock</span>::new(<span class="org-type">Socket</span> {
                <span class="org-variable-name">socket</span>: s.unwrap(),
                addr,
            })))
            .fit())
        })),
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(e))),
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">pub fn server_socket(env: Environment) -&gt; environment::Future {</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">let addr = env.pop();</span>

<span class="org-comment-delimiter">//     </span><span class="org-comment">let inner_env = Environment::try_derive(tos);</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">match inner_env {</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">Ok(inner) =&gt; Box::pin(eval_step(inner).map(|inner_next| env.push(Item::Env(inner_next)))),</span>
<span class="org-comment-delimiter">//         </span><span class="org-comment">Err(e) =&gt; env.push(Item::Error(e)).fit(),</span>
<span class="org-comment-delimiter">//     </span><span class="org-comment">}</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">}</span>

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">std</span>::<span class="org-constant">net</span>::<span class="org-type">AddrParseError</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">err</span>: <span class="org-constant">std</span>::<span class="org-constant">net</span>::<span class="org-type">AddrParseError</span>) -&gt; <span class="org-type">Error</span> {
        <span class="org-type">Error</span>::create(<span class="org-preprocessor">list!</span>(<span class="org-string">"addrparse"</span>), <span class="org-rust-ampersand">&amp;</span>err.to_string(), <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>)
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Socket</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">ss</span>: <span class="org-type">Socket</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">cont</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Socket</span>(<span class="org-type">Arc</span>::new(
            <span class="org-type">RwLock</span>::new(ss),
        ))))
    }
}
</pre>
</div></div>
</div>
</li>
<li><a id="org30f2db2"></a>Time<br />
<div class="outline-text-6" id="text-1-5-8-0-4">
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/time.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{associative <span class="org-keyword">as</span> assoc, <span class="org-type">SimpleTake</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Int</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::*;

<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">time</span>::{<span class="org-type">SystemTime</span>, <span class="org-type">UNIX_EPOCH</span>};

<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Time</span>;

<span class="org-keyword">impl</span> <span class="org-type">Time</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">new</span>() -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Time</span>
    }
}

<span class="org-keyword">impl</span> <span class="org-type">SimpleTake</span> <span class="org-keyword">for</span> <span class="org-type">Time</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Int</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_simple</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) -&gt; <span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">t</span> = <span class="org-type">SystemTime</span>::now()
            .duration_since(<span class="org-type">UNIX_EPOCH</span>)
            .unwrap()
            .as_millis() <span class="org-keyword">as</span> <span class="org-type">Int</span>;
        <span class="org-type">Some</span>(t)
    }
}
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>() -&gt; <span class="org-type">Item</span> {
    <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
        (<span class="org-string">"type"</span>.fit(), <span class="org-string">"out"</span>.fit()),
        (<span class="org-string">"from"</span>.fit(), <span class="org-string">"systemtime"</span>.fit()),
        (
            <span class="org-string">"values"</span>.fit(),
            <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
                (<span class="org-string">"type"</span>.fit(), <span class="org-string">"integer"</span>.fit()),
                (<span class="org-string">"units"</span>.fit(), <span class="org-string">"milliseconds"</span>.fit()),
            ])
            .fit(),
        ),
    ])
    .fit()
}
</pre>
</div></div>
</div>
</li>
<li><a id="org70de623"></a>Standard in/out<br />
<div class="outline-text-6" id="text-1-5-8-0-5">
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/standard.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::associative <span class="org-keyword">as</span> assoc;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, *};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::future;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">io</span>::{<span class="org-keyword">self</span>, <span class="org-type">Read</span>, <span class="org-type">Write</span>};

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt; {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">buf</span> = [0<span class="org-type">u8</span>];
    <span class="org-keyword">let</span> <span class="org-variable-name">n</span> = <span class="org-constant">io</span>::stdin().read(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> buf);
    <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = <span class="org-keyword">match</span> n {
        <span class="org-type">Ok</span>(0) =&gt; <span class="org-type">Ok</span>(<span class="org-type">None</span>),
        <span class="org-type">Ok</span>(n) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Some</span>(buf[..n].to_vec().fit())),
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Err</span>(e.into()),
    };
    <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(f))
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;&gt; {
    <span class="org-keyword">let</span> <span class="org-variable-name">bs</span> = <span class="org-type">Bytes</span>::try_derive(i);
    <span class="org-keyword">match</span> bs {
        <span class="org-type">Ok</span>(bs) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">f</span> = <span class="org-constant">io</span>::stdout().write(<span class="org-rust-ampersand">&amp;</span>bs);
            <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(f.map_err(|e| e.into()).map(|_| ())))
        }
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(e))),
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>() -&gt; <span class="org-type">Item</span> {
    <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
        (<span class="org-string">"type"</span>.fit(), <span class="org-string">"tunnel"</span>.fit()),
        (<span class="org-string">"peer"</span>.fit(), <span class="org-string">"standard"</span>.fit()),
    ])
    .fit()
}
</pre>
</div></div>
</div>
</li>
<li><a id="orgd308bf3"></a>Channels<br />
<div class="outline-text-6" id="text-1-5-8-0-6">
<p>
Implement the <code>handoff</code> type
</p>
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/channel.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::container <span class="org-keyword">as</span> coll;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">error</span>::<span class="org-type">Error</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::<span class="org-constant">pipe</span>::<span class="org-type">FutureTake</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{associative <span class="org-keyword">as</span> assoc, <span class="org-constant">environment</span>::<span class="org-type">Environment</span>, error, pipe};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Int</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, <span class="org-type">Item</span>};

<span class="org-keyword">use</span> <span class="org-constant">flume</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::future;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">pin</span>::<span class="org-type">Pin</span>;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::ptr;
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-constant">atomic</span>::{<span class="org-type">AtomicUsize</span>, <span class="org-type">Ordering</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">sync</span>::<span class="org-type">Arc</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">task</span>::<span class="org-type">JoinHandle</span>;
<span class="org-keyword">use</span> <span class="org-constant">tokio</span>::<span class="org-constant">time</span>::{sleep, <span class="org-type">Duration</span>};

<span class="org-preprocessor">#[derive(Debug, Clone)]</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">Use Option because we want to be able to drop senders/receivers to</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">close the channel</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">pub</span> <span class="org-variable-name">receiver</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">Receiver</span>&lt;<span class="org-type">T</span>&gt;&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">sender</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">Sender</span>&lt;<span class="org-type">T</span>&gt;&gt;,
    <span class="org-keyword">pub</span> <span class="org-variable-name">bidirectional</span>: <span class="org-type">bool</span>,
    <span class="org-keyword">pub</span> <span class="org-variable-name">id</span>: <span class="org-type">usize</span>,
}

<span class="org-keyword">impl</span>&lt;<span class="org-type">T</span>&gt; <span class="org-type">PartialEq</span> <span class="org-keyword">for</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">eq</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">other</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Self</span>) -&gt; <span class="org-type">bool</span> {
        <span class="org-keyword">match</span> (<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.receiver, <span class="org-rust-ampersand">&amp;</span>other.receiver, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.sender, <span class="org-rust-ampersand">&amp;</span>other.sender) {
            (<span class="org-type">Some</span>(sr), <span class="org-type">Some</span>(or), <span class="org-type">Some</span>(ss), <span class="org-type">Some</span>(os)) =&gt; <span class="org-constant">ptr</span>::eq(<span class="org-rust-ampersand">&amp;</span>sr, <span class="org-rust-ampersand">&amp;</span>or) &amp;&amp; <span class="org-constant">ptr</span>::eq(<span class="org-rust-ampersand">&amp;</span>ss, <span class="org-rust-ampersand">&amp;</span>os),
            _ =&gt; <span class="org-keyword">false</span>,
        }
    }
}

<span class="org-keyword">static</span> <span class="org-variable-name">ID</span>: <span class="org-type">AtomicUsize</span> = <span class="org-type">AtomicUsize</span>::new(0);

<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-comment-delimiter">// </span><span class="org-comment">println!(</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">"Taking from channel: {:?} on {:?}",</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">self,</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">thread::current().id()</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">);</span>
        <span class="org-keyword">if</span> !<span class="org-keyword">self</span>.bidirectional {
            <span class="org-keyword">self</span>.close_put();
        }
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(ch) = <span class="org-keyword">self</span>.receiver.clone() {
            <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> { ch.recv_async().<span class="org-keyword">await</span>.map(<span class="org-type">Some</span>).or_else(|_| <span class="org-type">Ok</span>(<span class="org-type">None</span>)) })
        } <span class="org-keyword">else</span> {
            <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Ok</span>(<span class="org-type">None</span>)))
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt; {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">new</span>(<span class="org-variable-name">bidirectional</span>: <span class="org-type">bool</span>) -&gt; <span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt; {
        <span class="org-keyword">let</span> (sender, receiver) = <span class="org-constant">flume</span>::bounded::&lt;<span class="org-type">Item</span>&gt;(0);
        <span class="org-keyword">let</span> <span class="org-variable-name">id</span> = <span class="org-type">ID</span>.fetch_add(1, <span class="org-type">Ordering</span>::<span class="org-type">Relaxed</span>);
        <span class="org-type">Handoff</span>::&lt;<span class="org-type">Item</span>&gt; {
            <span class="org-variable-name">sender</span>: <span class="org-type">Some</span>(sender),
            <span class="org-variable-name">receiver</span>: <span class="org-type">Some</span>(receiver),
            bidirectional,
            id,
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">put</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Result</span>&lt;(), <span class="org-constant">error</span>::<span class="org-type">Error</span>&gt;&gt; {
        <span class="org-comment-delimiter">// </span><span class="org-comment">println!(</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">"Putting into channel: {} into {:?} on {:?}",</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">i.clone(),</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">self,</span>
        <span class="org-comment-delimiter">//     </span><span class="org-comment">thread::current().id()</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">);</span>
        <span class="org-keyword">if</span> !<span class="org-keyword">self</span>.bidirectional {
            <span class="org-keyword">self</span>.close_take()
        };
        <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(ch) = <span class="org-keyword">self</span>.sender.clone() {
            <span class="org-keyword">if</span> <span class="org-constant">axiom</span>::is_truthy(<span class="org-rust-ampersand">&amp;</span>i) {
                <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                    ch.send_async(i)
                        .<span class="org-keyword">await</span>
                        .map_err(|_| <span class="org-constant">pipe</span>::closed_error(<span class="org-keyword">false</span>))
                })
            } <span class="org-keyword">else</span> {
                <span class="org-comment-delimiter">// </span><span class="org-comment">If we're putting 'nothing', that indicates end of</span>
                <span class="org-comment-delimiter">// </span><span class="org-comment">input, so we drop the sender.</span>
                <span class="org-keyword">self</span>.close_put();
                <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Ok</span>(())))
            }
        } <span class="org-keyword">else</span> {
            <span class="org-type">Box</span>::pin(<span class="org-constant">future</span>::ready(<span class="org-type">Err</span>(<span class="org-constant">pipe</span>::closed_error(<span class="org-keyword">false</span>))))
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">close_take</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.receiver.is_some() {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Dropping receiver");</span>
            <span class="org-keyword">self</span>.receiver = <span class="org-type">None</span>;
        }
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">close_put</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.sender.is_some() {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Dropping sender");</span>
            <span class="org-keyword">self</span>.sender = <span class="org-type">None</span>;
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt; {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">t</span> = <span class="org-keyword">match</span> (<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.sender, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>.receiver) {
            (<span class="org-type">Some</span>(_), <span class="org-type">Some</span>(_)) =&gt; <span class="org-string">"tunnel"</span>,
            (<span class="org-type">Some</span>(_), <span class="org-type">None</span>) =&gt; <span class="org-string">"in"</span>,
            (<span class="org-type">None</span>, <span class="org-type">Some</span>(_)) =&gt; <span class="org-string">"out"</span>,
            (<span class="org-type">None</span>, <span class="org-type">None</span>) =&gt; <span class="org-string">"closed"</span>,
        };
        <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
            (<span class="org-string">"type"</span>.fit(), t.fit()),
            (<span class="org-string">"handoff"</span>.fit(), (<span class="org-keyword">self</span>.id <span class="org-keyword">as</span> <span class="org-type">Int</span>).fit()),
        ])
        .fit()
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">handoff</span>(<span class="org-keyword">mut</span> <span class="org-variable-name">env</span>: <span class="org-type">Environment</span>) -&gt; <span class="org-constant">types</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Environment</span>&gt; {
    env.pop_prog();
    env.push(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(<span class="org-type">Handoff</span>::new(<span class="org-keyword">false</span>)));
    env.fit()
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">RecvError</span>&gt; <span class="org-keyword">for</span> <span class="org-variable-name">error</span>::<span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">_</span>: <span class="org-constant">flume</span>::<span class="org-type">RecvError</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-constant">pipe</span>::closed_error(<span class="org-keyword">false</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">todo fix this</span>
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">SendError</span>&lt;<span class="org-type">Item</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-variable-name">error</span>::<span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">_</span>: <span class="org-constant">flume</span>::<span class="org-type">SendError</span>&lt;<span class="org-type">Item</span>&gt;) -&gt; <span class="org-type">Self</span> {
        <span class="org-constant">pipe</span>::closed_error(<span class="org-keyword">false</span>)
    }
}

<span class="org-keyword">enum</span> <span class="org-type">ChannelOp</span>&lt;<span class="org-type">T</span>&gt; {
    <span class="org-type">Send</span>(<span class="org-type">Arc</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">Sender</span>&lt;<span class="org-type">T</span>&gt;&gt;, <span class="org-type">T</span>),
    <span class="org-type">Receive</span>(<span class="org-type">Arc</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">Receiver</span>&lt;<span class="org-type">T</span>&gt;&gt;),
}

<span class="org-doc">/// Given a list of pipes (channels) on top of stack, use flume's</span>
<span class="org-doc">/// selector to choose the next ready pipe.  A pipe means it's a</span>
<span class="org-doc">/// receive, a pipe/item pair means it's a send.</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">select</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">original</span> = l.clone();

    <span class="org-comment-delimiter">//</span><span class="org-comment">Create references out of any [pipe item] pairs</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">lr</span> = l
        .iter()
        .cloned()
        .map(<span class="org-keyword">move</span> |i| <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Handoff</span>(p))) =&gt; {
                <span class="org-type">Ok</span>(<span class="org-type">ChannelOp</span>::<span class="org-type">Receive</span>(<span class="org-type">Arc</span>::new(p.receiver.unwrap())))
            }
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(p))) =&gt; {
                <span class="org-type">Ok</span>(<span class="org-type">ChannelOp</span>::<span class="org-type">Receive</span>(<span class="org-type">Arc</span>::new(p.receiver.unwrap())))
            }
            <span class="org-comment-delimiter">// </span><span class="org-comment">Handle timeout channels - start the timer and add receive op</span>
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Timer</span>(t))) =&gt; {
                <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">t</span> = t.clone();
                t.start();
                <span class="org-type">Ok</span>(<span class="org-type">ChannelOp</span>::<span class="org-type">Receive</span>(<span class="org-type">Arc</span>::new(t.receiver.unwrap())))
            }
            i =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">l</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::try_derive(i.clone())<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">let</span> <span class="org-variable-name">p</span> = l.front();
                <span class="org-keyword">let</span> <span class="org-variable-name">i</span> = l.get(1);
                <span class="org-keyword">match</span> (p, i) {
                    (<span class="org-type">Some</span>(p), <span class="org-type">Some</span>(i)) =&gt; <span class="org-keyword">match</span> (p, i) {
                        (<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(<span class="org-constant">pipe</span>::<span class="org-type">In</span>::<span class="org-type">Handoff</span>(p))), i) =&gt; <span class="org-type">Ok</span>(
                            <span class="org-type">ChannelOp</span>::<span class="org-type">Send</span>(<span class="org-type">Arc</span>::new(p.sender.clone().unwrap()), i.clone()),
                        ),
                        (
                            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(p))),
                            i,
                        ) =&gt; <span class="org-type">Ok</span>(<span class="org-type">ChannelOp</span>::<span class="org-type">Send</span>(
                            <span class="org-type">Arc</span>::new(p.sender.clone().unwrap()),
                            i.clone(),
                        )),
                        (p, _i) =&gt; <span class="org-type">Err</span>(<span class="org-constant">error</span>::<span class="org-type">Error</span>::expected(<span class="org-string">"handoff"</span>, p.clone())),
                    },
                    _ =&gt; <span class="org-type">Err</span>(<span class="org-constant">error</span>::<span class="org-type">Error</span>::short_list(2)),
                }
            }
        })
        .collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">ChannelOp</span>&lt;<span class="org-type">Item</span>&gt;&gt;, <span class="org-constant">error</span>::<span class="org-type">Error</span>&gt;&gt;()<span class="org-rust-question-mark">?</span>;

    <span class="org-keyword">let</span> (res, idx) = {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">selector</span> = <span class="org-constant">flume</span>::<span class="org-type">Selector</span>::new();

        <span class="org-comment-delimiter">// </span><span class="org-comment">loop over the operations and add them to the selector. Each one</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">returns the original index in the list, so we can use that to</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">fetch the original item from the list.</span>
        <span class="org-keyword">for</span> (idx, item) <span class="org-keyword">in</span> lr.iter().enumerate() {
            <span class="org-keyword">let</span> <span class="org-variable-name">idx_clone</span> = idx;
            <span class="org-keyword">match</span> item {
                <span class="org-type">ChannelOp</span>::<span class="org-type">Receive</span>(r) =&gt; {
                    selector = selector.recv(<span class="org-rust-ampersand">&amp;</span>r, <span class="org-keyword">move</span> |i| {
                        (i.map(<span class="org-type">Some</span>).map_err(<span class="org-constant">error</span>::<span class="org-type">Error</span>::from), idx_clone)
                    });
                }
                <span class="org-type">ChannelOp</span>::<span class="org-type">Send</span>(s, i) =&gt; {
                    selector = selector.send(<span class="org-rust-ampersand">&amp;</span>s, i.clone(), <span class="org-keyword">move</span> |i| {
                        (i.map(|_| <span class="org-type">None</span>).map_err(<span class="org-constant">error</span>::<span class="org-type">Error</span>::from), idx)
                    });
                }
            }
        }

        selector.wait()
    };
    <span class="org-keyword">let</span> <span class="org-variable-name">selected</span> = original.get(idx).unwrap().clone();
    <span class="org-keyword">match</span> res {
        <span class="org-type">Ok</span>(<span class="org-type">Some</span>(i)) =&gt; {
            <span class="org-keyword">let</span> <span class="org-variable-name">l</span>: <span class="org-type">Item</span> = <span class="org-constant">coll</span>::<span class="org-type">List</span>::derive_iter(<span class="org-preprocessor">vec!</span>[selected, i]).fit();
            <span class="org-type">Ok</span>(l)
        }
        <span class="org-type">Ok</span>(<span class="org-type">None</span>) =&gt; <span class="org-type">Ok</span>(selected),
        <span class="org-type">Err</span>(e) =&gt; <span class="org-type">Err</span>(e),
    }
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">Item</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Handoff</span>&lt;<span class="org-type">Item</span>&gt; {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-constant">error</span>::<span class="org-type">Error</span>;

    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> i {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Handoff</span>(p))) =&gt; <span class="org-type">Ok</span>(p),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(<span class="org-constant">pipe</span>::<span class="org-type">In</span>::<span class="org-type">Handoff</span>(p))) =&gt; <span class="org-type">Ok</span>(p),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(p))) =&gt; <span class="org-type">Ok</span>(p),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Tunnel</span>(<span class="org-constant">pipe</span>::<span class="org-type">Tunnel</span>::<span class="org-type">Handoff</span>(p))) =&gt; <span class="org-type">Ok</span>(p),
            i =&gt; <span class="org-type">Err</span>(<span class="org-constant">error</span>::<span class="org-type">Error</span>::expected(<span class="org-string">"handoff"</span>, i)),
        }
    }
}

<span class="org-comment-delimiter">// </span><span class="org-comment">drop the receiver side of the handoff and return the handoff item</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">sender</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">h</span> = <span class="org-type">Handoff</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    h.close_take();
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">In</span>(<span class="org-constant">pipe</span>::<span class="org-type">In</span>::<span class="org-type">Handoff</span>(h))))
}

<span class="org-comment-delimiter">// </span><span class="org-comment">drop the sender side of the handoff and return the handoff item</span>
<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">receiver</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">h</span> = <span class="org-type">Handoff</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    h.close_put();
    <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Handoff</span>(h))))
}

<span class="org-preprocessor">#[derive(Debug)]</span>
<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Timer</span> {
    <span class="org-variable-name">receiver</span>: <span class="org-type">Option</span>&lt;<span class="org-constant">flume</span>::<span class="org-type">Receiver</span>&lt;<span class="org-type">Item</span>&gt;&gt;,
    <span class="org-variable-name">handle</span>: <span class="org-type">Option</span>&lt;<span class="org-type">JoinHandle</span>&lt;()&gt;&gt;,
    <span class="org-variable-name">duration</span>: <span class="org-type">Duration</span>,
}

<span class="org-comment-delimiter">// </span><span class="org-comment">Cloning a timeout makes a new one, clears state</span>
<span class="org-keyword">impl</span> <span class="org-type">Clone</span> <span class="org-keyword">for</span> <span class="org-type">Timer</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">clone</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Self</span> {
            <span class="org-variable-name">receiver</span>: <span class="org-type">None</span>,
            <span class="org-variable-name">handle</span>: <span class="org-type">None</span>,
            <span class="org-variable-name">duration</span>: <span class="org-keyword">self</span>.duration,
        }
    }
}
<span class="org-keyword">impl</span> <span class="org-type">FutureTake</span> <span class="org-keyword">for</span> <span class="org-type">Timer</span> {
    <span class="org-keyword">type</span> <span class="org-type">Item</span> = <span class="org-type">Item</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">take_future</span>&lt;'<span class="org-variable-name">a</span>&gt;(
        <span class="org-rust-ampersand">&amp;</span>'<span class="org-variable-name">a</span> <span class="org-keyword">mut</span> <span class="org-keyword">self</span>,
    ) -&gt; <span class="org-type">Pin</span>&lt;<span class="org-type">Box</span>&lt;<span class="org-keyword">dyn</span> <span class="org-constant">std</span>::<span class="org-constant">future</span>::<span class="org-type">Future</span>&lt;<span class="org-type">Output</span> = <span class="org-type">Result</span>&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Self</span>::<span class="org-type">Item</span>&gt;, <span class="org-type">Error</span>&gt;&gt; + <span class="org-type">Send</span> + '<span class="org-variable-name">a</span>&gt;&gt;
    {
        <span class="org-keyword">self</span>.start();
        <span class="org-keyword">let</span> <span class="org-variable-name">receiver</span> = <span class="org-keyword">self</span>.receiver.clone().unwrap();
        <span class="org-type">Box</span>::pin(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
            <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Receiving");</span>
            receiver.recv_async().<span class="org-keyword">await</span>.map(<span class="org-type">Some</span>).or_else(|_| <span class="org-type">Ok</span>(<span class="org-type">None</span>))
        })
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Timer</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">new</span>(<span class="org-variable-name">duration</span>: <span class="org-type">Duration</span>) -&gt; <span class="org-type">Timer</span> {
        <span class="org-type">Timer</span> {
            <span class="org-variable-name">receiver</span>: <span class="org-type">None</span>,
            <span class="org-variable-name">handle</span>: <span class="org-type">None</span>,
            duration,
        }
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">start</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">mut</span> <span class="org-keyword">self</span>) {
        <span class="org-keyword">if</span> <span class="org-keyword">self</span>.handle.is_none() {
            <span class="org-keyword">let</span> (sender, receiver) = <span class="org-constant">flume</span>::bounded(1);
            <span class="org-keyword">let</span> <span class="org-variable-name">duration</span> = <span class="org-keyword">self</span>.duration;
            <span class="org-keyword">self</span>.receiver = <span class="org-type">Some</span>(receiver);
            <span class="org-keyword">self</span>.handle = <span class="org-type">Some</span>(<span class="org-constant">tokio</span>::spawn(<span class="org-keyword">async</span> <span class="org-keyword">move</span> {
                sleep(duration).<span class="org-keyword">await</span>;
                <span class="org-comment-delimiter">//</span><span class="org-comment">TODO handle error condition on send</span>
                <span class="org-keyword">let</span> <span class="org-variable-name">_</span> = sender.send(<span class="org-type">Item</span>::default());
            }));
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">Derive</span>&lt;<span class="org-type">Timer</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">derive</span>(<span class="org-variable-name">t</span>: <span class="org-type">Timer</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Out</span>(<span class="org-constant">pipe</span>::<span class="org-type">Out</span>::<span class="org-type">Timer</span>(t)))
    }
}

<span class="org-keyword">impl</span> <span class="org-keyword">crate</span>::<span class="org-constant">serialize</span>::<span class="org-type">Display</span> <span class="org-keyword">for</span> <span class="org-type">Timer</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">representation</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Item</span> {
        <span class="org-constant">assoc</span>::<span class="org-type">Association</span>::derive_iter([
            (<span class="org-string">"type"</span>.fit(), <span class="org-string">"pipe"</span>.fit()),
            (<span class="org-string">"timeout"</span>.fit(), (<span class="org-keyword">self</span>.duration.as_millis() <span class="org-keyword">as</span> <span class="org-type">Int</span>).fit()),
        ])
        .fit()
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">timer</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">ms</span> = <span class="org-type">Int</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
    <span class="org-comment-delimiter">//</span><span class="org-comment">TODO: check for negative values</span>
    <span class="org-type">Ok</span>(<span class="org-type">Timer</span>::new(<span class="org-type">Duration</span>::from_millis(ms <span class="org-keyword">as</span> <span class="org-type">u64</span>)).fit())
}
</pre>
</div></div>
</div>
</li>
<li><a id="org064fe5a"></a>Database<br />
<div class="outline-text-6" id="text-1-5-8-0-7">
<div class='tangle-wrapper' data-tangle='src/types/container/pipe/db.rs'><div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-keyword">crate</span>::axiom;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::config;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::list;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">traits</span>::*;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">container</span>::{<span class="org-keyword">self</span> <span class="org-keyword">as</span> coll, associative <span class="org-keyword">as</span> assoc, <span class="org-constant">error</span>::<span class="org-type">Error</span>};
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::<span class="org-constant">number</span>::<span class="org-type">Number</span>;
<span class="org-keyword">use</span> <span class="org-keyword">crate</span>::<span class="org-constant">types</span>::{<span class="org-keyword">self</span>, <span class="org-type">Item</span>};

<span class="org-keyword">use</span> <span class="org-constant">rusqlite</span>::<span class="org-constant">types</span>::{<span class="org-type">ToSql</span>, <span class="org-type">ToSqlOutput</span>, <span class="org-type">Value</span>, <span class="org-type">ValueRef</span>};
<span class="org-keyword">use</span> <span class="org-constant">rusqlite</span>::{params, <span class="org-type">Connection</span>, <span class="org-type">Error</span> <span class="org-keyword">as</span> <span class="org-type">DBError</span>};
<span class="org-keyword">use</span> <span class="org-constant">std</span>::<span class="org-constant">path</span>::<span class="org-type">PathBuf</span>;

<span class="org-keyword">use</span> <span class="org-constant">uuid</span>;

<span class="org-keyword">pub</span> <span class="org-keyword">struct</span> <span class="org-type">Db</span> {
    <span class="org-variable-name">conn</span>: <span class="org-type">Connection</span>,
}

<span class="org-keyword">impl</span> <span class="org-type">Db</span> {
    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">new</span>() -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">DBError</span>&gt; {
        <span class="org-keyword">let</span> <span class="org-variable-name">db_file</span> = <span class="org-constant">config</span>::<span class="org-type">PlatformConfig</span>::get()
            .unwrap()
            .database
            .ok_or(<span class="org-type">DBError</span>::<span class="org-type">InvalidPath</span>(<span class="org-type">PathBuf</span>::from(<span class="org-string">""</span>.to_string())))<span class="org-rust-question-mark">?</span>;

        <span class="org-keyword">let</span> <span class="org-variable-name">conn</span> = <span class="org-type">Connection</span>::open(db_file.as_path())<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(<span class="org-type">Db</span> { conn })
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">query</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">query</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-variable-name">params</span>: <span class="org-type">Vec</span>&lt;(<span class="org-type">String</span>, <span class="org-type">Item</span>)&gt;) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
        <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">stmt</span> = <span class="org-keyword">self</span>.conn.prepare(query)<span class="org-rust-question-mark">?</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">Convert Vec&lt;Box&lt;dyn ToSql&gt;&gt; to Vec&lt;&amp;dyn ToSql&gt;</span>
        <span class="org-keyword">let</span> <span class="org-variable-name">params_refs</span>: <span class="org-type">Vec</span>&lt;(<span class="org-rust-ampersand">&amp;</span><span class="org-type">str</span>, <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">dyn</span> <span class="org-type">ToSql</span>)&gt; = params
            .iter()
            .map(|(s, b)| (s.as_str(), b <span class="org-keyword">as</span> <span class="org-rust-ampersand">&amp;</span><span class="org-keyword">dyn</span> <span class="org-type">ToSql</span>))
            .collect();

        <span class="org-keyword">let</span> <span class="org-variable-name">rows</span> = stmt.query_and_then(params_refs.as_slice(), |row| {
            (0..row.as_ref().column_count())
                .map(|column_index| {
                    <span class="org-keyword">let</span> <span class="org-variable-name">column_name</span> = row.as_ref().column_name(column_index).unwrap().to_string();
                    <span class="org-keyword">let</span> <span class="org-variable-name">column_value</span>: <span class="org-type">ValueRef</span> = row.get_ref_unwrap(column_index);
                    <span class="org-type">Item</span>::try_derive(column_value)
                        .map(|v| (<span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::derive(column_name.as_str()), v))
                })
                .my_collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-constant">assoc</span>::<span class="org-type">Association</span>, _&gt;&gt;()
                .map(<span class="org-type">Item</span>::derive)
        })<span class="org-rust-question-mark">?</span>;
        <span class="org-type">Ok</span>(rows.my_collect::&lt;<span class="org-type">Result</span>&lt;<span class="org-constant">coll</span>::<span class="org-type">List</span>, _&gt;&gt;()<span class="org-rust-question-mark">?</span>.fit())
    }

    <span class="org-keyword">fn</span> <span class="org-function-name">insert_attribute</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">id</span>: <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>, <span class="org-variable-name">attribute</span>: <span class="org-type">Item</span>, <span class="org-variable-name">value</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">q</span> = <span class="org-string">"INSERT INTO EAV (entity, attribute, value) VALUES (?, ?, ?)"</span>;

        <span class="org-keyword">match</span> value {
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a))) =&gt; {
                <span class="org-keyword">let</span> <span class="org-variable-name">sub_id</span> = <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>::new_v4();
                <span class="org-keyword">self</span>.insert_item(a.fit(), sub_id)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">self</span>.conn.execute(q, <span class="org-preprocessor">params!</span>[id, attribute, sub_id])<span class="org-rust-question-mark">?</span>;
            }
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Set</span>(s))) =&gt; <span class="org-keyword">self</span>.insert_iter(
                <span class="org-type">Some</span>((id, attribute)),
                s.iter().map(|i| <span class="org-type">Item</span>::derive(i.clone())),
            )<span class="org-rust-question-mark">?</span>,
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l))) =&gt; {
                <span class="org-keyword">self</span>.insert_iter(<span class="org-type">Some</span>((id, attribute)), (*l).clone())<span class="org-rust-question-mark">?</span>
            }
            i =&gt; {
                <span class="org-keyword">self</span>.conn.execute(q, <span class="org-preprocessor">params!</span>[id, attribute, i])<span class="org-rust-question-mark">?</span>;
            }
        }
        <span class="org-type">Ok</span>(<span class="org-type">Item</span>::default())
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">insert_iter</span>&lt;<span class="org-type">I</span>&gt;(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">parent_link</span>: <span class="org-type">Option</span>&lt;(<span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>, <span class="org-type">Item</span>)&gt;, <span class="org-variable-name">l</span>: <span class="org-type">I</span>) -&gt; <span class="org-type">Result</span>&lt;(), <span class="org-type">Error</span>&gt;
    <span class="org-keyword">where</span>
        <span class="org-variable-name">I</span>: <span class="org-type">IntoIterator</span>&lt;<span class="org-type">Item</span> = <span class="org-type">Item</span>&gt;,
    {
        <span class="org-keyword">for</span> <span class="org-variable-name">v</span> <span class="org-keyword">in</span> l {
            <span class="org-keyword">if</span> is_value(<span class="org-rust-ampersand">&amp;</span>v) {
                <span class="org-keyword">match</span> parent_link {
                    <span class="org-type">Some</span>(parent_link) =&gt; {
                        <span class="org-keyword">self</span>.insert_attribute(parent_link.0, parent_link.1.clone(), v.clone())<span class="org-rust-question-mark">?</span>;
                        <span class="org-keyword">return</span> <span class="org-type">Ok</span>(());
                    }
                    <span class="org-type">None</span> =&gt; {
                        <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"parent-link"</span>, v.clone()));
                    }
                }
            } <span class="org-keyword">else</span> {
                <span class="org-keyword">let</span> <span class="org-variable-name">sub_id</span> = <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>::new_v4();
                <span class="org-keyword">self</span>.insert_item(v.clone(), sub_id)<span class="org-rust-question-mark">?</span>;
                <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(parent_link) = parent_link.clone() {
                    <span class="org-keyword">self</span>.insert_attribute(
                        parent_link.0,
                        parent_link.1.clone(),
                        sub_id.into_bytes().to_vec().fit(),
                    )<span class="org-rust-question-mark">?</span>;
                }
            }
        }
        <span class="org-type">Ok</span>(())
    }

    <span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">insert_item</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>, <span class="org-variable-name">i</span>: <span class="org-type">Item</span>, <span class="org-variable-name">id</span>: <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
        <span class="org-keyword">let</span> <span class="org-variable-name">s</span> = <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::try_derive(i)<span class="org-rust-question-mark">?</span>;
        <span class="org-keyword">match</span> s {
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Associative</span>(a) =&gt; {
                <span class="org-keyword">for</span> (k, v) <span class="org-keyword">in</span> a.to_iter() {
                    <span class="org-comment-delimiter">//</span><span class="org-comment">println!("Insert! {:?} {:?}", k, v);</span>
                    <span class="org-keyword">let</span> <span class="org-variable-name">w</span>: <span class="org-constant">types</span>::<span class="org-type">Word</span> = k.try_fit()<span class="org-rust-question-mark">?</span>;
                    <span class="org-keyword">self</span>.insert_attribute(id, <span class="org-type">Item</span>::<span class="org-type">Word</span>(w), v)<span class="org-rust-question-mark">?</span>;
                }
            }
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">List</span>(l) =&gt; {
                <span class="org-keyword">self</span>.insert_iter(<span class="org-type">None</span>, (*l).clone())<span class="org-rust-question-mark">?</span>;
            }
            s =&gt; <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"db-object"</span>, s)),
        }
        <span class="org-type">Ok</span>(<span class="org-type">Item</span>::default())
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">is_value</span>(<span class="org-variable-name">i</span>: <span class="org-rust-ampersand">&amp;</span><span class="org-type">Item</span>) -&gt; <span class="org-type">bool</span> {
    <span class="org-keyword">match</span> i {
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(_))) =&gt; <span class="org-keyword">true</span>,
        <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(_))) =&gt; <span class="org-keyword">true</span>,
        <span class="org-type">Item</span>::<span class="org-type">Number</span>(_) =&gt; <span class="org-keyword">true</span>,
        <span class="org-type">Item</span>::<span class="org-type">Word</span>(_) =&gt; <span class="org-keyword">true</span>,
        <span class="org-type">Item</span>::<span class="org-type">Char</span>(_) =&gt; <span class="org-keyword">true</span>,
        _ =&gt; <span class="org-keyword">false</span>,
    }
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">query</span>(<span class="org-variable-name">q</span>: <span class="org-type">Item</span>, <span class="org-variable-name">params</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">query</span>: <span class="org-type">String</span> = q.try_fit()<span class="org-rust-question-mark">?</span>;
    <span class="org-comment-delimiter">// </span><span class="org-comment">Needs to be association, and instead of a slice of ToSql,</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">we need &amp;[(&amp;str, &amp;dyn ToSql)] (slice of pairs of strings and ToSql)</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">params</span>: <span class="org-constant">assoc</span>::<span class="org-type">Associative</span> = params.try_fit()<span class="org-rust-question-mark">?</span>;

    <span class="org-keyword">let</span> <span class="org-keyword">mut</span> <span class="org-variable-name">boxed_params</span>: <span class="org-type">Vec</span>&lt;(<span class="org-type">String</span>, <span class="org-type">Item</span>)&gt; = <span class="org-type">Vec</span>::new();
    <span class="org-keyword">for</span> (k, v) <span class="org-keyword">in</span> params.to_iter() {
        <span class="org-keyword">match</span> k {
            <span class="org-constant">assoc</span>::<span class="org-type">KeyItem</span>::<span class="org-type">String</span>(s) =&gt; boxed_params.push((s, v)),
            k =&gt; <span class="org-keyword">return</span> <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"string"</span>, k)),
        }
    }

    <span class="org-keyword">let</span> <span class="org-variable-name">db</span> = <span class="org-type">Db</span>::new()<span class="org-rust-question-mark">?</span>;
    db.query(<span class="org-rust-ampersand">&amp;</span>query, boxed_params)
}

<span class="org-keyword">pub</span> <span class="org-keyword">fn</span> <span class="org-function-name">insert_object</span>(<span class="org-variable-name">i</span>: <span class="org-type">Item</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">let</span> <span class="org-variable-name">db</span> = <span class="org-type">Db</span>::new()<span class="org-rust-question-mark">?</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">id</span> = <span class="org-constant">uuid</span>::<span class="org-type">Uuid</span>::new_v4();
    db.insert_item(i, id)
}

<span class="org-keyword">impl</span> <span class="org-type">TryDerive</span>&lt;<span class="org-type">ValueRef</span>&lt;'<span class="org-variable-name">_</span>&gt;&gt; <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">type</span> <span class="org-type">Error</span> = <span class="org-type">Error</span>;
    <span class="org-keyword">fn</span> <span class="org-function-name">try_derive</span>(<span class="org-variable-name">value</span>: <span class="org-type">ValueRef</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">Self</span>, <span class="org-type">Self</span>::<span class="org-type">Error</span>&gt; {
        <span class="org-keyword">match</span> value {
            <span class="org-type">ValueRef</span>::<span class="org-type">Integer</span>(i) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i))),
            <span class="org-type">ValueRef</span>::<span class="org-type">Real</span>(f) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(f))),
            <span class="org-type">ValueRef</span>::<span class="org-type">Text</span>(t) =&gt; decode_string(<span class="org-type">String</span>::from_utf8_lossy(t).into_owned()),

            <span class="org-type">ValueRef</span>::<span class="org-type">Blob</span>(b) =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(
                b.to_vec(),
            )))),
            <span class="org-type">ValueRef</span>::<span class="org-type">Null</span> =&gt; <span class="org-type">Ok</span>(<span class="org-type">Item</span>::default()),
        }
    }
}
<span class="org-doc">/// Since sqlite doesn't have separate string/word/char types, we</span>
<span class="org-doc">/// store them all as String, and encode a prefix to note which type</span>
<span class="org-doc">/// it should be when decoded.</span>
<span class="org-keyword">fn</span> <span class="org-function-name">decode_string</span>(<span class="org-variable-name">s</span>: <span class="org-type">String</span>) -&gt; <span class="org-constant">axiom</span>::<span class="org-type">ItemResult</span> {
    <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(w) = s.strip_prefix(<span class="org-string">"w|"</span>) {
        <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Word</span>(w.fit()))
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(s) = s.strip_prefix(<span class="org-string">"s|"</span>) {
        <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(
            <span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s.to_string()),
        )))
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-keyword">let</span> <span class="org-type">Some</span>(c) = s.strip_prefix(<span class="org-string">"c|"</span>) {
        <span class="org-keyword">let</span> <span class="org-variable-name">char_seq</span> = c;
        <span class="org-keyword">if</span> char_seq.chars().count() == 1 {
            <span class="org-type">Ok</span>(<span class="org-type">Item</span>::<span class="org-type">Char</span>(char_seq.chars().next().unwrap()))
        } <span class="org-keyword">else</span> {
            <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"char"</span>, char_seq))
        }
    } <span class="org-keyword">else</span> {
        <span class="org-type">Err</span>(<span class="org-type">Error</span>::expected(<span class="org-string">"string"</span>, s))
    }
}

<span class="org-keyword">enum</span> <span class="org-type">EncodeAs</span> {
    <span class="org-type">String</span>(<span class="org-type">String</span>),
    <span class="org-type">Char</span>(<span class="org-constant">types</span>::<span class="org-type">Char</span>),
    <span class="org-type">Word</span>(<span class="org-constant">types</span>::<span class="org-type">Word</span>),
}

<span class="org-keyword">impl</span> <span class="org-type">EncodeAs</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">encode</span>(<span class="org-keyword">self</span>: <span class="org-type">EncodeAs</span>) -&gt; <span class="org-type">ToSqlOutput</span>&lt;'<span class="org-keyword">static</span>&gt; {
        <span class="org-type">ToSqlOutput</span>::<span class="org-type">Owned</span>(<span class="org-type">Value</span>::<span class="org-type">Text</span>(<span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">EncodeAs</span>::<span class="org-type">String</span>(s) =&gt; <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"s|</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, s),
            <span class="org-type">EncodeAs</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"w|</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-type">String</span>::derive(w)),
            <span class="org-type">EncodeAs</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-rust-builtin-formatting-macro">format!</span>(<span class="org-string">"c|</span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-type">String</span>::from(c)),
        }))
    }
}

<span class="org-keyword">impl</span> <span class="org-constant">rusqlite</span>::<span class="org-type">ToSql</span> <span class="org-keyword">for</span> <span class="org-type">Item</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">to_sql</span>(<span class="org-rust-ampersand">&amp;</span><span class="org-keyword">self</span>) -&gt; <span class="org-type">Result</span>&lt;<span class="org-type">ToSqlOutput</span>&lt;'<span class="org-variable-name">_</span>&gt;, <span class="org-type">DBError</span>&gt; {
        <span class="org-keyword">match</span> <span class="org-keyword">self</span> {
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Int</span>(i)) =&gt; i.to_sql(),
            <span class="org-type">Item</span>::<span class="org-type">Number</span>(<span class="org-type">Number</span>::<span class="org-type">Float</span>(f)) =&gt; f.to_sql(),
            <span class="org-type">Item</span>::<span class="org-type">Char</span>(c) =&gt; <span class="org-type">Ok</span>(<span class="org-type">EncodeAs</span>::<span class="org-type">Char</span>(*c).encode()),
            <span class="org-type">Item</span>::<span class="org-type">Word</span>(w) =&gt; <span class="org-type">Ok</span>(<span class="org-type">EncodeAs</span>::<span class="org-type">Word</span>(w.clone()).encode()),
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s))) =&gt; {
                <span class="org-type">Ok</span>(<span class="org-type">EncodeAs</span>::<span class="org-type">String</span>(s.clone()).encode())
            }
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">String</span>(s))) =&gt; {
                <span class="org-type">Ok</span>(<span class="org-type">EncodeAs</span>::<span class="org-type">String</span>(s.clone()).encode())
            }
            <span class="org-type">Item</span>::<span class="org-type">Dispenser</span>(<span class="org-constant">coll</span>::<span class="org-type">Dispenser</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))) =&gt; b.to_sql(),
            <span class="org-type">Item</span>::<span class="org-type">Receptacle</span>(<span class="org-constant">coll</span>::<span class="org-type">Receptacle</span>::<span class="org-type">Sized</span>(<span class="org-constant">coll</span>::<span class="org-type">Sized</span>::<span class="org-type">Bytes</span>(b))) =&gt; b.to_sql(),

            _ =&gt; <span class="org-preprocessor">todo!</span>(<span class="org-string">"convert item variants to sql values"</span>),
        }
    }
}

<span class="org-keyword">impl</span> <span class="org-type">From</span>&lt;<span class="org-constant">rusqlite</span>::<span class="org-type">Error</span>&gt; <span class="org-keyword">for</span> <span class="org-type">Error</span> {
    <span class="org-keyword">fn</span> <span class="org-function-name">from</span>(<span class="org-variable-name">error</span>: <span class="org-constant">rusqlite</span>::<span class="org-type">Error</span>) -&gt; <span class="org-type">Self</span> {
        <span class="org-type">Error</span>::create(
            <span class="org-preprocessor">list!</span>(<span class="org-string">"io"</span>),
            error.to_string().as_str(),
            <span class="org-type">Option</span>::&lt;<span class="org-type">Item</span>&gt;::<span class="org-type">None</span>,
        )
    }
}
</pre>
</div></div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org8d92ec7" class="outline-2">
<h2 id="org8d92ec7"><span class="section-number-2">2.</span> Issues</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org4b76d8e" class="outline-3">
<h3 id="org4b76d8e"><span class="section-number-3">2.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Interactive mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></h3>
<div class="outline-text-3" id="text-2-1">
<p>
run with <code>kcats -i</code> for interactive, where you get a repl-like
prompt. Each prompt accepts kcats items as input, and updates the
state accordingly. There are special commands to print the current
state, clear it, write to file, etc.
</p>
</div>
<div id="outline-container-org2323da4" class="outline-4">
<h4 id="org2323da4"><span class="section-number-4">2.1.1.</span> <span class="done CANCELED">CANCELED</span> Only print the changed part of the stack</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:45] </span></span> <br />
I think it's too complicated for it to be clear exactly what
changed. How can we tell if we replaced a stack item or added one?</li>
</ul>
</div>
</div>
<div id="outline-container-orgf696351" class="outline-4">
<h4 id="orgf696351"><span class="section-number-4">2.1.2.</span> <span class="todo TODO">TODO</span> Emacs keybindings to send common stack ops</h4>
<div class="outline-text-4" id="text-2-1-2">
<ul class="org-ul">
<li>swap / swapdown</li>
<li>clear ([] evert drop)</li>
<li>clone</li>
<li>snapshot?</li>
<li>drop</li>
<li>sink / float</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga676960" class="outline-3">
<h3 id="orga676960"><span class="section-number-3">2.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Implement pipes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgab74701" class="outline-4">
<h4 id="orgab74701"><span class="section-number-4">2.2.1.</span> <span class="done DONE">DONE</span> Write to a file</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar4"</span><span class="org-kcats-brackets">]]</span> pipe-in

<span class="org-kcats-brackets">[</span><span class="org-string">"hello world!"</span>
 <span class="org-string">"Nice to meet you!"</span>
 <span class="org-string">"My name is kcats"</span><span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span><span class="org-string">"\n"</span> <span class="org-function-name">join</span> bytes <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>

<span class="org-function-name">step</span>
</pre>
</div>

<pre class="example">
[[asked [pipe]] [unwound [["Nice to meet you!" "My name is kcats"] ["\n" join bytes put] step]] [type error] [reason "type mismatch"]] [[type pipe] [file "/tmp/bar4"]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar101r7"</span><span class="org-kcats-brackets">]]</span> pipe-in

<span class="org-string">"hello world!"</span>

bytes <span class="org-function-name">put</span>

</pre>
</div>

<pre class="example">
[[type pipe] [file "/tmp/bar101r7"]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar101r7"</span><span class="org-kcats-brackets">]]</span> pipe-out

<span class="org-function-name">take</span>

string

</pre>
</div>

<pre class="example">
"hello world!" [[type pipe] [file "/tmp/bar101r7"]]
</pre>
</div>
</div>
<div id="outline-container-org0522754" class="outline-4">
<h4 id="org0522754"><span class="section-number-4">2.2.2.</span> <span class="done DONE">DONE</span> Read from a file</h4>
<div class="outline-text-4" id="text-2-2-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">""</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar2"</span><span class="org-kcats-brackets">]]</span> pipe-out

collect 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
stack: <span class="org-kcats-brackets">[[[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>pipe<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar2"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>type pipe<span class="org-kcats-brackets">]]</span> <span class="org-string">""</span><span class="org-kcats-brackets">]</span>
program: <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>closed? not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>closed? not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">loop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span>collect spec<span class="org-kcats-brackets">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
<span class="org-kcats-brackets">[[[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>fail<span class="org-kcats-brackets">]]]</span>
 <span class="org-string">"Lookup attempted on non association value"</span>
 <span class="org-kcats-brackets">[</span>spec<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span>definition <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-kcats-brackets">[[</span>closed? not<span class="org-kcats-brackets">]]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">while</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>spec <span class="org-kcats-brackets">[[</span>pipe program<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>item<span class="org-kcats-brackets">]]]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8e9ca26" class="outline-4">
<h4 id="org8e9ca26"><span class="section-number-4">2.2.3.</span> <span class="done DONE">DONE</span> Close a pipe</h4>
<div class="outline-text-4" id="text-2-2-3">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/foopytoop"</span><span class="org-kcats-brackets">]]</span> pipe-in <span class="org-string">"foo"</span> bytes <span class="org-function-name">put</span> close <span class="org-string">"bar"</span> bytes <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type pipe<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>file <span class="org-string">"/tmp/foopytoop"</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0d686fc" class="outline-4">
<h4 id="org0d686fc"><span class="section-number-4">2.2.4.</span> <span class="done DONE">DONE</span> Serialize pipes with something sane</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Maybe they can't be easily round-tripped, but at least we can print
something reasonable that will tell human eyes what it is.
something like[[type pipe-in] [file "/tmp/foo"]]
</p>
</div>
</div>
<div id="outline-container-org97f3dbe" class="outline-4">
<h4 id="org97f3dbe"><span class="section-number-4">2.2.5.</span> <span class="done DONE">DONE</span> Sockets</h4>
<div class="outline-text-4" id="text-2-2-5">
</div>
<div id="outline-container-orgf6f05d8" class="outline-5">
<h5 id="orgf6f05d8"><span class="section-number-5">2.2.5.1.</span> <span class="done DONE">DONE</span> Server Sockets</h5>
<div class="outline-text-5" id="text-2-2-5-1">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type ip-host<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>address <span class="org-string">"127.0.0.1"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>port 11211<span class="org-kcats-brackets">]]</span> pipe-out 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">socket: Int(11211) String(<span class="org-string">"127.0.0.1"</span>)
<span class="org-kcats-brackets">[[</span>type pipe<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>serversocket todo: fix serversocket local addr async issue<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"127.0.0.1"</span> 12345 serversocket 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">socket: Int(12345) String(<span class="org-string">"127.0.0.1"</span>)
<span class="org-kcats-brackets">[[</span>type pipe<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>serversocket todo: fix serversocket local addr async issue<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type ip-host<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>address <span class="org-string">"127.0.0.1"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>port 11211<span class="org-kcats-brackets">]]</span> pipe-out <span class="org-comment-delimiter">;; </span><span class="org-comment">server socket</span>
<span class="org-function-name">take</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">accept connection by taking a socket out of the pipe</span>
<span class="org-string">"foo\n"</span> bytes <span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">write a message to the socket</span>
<span class="org-function-name">take</span> string <span class="org-comment-delimiter">;; </span><span class="org-comment">get a message from the socket</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">close the socket</span>
 <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">close the server socket</span>
<span class="org-preprocessor">dip</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-string">"foo\n"</span> bytes <span class="org-function-name">put</span> <span class="org-function-name">take</span> string <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8ead95a" class="outline-5">
<h5 id="org8ead95a"><span class="section-number-5">2.2.5.2.</span> <span class="done DONE">DONE</span> Sockets</h5>
</div>

<div id="outline-container-orgce6f42f" class="outline-5">
<h5 id="orgce6f42f"><span class="section-number-5">2.2.5.3.</span> <span class="done CANCELED">CANCELED</span> Assemble is broken when reading files</h5>
<div class="outline-text-5" id="text-2-2-5-3">
<ul class="org-ul">
<li>State "CANCELED"   from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-10-22 Sun 07:55]</span></span></li>
</ul>
<p>
I think it's because <code>closed?</code> is broken.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">""</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]</span> pipe-out assemble
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">""</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]</span> pipe-out <span class="org-function-name">take</span> <span class="org-builtin">drop</span> <span class="org-function-name">take</span> <span class="org-builtin">drop</span> closed? 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">checking file closed <span class="org-keyword">false</span>
Got 3 bytes
checking file closed <span class="org-keyword">false</span>
Got 0 bytes
Closing!
checking file closed <span class="org-keyword">false</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-string">""</span>
</pre>
</div>

<p>
I see the problem. When we clone the pipe, we also clone the <code>closed</code>
boolean and we shouldn't be doing that. There should only be one copy
of that. The entire struct should be in an Arc&lt;Mutex&gt; and not just the
file field. And when we modify the boolean, we shouldn't 
</p>
</div>
</div>
</div>
<div id="outline-container-orgd05b66d" class="outline-4">
<h4 id="orgd05b66d"><span class="section-number-4">2.2.6.</span> <span class="done DONE">DONE</span> Convert In/Out traits to enums in pipes modules</h4>
<div class="outline-text-4" id="text-2-2-6">
<p>
Enums seem to work well elsewhere, and since pipes are also a closed
set, we can use them here too.
</p>

<p>
I don't think there will ever be user-created pipe types as it would
have to be done in rust and not in kcats.
</p>
</div>
</div>
<div id="outline-container-org08c6b6d" class="outline-4">
<h4 id="org08c6b6d"><span class="section-number-4">2.2.7.</span> <span class="done DONE">DONE</span> Composable transforms</h4>
<div class="outline-text-4" id="text-2-2-7">
<p>
There should be some way to compose transforms in a pipe. For example,
we can have a pipe that when you put bytes in it, it gets written to a
certain file on disk. But what we really want is that we put bytes
into it, and they get compressed with lz4 before being written to
disk.
</p>

<p>
I suppose pump could take an optional transducer-like thing, and <b>those</b>
could be composable. The transformations I'm thinking of generally
aren't going to be i/o, it's pure computation. Actually I guess any
pipe could take an optional transform. Clojure.core.async channels do this.
</p>

<p>
Maybe the first thing to do is implement transducers?
</p>
</div>
<div id="outline-container-orgae64dc8" class="outline-5">
<h5 id="orgae64dc8"><span class="section-number-5">2.2.7.1.</span> <span class="done DONE">DONE</span> Siphon from one pipe to another</h5>
<div class="outline-text-5" id="text-2-2-7-1">
<p>
A nice primitive would be a word that takes a program (the program
should expect an item on ToS and it should leave a transformed item)
and two pipes, and takes from one pipe, runs the program, and puts the
result back into the 2nd pipe. It should close the output pipe when
the input pipe closes. Should work with generators as input.
</p>

<p>
This should all work ok except for when programs somewhere in the
generator stack need access to items beneath the generator and we
don't know how to get to them.
</p>

<p>
The obvious solution to that is to include the needed values in the
program before giving it to the generator. Then the values will be in
a known place on the stack.
</p>

<p>
This little program will siphon directly from a generator to a
receptacle:
</p>
<div class="org-src-container">
<pre class="src src-kcats">integers 5 taker

<span class="org-kcats-brackets">[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">receptacle</span>
<span class="org-kcats-brackets">[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">placeholder that gets dropped (next iteration it will hold a</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">copy of the last element which is only needed to check if the</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">loop continues and can be dropped after)</span>
<span class="org-kcats-brackets">[</span>empty?<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">stop when generator returns nothing</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the last value</span>
 <span class="org-kcats-brackets">[</span>generate <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">until</span>
<span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop the now-empty dispenser</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 1 2 3 4 <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
4
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">integers 5 taker <span class="org-kcats-brackets">[]</span> siphon
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>actual <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>generator<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>siphon<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 5 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
-1
</pre>
</div>

<p>
And since pipes can have generator layers put on top of them, I think we're done. 
</p>
</div>
</div>
</div>
<div id="outline-container-orga9253b8" class="outline-4">
<h4 id="orga9253b8"><span class="section-number-4">2.2.8.</span> <span class="done CANCELED">CANCELED</span> Filled pipes</h4>
<div class="outline-text-4" id="text-2-2-8">
<p>
Mostly for testing purposes, takes a list and creates a buffered pipe
that offers list items until the list is exhausted and then returns pipe closed errors.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> filled <span class="org-function-name">take</span>
</pre>
</div>

<pre class="example">
1 [[type pipe] [filled todo: id-or-hash here]]
</pre>
</div>
</div>
<div id="outline-container-org35348ae" class="outline-4">
<h4 id="org35348ae"><span class="section-number-4">2.2.9.</span> <span class="todo INPROGRESS">INPROGRESS</span> Object pipes</h4>
<div class="outline-text-4" id="text-2-2-9">
</div>
<div id="outline-container-orgf9c5e7d" class="outline-5">
<h5 id="orgf9c5e7d"><span class="section-number-5">2.2.9.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Generator re-splitting</h5>
<div class="outline-text-5" id="text-2-2-9-1">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-10-19 Thu 21:10]</span></span></li>
</ul>
<p>
These pipes should send serialized kcats objects and each put/take
should transfer 1 object. Maybe use protocol buffers or similar
</p>

<p>
This could be done using a network pipe, and an assemble function that
pulls byte chunks and builds objects when there are enough bytes for
one object, and puts them into a handoff pipe.
</p>

<p>
This should be possible to do entirely in kcats, similar to how the
interactive mode works. Send a length, then send that number of
bytes. Then the receiving transform can track how many bytes it has
left to receive and the partial encoded item it's got so far. It takes
the next chunk, knocks off that many bytes (if it's more than needed
for that item), and calls <code>read</code>. If it's still not enough for the full
item, append to the partial encoded item and decrease the 'bytes
needed' number.
</p>

<p>
This mechanism of using kcats serialization means we can't send
associations and sets over the wire as-is. We'd have to send them as a
list and convert them at the other end.
</p>

<p>
Let's see if we can make an object serializer that sends the length
first (separated by \n).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> emit bytes
<span class="org-kcats-brackets">[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
string <span class="org-string">"\n"</span> <span class="org-function-name">join</span> bytes
<span class="org-builtin">swap</span> <span class="org-function-name">join</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"NwpbMSAyIDNd"</span>
</pre>
</div>

<p>
That's pretty easy! The trickier part is a deserializer where we don't
know how many bytes we're going to get in a chunk.
</p>

<p>
First we might need a generator that divides into lines.
A generic splitter generator would do most of the work.
</p>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo\nbar\nbaz\n\n"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-string">"\n"</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">\f</span>
<span class="org-kcats-brackets">[</span>empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> ends? not<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> prime
 <span class="org-builtin">drop</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> ends?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> 
  <span class="org-kcats-brackets">[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-builtin">swap</span> - <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> slice<span class="org-kcats-brackets">]</span>
 when
 <span class="org-kcats-brackets">[</span>empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> <span class="org-string">"baz"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span>
                                                                        ends? not<span class="org-kcats-brackets">]]</span>
                                                                   <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> prime <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> ends?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dive</span> <span class="org-builtin">swap</span> - <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> slice<span class="org-kcats-brackets">]</span>
                     when <span class="org-kcats-brackets">[</span>empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
<span class="org-string">""</span> <span class="org-string">"\n"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">""</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo\nbar\nbaz\n\n"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
  <span class="org-string">"\n"</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">\f</span>
 split collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> <span class="org-string">"baz"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span>
                                                                        ends? not<span class="org-kcats-brackets">]]</span>
                                                                   <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> prime <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> ends?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dive</span> <span class="org-builtin">swap</span> - <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> slice<span class="org-kcats-brackets">]</span>
                     when <span class="org-kcats-brackets">[</span>empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
<span class="org-string">""</span> <span class="org-string">"\n"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">""</span>
</pre>
</div>

<p>
Ok this works but ultimately what we need is <code>resplit</code> which takes a
list of sized (all the same type presumably) and joins and splits
piece by piece.
</p>

<p>
We could just create something like <code>atomize</code> that takes a generator of
lists, and emits single items.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo\n"</span> <span class="org-string">"bar\nba"</span> <span class="org-string">"z\n\n"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> generate <span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"foo\nbar\nbaz\n\n"</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> generate <span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Ok the <code>atomize</code> is still handy but what I'm going to do is implement
splitter, that takes a string and emits fields. Then i can use that
generator <b>within</b> a re-split chunks generator, that keeps partial
content as state.
</p>

<p>
So here's that split gen:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">"foo\nbar\nbaz\n\n" [take] "\n"</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[1 2 3 2 5] [take] [2]</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"foo\nbeep"</span> <span class="org-string">"bar\nba"</span> <span class="org-string">"z\n\n"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">"\n"</span>
<span class="org-kcats-brackets">[</span>empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>

<span class="org-comment-delimiter">;</span><span class="org-comment">"foo\nbeep"</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">while the state has no separator, pull chunks into it</span>
<span class="org-kcats-brackets">[</span>yes
 <span class="org-kcats-brackets">[[[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> contains? not<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">state doesn't have sep?</span>
   <span class="org-kcats-brackets">[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">last item still something</span>
  <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> 
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the previous chunk</span>
  <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">while</span>
 <span class="org-builtin">drop</span> 
 <span class="org-comment-delimiter">;; </span><span class="org-comment">now call the split generator internally</span>
 <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">put</span> <span class="org-function-name">reverse</span>
 <span class="org-kcats-brackets">[</span>split <span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> 3 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> 
 <span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span> 

<span class="org-kcats-brackets">]</span>

collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-string">"beepbar"</span> <span class="org-string">"baz"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>yes <span class="org-kcats-brackets">[[[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> contains? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]</span>
                              <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
                         <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
                          bail<span class="org-kcats-brackets">]</span>
                         <span class="org-preprocessor">while</span> <span class="org-builtin">drop</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">put</span> <span class="org-function-name">reverse</span> <span class="org-kcats-brackets">[</span>split <span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> 3
                                                                              <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span>
                         <span class="org-preprocessor">inject</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
<span class="org-string">""</span> <span class="org-string">"\n"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
This is great and all, but maybe not quite what we need for object
serialization. Objects can have \n embedded within strings, so that
character doesn't necessarily mean "end of object". It's just used to
separate the byte count from the content.
</p>

<p>
I think we can implement this pretty directly and easily, especially
if we don't have to account for the case where the count is split
across chunks. We can have a generator with the following state: a
count of chars to read, current content.
</p>

<p>
Generate, read the count, then loop until there is more content left
in buffer than the count says to expect. Slice off [count] characters
from the buffer and return it if there's enough in the buffer,
otherwise generate and repeat. 
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">["5\n[1 2]13\n[ooba " "bazquu]11\nboobooboobo"]</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"3\n"</span> <span class="org-string">"fpp4\nfoo"</span><span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[bytes] map</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[string] each</span>
<span class="org-string">""</span> 0
<span class="org-kcats-brackets">[[[</span>complete? <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>readcount <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span>
              <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">"\n"</span> split generate
              <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 4 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
              <span class="org-kcats-brackets">[</span>read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> bail 0 or<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span>\newline contains? not<span class="org-kcats-brackets">]]</span>
     <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
    prime <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> 
   <span class="org-preprocessor">dip</span>
   <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> \newline contains?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>readcount<span class="org-kcats-brackets">]</span> when<span class="org-kcats-brackets">]</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">[dump [generate] dive [] [join] [drop] if readcount]</span>
  <span class="org-kcats-brackets">[</span>dump complete? not<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span>  <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> prime<span class="org-kcats-brackets">]</span>
 let dump cut 0 <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> each
collect
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbce918a" class="outline-5">
<h5 id="orgbce918a"><span class="section-number-5">2.2.9.2.</span> <span class="todo TODO">TODO</span> Another take on re-splitting</h5>
<div class="outline-text-5" id="text-2-2-9-2">
<p>
A more generic version of the re-splitter:
</p>

<p>
Take as input a buffer (probably of Bytes), and a function of that
buffer that returns 0 or more objects and a new buffer that's the same
or smaller (with parsed objects sliced out). It has additional state of a
buffer of parsed objects (used when we find say, 10 words in a single
byte chunk, if we're trying to parse words - we can't emit 10 objects
at once so we need to save the other 9).
</p>

<p>
Then the resplitting generator becomes:
</p>

<ul class="org-ul">
<li>take from parent generator. If empty, emit from the object buffer (if
any). If non-empty, join with previous byte buffer state</li>
<li><p>
run the splitter function on the byte buffer, join with previous
object buffer state, emit one object
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"[foo] [bar] [ba"</span> <span class="org-string">"z] [quux"</span> <span class="org-string">"] [[this] "</span> <span class="org-string">"[that]]"</span> <span class="org-string">"[foo"</span> <span class="org-string">"]"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">if there is already a parsed object, emit it and don't pull from the parent yet</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">nothing in output</span>
 <span class="org-kcats-brackets">[</span> <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">while</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> collect
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>this<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>that<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]</span>
                                            <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span> when <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-string">"[foo"</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"]"</span><span class="org-kcats-brackets">]</span>
</pre>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span><span class="org-string">"[foo] [bar] [ba"</span>
  <span class="org-string">"z] [quux"</span>
  <span class="org-string">"] [[this] "</span>
  <span class="org-string">"[that]]"</span>
  <span class="org-string">"[foo"</span> <span class="org-string">"]"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>parse-edn<span class="org-kcats-brackets">]</span> parse collect<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>this<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>that<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">
<span class="org-kcats-brackets">[</span><span class="org-string">"[foo]\n [bar] [ba"</span> <span class="org-string">"z] [quux"</span> <span class="org-string">"] [[this] "</span> <span class="org-string">"[that]]"</span> <span class="org-string">"[other"</span> <span class="org-string">"]"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span>

<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if there's nothing in the output, </span>
 <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">generate parent</span>
  <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">as long as the parent generates and there's no output</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span> prime
  <span class="org-comment-delimiter">;; </span><span class="org-comment">we may have bailed out of the loop either because the parent is done or there's output, see which</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span> when
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">generate until either we have output or the parent returned nothing</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise keep generating </span>
 when
 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">]</span> collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>this<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>that<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>other<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span>
  prime <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span>
  when<span class="org-kcats-brackets">]</span>
 when <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-string">""</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Now let's demonstrate with reading UTF8 bytes
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"[foo] [bar] [ba"</span> <span class="org-string">"z] [quux"</span> <span class="org-string">"] [[this] "</span> <span class="org-string">"[that]]"</span> <span class="org-string">"[foo"</span> <span class="org-string">"]"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">if there is already a parsed object, emit it and don't pull from the parent yet</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> not<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span> <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-function-name">join</span> read-chunk<span class="org-kcats-brackets">]</span>
 when
 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> collect
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>104 101 108 108 111<span class="org-kcats-brackets">]</span>              <span class="org-comment-delimiter">;; </span><span class="org-comment">"hello" (all ASCII)</span>
  <span class="org-kcats-brackets">[</span>228 189 160 229 165 189<span class="org-kcats-brackets">]</span>          <span class="org-comment-delimiter">;; </span><span class="org-comment">"&#20320;&#22909;" (two complete Chinese chars)</span>
  <span class="org-kcats-brackets">[</span>104 105 226<span class="org-kcats-brackets">]</span>                      <span class="org-comment-delimiter">;; </span><span class="org-comment">"hi" + start of "&#8364;"</span>
  <span class="org-kcats-brackets">[</span>130 172<span class="org-kcats-brackets">]</span>                          <span class="org-comment-delimiter">;; </span><span class="org-comment">completion of "&#8364;"</span>
  <span class="org-kcats-brackets">[</span>240 159 145<span class="org-kcats-brackets">]</span>                      <span class="org-comment-delimiter">;; </span><span class="org-comment">start of "&#128081;"</span>
  <span class="org-kcats-brackets">[</span>145<span class="org-kcats-brackets">]</span>                              <span class="org-comment-delimiter">;; </span><span class="org-comment">completion of "&#128081;"</span>
  <span class="org-kcats-brackets">[</span>97 98 99 240<span class="org-kcats-brackets">]</span>                     <span class="org-comment-delimiter">;; </span><span class="org-comment">"abc" + start of "&#127752;"</span>
  <span class="org-kcats-brackets">[</span>159 140 136<span class="org-kcats-brackets">]]</span>                     <span class="org-comment-delimiter">;; </span><span class="org-comment">completion of "&#127752;"</span>

 <span class="org-kcats-brackets">[</span>#b64 <span class="org-string">""</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>

 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>parse-utf8<span class="org-kcats-brackets">]</span>
 parse <span class="org-string">""</span> into<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"hello&#20320;&#22909;hi&#8364;&#128081;abc&#127752;"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">""</span> 123 <span class="org-function-name">put</span> string
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"{"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">""</span> <span class="org-kcats-brackets">[</span>104 101 108 108 111<span class="org-kcats-brackets">]</span> #b64 <span class="org-string">""</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-comment-delimiter">; </span><span class="org-comment">parse-utf8</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">""</span> #b64 <span class="org-string">"aGni"</span> parse-utf8
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"4g"</span> <span class="org-string">"hi"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGni"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span> #b64 <span class="org-string">"4g"</span><span class="org-kcats-brackets">]]</span>
                        <span class="org-kcats-brackets">[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGVsbG8"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hello"</span> #b64 <span class="org-string">""</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>parse-utf8 <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[[</span>bytes input<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sized current-output<span class="org-kcats-brackets">]]</span>
                  <span class="org-kcats-brackets">[[</span>bytes remaining-input<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>string updated-output-sequence<span class="org-kcats-brackets">]]]]</span>
           <span class="org-kcats-brackets">[</span>examples <span class="org-kcats-brackets">[[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGni"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span> #b64 <span class="org-string">"4g"</span><span class="org-kcats-brackets">]]</span>
                      <span class="org-kcats-brackets">[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGVsbG8"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hello"</span> #b64 <span class="org-string">""</span><span class="org-kcats-brackets">]]]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>parse-utf8 <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[[</span>bytes input<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>sized current-output<span class="org-kcats-brackets">]]</span>
                    <span class="org-kcats-brackets">[[</span>bytes remaining-input<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>string updated-output-sequence<span class="org-kcats-brackets">]]]]</span>
             <span class="org-kcats-brackets">[</span>examples <span class="org-kcats-brackets">[[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGni"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span> #b64 <span class="org-string">"4g"</span><span class="org-kcats-brackets">]]</span>
                        <span class="org-kcats-brackets">[[</span><span class="org-string">""</span> #b64 <span class="org-string">"aGVsbG8"</span> parse-utf8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"hello"</span> #b64 <span class="org-string">""</span><span class="org-kcats-brackets">]]]]]]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb4c3492" class="outline-4">
<h4 id="orgb4c3492"><span class="section-number-4">2.2.10.</span> <span class="done DONE">DONE</span> Time pipe</h4>
<div class="outline-text-4" id="text-2-2-10">
<p>
Each take from the pipe return the current unix time in ms.  Should be
a "singleton" - probably using Box::leak, so that we can insert a copy
of this pipe whenever we want and it's always a reference to the same
object. Might be an Arc for compatibility even though we don't need to
ref count. (But I suspect we don't need the Arc).
</p>

<div class="org-src-container">
<pre class="src src-kcats">timestamps <span class="org-function-name">take</span>
</pre>
</div>

<pre class="example">
1687273991929 [[from systemtime] [values [[type integer] [units milliseconds]]] [type out]]
</pre>
</div>
</div>
<div id="outline-container-orgf2775d8" class="outline-4">
<h4 id="orgf2775d8"><span class="section-number-4">2.2.11.</span> <span class="done DONE">DONE</span> stdin/stdout pipes</h4>
<div class="outline-text-4" id="text-2-2-11">
<p>
Should also be singleton. Should it always be a tunnel or should we
allow separate access to in or out?
</p>

<div class="org-src-container">
<pre class="src src-kcats">standard <span class="org-string">"foo"</span> bytes <span class="org-function-name">put</span>
</pre>
</div>

<pre class="example">
foo[[type tunnel] [peer standard]]
</pre>


<p>
Stdin is not tested, since currently the interpreter reads the program
from stdin. May need to change that (read the program from filesystem
and let the program itself access stdin).
</p>
</div>
</div>
<div id="outline-container-orgf342c52" class="outline-4">
<h4 id="orgf342c52"><span class="section-number-4">2.2.12.</span> <span class="done CANCELED">CANCELED</span> Pipe take outcome</h4>
<div class="outline-text-4" id="text-2-2-12">
<ul class="org-ul">
<li><p>
State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-09-22 Fri 09:14] </span></span> <br />
I don't think there's any glaring inconsistency here - indefinite (or
i guess I might call them 'unsized') dispensers will dispense <code>nothing</code>
when there's nothing left. That means that when you are using one of
these, <code>nothing</code> is not a valid value you can use in the sequence.
</p>

<p>
That means, for example, that if you wanted to print whether integers
are odd or not, you can't quite do that. You'd need to use pairs (the
original value and true/[] for whether it's odd).
</p>

<p>
Perhaps later we can think about signaling end-of-stream out of
band. One way to do that is to use an unhandled error value that
unwinds the stack, and you have to recover to catch it. But that
introduces a lot of complexity and I think it may be easier to just
work around the fact that you can't use <code>nothing</code> in the data. It's
possible that maybe the complexity in the out-of-band impl could be
abstracted away, so it's worth revisiting later.
</p></li>
</ul>
<p>
There is some inconsistency with what happens when there's nothing
left - empty lists just return nothing on take, but closed pipes
return an error. May need to resolve this inconsistency.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">List</th>
<th scope="col" class="org-left">Handoff</th>
<th scope="col" class="org-left">Socket</th>
<th scope="col" class="org-left">StaticFile</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">take Items</td>
<td class="org-left">Item</td>
<td class="org-left">Item</td>
<td class="org-left">Bytes</td>
<td class="org-left">Bytes</td>
</tr>

<tr>
<td class="org-left">take Past EOF</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
</tr>

<tr>
<td class="org-left">step Past EOF</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgce67a64" class="outline-3">
<h3 id="orgce67a64"><span class="section-number-3">2.3.</span> <span class="todo TODO">TODO</span> Error should have actual struct fields&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></h3>
<div class="outline-text-3" id="text-2-3">
<p>
It's still implemented as generic Hashmap data field. 
</p>
</div>
</div>
<div id="outline-container-orgf6eb2b2" class="outline-3">
<h3 id="orgf6eb2b2"><span class="section-number-3">2.4.</span> <span class="todo INPROGRESS">INPROGRESS</span> Script</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-23 Fri 15:12]</span></span></li>
</ul>
</div>
<div id="outline-container-orgac88733" class="outline-4">
<h4 id="orgac88733"><span class="section-number-4">2.4.1.</span> <span class="done DONE">DONE</span> Cryptographic primitives</h4>
<div class="outline-text-4" id="text-2-4-1">
</div>
<div id="outline-container-orgb5d7c19" class="outline-5">
<h5 id="orgb5d7c19"><span class="section-number-5">2.4.1.1.</span> <span class="done DONE">DONE</span> SHA256</h5>
<div class="outline-text-5" id="text-2-4-1-1">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes hash <span class="org-string">"fop"</span> bytes hash =
</pre>
</div>

<pre class="example">
[]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> bytes key<span class="org-kcats-brackets">]</span> 2 <span class="org-preprocessor">times</span> =
</pre>
</div>

<pre class="example">
true
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key
</pre>
</div>

<pre class="example">
[[public #b64 "NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA="] [type elliptic-curve-key] [secret #b64 "LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="]]
</pre>
</div>
</div>
<div id="outline-container-org1fa7444" class="outline-5">
<h5 id="org1fa7444"><span class="section-number-5">2.4.1.2.</span> <span class="done DONE">DONE</span> Signing</h5>
<div class="outline-text-5" id="text-2-4-1-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key <span class="org-string">"we attack at dawn"</span> bytes <span class="org-kcats-brackets">[</span>sign<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> verify
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-keyword">true</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key <span class="org-string">"we attack at dawn"</span> bytes <span class="org-kcats-brackets">[</span>sign<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">now change the message</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-string">"we attack at dawn"</span> bytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
verify
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"d2UgYXR0YWNrIGF0IGRhd24="</span>
</pre>
</div>

<p>
We need to be able to construct scripts and their hash. What is the
public key format? We can sort the assoc so that the serialization is
always the same.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key <span class="org-comment-delimiter">;; </span><span class="org-comment">new key</span>
<span class="org-kcats-brackets">[</span>secret<span class="org-kcats-brackets">]</span> unassign <span class="org-comment-delimiter">;; </span><span class="org-comment">discard the secret portion</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> sort <span class="org-comment-delimiter">;; </span><span class="org-comment">make sure the assoc is always serialized the same way</span>
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">sink</span> verify<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> 
emit<span class="org-comment-delimiter">; </span><span class="org-comment">bytes hash </span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"[[[public #b64 \"NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA=\"] [type elliptic-curve-key]] sink verify]"</span>
</pre>
</div>

<p>
So this is the script data. Then the high level script (that's always
the same) is: we've got inputs, a script, and a script hash. If the
hash of the script is equal the given hash, execute the program on the
given input.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"[[[public #b64 \"NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA=\"] [type elliptic-curve-key]] sink verify]"</span> bytes <span class="org-kcats-brackets">[</span>hash<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span> #b64 <span class="org-string">"W1tbcHVibGljICNiNjQgIk5OSmxlZHUwVm1rK1ZBWnl6NUl2VXQzZzFsTXVOYjhHdmdFNmZGTXZJT0E9Il0gW3R5cGUgZWxsaXB0aWMtY3VydmUta2V5XV0gc2luayB2ZXJpZnld"</span>
</pre>
</div>

<p>
Now let's make a signature with that same key
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key <span class="org-string">"we attack at dawn"</span> bytes <span class="org-kcats-brackets">[</span>sign<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"sAVOx61lJzZAcVMPNFBeDGjzaSej++hqjLctgr1stVcAMk+L1mSZC7nxbtj5+8rYj99zXKLZX6gQzO8bBvvlAA=="</span>
#b64 <span class="org-string">"d2UgYXR0YWNrIGF0IGRhd24="</span> <span class="org-kcats-brackets">[[</span>type elliptic-curve-key<span class="org-kcats-brackets">]</span>
                                 <span class="org-kcats-brackets">[</span>secret #b64 <span class="org-string">"LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>public #b64 <span class="org-string">"NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA="</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
Now use that data and execute the script on it
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"sAVOx61lJzZAcVMPNFBeDGjzaSej++hqjLctgr1stVcAMk+L1mSZC7nxbtj5+8rYj99zXKLZX6gQzO8bBvvlAA=="</span>
 #b64 <span class="org-string">"d2UgYXR0YWNrIGF0IGRhd24="</span><span class="org-kcats-brackets">]</span> emit
read <span class="org-function-name">first</span> 
<span class="org-string">"[[[public #b64 \"NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA=\"] [type elliptic-curve-key]] sink verify]"</span> read <span class="org-function-name">first</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> string
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"we attack at dawn"</span>
</pre>
</div>

<p>
Now let's make a word 'authenticate', that takes a script hash, a
script, and its args, and returns true if it's the right script and it
validates. Important: check the hash before attempting to execute or
even read the script. That ensures that it's what the sender intended
(doesn't protect against malicious real sender, just malicious impostors).
</p>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">script hash</span>
#b64 <span class="org-string">"W1tbcHVibGljICNiNjQgIk5OSmxlZHUwVm1rK1ZBWnl6NUl2VXQzZzFsTXVOYjhHdmdFNmZGTXZJT0E9Il0gW3R5cGUgZWxsaXB0aWMtY3VydmUta2V5XV0gc2luayB2ZXJpZnld"</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">script</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">"foo"</span>
<span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"sAVOx61lJzZAcVMPNFBeDGjzaSej++hqjLctgr1stVcAMk+L1mSZC7nxbtj5+8rYj99zXKLZX6gQzO8bBvvlAA=="</span>
 #b64 <span class="org-string">"d2UgYXR1YWNrIGF0IGRhd24="</span>
 <span class="org-kcats-brackets">]</span> emit bytes <span class="org-comment-delimiter">;; </span><span class="org-comment">the proof (key) as serialized bytes list - the sig and message</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">first check hash</span>
<span class="org-kcats-brackets">[[[</span>hash =<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>string read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> both functional <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> lingo <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> recover
 <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> bail <span class="org-comment-delimiter">;; </span><span class="org-comment">gives the message and who it's from</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> #b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span>
</pre>
</div>

<p>
Try where the actual script is not what the hash requires, should return <code>nothing</code>
</p>
<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">script hash</span>
<span class="org-string">"[true]"</span> emit bytes
<span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"sAVOx61lJzZAcVMPNFBeDGjzaSej++hqjLctgr1stVcAMk+L1mSZC7nxbtj5+8rYj99zXKLZX6gQzO8bBvvlAA=="</span>
 #b64 <span class="org-string">"d2UgYXR0YWNrIGF0IGRhd24="</span>
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">data as list</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">first check hash</span>
<span class="org-kcats-brackets">[[[</span>hash =<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> string read <span class="org-function-name">first</span> functional <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> lingo <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> recover

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> #b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span>
</pre>
</div>

<p>
Try where the signature is invalid by substituting a sig from a different message - same key.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes key <span class="org-string">"we attack at dusk"</span> bytes sign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"XtOnDCT9+iiHV0BElSAckjo76e2yY3swEOOWo0FfstHgukymw9XXHm7+jLtEBsBjJzo5kyo6058WJ/XPpAe1Aw=="</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">script hash</span>
#b64 <span class="org-string">"W1tbcHVibGljICNiNjQgIk5OSmxlZHUwVm1rK1ZBWnl6NUl2VXQzZzFsTXVOYjhHdmdFNmZGTXZJT0E9Il0gW3R5cGUgZWxsaXB0aWMtY3VydmUta2V5XV0gc2luayB2ZXJpZnld"</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">lock</span>
<span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"XtOnDCT9+iiHV0BElSAckjo76e2yY3swEOOWo0FfstHgukymw9XXHm7+jLtEBsBjJzo5kyo6058WJ/XPpAe1Aw=="</span>
 #b64 <span class="org-string">"d2UgYXR0YWNrIGF0IGRhd24="</span>
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">data as list</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">first check hash</span>
<span class="org-kcats-brackets">[[[</span>hash =<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> string read <span class="org-function-name">first</span> functional <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> lingo <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> recover

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> #b64 <span class="org-string">"SsjPm5GDruW/Ixa/pY97y+Y2JI1+siSETU6yJwlSUvM="</span>
</pre>
</div>

<p>
try a dummy script that really does always validate
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-keyword">true</span><span class="org-kcats-brackets">]</span> encode hash
<span class="org-string">"[true]"</span> encode <span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[</span>dump <span class="org-kcats-brackets">[</span>hash =<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> string read <span class="org-function-name">first</span> functional <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> lingo <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> recover
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[]</span> #b64 <span class="org-string">"W3RydWVd"</span> #b64 <span class="org-string">"M+LwVX3X2/aNUvQNUQxkH9+m5dpgq8cN+sB9K2tsvM8="</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> #b64 <span class="org-string">"M+LwVX3X2/aNUvQNUQxkH9+m5dpgq8cN+sB9K2tsvM8="</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1d82031" class="outline-5">
<h5 id="org1d82031"><span class="section-number-5">2.4.1.3.</span> <span class="done DONE">DONE</span> Make verify return the message</h5>
<div class="outline-text-5" id="text-2-4-1-3">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-09-28 Thu 10:43]</span></span></li>
</ul>
<p>
one thing I hadn't considered before. We receive this package of
"proof" - proof of what? That this message is from the party
represented by the given script hash. What message?  It's contained in
the proof. The important thing is that if the proof is good <b>we return
the message</b>. I think a good contract is that we return the message (as
bytes) if it's valid proof, otherwise <code>nothing</code>.  If we only return <code>true</code>
on valid proof then we have to embark on digging out the message from
potentially nested proofs. If we just return the message from each
layer (on success) then we don't have to have this separate logic.
</p>

<p>
I think it's best to just have the contract of the word <code>verify</code> do this
for us - there's no reason to just return the truthy value <code>true</code> when
the message is a perfectly good truthy value. I suppose signing an
empty byte array could cause confusion (if that were considered
"nothing" which I suppose it should, but currently isn't). But I can't
think of any valid reason to sign 'nothing'.
</p>
</div>
</div>
<div id="outline-container-org51e7aa5" class="outline-5">
<h5 id="org51e7aa5"><span class="section-number-5">2.4.1.4.</span> <span class="todo TODO">TODO</span> AES Encryption</h5>
</div>
<div id="outline-container-org24284f6" class="outline-5">
<h5 id="org24284f6"><span class="section-number-5">2.4.1.5.</span> <span class="todo TODO">TODO</span> Random</h5>
</div>
</div>
<div id="outline-container-org737ee8d" class="outline-4">
<h4 id="org737ee8d"><span class="section-number-4">2.4.2.</span> <span class="done DONE">DONE</span> Pure functional env</h4>
<div class="outline-text-4" id="text-2-4-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>pipe-in pipe-out channel timeout handoff file-in file-out timestamps standard serversocket animate future spit tunnel <span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> unassign<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> lingo
</pre>
</div>

<pre class="example">
1 2
</pre>
</div>
</div>
<div id="outline-container-orgc746435" class="outline-4">
<h4 id="orgc746435"><span class="section-number-4">2.4.3.</span> <span class="todo TODO">TODO</span> Infinite loop protection</h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
We need to prevent an attacker presenting <code>true [clone] loop</code> as their
identity proof, which would never halt. It may be easiest to just
remove all the looping words from the dictionary, but that seems
overly restrictive, when the point is just to limit the resources an
attacker can consume, and we already have a direct solution for that:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-keyword">true</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">loop</span><span class="org-kcats-brackets">]]]</span> environment
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org9a1dc22" class="outline-3">
<h3 id="org9a1dc22"><span class="section-number-3">2.5.</span> <span class="todo TODO">TODO</span> retry should have opposite argument order&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span>&#xa0;<span class="consistency">consistency</span></span></h3>
<div class="outline-text-3" id="text-2-5">
<p>
Currently it expects an error on ToS and then a program beneath. But
it seems like we'd nearly always have to <code>dip</code> the program beneath the
error. I think it would be better if <code>retry</code> expected the program to fix
the issue on top, and the error beneath.
</p>
</div>
</div>
<div id="outline-container-org4a1d67e" class="outline-3">
<h3 id="org4a1d67e"><span class="section-number-3">2.6.</span> <span class="todo INPROGRESS">INPROGRESS</span> Support Kademlia DHT</h3>
<div class="outline-text-3" id="text-2-6">
</div>
<div id="outline-container-org86b1d2e" class="outline-4">
<h4 id="org86b1d2e"><span class="section-number-4">2.6.1.</span> <span class="done DONE">DONE</span> XOR</h4>
<div class="outline-text-4" id="text-2-6-1">
<p>
We have a node id (maybe just the i2p destination address?) and we
want to calculate the distance to another node as the XOR
</p>
</div>
</div>
<div id="outline-container-org84fc915" class="outline-4">
<h4 id="org84fc915"><span class="section-number-4">2.6.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Simple API server</h4>
<div class="outline-text-4" id="text-2-6-2">
<p>
Construct a socket listener, and serve something from a trivial local
database. Disable exploitable words. Catch errors and return to the user.
</p>

<div class='tangle-wrapper' data-tangle='examples/api.kcats'><div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">create an API service</span>
<span class="org-comment-delimiter">;; </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Takes from the stack:</span>
<span class="org-comment-delimiter">;; </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">* a Database (can be a regular data structure for read-only apis),</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">or a pipe to an actual (sql or other) database that accepts queries for</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">read/write ops</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">* a program that modifies the dictionary that clients can</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">access. It should add words to make interaction easier (for</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">example, you might provide a word 'customers' that gets the customers</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">db table). It should also remove words that the clients should not be able</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">to use - for example, they shouldn't be able to create file or network pipes. </span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">* a server socket pipe to serve from</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">The client sends a program to run in a fresh environment where he</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">can expect to find:</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">* The database (either a pipe or data structure)</span>
<span class="org-comment-delimiter">;;</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">His program runs and then the resulting stack is returned to him.</span>
<span class="org-comment-delimiter">;; </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">socket listener</span>
<span class="org-kcats-brackets">[[</span>type ip-host<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>port 12121<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>address <span class="org-string">"127.0.0.1"</span><span class="org-kcats-brackets">]]</span> pipe-out

<span class="org-comment-delimiter">;; </span><span class="org-comment">book db</span>
<span class="org-string">"examples/books.kcats"</span> file-out slurp read

<span class="org-comment-delimiter">;</span><span class="org-comment">functional ;; dictionary modifications, removes any io access </span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">API Server code begins here</span>

<span class="org-comment-delimiter">;</span><span class="org-comment">dictionary swap execute ;; -&gt; new-dict db sock</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">start building the environment</span>
<span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the request as bytes</span>
           <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">we want the pipe on top so we can dip the user's program under it -&gt; pipe req db</span>
           <span class="org-kcats-brackets">[</span>string <span class="org-comment-delimiter">;; </span><span class="org-comment">translate to a string -&gt; req-str db</span>
            read <span class="org-function-name">first</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the request program into a data structure -&gt; prog db</span>
            <span class="org-builtin">clone</span> emit print <span class="org-comment-delimiter">;; </span><span class="org-comment">log the request</span>
            functional <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> recover<span class="org-kcats-brackets">]</span> lingo <span class="org-comment-delimiter">;; </span><span class="org-comment">the program -&gt; items*</span>
            <span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the pipe so the user's code has no access</span>
           <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; response pipe</span>
           emit <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; response-str pipe</span>
           bytes <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; response-bytes pipe</span>
           <span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the response into the pipe</span>
           <span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">close the connection</span>
          <span class="org-kcats-brackets">]]]</span> environment <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; env new-dict db sock </span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[dictionary] float ;; -&gt; new-dict [dictionary] env db sock</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">assign  ;; -&gt; env db sock</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">now just need to assign the stack, which is [pipe db] </span>
<span class="org-builtin">float</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; sock env db</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">loop to accept connections and start new env with the db and a pipe</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">to take requests and reply</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">float</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; pipe db env</span>
  pair <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; stack env</span>
  <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; stack ks env</span>
  assign <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; env</span>
  environment
  animate <span class="org-comment-delimiter">;; </span><span class="org-comment">let it fly  </span>
 <span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">shielded so as not to consume the db each time</span>
 <span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop whatever the result is of this iteration, we don't need it</span>
<span class="org-kcats-brackets">]</span>

<span class="org-function-name">step</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">accepts incoming connections until killed</span>
</pre>
</div></div>

<p>
This works ok for a read-only database, but for the purposes of a DHT
we can't do it this way - we'd have to expose the database and there's
no way to prevent the api user from making arbitrary (and malicious)
changes.
</p>
</div>
</div>
<div id="outline-container-org45bfd27" class="outline-4">
<h4 id="org45bfd27"><span class="section-number-4">2.6.3.</span> <span class="todo INPROGRESS">INPROGRESS</span> Simple API client</h4>
<div class="outline-text-4" id="text-2-6-3">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"localhost"</span> 12121 socket
<span class="org-kcats-brackets">[[[</span>title<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">count</span> 10 &lt;<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span><span class="org-kcats-brackets">]</span>
encode <span class="org-function-name">put</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> joiner generate string read<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"George"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Orwell"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>title <span class="org-string">"1984"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>year 1949<span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>government dystopia surveillance totalitarianism freedom<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Charlotte"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bronte"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>title <span class="org-string">"Jane Eyre"</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>year 1847<span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>love morality society class womanhood independence<span class="org-kcats-brackets">]]]]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org789a88a" class="outline-4">
<h4 id="org789a88a"><span class="section-number-4">2.6.4.</span> <span class="todo TODO">TODO</span> Kademlia functions</h4>
</div>
</div>
<div id="outline-container-org263ae9b" class="outline-3">
<h3 id="org263ae9b"><span class="section-number-3">2.7.</span> <span class="done DONE">DONE</span> read and emit don't have quite the same semantics&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-06-14 Fri 06:56]</span></span></li>
</ul>
<p>
read will read all the bytes and return however many objects were read.
emit will take an object and return its serialization.
</p>

<p>
There should be some way of round tripping here, maybe a word <code>read1</code> or
something that just reads one object. 
</p>
</div>
</div>
<div id="outline-container-org2e9b381" class="outline-3">
<h3 id="org2e9b381"><span class="section-number-3">2.8.</span> <span class="done DONE">DONE</span> Inconsistent stack handling when encountering error&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:34] </span></span> <br />
I think this is complete, not aware of any more cases. Will reopen if needed</li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-12-30 Sat 14:17]</span></span></li>
</ul>
<p>
Some words pop the arguments off the stack, then if an error is
encountered, throws the error without the args on the stack. Others
leave the args intact. This needs to be consistent.
</p>

<p>
I would lean towards leaving the args intact so that <code>retry</code> is easily applied.
</p>
</div>
<div id="outline-container-org654a014" class="outline-4">
<h4 id="org654a014"><span class="section-number-4">2.8.1.</span> <span class="done DONE">DONE</span> 'read' on invalid edn consumes the string argument</h4>
<div class="outline-text-4" id="text-2-8-1">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:33]</span></span></li>
</ul>
<p>
It should attempt to parse before popping the item off the stack.
</p>
</div>
</div>
<div id="outline-container-org6ec8808" class="outline-4">
<h4 id="org6ec8808"><span class="section-number-4">2.8.2.</span> <span class="done DONE">DONE</span> Division by zero consumes stack items</h4>
<div class="outline-text-4" id="text-2-8-2">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:34]</span></span></li>
</ul>
<p>
<code>5 0 /</code> shouldn't consume the <code>5</code> and <code>0</code> - compare to <code>1 "2" +</code> behavior
(which leaves items on stack).
</p>
</div>
</div>
</div>
<div id="outline-container-org42113af" class="outline-3">
<h3 id="org42113af"><span class="section-number-3">2.9.</span> <span class="done DONE">DONE</span> Inconsistent expression handling when encountering error</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-10-15 Sun 15:24]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-10-15 Sun 15:20]</span></span></li>
</ul>
<p>
Some errors lose the word on which they occurred. They should be in
the expression still.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> get
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>actual <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>get<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
The word <code>get</code> should still be in the <code>unwound</code> field.
</p>

<p>
I think this only works correctly when the invalid argument is caught
by spec checking and not in the actual axiom function.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-string">""</span> +
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>actual <span class="org-string">""</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span>
<span class="org-string">""</span> 1
</pre>
</div>

<p>
Here's an example where the spec is too permissive and the actual
function throws the error.
</p>
<div class="org-src-container">
<pre class="src src-kcats">1 set
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>sized<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>set<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>actual 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
The question then is how to fix this? Hopefully this can be fixed
inside <code>eval_step</code>. After the function completes, we can check if there
was an error on top (if there wasn't before), and if so, we can replace the 
</p>
</div>
</div>
<div id="outline-container-org536a8dd" class="outline-3">
<h3 id="org536a8dd"><span class="section-number-3">2.10.</span> <span class="todo TODO">TODO</span> Performance optimizations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></h3>
<div class="outline-text-3" id="text-2-10">
</div>
<div id="outline-container-org111e96c" class="outline-4">
<h4 id="org111e96c"><span class="section-number-4">2.10.1.</span> <span class="todo TODO">TODO</span> Compile programs</h4>
<div class="outline-text-4" id="text-2-10-1">
<p>
Here is how it could maybe be done. We already have a type StepFn
(which takes an env and returns a new one, in a future).
</p>

<p>
So let's say we have a program [1 2 +], and we want to convert that
into a StepFn. We could have a function <code>compose</code> and another
<code>self_insert</code>, and then call compose([self<sub>insert</sub>(1), self<sub>insert</sub>(2),
plus]), which would return a StepFn.
</p>

<p>
Let's look at something more complex:
</p>

<p>
<code>1 2 3 4 [+ *] dip</code>
</p>

<p>
In this case, the program is the composition of the 5 self-inserts and
dip. But what is self-inserted as the 5th item in this case could be
compiled because we know <code>dip</code> follows it. How we know in advance a list
can be compiled is difficult.
</p>

<p>
Let's try this:
</p>

<p>
<code>0 1 [2 3 4] [[+] dip] step</code>
</p>

<p>
In this case, the program for <code>step</code> is easy to spot, and in turn <code>dip</code>.
</p>

<p>
How about this:
</p>

<p>
<code>[+ *] [2 3 4] swap join execute</code>
</p>

<p>
We can't know the first two programs can be compiled until later on,
unless we look ahead in the program. Even then we can only know
what arguments end up being passed to join and execute by examining
the words' specs, and even that is not foolproof, as we have wildcard
specs like dip where the stack change is arbitrary.
</p>

<p>
One major issue with this optimization is that it will stop the
debugger from working properly, unless special care is taken: with the
debugger we can go step by step, but if the function composition is
bundled up, we can only "step over" that function and not "into" it. I
am not sure if it's possible to build this such that we preserve
stepping ability and increase performance substantially.
</p>

<p>
I've tried various approaches to this problem and honestly I can't
find anything remotely simple that I'm confident would be a
significant performance improvement. I'm not even sure something
complex would be fast, short of a full blown compiler. And then
whatever compiler that is would have to be available at runtime on all
platforms - so I can't just compile to C source because I would then
have to ship a C compiler too.
</p>
</div>
</div>
<div id="outline-container-org250d638" class="outline-4">
<h4 id="org250d638"><span class="section-number-4">2.10.2.</span> <span class="todo TODO">TODO</span> Programs as their own immutable type</h4>
<div class="outline-text-4" id="text-2-10-2">
<p>
Programs executing in a loop are generally not modified (exception -
the <code>recur</code> word, which can modify but usually just calls <code>execute</code>)- so
when we execute a program with <code>loop</code> we don't want to have to clone it
each time through the loop.
</p>

<p>
Instead we'll do the following: when <code>loop</code> places a program into the
program, instead of joining it, it's just going to put it right on
top as a <code>program</code> - we may need to differentiate programs that are
active vs meant to be run later. When <code>eval-step</code> runs, it sees an
active program on the top of the program, so it calls <code>next</code> and gets
a reference to the next word (or None if it's at the end, drop the
program). Then we lookup that word. If it's an axiom, we call it. If
it's derived, we place a new program on the top of the program,
with its PC set to 0. The actual programs are immutable, and behind an
Rc. Each "copy" of the program is just an Rc and a counter. Then all
programs are references except the counter.
</p>


<p>
example program:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>flip <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">0 </span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">float</span> <span class="org-builtin">swapdown</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>flip <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">0 1</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">pc 0</span>
<span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">pc 1 </span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">pc 0 1</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">etc</span>
</pre>
</div>

<p>
So when printing out the program, we could cheat and only show the
remaining program (instead of a stack of partially executed programs).
</p>
</div>
</div>
</div>
<div id="outline-container-orgf0c264b" class="outline-3">
<h3 id="orgf0c264b"><span class="section-number-3">2.11.</span> <span class="todo INPROGRESS">INPROGRESS</span> Generators&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h3>
<div class="outline-text-3" id="text-2-11">
</div>
<div id="outline-container-orgf6d131d" class="outline-4">
<h4 id="orgf6d131d"><span class="section-number-4">2.11.1.</span> <span class="done DONE">DONE</span> Basic functionality and generators</h4>
<div class="outline-text-4" id="text-2-11-1">
<p>
There's the concept of "lazy sequence" that I think maps nicely to
pipes - you can keep calling 'take' and it keeps calculating new
values. Everything it needs is contained in the object, it's not like
a network or filesystem pipe where the data is coming from somewhere
external. But it acts like a pipe.
</p>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">the producer - infinite seq of integers</span>
<span class="org-kcats-brackets">[[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; [1] 1</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">the filter condition</span>
<span class="org-kcats-brackets">[</span>3 mod 0 =<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">divisible by 3</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">filter-xf</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">pop</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>  

<span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">[generation filtration] [] 0 </span>
<span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">generate ;; [3]</span>
<span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">generate ;; [3]</span>
<span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">generate ;; [3]</span>
<span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">generate ;; [3]</span>
</pre>
</div>

<p>
The problem above is <code>generate</code> will not produce a value until one
passes the filter. I think filter needs to keep calling <code>generate</code> on the xf below it?
</p>
<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-function-name">pop</span> <span class="org-kcats-brackets">[</span>3 mod 0 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> 4
</pre>
</div>

<pre class="example">
1 [[unwound [[[[inc clone] dip swap put [pop [3 mod 0 =]] [put] [drop] if]] unwrap]] [type error] [asked [packable]] [actual 1] [reason "type mismatch"] [handled true]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">the impl of filter-xf</span>
<span class="org-kcats-brackets">[</span>3 mod 0 =<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">pop</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>  
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-function-name">pop</span> <span class="org-kcats-brackets">[</span>3 mod 0 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span>
<span class="org-builtin">drop</span> <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span>
</pre>
</div>

<pre class="example">
2 [inc clone] 2
</pre>


<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">]</span>
</pre>
</div>

<pre class="example">
[[generate] dip] [] [inc] 1
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">[1 2 3 4 6 9] liberate ;; produce from list</span>
1 <span class="org-kcats-brackets">[</span>2 * <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">infinite list</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">increment each</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">[3 * 3 -] each</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">drop the first few</span>
5 dropper
<span class="org-comment-delimiter">;; </span><span class="org-comment">limit the list</span>
10 taker
<span class="org-comment-delimiter">;; </span><span class="org-comment">collect into list</span>
collect
<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>64 128 256 512 1024 2048 4096 8192
 16384 32768<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> generate
</pre>
</div>

<pre class="example">
1 [inc clone] 1
</pre>


<p>
Now express the debugger interface in terms of generated environment states!
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">the steps of execution</span>
<span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>0 0 10 1 range <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span> environment
<span class="org-kcats-brackets">[[[</span>program<span class="org-kcats-brackets">]</span> lookup something?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[]]</span>
 <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the generator, which needs to emit 'nothing' once the program is empty</span>
<span class="org-kcats-brackets">[[</span>stack<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> each
50 taker
laster
generate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>reason word is not defined<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>laster generate<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>laster<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 50 <span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[[[</span>stack<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
           bail<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[</span>program<span class="org-kcats-brackets">]</span> lookup something?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>0 0 10 1 range <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
implement 'laster' which returns only the last in the seq
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 100 1 range liberate
laster
generate
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> traversal <span class="org-comment-delimiter">;; </span><span class="org-comment">a generator for the list</span>
<span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> each
collect
</pre>
</div>
<pre class="example">
99 [generate [] swap [] [swap drop [generate] dip swap] while drop] liberate []
</pre>


<p>
Now implement 'keep' which returns only an item that passes the filter
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> keep
1 dropper
10 taker
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]</span> each
collect
</pre>
</div>

<pre class="example">
[9 25 49 81 121 169 225 289 361 441] [generate [[clone *] bail] shielddown] [[positive?] [dec [generate] dip swap] [drop []] if] [[[positive?] [[generate drop] dip dec] while [generate swap] dip swapdown swap] bail] 0 [clone [[generate] dip [drop generate] while] dip swap] [[[something?] [odd? not]] [execute] every?] [inc clone] 21
</pre>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>something?<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> pair <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>every?<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">[odd? not]</span>

</pre>
</div>

<pre class="example">
[[[something?] [odd?]] every?]
</pre>


<p>
dropper (almost got it, doesn't detect end of parent stream yet)
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 20 1 range liberate
 5 dropper
 10 taker
 <span class="org-kcats-brackets">[</span>5 *<span class="org-kcats-brackets">]</span> each
 <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> keep
 collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>25 35 45 55 65<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
Collect fix
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> liberate

generate <span class="org-comment-delimiter">;; </span><span class="org-comment">n</span>
<span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">n n r</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r</span>
 <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r n</span>
 <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">n n r </span>
<span class="org-preprocessor">loop</span> <span class="org-builtin">drop</span>
</pre>
</div>

<pre class="example">
[1 2 3] liberate []
</pre>


<div class="org-src-container">
<pre class="src src-kcats">integers 10 taker collect <span class="org-builtin">drop</span> generate 
</pre>
</div>

<pre class="example">
[] [[positive?] [dec [generate] dive] [[]] if] 0 [inc clone] 9
</pre>
</div>
</div>
<div id="outline-container-org6c9e5e8" class="outline-4">
<h4 id="org6c9e5e8"><span class="section-number-4">2.11.2.</span> <span class="done DONE">DONE</span> map</h4>
</div>
<div id="outline-container-orgb301c1c" class="outline-4">
<h4 id="orgb301c1c"><span class="section-number-4">2.11.3.</span> <span class="done DONE">DONE</span> filter</h4>
</div>
<div id="outline-container-org5ae56d5" class="outline-4">
<h4 id="org5ae56d5"><span class="section-number-4">2.11.4.</span> <span class="done DONE">DONE</span> take</h4>
<div class="outline-text-4" id="text-2-11-4">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">a generator of ints starting with 0</span>
-1 <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>inc &#128101;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670;
<span class="org-comment-delimiter">;; </span><span class="org-comment">taker</span>
5
<span class="org-kcats-brackets">[[[</span>positive?<span class="org-kcats-brackets">]</span> &#128737;&#65039;
  <span class="org-kcats-brackets">[</span>&#128465;&#65039; 1&#65039;&#8419; &#128011;<span class="org-kcats-brackets">]</span> 
  <span class="org-kcats-brackets">[[]]</span> &#9878;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#127890;<span class="org-kcats-brackets">]</span> &#128011;
<span class="org-kcats-brackets">[[</span>dec &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#129668;<span class="org-kcats-brackets">]</span>  
<span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[]]</span>
<span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; 
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 1 2 3 4<span class="org-kcats-brackets">]</span> 4
</pre>
</div>
</div>
</div>
<div id="outline-container-org965976f" class="outline-4">
<h4 id="org965976f"><span class="section-number-4">2.11.5.</span> <span class="done DONE">DONE</span> drop</h4>
<div class="outline-text-4" id="text-2-11-5">
<div class="org-src-container">
<pre class="src src-kcats">integers 15 taker 10 dropper <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> reduce
</pre>
</div>

<pre class="example">
60 [[[positive?] [[generate drop] dip dec] while [generate swap] dip float] bail] 0 [[positive?] [dec [generate] dive] [[]] if] 0 [inc clone] 14
</pre>
</div>
</div>
<div id="outline-container-org7925ee4" class="outline-4">
<h4 id="org7925ee4"><span class="section-number-4">2.11.6.</span> <span class="done DONE">DONE</span> drop-while (skipper)</h4>
<div class="outline-text-4" id="text-2-11-6">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-11-30 Thu 18:01]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-11-30 Thu 17:28]</span></span>
This is what drop-while looks like</li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the state (whether threshold reached)</span>
<span class="org-kcats-brackets">[[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">condition - whether we've finished dropping or not </span>
 <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">true - pass everything else through</span>
 <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">prime init</span>
  <span class="org-kcats-brackets">[[[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">bring pred up and exec it</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if pred passes drop the value</span>
  prime <span class="org-comment-delimiter">;; </span><span class="org-comment">after this should have value on top</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-keyword">true</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">set flag</span>
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">false - generate, check pred, repeat</span>
 <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
collect
</pre>
</div>
</div>
</div>
<div id="outline-container-orge9eee7d" class="outline-4">
<h4 id="orge9eee7d"><span class="section-number-4">2.11.7.</span> <span class="done DONE">DONE</span> take-while (catcher)</h4>
<div class="outline-text-4" id="text-2-11-7">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-11-30 Thu 18:02]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-11-30 Thu 17:30]</span></span></li>
</ul>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 <span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span>
 <span class="org-kcats-brackets">[[[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> bail not<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span>
 when<span class="org-kcats-brackets">]</span>




collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> bail not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span>
         when<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3384ba8" class="outline-4">
<h4 id="org3384ba8"><span class="section-number-4">2.11.8.</span> <span class="done CANCELED">CANCELED</span> last</h4>
</div>
<div id="outline-container-org8b8aad6" class="outline-4">
<h4 id="org8b8aad6"><span class="section-number-4">2.11.9.</span> <span class="todo TODO">TODO</span> distinct</h4>
<div class="outline-text-4" id="text-2-11-9">
<p>
depends on sets
</p>

<p>
The difference between this and just calling <code>set</code> is that the result is
still a list, and it preserves the original order, just removes
duplicates. Should be a similar impl to <code>keep</code>.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 3<span class="org-kcats-brackets">]</span> liberate
<span class="org-kcats-brackets">[]</span> set <span class="org-comment-delimiter">;; </span><span class="org-comment">state</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">n seen g</span>

 <span class="org-kcats-brackets">[</span>contains?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">seen g</span>
  <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">n seen g</span>
 <span class="org-preprocessor">while</span>
<span class="org-kcats-brackets">]</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[</span>contains?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span> <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgccc70ef" class="outline-4">
<h4 id="orgccc70ef"><span class="section-number-4">2.11.10.</span> <span class="done DONE">DONE</span> partition</h4>
<div class="outline-text-4" id="text-2-11-10">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-12-07 Thu 17:39]</span></span></li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5 6<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
2 <span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">count</span> inc <span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">count</span> inc<span class="org-kcats-brackets">]]</span>
    <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> 2 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 3 4 5 6<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orged0f15f" class="outline-4">
<h4 id="orged0f15f"><span class="section-number-4">2.11.11.</span> <span class="done DONE">DONE</span> joiner (aka catenate)</h4>
<div class="outline-text-4" id="text-2-11-11">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 5 6<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>7 8 9<span class="org-kcats-brackets">]]</span>
liberate
<span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span>
 <span class="org-kcats-brackets">[]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span>
  <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> 
 <span class="org-preprocessor">while</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 
generate
</pre>
</div>

<pre class="example">
[1 2 3 4 5 6 7 8 9] [generate [] swap [] [join [generate] dip swap] while drop] [take] []
</pre>
</div>
</div>
<div id="outline-container-org2348070" class="outline-4">
<h4 id="org2348070"><span class="section-number-4">2.11.12.</span> <span class="done DONE">DONE</span> groupby</h4>
<div class="outline-text-4" id="text-2-11-12">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:35] </span></span> <br />
Implemented as `group`</li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> <span class="org-string">"baaz"</span> <span class="org-string">"quux"</span><span class="org-kcats-brackets">]</span>
liberate <span class="org-comment-delimiter">;; </span><span class="org-comment">(the next word foo)</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">liberate ;; (the first letter f)</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>

<span class="org-function-name">wrap</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">k v state</span>
 <span class="org-function-name">wrap</span> <span class="org-builtin">swap</span>  <span class="org-comment-delimiter">;;  </span><span class="org-comment">v k state</span>
 <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-kcats-brackets">[]</span> association <span class="org-comment-delimiter">;; </span><span class="org-comment">state f</span>
<span class="org-builtin">swap</span>

cram
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>\q <span class="org-kcats-brackets">[</span><span class="org-string">"quux"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>\f <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>\b <span class="org-kcats-brackets">[</span><span class="org-string">"bar"</span> <span class="org-string">"baaz"</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Ok so now we just need to insert the [take] program instead of
specifying it inline.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> group
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span><span class="org-keyword">true</span> <span class="org-kcats-brackets">[</span>1 3<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>2 4<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf385257" class="outline-4">
<h4 id="orgf385257"><span class="section-number-4">2.11.13.</span> <span class="done CANCELED">CANCELED</span> Map/filter can't access lower stack items</h4>
<div class="outline-text-4" id="text-2-11-13">
</div>
<div id="outline-container-org0772405" class="outline-5">
<h5 id="org0772405"><span class="section-number-5">2.11.13.1.</span> Problem</h5>
<div class="outline-text-5" id="text-2-11-13-1">
<p>
this doesn't work:
</p>

<div class="org-src-container">
<pre class="src src-kcats">10 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> liberate <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> each
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> 10
</pre>
</div>

<p>
We should get <code>[11 12 13]</code> but it errors out.
</p>

<p>
The reason is that when + runs, the generators are still on the stack,
in between this mapping function, and the original stack arguments.
</p>

<p>
We need a way to break out of the generation part of the stack and let
the mapping function access the arguments below it.
</p>

<p>
I can't immediately think of a good way to do it.
</p>

<p>
Actually I think that instead of recursively calling generate, and
passing the values back up the stack, there might be a way to build up
the program recursively, and then execute it in one swoop? 
</p>

<p>
Perhaps we can split each stage into several parts:
</p>

<ul class="org-ul">
<li>Generate from the layer below (in which case we obviously need the
layers below to get the next value)</li>
<li>dip underneath the layers to calculate the next value using lower stack items</li>
<li>swap the new value to the top of stack</li>
<li></li>
</ul>
</div>
</div>
<div id="outline-container-orgfba5c04" class="outline-5">
<h5 id="orgfba5c04"><span class="section-number-5">2.11.13.2.</span> Debug session</h5>
<div class="outline-text-5" id="text-2-11-13-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>10 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> liberate <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> each generate<span class="org-kcats-brackets">]]]</span> environment
advance advance advance advance eval-<span class="org-function-name">step</span> <span class="org-kcats-brackets">[</span>advance<span class="org-kcats-brackets">]</span> 5 <span class="org-preprocessor">times</span> eval-<span class="org-function-name">step</span>
<span class="org-kcats-brackets">[</span>advance<span class="org-kcats-brackets">]</span> 2 <span class="org-preprocessor">times</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> 99 <span class="org-preprocessor">times</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">10 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> liberate <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> each generate
</pre>
</div>

<pre class="example">
[[asked [number]] [reason "type mismatch"] [unwound [+ [[1 [take] [2 3] 10]] unwrap evert first swap drop [[generate [[+] bail] shielddown]] unwrap swap]] [actual [take]] [type error] [handled true]] 1 [take] [2 3] 10
</pre>



<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[[</span>program <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]]]</span> environment advance<span class="org-kcats-brackets">]]]</span> environment advance advance eval-<span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[[</span>program<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">count</span> <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&lt;=<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>stack <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]]]]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfc2573b" class="outline-5">
<h5 id="orgfc2573b"><span class="section-number-5">2.11.13.3.</span> Resolution</h5>
<div class="outline-text-5" id="text-2-11-13-3">
<p>
After thinking about this some more, my conclusion:
</p>

<p>
This is supporting multi-arity mapping functions, which did work in
the original map implementation but they are not supported in other
languages. The way you access multiple values there is by closing over
them. So the way you'd do it in kcats is like so:
</p>

<div class="org-src-container">
<pre class="src src-kcats">10 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the extra arg and the list</span>
<span class="org-kcats-brackets">[</span>-<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the multi-arity map fn</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">clone the 10</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> prepend <span class="org-comment-delimiter">;; </span><span class="org-comment">prepend the word swap to the fn so that the 10 ends up beneath the list item</span>
<span class="org-builtin">float</span> prepend <span class="org-comment-delimiter">;; </span><span class="org-comment">prepend the 10</span>
<span class="org-function-name">map</span>
</pre>
</div>

<pre class="example">
[9 8 7] 10
</pre>


<p>
In theory we could write a helper function called <code>capture1</code> or something that does this for us, so you can write
</p>

<pre class="example">
10 [1 2 3] [-] capture1 map
</pre>

<div class="org-src-container">
<pre class="src src-kcats">10 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the extra arg and the list</span>
<span class="org-kcats-brackets">[</span>-<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the multi-arity map fn</span>

<span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">f i</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> prepend
 <span class="org-builtin">swap</span> prepend<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
<span class="org-kcats-brackets">[</span>liberate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> each collect
</pre>
</div>

<pre class="example">
[9 8 7] [generate [[10 swap -] bail] shielddown] [take] [] 10
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-string">"oh fudge"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>5 +<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> 5<span class="org-kcats-brackets">]</span>
 recover<span class="org-kcats-brackets">]</span>
<span class="org-function-name">map</span>
</pre>
</div>

<pre class="example">
[6 7 5]
</pre>
</div>
</div>
<div id="outline-container-org75f5344" class="outline-5">
<h5 id="org75f5344"><span class="section-number-5">2.11.13.4.</span> <span class="done DONE">DONE</span> Add functions to help capture environment for map/filter fns</h5>
<div class="outline-text-5" id="text-2-11-13-4">
<p>
It's too difficult to do this manually.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[</span>2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
</pre>
</div>

<p>
we want to redesign this so that we build the mapping function first:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> capture
<span class="org-kcats-brackets">[</span>2 3 4<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">map</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>3 4 5<span class="org-kcats-brackets">]</span> 1
</pre>
</div>

<p>
and the generator equivalent
</p>
<div class="org-src-container">
<pre class="src src-kcats">5 <span class="org-kcats-brackets">[</span>* inc<span class="org-kcats-brackets">]</span> capture <span class="org-kcats-brackets">[</span>integers 100 dropper 10 taker<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> each collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>501 506 511 516 521 526 531 536 541 546<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[[[</span>5<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> * inc<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 0 <span class="org-kcats-brackets">[[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>generate <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
                                                             <span class="org-preprocessor">dip</span> dec<span class="org-kcats-brackets">]</span>
                                                <span class="org-preprocessor">while</span> <span class="org-kcats-brackets">[</span>generate <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
                                                <span class="org-preprocessor">dip</span> <span class="org-builtin">float</span><span class="org-kcats-brackets">]</span>
                                               bail<span class="org-kcats-brackets">]</span>
0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
109 5
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org16fb6db" class="outline-4">
<h4 id="org16fb6db"><span class="section-number-4">2.11.14.</span> <span class="done DONE">DONE</span> Reduce</h4>
<div class="outline-text-4" id="text-2-11-14">
<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 30 taker <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-builtin">clone</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">acc acc f</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">drop [generate] divedown [] [float execute clone] [] if</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">acc f g</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">i acc f g</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">float</span> <span class="org-preprocessor">execute</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">acc acc f g</span>
<span class="org-preprocessor">loop</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 10 taker 
generate <span class="org-builtin">clone</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">acc acc </span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">drop [generate] divedown [] [float execute clone] [] if</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">acc g</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">i acc g</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>+ <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">acc acc f g</span>
<span class="org-preprocessor">loop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">55 <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 10
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 3 taker
<span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">build the 'then' branch</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">-&gt; [+ clone]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">build the loop body</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[]]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-kcats-brackets">[[]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">generate the first item under the loop body</span>
<span class="org-kcats-brackets">[</span>generate <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
<span class="org-preprocessor">loop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6 <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 0 <span class="org-kcats-brackets">[</span>inc <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 2 3 4 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span>
</pre>
</div>

<pre class="example">
3 4 3
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-keyword">true</span> <span class="org-kcats-brackets">[</span> inc <span class="org-builtin">clone</span> 5 &lt; <span class="org-kcats-brackets">]</span> <span class="org-preprocessor">loop</span>
</pre>
</div>

<pre class="example">
5
</pre>


<div class="org-src-container">
<pre class="src src-kcats">integers
1 dropper <span class="org-comment-delimiter">;; </span><span class="org-comment">start with 1</span>
1000 taker <span class="org-comment-delimiter">;; </span><span class="org-comment">take items</span>
<span class="org-kcats-brackets">[</span>3 *<span class="org-kcats-brackets">]</span> each
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> keep
<span class="org-kcats-brackets">[</span>+ 37 mod<span class="org-kcats-brackets">]</span> reduce
</pre>
</div>

<pre class="example">
10 [clone [[generate] dip [drop generate] while] dive] [[[something?] [odd? not]] [execute] every?] [generate [[3 *] bail] shielddown] [[positive?] [dec [generate] dive] [drop []] if] [[[positive?] [[generate drop] dip dec] while [generate swap] dip float] bail] 0 [inc clone] 1000
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1025 8 mod
</pre>
</div>

<pre class="example">
1
</pre>


<p>
let's make an equivalent to <code>map</code> (that doesn't require a generator) for ease of use
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span>  
</pre>
</div>

<p>
&#x2026;wait a minute, isn't that just <code>step</code>?
</p>
</div>
</div>
<div id="outline-container-orgf02eaf6" class="outline-4">
<h4 id="orgf02eaf6"><span class="section-number-4">2.11.15.</span> <span class="done CANCELED">CANCELED</span> Generator combinators?</h4>
<div class="outline-text-4" id="text-2-11-15">
<ul class="org-ul">
<li>State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-01-16 Tue 17:10] </span></span> <br />
Not sure there's anything to do here.</li>
</ul>
<p>
When writing <code>partition</code>, it would be nice if we could use generators
<b>within</b> a generator. For example, we need to partition a list into
pairs. It would be nice if we could use <code>2 taker</code> repeatedly. Let's see if we can make that work:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>2 taker collect <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> collect

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>3 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>5 6<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>7<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span>2 taker collect <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Ok wow did not expect that to be so easy.
</p>

<p>
Maybe we can even implement the window shifting version?
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
3 1  <span class="org-comment-delimiter">; </span><span class="org-comment">params: window-size, shift-size, state</span>
<span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[[</span>dotake <span class="org-kcats-brackets">[[</span>taker collect
            <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">; </span><span class="org-comment">drop the used-up taker generator</span>
           <span class="org-function-name">join</span> divedeep<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>doshift <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> 0 slice<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>
  <span class="org-kcats-brackets">[]</span>
  <span class="org-kcats-brackets">[</span>over <span class="org-function-name">wrap</span> dotake <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> doshift<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>over<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">wrap</span> dotake <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> doshift<span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
 draft<span class="org-kcats-brackets">]</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 5 6<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 6 7<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>dotake <span class="org-kcats-brackets">[[</span>taker collect <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span>
                                                     <span class="org-function-name">join</span> divedeep<span class="org-kcats-brackets">]]</span>
                                            <span class="org-kcats-brackets">[</span>doshift <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]</span>
                                                       <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> 0 slice<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
                                                      <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
                                           <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>over <span class="org-function-name">wrap</span> dotake <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> doshift<span class="org-kcats-brackets">]</span>
                                                bail<span class="org-kcats-brackets">]</span>
                                            <span class="org-kcats-brackets">[[</span>over<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">wrap</span> dotake <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> doshift<span class="org-kcats-brackets">]</span>
                                            <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
                                           draft<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>6 7<span class="org-kcats-brackets">]</span>
1 3 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc3221c4" class="outline-4">
<h4 id="orgc3221c4"><span class="section-number-4">2.11.16.</span> <span class="done DONE">DONE</span> Applying generator to an existing container</h4>
<div class="outline-text-4" id="text-2-11-16">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-12-07 Thu 17:40]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-11-10 Fri 16:36]</span></span></li>
</ul>
<p>
we commonly have this construct: <code>[[1 2 3] ... collect] shield</code>, where
we're transducing a list and we want to just get the result.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>odd?<span class="org-kcats-brackets">]</span> keep<span class="org-kcats-brackets">]</span> 
<span class="org-kcats-brackets">[</span>xform dispenser<span class="org-kcats-brackets">]</span> label
<span class="org-kcats-brackets">[[[</span>poke dispenser<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>splice xform<span class="org-kcats-brackets">]</span> collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
template <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 3 5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb063731" class="outline-4">
<h4 id="orgb063731"><span class="section-number-4">2.11.17.</span> <span class="todo INPROGRESS">INPROGRESS</span> Combinations</h4>
<div class="outline-text-4" id="text-2-11-17">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-01-17 Wed 09:13]</span></span></li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> -1 <span class="org-comment-delimiter">;; </span><span class="org-comment">l idx i</span>
             <span class="org-kcats-brackets">[[[</span><span class="org-builtin">swap</span> <span class="org-function-name">count</span> =<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-function-name">take</span> 0 <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> when
              <span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span><span class="org-kcats-brackets">]</span>
             <span class="org-comment-delimiter">;</span><span class="org-comment">generate drop generate drop generate drop generate</span>
             collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 5<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 5<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>3 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>3 5<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
This isn't quite right because we're not using a lower generator as
the source, even though we could. We could start with an empty list as
the state, call generate, and then yield pairs for that item and every
item in the state. Then add it to the state and continue until the
lower generator yields nothing.
</p>

<p>
"combinations" may not be a good name since it implies all
combinations and not just pairs. Maybe put this on hold until we actually need it.
</p>

<p>
Ok let's do it this way, here's a python version:
</p>
<div class="org-src-container">
<pre class="src src-python">
<span class="org-keyword">def</span> <span class="org-function-name">generate_recursive</span>(items_generator, current_combo, remaining_arity):
    <span class="org-keyword">if</span> remaining_arity <span class="org-operator">==</span> 0:
        <span class="org-keyword">yield</span> current_combo
    <span class="org-keyword">else</span>:
        <span class="org-keyword">for</span> item <span class="org-keyword">in</span> items_generator():
            <span class="org-keyword">yield</span> <span class="org-keyword">from</span> generate_recursive(items_generator, current_combo <span class="org-operator">+</span> [item], remaining_arity <span class="org-operator">-</span> 1)

<span class="org-keyword">def</span> <span class="org-function-name">generate_combinations</span>(items_generator, arity):
    <span class="org-keyword">for</span> item <span class="org-keyword">in</span> items_generator():
        <span class="org-keyword">yield</span> <span class="org-keyword">from</span> generate_recursive(items_generator, [item], arity <span class="org-operator">-</span> 1)

<span class="org-comment-delimiter"># </span><span class="org-comment">Example usage with a generator:</span>
<span class="org-keyword">def</span> <span class="org-function-name">item_generator</span>():
    <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(1, 4):
        <span class="org-keyword">yield</span> i

<span class="org-variable-name">arity</span> <span class="org-operator">=</span> 3
<span class="org-variable-name">result</span> <span class="org-operator">=</span> []

<span class="org-keyword">for</span> combo <span class="org-keyword">in</span> generate_combinations(item_generator, arity):
    result.append( combo)
<span class="org-keyword">return</span> result
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>combos <span class="org-kcats-brackets">[[]</span>
          <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> 1 =<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">clone</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> dec <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>self enumerate generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">put a generator for tuples one smaller and get the first one</span>
           <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[[</span>a b c d<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> 2 combos generate<span class="org-kcats-brackets">]</span>
draft

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">2 <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> 1 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">clone</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> dec <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span>
                                                          <span class="org-kcats-brackets">[</span>combos enumerate generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span><span class="org-kcats-brackets">]</span>
   <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>a<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> 1 <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> 1 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span>
                                                                    <span class="org-builtin">clone</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
                                                        <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> dec <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>combos enumerate generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>a<span class="org-kcats-brackets">]</span> 1 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>b c d<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
enumerate generator
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c d<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
0 <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> 
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>0 a<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 b<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 c<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>3 d<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> 4 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c d e<span class="org-kcats-brackets">]</span> 1 3 <span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[</span>= not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span> <span class="org-kcats-brackets">[[</span>1 =<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[]</span>
   <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span> when

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c d e<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> 3 1 <span class="org-kcats-brackets">[</span>a b c d e<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbdee382" class="outline-4">
<h4 id="orgbdee382"><span class="section-number-4">2.11.18.</span> <span class="done DONE">DONE</span> Frequencies</h4>
<div class="outline-text-4" id="text-2-11-18">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:35]</span></span></li>
</ul>
<p>
Given a generator, keep track of how many times each value occurs.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 1 2 3 4 -1 3 3<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> association
<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span>
cram
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>-1 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>3 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>4 1<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-kcats">
<span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">the sample program to run</span>
tracer
<span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> each <span class="org-comment-delimiter">;; </span><span class="org-comment">what item is being executed</span>
<span class="org-kcats-brackets">[</span>word?<span class="org-kcats-brackets">]</span> keep <span class="org-comment-delimiter">;; </span><span class="org-comment">only words</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">frequencies</span>
<span class="org-kcats-brackets">[]</span> association
<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span>
cram
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span>
                             <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
                             <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]]]</span>
          <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
                   <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
                   <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
                   <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]]]]]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[[</span>generate <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span>
                                                                             <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">float</span> <span class="org-function-name">join</span> <span class="org-preprocessor">while</span>
           <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span>
                    <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
                    <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
          <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]]]]]</span>
<span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span>
                    <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
                    <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
          <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>2 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">the sample program to run</span>
<span class="org-kcats-brackets">[</span>tracer
 <span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> bail 0 or<span class="org-kcats-brackets">]</span> each <span class="org-comment-delimiter">;; </span><span class="org-comment">what item is being</span>
                                           <span class="org-comment-delimiter">;; </span><span class="org-comment">executed, don't emit []</span>
                                           <span class="org-comment-delimiter">;; </span><span class="org-comment">or the execution stops,</span>
                                           <span class="org-comment-delimiter">;; </span><span class="org-comment">use 0 instead</span>
 <span class="org-kcats-brackets">[</span>word?<span class="org-kcats-brackets">]</span> keep <span class="org-comment-delimiter">;; </span><span class="org-comment">count only words</span>
 frequencies<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>&gt; 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> 6<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>dec 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>decorate 2<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>decorated 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span> 11<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dipdown</span> 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> 12<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">loop</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span> 5<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> 4<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> 3<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> 14<span class="org-kcats-brackets">]</span>
 
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">while</span> 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> 3<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar <span class="org-kcats-brackets">[]</span> quux<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>word?<span class="org-kcats-brackets">]</span> keep collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> generate<span class="org-kcats-brackets">]</span>
        <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>something?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>word? not<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org908621e" class="outline-3">
<h3 id="org908621e"><span class="section-number-3">2.12.</span> <span class="todo TODO">TODO</span> Make floats hashable</h3>
<div class="outline-text-3" id="text-2-12">
<p>
This will allow floats to be added to the <code>KeyItem</code> enum. Floats are not
normally hashable, because mathematically identical numbers are not
always represented the same way in memory and wouldn't hash the
same. But for the purposes of kcats, I think this doesn't matter. We
can document that you can't expect (10.0 + 10.0) and (15.0 + 5.0) to
be the same map key.
</p>

<p>
This will then allow a list that contains floats, to be sorted, or be
able to use float values as a sort-by key.
</p>
</div>
</div>
<div id="outline-container-org13896d2" class="outline-3">
<h3 id="org13896d2"><span class="section-number-3">2.13.</span> <span class="done DONE">DONE</span> Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h3>
<div class="outline-text-3" id="text-2-13">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:51]</span></span></li>
</ul>
</div>
<div id="outline-container-org4bf7b7f" class="outline-4">
<h4 id="org4bf7b7f"><span class="section-number-4">2.13.1.</span> <span class="done DONE">DONE</span> Implement partialord</h4>
<div class="outline-text-4" id="text-2-13-1">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:50]</span></span></li>
</ul>
<p>
Each type needs to be comparable to another.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span><span class="org-string">"b"</span> 2<span class="org-kcats-brackets">][</span><span class="org-string">"g"</span> 5<span class="org-kcats-brackets">][</span><span class="org-string">"a"</span>, 1<span class="org-kcats-brackets">][</span><span class="org-string">"d"</span> 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"c"</span> 3<span class="org-kcats-brackets">]]</span> association sort-indexed
</pre>
</div>

<pre class="example">
[1 2 3 4 5]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>-2 10 -8 -12 8 0 1 20<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>5 - abs<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">join</span>
<span class="org-kcats-brackets">[</span> pair<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-function-name">map</span>  sort-indexed 
</pre>
</div>

<pre class="example">
Pair is (Int(-2), Int(7))
Pair is (Int(10), Int(5))
Pair is (Int(-8), Int(13))
Pair is (Int(-12), Int(17))
Pair is (Int(8), Int(3))
Pair is (Int(0), Int(5))
Pair is (Int(1), Int(4))
Pair is (Int(20), Int(15))
[8 1 10 0 -2 -8 20 -12]
</pre>


<p>
UHOH
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span> <span class="org-string">"there"</span> <span class="org-string">"what"</span> <span class="org-string">"is"</span> <span class="org-string">"your"</span> <span class="org-string">"birthdate"</span> <span class="org-string">"homeboy"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">join</span>
<span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-function-name">map</span>  sort-indexed 
</pre>
</div>

<pre class="example">
Pair is (Iterable(Sized(String("hi"))), String("hi"))
Pair is (Iterable(Sized(String("there"))), String("there"))
Pair is (Iterable(Sized(String("what"))), String("what"))
Pair is (Iterable(Sized(String("is"))), String("is"))
Pair is (Iterable(Sized(String("your"))), String("your"))
Pair is (Iterable(Sized(String("birthdate"))), String("birthdate"))
Pair is (Iterable(Sized(String("homeboy"))), String("homeboy"))
["birthdate" "hi" "homeboy" "is" "there" "what" "your"]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">8 5 - 
</pre>
</div>

<pre class="example">
3
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 2 <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> both
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3 2
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfdbbfa4" class="outline-4">
<h4 id="orgfdbbfa4"><span class="section-number-4">2.13.2.</span> <span class="done DONE">DONE</span> Implement compare</h4>
<div class="outline-text-4" id="text-2-13-2">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:39]</span></span></li>
</ul>
<p>
Should expose Rust's comparison function. That will allow a native
sort function, for max flexibility (but not performance).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"a"</span> <span class="org-string">"b"</span> compare
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">less
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"a"</span> <span class="org-string">"a"</span> compare
</pre>
</div>

<pre class="example">
equal
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"a"</span> <span class="org-string">"b"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"a"</span> <span class="org-string">"c"</span><span class="org-kcats-brackets">]</span> compare
</pre>
</div>

<pre class="example">
less
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> encode <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> compare
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">less
</pre>
</div>

<p>
This should work - the empty set and map maybe can't be compared but Nothing should be in there.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> -1000 compare
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">greater
</pre>
</div>

<p>
<code>&lt;</code> in terms of compare?
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> compare <span class="org-kcats-brackets">[</span>greater<span class="org-kcats-brackets">]</span> &#127851; =
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">&#9989;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5232eb7" class="outline-3">
<h3 id="org5232eb7"><span class="section-number-3">2.14.</span> <span class="todo TODO">TODO</span> Stream transformation</h3>
<div class="outline-text-3" id="text-2-14">
<p>
Problem: kcats doesn't speak http or https or various other protocols
and formats, but rust does. We want to be able to use the complicated
bits of rust, but let kcats decide how to combine them.
</p>

<p>
Implementation: I think we may need to create a new Rust enum Item
type, that acts as a generator. It has an input method "next<sub>input</sub>"
that takes an input chunk which is the result of the generator
beneath, then it either returns None (updated the state, but no new
item yet), or Item (got a new item), or some signal for end of stream,
or Error. So it would have some program with a while loop to
iterate. All such transforms would probably have the same program.
</p>

<p>
I think what I am getting at here is that Items should implement Rust
traits where possible, eg Read/Write for file and network pipes.
</p>
</div>
</div>
<div id="outline-container-orge87707f" class="outline-3">
<h3 id="orge87707f"><span class="section-number-3">2.15.</span> <span class="todo INPROGRESS">INPROGRESS</span> Select from multiple pipes</h3>
<div class="outline-text-3" id="text-2-15">
<p>
A basic select (which I call <code>attend</code>) is in place. 
</p>
</div>
<div id="outline-container-org3c28e60" class="outline-4">
<h4 id="org3c28e60"><span class="section-number-4">2.15.1.</span> <span class="todo TODO">TODO</span> Attend should leave the pipe list argument</h4>
<div class="outline-text-4" id="text-2-15-1">
<p>
A lot of callers would want to re-use that argument so it shouldn't
need to be shielded by default.
</p>
</div>
</div>
<div id="outline-container-org4adf4ea" class="outline-4">
<h4 id="org4adf4ea"><span class="section-number-4">2.15.2.</span> <span class="todo TODO">TODO</span> Better error handling</h4>
<div class="outline-text-4" id="text-2-15-2">
<p>
There's lots of places where flume could throw an error and we don't
do anything about it.
</p>
</div>
</div>
</div>
<div id="outline-container-orgfecb77f" class="outline-3">
<h3 id="orgfecb77f"><span class="section-number-3">2.16.</span> <span class="todo TODO">TODO</span> Monitoring tools</h3>
<div class="outline-text-3" id="text-2-16">
</div>
<div id="outline-container-orgc4587f5" class="outline-4">
<h4 id="orgc4587f5"><span class="section-number-4">2.16.1.</span> <span class="todo TODO">TODO</span> Reporting back to the mothership</h4>
<div class="outline-text-4" id="text-2-16-1">
<p>
When we spawn/animate, the environment is in its own universe and the
main environment has no way to get any information about it, except by
whatever means are baked into the spawned env's program. Users can
come up with their own scheme of sending some kind of result via a
pipe, of course. But what happens if the program encounters an error?
</p>

<p>
It would be nice to wrap the program such that it reports the final
stack via a pipe, back to the main environment. And in the main env,
it would be nice to keep a list of those pipes so we can select and
get updates. Note, need to compare and contrast with the existing
mechanism in 'future'.
</p>

<p>
Another nice tool would be the ability to send the current state back
on demand (sort of like a thread dump) - in the spawned env, call
eval-step until some signal comes in on the pipe from the main env,
then send back a copy of the env. This mechanism could be used later
to implement a monitoring tool.
</p>

<p>
How to do this: I think a combination of "channel of channels", and
redefinition of <code>spawn</code> with <code>let</code> should go a long way. The
channel-channel lets new nested envs send back reply channels to the
master env, even if they are deeply nested. Redefining <code>spawn</code> lets us
insert the code to send those channels back (by passing in the channel
that leads back to the master env). What would be really handy is
parsing the inner env data to see which references to channels it
contains, seeing whether it's a sender or receiver, and drawing arrows
between envs so users can see they talk to each other.
</p>
</div>
</div>
<div id="outline-container-org3439282" class="outline-4">
<h4 id="org3439282"><span class="section-number-4">2.16.2.</span> <span class="todo TODO">TODO</span> Monitoring UI</h4>
<div class="outline-text-4" id="text-2-16-2">
<p>
We could show not only all the envs and ther recent state (perhaps
dumped every few seconds), we could show arrows between environments
that represent pipes (if two envs have a copy of the same pipe
anywhere in the stack or program, draw an arrow. If one env has a
sender and the other receiver, then show an arrow indicating the
direction of data flow along with the pipe id.
</p>

<p>
We could also allow views into a particular pipe where we copy the
last handful of values to pass through (this is doable for channels
but probably not file/network pipes).
</p>
</div>
</div>
</div>
<div id="outline-container-org9021608" class="outline-3">
<h3 id="org9021608"><span class="section-number-3">2.17.</span> <span class="todo INPROGRESS">INPROGRESS</span> Native REPL</h3>
<div class="outline-text-3" id="text-2-17">
</div>
<div id="outline-container-orgd19ff83" class="outline-4">
<h4 id="orgd19ff83"><span class="section-number-4">2.17.1.</span> <span class="done DONE">DONE</span> Main mode of reading program from cmdline or file</h4>
<div class="outline-text-4" id="text-2-17-1">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-10-19 Thu 21:08]</span></span></li>
</ul>
</div>
</div>
<div id="outline-container-orgb6544eb" class="outline-4">
<h4 id="orgb6544eb"><span class="section-number-4">2.17.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> REPL as a kcats program</h4>
<div class="outline-text-4" id="text-2-17-2">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-10-19 Thu 21:08]</span></span></li>
</ul>
<p>
Read inputs from stdin, eval in a nested env, write to stdout.
</p>

<div class="org-src-container">
<pre class="src src-kcats">standard <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> 
<span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> each
<span class="org-string">""</span>
<span class="org-kcats-brackets">[[[</span>complete? <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>readcount <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">"\n"</span> split generate
              <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 4 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
              <span class="org-kcats-brackets">[</span>read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> bail 0 or<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> readcount<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>complete? not<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">swapdown</span> <span class="org-function-name">join</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> prime<span class="org-kcats-brackets">]</span>
 draft cut<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>read<span class="org-kcats-brackets">]</span> each
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[[</span>read<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
    <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>complete? <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>readcount <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-string">"\n"</span> split generate <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 4 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
              bail 0 or<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> readcount<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>complete? not<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">swapdown</span> <span class="org-function-name">join</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> prime<span class="org-kcats-brackets">]</span>
 draft cut<span class="org-kcats-brackets">]</span>
<span class="org-string">""</span> <span class="org-kcats-brackets">[</span>generate <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
    <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>peer standard<span class="org-kcats-brackets">]</span>
        <span class="org-kcats-brackets">[</span>type tunnel<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">standard <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">generate chunks of bytes from stdin</span>
<span class="org-kcats-brackets">[</span>parse-utf8<span class="org-kcats-brackets">]</span> parse <span class="org-comment-delimiter">;; </span><span class="org-comment">now have chunks of strings</span>

</pre>
</div>

<p>
write a parser for length-delimited inputs
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">; </span><span class="org-comment">["10\nabcdefg" "hij12\nfoo"]</span>
 <span class="org-kcats-brackets">[]</span>
 <span class="org-comment-delimiter">;;</span><span class="org-comment">"5\nfooba4\nquux"</span>
 <span class="org-string">"5\nfo"</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
 <span class="org-string">"\n"</span> split generate <span class="org-kcats-brackets">[</span>read <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> bail 0 or <span class="org-comment-delimiter">;; </span><span class="org-comment">get count</span>
 <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 4 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop the split generator</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>cut <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
 when

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">5 <span class="org-string">"fo"</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfb4b2fb" class="outline-3">
<h3 id="orgfb4b2fb"><span class="section-number-3">2.18.</span> <span class="done CANCELED">CANCELED</span> Words that quote programs instead of executing them</h3>
<div class="outline-text-3" id="text-2-18">
<ul class="org-ul">
<li><p>
State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 19:58] </span></span> <br />
I don't think there's really any good fix for this.
</p>

<p>
For example 'partition' that needs to insert some state before the
generator. The generator doesn't actually include that state but it
needs to be there. So the quoted program is needed.
</p></li>
</ul>
<p>
eg <code>liberate</code> - it is just <code>[take]</code>, so it doesn't actually do anything by
itself. It seems like the quotedness should remain and maybe the word
should always perform the action.
</p>

<p>
In that case we would have to write <code>5 [taker]</code>. I'm not thrilled with
that either, but maybe it's just not a good name.
</p>

<p>
It does seem like there's an inconsistency having a word quote a
program instead of the caller doing it.
</p>

<p>
There are certainly words that operate on programs without executing
them (like <code>each</code> which just modifies the mapping function to call the
generator below it, it doesn't add an entirely new generator to the
stack) but the word is still executing a program vs just
self-inserting one object.
</p>

<p>
So I think I do have to fix this. I'm just not sure what to do.
</p>

<p>
I think it will <b>look</b> inconsistent to write:
</p>
<div class="org-src-container">
<pre class="src src-kcats">integers
5 <span class="org-kcats-brackets">[</span>taker<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> each
</pre>
</div>
<p>
People will see that and wonder why <code>taker</code> is quoted but not <code>each</code>. It
makes sense when you dive into it.
</p>

<p>
Isn't this just an implementation detail? In theory <code>each</code> could be a
separate generator and honestly it probably should be.
</p>
</div>
<div id="outline-container-org8711905" class="outline-4">
<h4 id="org8711905"><span class="section-number-4">2.18.1.</span> <span class="todo TODO">TODO</span> Get rid of self-inserting programs (esp with generators)</h4>
<div class="outline-text-4" id="text-2-18-1">
<p>
Problem: words like <code>joiner</code> and <code>taker</code> don't do anything except insert a
program. That, i think, should be an anti-pattern in kcats. If you
want to put a program on the stack succintly,then define a word that
does what you want, and quote that word.
</p>

<p>
For example, some complex function <code>foo</code>, if you want a program on the
stack that does what foo does, use <code>[foo]</code>. <code>foo</code> itself should perform the action.
</p>

<p>
There's some confusion because <code>each</code> does perform an action: it
modifies the program already on the stack. So you would write <code>5 [taker]</code> but <code>[inc] each</code>.
</p>

<p>
One issue is with something like <code>partition</code> where there's boilerplate initial state
that needs to go on the stack before the generator program. With <code>taker</code>
the user provides the initial state because we don't know what it is in advance.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c d e<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> 2 2 partition generate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>taker<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>taker collect <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span> <span class="org-kcats-brackets">[</span>2<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>2<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">float</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-function-name">unwrap</span>
           <span class="org-builtin">swap</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> shift<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>over <span class="org-function-name">wrap</span> <span class="org-function-name">take</span>-chunk <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> shift<span class="org-kcats-brackets">]</span>
                bail<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[[</span>over<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">wrap</span> <span class="org-function-name">take</span>-chunk <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> shift<span class="org-kcats-brackets">]</span>
            <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"yO3LwN0ITlhqAj8T1IKcUqNoiQmEAyrBwbFpGixDtQ8="</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> assign environment evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span>
2 <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>a b c d e<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
It's possible for partition to check if the state is present and
create it (since the state is always a list and otherwise it would see
a number). But it's not generally possible for a generator to tell if
it needs to add state - it should already be there. So if we're just
quoting the generator, then what will add it?
</p>

<p>
Self-insert: can insert 
</p>
</div>
</div>
</div>
<div id="outline-container-orgce36eb7" class="outline-3">
<h3 id="orgce36eb7"><span class="section-number-3">2.19.</span> <span class="todo TODO">TODO</span> Data compression</h3>
<div class="outline-text-3" id="text-2-19">
<p>
Data streams that we intend to produce later are going to need
compression - the streams should be as small as possible (they'll be
encrypted later so it's too late to compress them after that). lz4 maybe?
</p>
</div>
</div>
<div id="outline-container-org2103fb8" class="outline-3">
<h3 id="org2103fb8"><span class="section-number-3">2.20.</span> <span class="todo TODO">TODO</span> Multimethod improvements</h3>
<div class="outline-text-3" id="text-2-20">
</div>
<div id="outline-container-org416c504" class="outline-4">
<h4 id="org416c504"><span class="section-number-4">2.20.1.</span> <span class="todo TODO">TODO</span> Convert to multi</h4>
</div>
<div id="outline-container-org6e2b994" class="outline-4">
<h4 id="org6e2b994"><span class="section-number-4">2.20.2.</span> <span class="done DONE">DONE</span> Refactor addmethod</h4>
<div class="outline-text-4" id="text-2-20-2">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2023-12-04 Mon 16:24]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-12-04 Mon 16:13]</span></span></li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[</span><span class="org-function-name">count</span> 3 &gt;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"bar"</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]]]</span> decide<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">count</span> 1 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span><span class="org-kcats-brackets">]</span>
pair <span class="org-comment-delimiter">;; </span><span class="org-comment">[c b] [[[...]] decide]</span>
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>prepend<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-kcats-brackets">[[</span>0<span class="org-kcats-brackets">]]</span> <span class="org-preprocessor">dip</span> update
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[</span><span class="org-function-name">count</span> 1 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span><span class="org-function-name">count</span> 3 &gt;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"bar"</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]]]</span>
 decide<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>hash definition<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span>type <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-string">"foo"</span> hash<span class="org-kcats-brackets">]</span> addmethod<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span> <span class="org-kcats-brackets">[[</span>foo bar<span class="org-kcats-brackets">]]</span> association hash<span class="org-kcats-brackets">]</span>
lingo
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo bar<span class="org-kcats-brackets">]]</span> association type
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">foo
</pre>
</div>
</div>
</div>
<div id="outline-container-org90496d7" class="outline-4">
<h4 id="org90496d7"><span class="section-number-4">2.20.3.</span> <span class="done DONE">DONE</span> ismulti?</h4>
<div class="outline-text-4" id="text-2-20-3">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-12-04 Mon 16:25]</span></span></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org409ee52" class="outline-3">
<h3 id="org409ee52"><span class="section-number-3">2.21.</span> <span class="done CANCELED">CANCELED</span> run multiple programs on same argument to get list</h3>
<div class="outline-text-3" id="text-2-21">
<ul class="org-ul">
<li>State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:43] </span></span> <br />
I think this is clear enough, no new word needed</li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats">5 2 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>7 10<span class="org-kcats-brackets">]</span>
2 5
</pre>
</div>
</div>
</div>
<div id="outline-container-org3c973ba" class="outline-3">
<h3 id="org3c973ba"><span class="section-number-3">2.22.</span> <span class="todo INPROGRESS">INPROGRESS</span> pairwise operations</h3>
<div class="outline-text-3" id="text-2-22">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-03 Sat 11:28]</span></span></li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats">1 2 3 4 5 <span class="org-kcats-brackets">[]</span> both<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>2 2 partition<span class="org-kcats-brackets">]</span> assemble<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
<span class="org-preprocessor">inject</span> <span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> <span class="org-builtin">evert</span> <span class="org-builtin">drop</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">9 5 1
</pre>
</div>

<p>
this generator based impl doesn't support nil values on the stack:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 2 <span class="org-kcats-brackets">[]</span> 3 4 <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> pairwise
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"not enough items on stack"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> <span class="org-builtin">evert</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>consume<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span>4 3<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6ec3d40" class="outline-3">
<h3 id="org6ec3d40"><span class="section-number-3">2.23.</span> <span class="done DONE">DONE</span> Non-generator filter</h3>
<div class="outline-text-3" id="text-2-23">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:43]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-04 Sun 13:50]</span></span></li>
</ul>
<p>
map now doesn't require you to bind values (the map function has access to the rest of the stack).
 Do the same for <code>filter</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats">5 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+ odd?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">put empty results below list</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> decorate <span class="org-comment-delimiter">;; </span><span class="org-comment">run map fn shielded and dipped under result</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> prepend <span class="org-comment-delimiter">;; </span><span class="org-comment">start by swapping the result back to the top</span>
<span class="org-kcats-brackets">[</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">end by checking pred, add to result</span>
<span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>2 4<span class="org-kcats-brackets">]</span>
5
</pre>
</div>
</div>
</div>
<div id="outline-container-org3838901" class="outline-3">
<h3 id="org3838901"><span class="section-number-3">2.24.</span> <span class="todo INPROGRESS">INPROGRESS</span> Modules</h3>
<div class="outline-text-3" id="text-2-24">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-05-22 Wed 09:44]</span></span></li>
</ul>
</div>
<div id="outline-container-orgfbc4bed" class="outline-4">
<h4 id="orgfbc4bed"><span class="section-number-4">2.24.1.</span> Problem statement</h4>
<div class="outline-text-4" id="text-2-24-1">
</div>
<div id="outline-container-orgefe91c7" class="outline-5">
<h5 id="orgefe91c7"><span class="section-number-5">2.24.1.1.</span> <span class="todo TODO">TODO</span> Efficient use</h5>
<div class="outline-text-5" id="text-2-24-1-1">
<p>
When code is defining new vocabulary, and it gets called in a tight
 loop, it should not be modifying the dictionary each
 time. Dictionary shoud be append only (to avoid having to swap back
 and forth between a modified and unmodified version)
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">save a modified env or dictionary and use it</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">again.</span>
<span class="org-kcats-brackets">[</span>crypto<span class="org-kcats-brackets">]</span> stdmod <span class="org-comment-delimiter">;; </span><span class="org-comment">make the module</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">apply it to the dictionary</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> encode hash<span class="org-kcats-brackets">]</span> confine
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="</span>
</pre>
</div>

<p>
Let's make a word to load multiple modules
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>crypto time<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">apply the changes in order</span>
dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>decache string read <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">now execute</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary_redacted
</pre>
</div>

<p>
Let's divide up the functionality:
</p>
<ul class="org-ul">
<li>reading from cache and parsing (module)</li>
<li>apply module to dictionary (inscribe)</li>
<li>spawn env with new dict and program (spawn)</li>
<li>capture result as our stack</li>
</ul>
</div>
</div>
<div id="outline-container-orgb35d0cc" class="outline-5">
<h5 id="orgb35d0cc"><span class="section-number-5">2.24.1.2.</span> <span class="todo TODO">TODO</span> Modification happens once per program</h5>
<div class="outline-text-5" id="text-2-24-1-2">
<p>
Dictionary modification should not happen at "runtime" (when the
program is actually being executed) - it should be modified when the
program is <b>built</b>. However the consequence of this is pretty dire,
because much of the standard library is currently just programs that
are literals and don't need "building".
</p>
</div>
</div>
<div id="outline-container-orga33f450" class="outline-5">
<h5 id="orga33f450"><span class="section-number-5">2.24.1.3.</span> <span class="todo TODO">TODO</span> Nested library calls need to work</h5>
<div class="outline-text-5" id="text-2-24-1-3">
<p>
I should be able to call <code>af</code> that loads (or depends on <code>b</code> and calls <code>bf</code>
that loads <code>c</code> and calls <code>cf</code>, and those loads should only happen once
even if i call <code>af</code> in a tight loop.
</p>
</div>
</div>
<div id="outline-container-org2794c67" class="outline-5">
<h5 id="org2794c67"><span class="section-number-5">2.24.1.4.</span> <span class="todo TODO">TODO</span> Code should be shareable</h5>
<div class="outline-text-5" id="text-2-24-1-4">
<p>
That means, local names should generarlly not appear in code, as they
change meaning.
</p>
</div>
</div>
<div id="outline-container-org61943b5" class="outline-5">
<h5 id="org61943b5"><span class="section-number-5">2.24.1.5.</span> <span class="todo TODO">TODO</span> Building vocabulary and the programs that use that vocabulary need to be separable</h5>
<div class="outline-text-5" id="text-2-24-1-5">
<p>
(that's the whole point of a library). In practice there will be
some "mini-libs" that mostly just make code easier to read and stay
with the program that uses them. However we need to be able to
modify the dictionary, and then refer to that modification later (by
name? hash?), to support the typical library use case. That maps to
a use/require when a program starts, and then later, in some
arbitrary place in the code, you refer to the library's functions
via its namespace.
</p>
</div>
</div>
<div id="outline-container-org37f7235" class="outline-5">
<h5 id="org37f7235"><span class="section-number-5">2.24.1.6.</span> <span class="todo TODO">TODO</span> Sandboxing</h5>
<div class="outline-text-5" id="text-2-24-1-6">
</div>
<ol class="org-ol">
<li><a id="orgfa4f7fc"></a><span class="todo TODO">TODO</span> Preservation of meaning<br />
<div class="outline-text-6" id="text-2-24-1-6-1">
<p>
We execute untrusted code, then our own code, our code should mean the
same thing as it would have before executing the untrusted code.
</p>
</div>
</li>
<li><a id="org26f031c"></a><span class="todo TODO">TODO</span> Access control<br />
<div class="outline-text-6" id="text-2-24-1-6-2">
<p>
We should be able to execute untrusted code in a limited environment
(where, for example, it does not have access to the filesystem
etc). 
</p>
</div>
<ol class="org-ol">
<li><a id="org2d2ee63"></a><span class="todo TODO">TODO</span> Fine grained access control<br />
<div class="outline-text-7" id="text-2-24-1-6-2-1">
<p>
We could for example, limit filesystem access to a particular
directory, or network access to a particular host. One way this could
be done: have all such primitives run some other word as a predicate
lock, and respect the outcome of that predicate. However, some care
would need to be taken that the untrusted code couldn't just bootstrap
a new env without that lock in place. I'm not sure this is possible
within the overall language design.cause
</p>

<blockquote>
<p>
Integrating an authentication scripting language directly into the
core of your stack-based language and leveraging it for controlling
access to sensitive operations could indeed be a powerful and flexible
solution. This approach aligns well with your goal of making
authentication programmable while addressing the specific challenges
of providing fine-grained access control in a sandboxed
environment. Here's how to address potential concerns and make the
most out of this integration: Design Principles
</p>

<p>
Efficiency by Design: Since performance is a concern, designing
the authentication script execution to be as lightweight as
possible is crucial. Optimize the most common authentication paths
to reduce overhead. Consider caching results of authentication
checks where safe and applicable, especially in scenarios where
the same authentication decision is repeated.
</p>

<p>
Conditional Authentication Checks: Implement the authentication
scripts to run conditionally, i.e., only in contexts where
sandboxing is required. This minimizes the performance impact on
the overall system while still providing robust security measures
where they're most needed.
</p>

<p>
Customizable Script Complexity: Allow the complexity of the
authentication scripts to be tailored according to the security
needs of the sandbox environment. For less sensitive operations or
more trusted sandboxed environments, simpler scripts could be
used, reducing resource consumption.
</p>

<p>
Practical Implementation
</p>

<p>
Authentication Context: Provide a rich context to the
authentication scripts, including details about the requested
operation (e.g., file path for file access, URL for network
requests), the environment's security status, and any relevant
user or process identifiers. This enables writing precise and
effective authentication logic.
</p>

<p>
Digital Signatures and Proof Checking: As part of the
authentication scripts, leverage digital signatures for verifying
the integrity and authenticity of the scripts themselves or any
other supplied credentials. Although checking digital signatures
can be resource-intensive, optimizing the cryptographic operations
and selectively applying them can help manage the performance
impact.
</p>

<p>
Expandable Security Model: By integrating authentication scripting
into the core, you lay a foundation that's not only useful for
sandboxed environment control but can also be expanded for broader
security features in the future, such as secure inter-process
communication or encrypted data storage, using the same flexible
scripting approach.
</p>

<p>
Security and Performance Balance
</p>

<p>
Asynchronous Operations: When possible, make the authentication
checks asynchronous, especially for I/O bound tasks like network
requests or disk access. This can help mitigate the performance
impact on the rest of the system.
</p>

<p>
Resource Limits and Quotas: Introduce limits on the resources that
authentication scripts can consume, such as CPU time or memory
usage. This prevents potential abuse where overly complex scripts
could degrade system performance.
</p>

<p>
In sum, your approach to incorporate an authentication scripting layer
directly into the core of the language introduces a novel mechanism
for fine-grained access control, effectively turning authentication
checks into programmable gatekeepers for sensitive operations. While
it introduces challenges in terms of complexity and resource
management, careful design and optimizations can mitigate these
issues, offering a powerful and flexible tool for secure sandboxing.
I guess the question is, can the lock be unalterable? I can definitely
hardcode some aspects of these locks so that they are alterable from
the outside but not the inside. For example, if my trusted env wants
to create an untrusted one, it could insert a lock into a field of the
inner env, that is not accessible to the untrusted program. However,
the inner env can still construct a new env itself with a very
permissive lock and still use it to read the filesystem however it
wants. So somehow, the construct needs to force new envs to inherit
the locks of the current one. That's possible to implement. It could
be a series of locks (append only), and the key has to unlock all of
them.
</p>

<p>
&gt; I think the locks don't really even need cryptography in that case:
the lock would say "can only read/write to /tmp" and the key would
just be the file that the environment is trying to access. If it
starts with /tmp then it is allowed.
</p>

<p>
Yes, designing a lock mechanism that is both unalterable from inside
the untrusted environment and inheritable for any subsequently created
environments is indeed possible and can effectively secure the system
according to your requirements. The append-only series of locks, where
each new environment inherits the restrictions (locks) of its creator,
ensures that no matter how deeply nested an environment is, it cannot
escape the boundaries set by its original, trusted creator. Here's how
such a mechanism could be structured:
Lock Mechanism Design
</p>

<p>
Immutable Locks: Implement locks as immutable structures within
each environment. Once a lock is set, it cannot be modified from
within that environment. New environments inherit the lock state
of their parent environment upon creation.
</p>

<p>
Lock Inheritance and Aggregation: Ensure that when an environment
creates a new environment (even an untrusted one wants to create
another environment), the new environment inherits all the locks
of its parent environment, potentially adding its own restrictions
but never relaxing any existing ones. This could be done in an
append-only manner, where new locks add to the restrictions but do
not overwrite them.
</p>

<p>
Path-Based Access Control: Your description of using locks to
control file access based on paths (e.g., "can only read/write to
/tmp") is an example of path-based access control. This control is
straightforward yet effective and does not necessarily require
cryptographic keys for enforcement, simplifying implementation and
reducing overhead.
</p>

<p>
Implementation Considerations
</p>

<p>
System-Enforced Lock Checks: The core system that mediates access
to resources (file system, network, etc.) must enforce the lock
checks before granting any operation. This ensures that no
environment, regardless of its programming, can bypass the
restrictions placed upon it by its defined locks.
</p>

<p>
Auditing and Monitoring: Although the lock mechanism provides a
strong control mechanism, implementing auditing and monitoring on
the enforcement points can help identify potential attempts to
bypass restrictions or exploit weaknesses in the lock design.
</p>

<p>
Error Handling and Feedback: Define clear behavior and feedback
mechanisms for when an environment attempts to perform an
operation that is denied by its locks. Good error handling is
crucial for developers working within these environments to
understand the boundaries and work effectively within them.
</p>

<p>
Documentation and Transparency: Providing clear documentation on
how locks work, how they are inherited, and how they restrict
operations will aid in the adoption and correct usage of the
environment creation and management functionalities you are
designing.
</p>

<p>
In conclusion, your approach to using immutable, inheritable locks
that enforce path-based access control offers a robust method to
secure environments in a stack-based programming language, without
necessitating the complexity and overhead associated with
cryptographic solutions. This method provides a fine-grained control
mechanism that's both practical and efficient, aligning well with the
needs of a secure, sandboxed execution environment.
</p>
</blockquote>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div id="outline-container-org576999d" class="outline-4">
<h4 id="org576999d"><span class="section-number-4">2.24.2.</span> Discussion</h4>
<div class="outline-text-4" id="text-2-24-2">
</div>
<div id="outline-container-org6f80e4b" class="outline-5">
<h5 id="org6f80e4b"><span class="section-number-5">2.24.2.1.</span> pairs of program/dictionary.</h5>
<div class="outline-text-5" id="text-2-24-2-1">
<p>
It's sort of like a passage of english prose, and a dictionary of what
all the words used in that prose mean. In terms of "true" meaning,
those two things are bound up together, you can change the meaning
either by changing the prose or the dictionary. So in a sense the
"meaning hash" is hash of the dict+program, not just the program
itself.
</p>

<p>
One potential hole in this concept is the existence of axiom words
(that aren't defined in terms of other words). It's not clear how to
hash them, we'd need the source of their implementation. Another issue
is it's possible to make alterations in the interpreter that still
execute the program the same way but the hash doesn't match. So
non-matching hash doesn't mean "different meaning", but same hash
generally means "same meaning". That's the way hashes work most places
though.
</p>

<p>
Can we do anything with this? Maybe not.
</p>
</div>
</div>
<div id="outline-container-org27108fb" class="outline-5">
<h5 id="org27108fb"><span class="section-number-5">2.24.2.2.</span> not having to recalculate the whole dictionary each time we want to use a module.</h5>
<div class="outline-text-5" id="text-2-24-2-2">
<p>
There's several possible mitigations:
</p>

<ul class="org-ul">
<li>Leave the modified dictionary on the stack so it can be reused</li>
<li><p>
Make 2 levels of env nesting per library
</p>
<ul class="org-ul">
<li>One where the modified dict is in the dict (but words are not available)</li>
<li>One where we actually apply that dict so the words can be used</li>
</ul>

<p>
It's possible to load all the libraries first, in a single
 environment and then go from there. However it's inherently nested -
 any library might have dependencies. So who loads them? We can't
 load them right at execution time because that would happen repeatedly.
</p>

<p>
Somehow we need the module that updates the dictionary to pull in
its own dependencies. But how can it do that, when its dependencies
aren't loaded and don't have names?
</p>

<p>
eg, crypto -&gt; hash -&gt; bytes. If crypto depends on hash in some other
module where do we fetch it from?
</p>

<p>
Can we include the loading of dependencies in the module itself? In
other words, include the changes from the other module in this one?
I think that might be possible. However if the intention is to refer
to the dependency by name like in other languages that might be more
difficult. Perhaps we can start by breaking out stdlib modules and
having the standard env refer to them as dictionary entries.
</p>

<p>
However how would dependency loading work then?
Let's say we have
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foomod <span class="org-kcats-brackets">[[[</span>foo <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>barmod <span class="org-kcats-brackets">[</span>foomod <span class="org-function-name">join</span> <span class="org-kcats-brackets">[[</span>bar <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
That could work: if both <code>foomod</code> and <code>barmod</code> are in the dictionary
then we can have <code>barmod</code> refer to <code>foomod</code>.
</p>

<p>
This doesn't quite solve the problem that <code>let</code> should solve
though. We really just want a little supplemental dictionary for the
duration of a program, but we want it "compiled in" so that the
program can be passed around and run many times without having to do
the setup work again.
</p>

<p>
so what we want is to pass around the program+dictionary. But doing
it as an "environment" is maybe not quite what we want because the
stack is not permanent. So perhaps what we need is a word that takes
an environment and executes it as if it's just a program (inheriting
the stack). Then the actual program is the call to that word.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">the stack</span>
<span class="org-kcats-brackets">[</span>5 6 7 8 9<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">let's create an inner env, all the compile time stuff</span>
<span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]]</span> draft inscribe <span class="org-kcats-brackets">[</span>square<span class="org-kcats-brackets">]</span> spawn <span class="org-function-name">wrap</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">now let's call this with inherited stack at runtime</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> assign <span class="org-comment-delimiter">;; </span><span class="org-comment">all set</span>
evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;</span><span class="org-comment">map</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>square<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>5 6 7 8 9<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> assign evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>5 6 7 8 9<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
What we need then is a way to access the "compiled" program
 repeatedly, with different stack data each time.
</p>

<p>
Also, this binds a dictionary to a single program which is fine for
<code>let</code> but we also need a module case where we make the dictionary
available via a word.
</p>

<p>
What about cases where we want to load more than one module at a
 time? Can we save that dictionary too? Do we need to? I don't know
 why we'd need to call <code>using</code> in a tight loop, <code>using</code> could just go
 around the loop.
</p>

<p>
Let's just try some stuff. Create a module and cache it
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span> draft
encode <span class="org-kcats-brackets">[]</span> cache
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"Tz9VhU5ISws4N7I7ckTcKBEpjCGHp5Svc1O7t7JRWX4="</span>
</pre>
</div>

<p>
ok now we want to use this module
</p>
<div class="org-src-container">
<pre class="src src-kcats">#b64 <span class="org-string">"Tz9VhU5ISws4N7I7ckTcKBEpjCGHp5Svc1O7t7JRWX4="</span> decache string read <span class="org-function-name">first</span> inscribe
<span class="org-kcats-brackets">[</span>9 cube<span class="org-kcats-brackets">]</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>9 cube<span class="org-kcats-brackets">]</span>
dictionary_redacted
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgfc1b56e" class="outline-5">
<h5 id="orgfc1b56e"><span class="section-number-5">2.24.2.3.</span> Separate manifest</h5>
<div class="outline-text-5" id="text-2-24-2-3">
<p>
If we look at other languages, usually there's a separate piece of
data from the actual program: the build manifest. It specifies what
versions of what libraries are to be loaded. Then later in the code,
the libraries are brought in but there's no mention of versions or
where the package came from.
</p>

<p>
kcats could have a similar mechanism, but since there's no separate
build tool (yet, eventually will need something to at least fetch
remote libraries), we can have a sort of prelude section to a program
where we specify all the hashes of libs we want to use in the
program. By that point, presumably they are already in the cache.
</p>

<p>
This brings up the question of how dependencies are specified. The
naive approach would be for the code of the module itself to have its
own prelude (which is pretty much how other languages work). However
that leaves the issue of how the fetch tool will know what it needs to
fetch. An obvious method is via convention, that the first thing in
the module is the dependencies, which we can read the hashes and go
download them. Another is to just load the library in the tool, so
then the convention is not needed (other things can come before the
hashes). The tool would somehow interpret "loading from cache" as
"load from cache and go to the network if it's not there".
</p>
</div>
</div>
<div id="outline-container-org1066d22" class="outline-5">
<h5 id="org1066d22"><span class="section-number-5">2.24.2.4.</span> Use of names</h5>
<div class="outline-text-5" id="text-2-24-2-4">
<p>
It occurred to me that we don't have to use names at all when it comes
to libaries or modules. We just let code refer to hashes, and the IDE
tools will help resolve those hashes to names or vice versa. But the
canonical form (in the actual code) will be hashes only.
</p>

<p>
This solves a lot of issues:
</p>

<ul class="org-ul">
<li>There is no chicken and egg problem. The kcats language itself
simply does not support names or local address books. It refers to
content by hash and that's it. That's how libraries are loaded,
etc. After the kcats language is complete, then we write naming
tooling in kcats, and we run those tools against a kcats program to
resolve hashes to names (possibly as part of IDE functionality). For
example, the IDE replaces hashes with names (if known) and you can
hover over the name to see the hash if needed.</li>
<li>Code is sharable because there are no local names present</li>
</ul>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">define a module</span>
<span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]]</span> draft inscribe
<span class="org-comment-delimiter">;; </span><span class="org-comment">now the dictionary is on the stack</span>
<span class="org-kcats-brackets">[</span>9 square<span class="org-kcats-brackets">]</span> confine
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">81
</pre>
</div>

<p>
Defining a module hierarchy using only the stack can get diffcult. We
can create dictionaries and make them a dictionary entry to refer to them.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]]</span> draft inscribe
<span class="org-comment-delimiter">;; </span><span class="org-comment">so now we have an updated dictionary, let's make this an entry we</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">can access without polluting the dictionary with all the words we defined</span>
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> entry dictionary <span class="org-builtin">swap</span> <span class="org-function-name">put</span>
<span class="org-kcats-brackets">[</span>math <span class="org-kcats-brackets">[</span>8 square<span class="org-kcats-brackets">]</span> confine<span class="org-kcats-brackets">]</span> confine
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">64
</pre>
</div>

<p>
So how would we make a hierarchy with this mechanism? For example the
db has a hierarchy. Maybe make some words to help. Let's say we have <code>a</code>
that depends on <code>b</code> and <code>c</code>. We can create those dictionaries separately
and then make the dependencies available as words. So the environment
that runs <code>a</code> has entries for <code>b</code> and <code>c</code> dictionaries. So when it needs to
call b/c words, it calls them with confine. Does it makes sense to
keep calling confine or just merge all the necessary words at the
beginning of the program? How do we not end up with either calling
confine just for one word, or just using one giant dictionary? I don't
know. Neither makes any sense, this whole design is crap. It's
basically just horrible ad-hoc namespaces, where the inner dictionary
is its own namespace.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">using: takes a list of words that point to dictionaries and merges them</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgb37214a" class="outline-5">
<h5 id="orgb37214a"><span class="section-number-5">2.24.2.5.</span> How to implement let</h5>
<div class="outline-text-5" id="text-2-24-2-5">
<p>
It's something most languages just don't have - functions scoped to a
function. I mean, they do but there is no way to avoid having them
redefined each time.
</p>

<p>
Can we do better?
</p>

<p>
So I guess what we want is to take a program that contains local
functions and an outer program, and transform that into a program that
contains an altered dictionary.
</p>

<p>
Maybe let just transforms the program without executing it?
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">dictionary_redacted #b64 <span class="org-string">"g5nJOWpyglIeN2EgJOdFRVQ0ix76q42bTs2uG5w5J/s="</span>
</pre>
</div>

<p>
This gives us basically a closure 
</p>
<div class="org-src-container">
<pre class="src src-kcats">3 4
<span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stuff <span class="org-kcats-brackets">[</span>plus2 3 *<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>stuff<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the let program ;; prog dict hash</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the hash to make a list of 1 namespace</span>

<span class="org-kcats-brackets">[</span>program dictionary resolver<span class="org-kcats-brackets">]</span> label environment <span class="org-comment-delimiter">;; </span><span class="org-comment">creates closure</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">now execute the closure by capturing outer stack</span>
<span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> assign
evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">18 3
</pre>
</div>

<p>
So I guess the challenge then is to be able to reuse it (eg inside map), which we can this way:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 10 1 range
<span class="org-comment-delimiter">;; </span><span class="org-comment">the inner functions</span>
<span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stuff <span class="org-kcats-brackets">[</span>plus2 3 *<span class="org-kcats-brackets">]]]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">program to run that uses them</span>
<span class="org-kcats-brackets">[</span>stuff<span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span>draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the let program ;; prog dict hash</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the hash to make a list of 1 namespace</span>

<span class="org-kcats-brackets">[</span>program dictionary resolver<span class="org-kcats-brackets">]</span> label environment <span class="org-comment-delimiter">;; </span><span class="org-comment">creates closure</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">when the closure executes, capture the outer stack first</span>
<span class="org-function-name">wrap</span>
<span class="org-kcats-brackets">[[</span>stack<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> assign evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>

<span class="org-function-name">map</span>

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>9 12 15 18 21 24 27 30 33<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d43eca" class="outline-5">
<h5 id="org5d43eca"><span class="section-number-5">2.24.2.6.</span> Sandboxing</h5>
<div class="outline-text-5" id="text-2-24-2-6">
<p>
In the context of how the rest of kcats works, I think sandboxing should work as follows:
</p>

<p>
As always, when altering the dictionary, we can only do it in a new
environment. Since environments and dictionaries are first class
objects, it will always be possible to construct a dictionary with any
word whose value is reachable from the current environment. Therefore
in order to make a secure sandbox, we have to remove the values that
we don't want used so that they are truly unreachable. That means
overwriting words or deleting them from the dictionary and then
creating a new environment from that reduced dictionary.
</p>

<p>
As mentioned before, this is mostly about axiom words (that do things
like access network etc). There isn't much point in obscuring derived
words, since it's always possible to reconstruct it from axiom words.
</p>
</div>
</div>
</div>
<div id="outline-container-org6ef13a4" class="outline-4">
<h4 id="org6ef13a4"><span class="section-number-4">2.24.3.</span> Implementation</h4>
<div class="outline-text-4" id="text-2-24-3">
</div>
<div id="outline-container-org1c5d278" class="outline-5">
<h5 id="org1c5d278"><span class="section-number-5">2.24.3.1.</span> <span class="todo TODO">TODO</span> take a dictionary and a program and execute the program with that dict</h5>
</div>
<div id="outline-container-org5af3a00" class="outline-5">
<h5 id="org5af3a00"><span class="section-number-5">2.24.3.2.</span> <span class="todo TODO">TODO</span> take a mapping of name to module and return a dictionary with those modules</h5>
<div class="outline-text-5" id="text-2-24-3-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[[</span>foo <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>foo math<span class="org-kcats-brackets">]</span> label draft
inscribe

<span class="org-kcats-brackets">[[</span>foo math<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>9 square foo<span class="org-kcats-brackets">]</span>
 using<span class="org-kcats-brackets">]</span>
confine
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"foo"</span> 81
</pre>
</div>
</div>
</div>
<div id="outline-container-org1df36eb" class="outline-5">
<h5 id="org1df36eb"><span class="section-number-5">2.24.3.3.</span> <span class="todo TODO">TODO</span> One module depends on another, loads it</h5>
<div class="outline-text-5" id="text-2-24-3-3">
<p>
So, how exactly should this work?
</p>

<p>
How does one module ensure another is loaded before this one is used?
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[[</span>sixth <span class="org-kcats-brackets">[</span>square cube<span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>foo math<span class="org-kcats-brackets">]</span> label draft
inscribe

<span class="org-kcats-brackets">[[</span>foo math<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>9 sixth<span class="org-kcats-brackets">]</span>
 using<span class="org-kcats-brackets">]</span>
confine
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual foo<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>sized<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>get <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>something?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>get<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>something?<span class="org-kcats-brackets">]</span>
                                                          <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
           <span class="org-preprocessor">loop</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[[[</span>math definition<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[</span>foo definition <span class="org-kcats-brackets">[</span>sixth <span class="org-kcats-brackets">[[</span>definition <span class="org-kcats-brackets">[</span>square cube<span class="org-kcats-brackets">]]]]]</span> dictionary_redacted<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span>
           <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> pair <span class="org-kcats-brackets">[</span>lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
           <span class="org-kcats-brackets">[[</span>9 sixth<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> confine<span class="org-kcats-brackets">]]]</span>
math <span class="org-kcats-brackets">[</span>foo definition <span class="org-kcats-brackets">[</span>sixth <span class="org-kcats-brackets">[[</span>definition <span class="org-kcats-brackets">[</span>square cube<span class="org-kcats-brackets">]]]]]</span> dictionary_redacted
</pre>
</div>

<p>
So here we have modules that depend on each other, but the actual
dependency is not expressed here. We have to manually load <code>math</code> even
though we are only calling <code>foo</code>.
</p>

<p>
At what point do we load the dep and how? Inside the module code we do
have access to the dictionary as input.
</p>

<p>
Let's list the steps:
</p>
<ul class="org-ul">
<li>retrieve dictionary</li>
<li>"Main" - load prelude</li>
<li>prelude says hashA</li>
<li>decache, read hashA -&gt; moduleA</li>
<li>execute moduleA
<ul class="org-ul">
<li>moduleAprelude empty (no deps)</li>
<li>execute rest of moduleA to modify dict</li>
</ul></li>
</ul>

<p>
Re below: does the math module need to be available as a module or
just merged with the dictionary or both?  If we just make it a module,
we need to put <code>using</code> in the impl of <code>sixth</code> which would be very slow if
called repeatedly. Some kind of caching might be needed.
</p>

<p>
I think perhaps the original model of a single namespaced dictionary
might be best, such that we don't have to repeatedly apply changes -
we just do it at library loading time and then the entire execution
uses the same dictionary. During executing we can change how words are
resolved via <code>using</code>. But the difference between this and the previous
implementation of namespaces, is that resolution is altered for the
entire execution of a program and not just the words within that
program. That should fix the sandboxing security hole that existed in
that implementation. So we can have a word <code>depend</code> that loads libraries
into their own namespace (including deletions) (and assigns them
words), and then <code>using</code> (or <code>use</code>) that alters name resolution for the
duration of a program.
</p>
<div class="org-src-container">
<pre class="src src-kcats">  <span class="org-comment-delimiter">;; </span><span class="org-comment">then the outer mod</span>
  <span class="org-kcats-brackets">[[[</span>math #b64 <span class="org-string">"ULY02dWGqy3G7x9Hd7RgBG2q+Dw9RE8hC4dUjzyCqRk="</span><span class="org-kcats-brackets">]]</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">load each dep module</span>
   <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> module <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> entry assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">this makes the modules available as a package,</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">also need to integrate them into this dictionary</span>
   <span class="org-kcats-brackets">[[</span>sixth <span class="org-kcats-brackets">[</span>square cube<span class="org-kcats-brackets">]]]</span> draft <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> 
  encode <span class="org-kcats-brackets">[]</span> cache
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"QUsvdqQ6E46RsswGPAAlbz7tTWpdefkXPA5NByxGr4c="</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"> <span class="org-comment-delimiter">;; </span><span class="org-comment">first cache the inner mod</span>
 <span class="org-kcats-brackets">[[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span> draft<span class="org-kcats-brackets">]</span> encode <span class="org-kcats-brackets">[]</span> cache
 <span class="org-comment-delimiter">;; </span><span class="org-comment">then the outer mod</span>
 <span class="org-kcats-brackets">[[[[</span>math #b64 <span class="org-string">"ULY02dWGqy3G7x9Hd7RgBG2q+Dw9RE8hC4dUjzyCqRk="</span><span class="org-kcats-brackets">]]</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">load each dep module</span>
   <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> module <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>sixth <span class="org-kcats-brackets">[</span>square cube<span class="org-kcats-brackets">]]]</span> draft <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span>
 encode <span class="org-kcats-brackets">[]</span> cache

 dictionary
 <span class="org-comment-delimiter">;; </span><span class="org-comment">outer mod</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">first the prelude</span>
 <span class="org-kcats-brackets">[[</span>foo #b64 <span class="org-string">"QUsvdqQ6E46RsswGPAAlbz7tTWpdefkXPA5NByxGr4c="</span><span class="org-kcats-brackets">]]</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">load each dep module</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> module <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> entry assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[[foo] lookup] shield dump drop</span>
 <span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>9 sixth<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
  confine<span class="org-kcats-brackets">]</span>
confine <span class="org-comment-delimiter">;; </span><span class="org-comment">outer confine creates a dictionary with all the module words</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>9 sixth<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
  <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">dip</span> confine<span class="org-kcats-brackets">]</span>
dictionary_redacted #b64 <span class="org-string">"rJDrBYlO0RF3MHLh9tisE6kvRpGdVqtcKaWm0VyG6CQ="</span> #b64 <span class="org-string">"i4VyOtSDZ8aKk1YkF4scKaml+ULiClqGdeG3D8NST30="</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">2 3 <span class="org-kcats-brackets">[</span>3 2<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">2 2
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfa5cbcc" class="outline-5">
<h5 id="orgfa5cbcc"><span class="section-number-5">2.24.3.4.</span> <span class="todo TODO">TODO</span> Revert back to namespaces</h5>
<div class="outline-text-5" id="text-2-24-3-4">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]]</span> draft <span class="org-kcats-brackets">[</span>emit<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>  <span class="org-comment-delimiter">;</span><span class="org-comment">encode</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[hashbytes] shield swap string read</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[dictionary clone] dip shielddown </span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"[[square [[definition [clone *]]]]]"</span> <span class="org-string">"join"</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
Let's figure out how to implement <code>inscribe</code> without the caller having
to provide a hash (which is a security flaw anyway). Do we require
going through the cache all the time or do we round trip serialize so
we can support inline modules? I lean toward the latter, let's try that first.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
<span class="org-builtin">sink</span> dictmerge
<span class="org-comment-delimiter">;; </span><span class="org-comment">[first [plus2] unwrap =] filter ;; to check if the word is there</span>
<span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"g5nJOWpyglIeN2EgJOdFRVQ0ix76q42bTs2uG5w5J/s="</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 plus2<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>program resolver dictionary<span class="org-kcats-brackets">]</span> label environment evaluate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>7<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
Ok now let's refactor this into the form we want for <code>let</code>. 
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stuff <span class="org-kcats-brackets">[</span>plus2 3 *<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>5 stuff<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the let program ;; prog dict hash</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the hash to make a list of 1 namespace</span>
<span class="org-kcats-brackets">[</span>program dictionary resolver<span class="org-kcats-brackets">]</span> label environment evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">21
</pre>
</div>

<p>
Ok seems like we have a reasonable definition of <code>let</code> so what would a
nested call look like? Would we even do this or just use actual modules?
</p>

<p>
Let's say some local function has its own local function.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">clone</span> * *<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>2 + cube<span class="org-kcats-brackets">]</span> let
<span class="org-kcats-brackets">[</span>plus2cube<span class="org-kcats-brackets">]</span> label
<span class="org-kcats-brackets">[</span>4 plus2cube<span class="org-kcats-brackets">]</span> let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">216
</pre>
</div>

<p>
Now let's make sure the nesting has proper priority if there are conflicts. 
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo <span class="org-kcats-brackets">[</span><span class="org-string">"outer"</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"inner"</span><span class="org-kcats-brackets">]</span> let
<span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> label
<span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"inner"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1e8579a" class="outline-5">
<h5 id="org1e8579a"><span class="section-number-5">2.24.3.5.</span> <span class="todo TODO">TODO</span> Fix partition module logic</h5>
<div class="outline-text-5" id="text-2-24-3-5">
<p>
The problem is that <code>let</code> should modify the given program to wrap in a
'using', so that the module is defined once and then the program can
be run many times even with different dictionaries in different
environments - the 'using' will just add one more module to the resolver.
</p>
</div>
</div>
</div>
<div id="outline-container-org64fd185" class="outline-4">
<h4 id="org64fd185"><span class="section-number-4">2.24.4.</span> <span class="todo INPROGRESS">INPROGRESS</span> inscribe currently re-defines words repeatedly at runtime</h4>
<div class="outline-text-4" id="text-2-24-4">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-08 Thu 17:17]</span></span></li>
</ul>
</div>
<div id="outline-container-orgbceaf77" class="outline-5">
<h5 id="orgbceaf77"><span class="section-number-5">2.24.4.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Current design</h5>
<div class="outline-text-5" id="text-2-24-4-1">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-12 Mon 08:22]</span></span></li>
</ul>
<p>
Have two separate words: one for loading new modules <code>loadlib</code>, and
other <code>using</code> for activating them in a given program.
</p>

<p>
Using hashes to refer to modules or namespaces is secure, but hard to
read. We can use aliases, but we need to be careful about which
aliases we use - should we trust an alias created by a module we
loaded? Can we overwrite aliases?
</p>

<p>
Attack scenario: we load a module foo, and it creates an alias bar and
then we later assume bar refers to something else, and call its 'quux'
word.
</p>

<p>
There are several different loading mechanisms which is what makes this functionality difficult:
</p>

<ul class="org-ul">
<li>defining a module inline (we provide the bytes and perhaps also an alias)</li>
<li>loading a stdlib module into the default namespace</li>
<li>loading a stdlib module into its own namespace</li>
<li>loading an externally-downloaded module and giving it an alias</li>
</ul>

<p>
I think for the last case, if you load a module and give it an alias
simultaneously, I don't see how an attacker can get you, as long as
it's an error trying to overwrite an alias. If the alias already
existed, you get an error, and if not, you're guaranteed the content
can't change after that point. It's only dangerous when you try to use
an alias you never attempted to create yourself.
</p>

<p>
This may at least mitigate RCE attacks, but it does still leave the
problem of aliases potentially colliding and those collisions being
hard to predict. I don't know that this is a problem unique to this
language though.
</p>

<p>
In terms of implementation details, we could leave it mostly as-is
except we need the ability to
</p>

<ul class="org-ul">
<li>load a library using an predefined alias (for stdlibs that aren't
loaded by default)</li>
<li>load libraries into the default (no) namespace</li>
</ul>

<p>
So how do we implement that? <code>inscribe</code> doesn't know or care about where
the content comes from, so we need a way of fetching from the
cache. We can check the mapping of alias-&gt;hash and if it exists,
verify a match, and if it doesn't exist, create the mapping. Since the
mapping will exist before calling <code>inscribe</code>, <code>inscribe</code> needs a way of
not creating the alias - we could do that by allowing <code>[]</code> as an alias.
</p>
</div>
</div>
<div id="outline-container-org72bec5a" class="outline-5">
<h5 id="org72bec5a"><span class="section-number-5">2.24.4.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Library loading</h5>
<div class="outline-text-5" id="text-2-24-4-2">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-17 Sat 14:51]</span></span></li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgd9c2b9c"></a><span class="todo TODO">TODO</span> Make library loading primitives<br />
<ol class="org-ol">
<li><a id="org29acece"></a><span class="done DONE">DONE</span> Move hash to earlier loading module<br />
<div class="outline-text-7" id="text-2-24-4-2-1-1">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 11:39]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 11:14]</span></span></li>
</ul>
<p>
We need it for library loading, can't stay as part of crypto lib.
</p>
</div>
</li>
<li><a id="orgb67ab4e"></a><span class="done DONE">DONE</span> Primitive for namespacing a word<br />
<div class="outline-text-7" id="text-2-24-4-2-1-2">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 16:50]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 11:44]</span></span></li>
</ul>
</div>
</li>
<li><a id="org3373723"></a><span class="done DONE">DONE</span> Primitive for loading a blob from cache via hash or alias<br />
<div class="outline-text-7" id="text-2-24-4-2-1-3">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 16:50]</span></span></li>
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-19 Tue 16:34]</span></span>
</p>

<p>
This verifies the module being loaded from cache matches the builtin hash.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>crypto<span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-function-name">unwrap</span>
decache <span class="org-builtin">swap</span> <span class="org-string">"modules"</span> encodestring hashbytes
<span class="org-builtin">swap</span> <span class="org-function-name">unwrap</span> namespaced <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>definition<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
 dictionary <span class="org-builtin">swap</span> lookup <span class="org-function-name">first</span> <span class="org-builtin">swap</span>
 hashbytes =
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">yes
</pre>
</div>

<p>
this just inscribes the module
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>pipes<span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-function-name">unwrap</span>
  decache string read
  <span class="org-comment-delimiter">;;</span><span class="org-comment">inscribe</span>
  <span class="org-comment-delimiter">;;</span><span class="org-comment">[crypto] ["foo" hash] using</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>pipe-in <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>item<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>pipe<span class="org-kcats-brackets">]]]</span>
           <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span>association <span class="org-kcats-brackets">[[[</span>type <span class="org-kcats-brackets">[</span>file<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>value file-in<span class="org-kcats-brackets">]]</span>
                                     <span class="org-kcats-brackets">[[</span>type <span class="org-kcats-brackets">[</span>stdout<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>stdout<span class="org-kcats-brackets">]]]</span>
                        decide<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>tunnel <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>item<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>pipe<span class="org-kcats-brackets">]]]</span>
          <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span>association <span class="org-kcats-brackets">[[[</span>type <span class="org-kcats-brackets">[</span>ip-host<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>port<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[[</span>address<span class="org-kcats-brackets">]</span>
                                                                                     lookup<span class="org-kcats-brackets">]</span>
                                                                <span class="org-preprocessor">dip</span> serversocket<span class="org-kcats-brackets">]]</span>
                                    <span class="org-kcats-brackets">[[</span>type <span class="org-kcats-brackets">[</span>ip-client<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>port<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[[</span>address<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                                                                  <span class="org-preprocessor">dip</span> socket<span class="org-kcats-brackets">]]]</span>
                       decide<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>pipe-out <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>item<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>pipe<span class="org-kcats-brackets">]]]</span>
            <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span>association <span class="org-kcats-brackets">[[[</span>type <span class="org-kcats-brackets">[</span>file<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>value file-out<span class="org-kcats-brackets">]]</span>
                                      <span class="org-kcats-brackets">[[</span>type <span class="org-kcats-brackets">[</span>ip-host<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>port<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[[</span>address<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                                                                  <span class="org-preprocessor">dip</span> serversocket<span class="org-kcats-brackets">]]]</span>
                         decide<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>spit <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>item <span class="org-kcats-brackets">[</span>item target<span class="org-kcats-brackets">]]</span>
               <span class="org-kcats-brackets">[]]]</span>
        <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[</span>pipe-in<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> encode <span class="org-function-name">put</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>slurp <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>pipe<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>item<span class="org-kcats-brackets">]]]</span>
         <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> fold string <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>print <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]]</span>
         <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[</span>standard<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-string">"\n"</span> <span class="org-function-name">join</span> encode <span class="org-function-name">put</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>sleep <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>integer<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]]</span>
         <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span>timer <span class="org-function-name">take</span> <span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[</span>future <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>pipe<span class="org-kcats-brackets">]]]</span>
          <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span>handoff <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dive</span> <span class="org-function-name">put</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> spawn animate<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>examples <span class="org-kcats-brackets">[[[</span>1 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]</span>
                       future <span class="org-function-name">take</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[</span>1 <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]]]]]]]</span>
 <span class="org-kcats-brackets">[</span>generator <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[[</span>program generator-maker<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>program wrapped-generator<span class="org-kcats-brackets">]]]]</span>
             <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span> <span class="org-preprocessor">inject</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">take</span><span class="org-kcats-brackets">]]]]]</span>
 <span class="org-kcats-brackets">[</span>siphon <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[[</span>receptacle output<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[</span>program generator<span class="org-kcats-brackets">]]</span>
                 <span class="org-kcats-brackets">[[</span>receptacle output<span class="org-kcats-brackets">]]]]</span>
          <span class="org-kcats-brackets">[</span>description <span class="org-string">"Generates values from a wrapped generator (stacked generator inside a list), until exhausted, puts all items into the output receptacle"</span><span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>empty?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span>generate <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
                                    <span class="org-preprocessor">dip</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
                                    <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
                       <span class="org-preprocessor">until</span> <span class="org-builtin">drop</span> <span class="org-builtin">drop</span> <span class="org-builtin">sink</span> <span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>examples <span class="org-kcats-brackets">[[[[[</span>integers 5 taker<span class="org-kcats-brackets">]</span> generator <span class="org-kcats-brackets">[]</span> siphon<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[[</span>0 1 2 3 4<span class="org-kcats-brackets">]]]]]]]</span>
 <span class="org-kcats-brackets">[</span>close <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[</span>pipe<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]]</span>
         <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]]]</span>
<span class="org-kcats-brackets">[</span>pipes<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>actual close<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>sized<span class="org-kcats-brackets">]]</span>
         <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>dictmerge <span class="org-kcats-brackets">[</span>generators<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>decache <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> inscribe<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org00e2c5e"></a><span class="done CANCELED">CANCELED</span> Primitive for aliasing a module<br />
<div class="outline-text-7" id="text-2-24-4-2-1-4">
<ul class="org-ul">
<li>State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-04-08 Mon 16:40] </span></span> <br />
Not going to use aliases.</li>
</ul>
<p>
Needs to respect the "no overwrite" rule.
</p>
</div>
</li>
<li><a id="orgdc49540"></a><span class="todo TODO">TODO</span> Test out saving modules as dict entries<br />
<div class="outline-text-7" id="text-2-24-4-2-1-5">
<p>
We can think of a module as a dictionary modification program. We can
store those programs in the dictionary as definitions and use them
later? No not really, because we can't modify the current
dictionary. So there's no way to just install an alias to a module.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"123"</span> encode
<span class="org-kcats-brackets">[</span>crypto<span class="org-kcats-brackets">]</span> stdmod
<span class="org-kcats-brackets">[</span>hash<span class="org-kcats-brackets">]</span> boomerang
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>
</pre>
</div>

<p>
Ok so this is straight forward enough but what if we want to use a
module later? Do we need to reload it? We could save dictionaries but
that's not the same as saving the modules that comprise it so that
they can be combined in different ways.
</p>

<p>
In most languages, a module continues to be addressable by an alias
after you've loaded it (and doesn't result in loading it again).
</p>

<p>
A couple ways to deal with that - can store a diff instead of the
module program and just apply it. Can just reload the module every
time. Can keep the resulting dictionary somewhere (on the stack?).
</p>

<p>
Kcats is just function composition, I don't think there's any case
where more than one function needs to be available at a time. Dividing
the dictionary seems to be more of a security feature - you're saying
"this program should only need these functions but I don't know what
the lower levels try to do". In theory you could give different
dictionaries to every word of the program that consisted of all the
words that word calls, etc. So this whole system is more of a
"matching my expectations to the actual behavior" type of feature.
</p>
</div>
</li>
<li><a id="orge7421fb"></a><span class="todo TODO">TODO</span> Test out nested envs as library mechanism<br />
<div class="outline-text-7" id="text-2-24-4-2-1-6">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">load a module</span>
<span class="org-kcats-brackets">[</span>crypto<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> decache string read
<span class="org-kcats-brackets">[[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> <span class="org-string">"baz"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>hash<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> spawn <span class="org-builtin">clone</span> evaluate

<span class="org-comment-delimiter">;;</span><span class="org-comment">boomerang</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>#b64 <span class="org-string">"LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="</span> #b64 <span class="org-string">"/N4rLtula/QIYB+3If6bXDONEO5CnqBPrlURto+/j7k="</span>
          #b64 <span class="org-string">"uqWglk0zIPvAxqkiFARTyFE+okq4/QV3A0gEqWckgJY="</span><span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span> <span class="org-string">"baz"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>hash<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
</pre>
</div>

<p>
So what is <code>let</code> in this model?
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>5 plus2<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>draft<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
boomerang
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">7
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-org2a5f565" class="outline-5">
<h5 id="org2a5f565"><span class="section-number-5">2.24.4.3.</span> <span class="todo INPROGRESS">INPROGRESS</span> Nesting scopes</h5>
<div class="outline-text-5" id="text-2-24-4-3">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-14 Wed 20:07]</span></span></li>
</ul>
<p>
We should be able to chain calls to <code>using</code> without repeating any
expensive calls.
</p>

<p>
That means we need a word that only modifies a program by resolving
the words in it (could call it <code>resolve</code>?)
</p>

<p>
test overriding behavior
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>+ <span class="org-kcats-brackets">[</span><span class="org-string">"oo"</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"a"</span> <span class="org-string">"b"</span> +<span class="org-kcats-brackets">]</span>
let
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">Resolved: Word { data: 0x55b105c8ce50 : <span class="org-string">"+"</span>, namespace: Some(<span class="org-kcats-brackets">[</span>95, 8, 227, 46, 226, 44, 177, 198, 142, 175, 56, 167, 55, 63, 227, 254, 126, 182, 160, 134, 28, 68, 164, 57, 208, 15, 103, 59, 84, 173, 128, 139<span class="org-kcats-brackets">]</span>) }
<span class="org-kcats-brackets">[</span><span class="org-string">"oo"</span><span class="org-kcats-brackets">]</span> <span class="org-string">"b"</span> <span class="org-string">"a"</span>
</pre>
</div>

<p>
The issue is we're updating the definition but we end up keeping the
old spec and examples. we need to clear the whole entry.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span>6<span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the word name to get a path to update</span>
 <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]</span> label<span class="org-kcats-brackets">]</span> update <span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">[[</span>update<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span>  inscribe
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-kcats-brackets">[[</span>definition <span class="org-kcats-brackets">[[</span>6<span class="org-kcats-brackets">]]]]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>update dictmerge <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> using<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>definition <span class="org-kcats-brackets">[[</span>6<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> dictionary_redacted #b64 <span class="org-string">"DFyCLJSxw6T5kHmcZ0+a4jZT0gNq29vn/BE9oKcRSTU="</span>
foo
</pre>
</div>

<p>
ok this is too rigid, let's get rid of revise/draft in their current
terms and make words that bulld what <code>inscribe</code> needs.
</p>

<p>
After some internal debate, i think it's best to have inscribe take a
single update program - rationale is that there's no need at that
point to treat them separately, that can be done before.
</p>

<p>
So inscribe is currently correct, we need to &#x2026; revise <code>revise</code>. First
thing is a function that takes a list of word updates and translates
to a single dictionary update.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>definition <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>spec <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]]]]]]</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the word name to get a path to update</span>
  <span class="org-kcats-brackets">[</span>update<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> each
 joiner generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> 
inscribe
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">Resolved: Word { data: 0x56294637f420 : <span class="org-string">"swap"</span>, namespace: Some(<span class="org-kcats-brackets">[</span>59, 133, 203, 149, 9, 0, 17, 144, 86, 83, 103, 44, 36, 226, 184, 25, 62, 38, 28, 127, 173, 154, 55, 144, 71, 243, 173, 235, 59, 37, 10, 18<span class="org-kcats-brackets">]</span>) }
6
</pre>
</div>

<p>
Now we need a shortcut for when we don't want to specify the whole entry, just the definition
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
updates inscribe <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6
</pre>
</div>

<p>
Test draft
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]]</span> draft <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> let
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>bar <span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span><span class="org-kcats-brackets">]]]</span> draft inscribe
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">foo
</pre>
</div>

<p>
Ok this is all seems to be in order, there's now a problem in the
stdlib where a word calls <code>let</code> and defines some local functions, eg
<code>partition</code>. What we actually need is to do <code>resolve</code> as the stdlib is
being built, perhaps defining <code>partition</code> in its own little module, and
then resolving the module once. Something like this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">functions partition uses</span>
<span class="org-kcats-brackets">[</span>partition<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span> <span class="org-kcats-brackets">[[</span>taker collect
         <span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">; </span><span class="org-comment">drop the used-up taker generator</span>
        <span class="org-function-name">join</span> divedeep<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>shift <span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span> &lt;=<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> 0 slice<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span> 
<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">[</span>partition<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>spec <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]]</span>
             <span class="org-kcats-brackets">[</span>definition <span class="org-kcats-brackets">[[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">state</span>
                          <span class="org-comment-delimiter">;; </span><span class="org-comment">the generator</span>
                          <span class="org-kcats-brackets">[[[]</span>
                            <span class="org-kcats-brackets">[</span>over <span class="org-function-name">wrap</span> <span class="org-function-name">take</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> shift<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
                            <span class="org-kcats-brackets">[[</span>over<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> <span class="org-function-name">wrap</span> <span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> shift<span class="org-kcats-brackets">]</span>
                            <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]]]]]</span> assign
updates inscribe

</pre>
</div>
</div>
</div>
<div id="outline-container-org9d456d8" class="outline-5">
<h5 id="org9d456d8"><span class="section-number-5">2.24.4.4.</span> <span class="todo TODO">TODO</span> Stack escape protection</h5>
<div class="outline-text-5" id="text-2-24-4-4">
<p>
If a program refers to a word, and at the time that program is put on
the stack, that word means something, it should still carry the same
meaning if that program is later run with <code>execute</code>. That means that
module changes must be permanent.
</p>
</div>
</div>
<div id="outline-container-org9b54973" class="outline-5">
<h5 id="org9b54973"><span class="section-number-5">2.24.4.5.</span> <span class="todo INPROGRESS">INPROGRESS</span> Sandboxing support</h5>
<div class="outline-text-5" id="text-2-24-4-5">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-04-03 Wed 20:41]</span></span></li>
</ul>
<p>
It must be possible for a module to <b>deny</b> access to a given word. Given
that dictionary changes are permanent, we can't just delete words from
the dictionary (once the given program is done, that word needs to be
available again somehow).
</p>

<p>
We can implement this with some sort of shadowing mechanism during
resolving: If we "delete" a word, we could actually define the word in
the module's namespace, such that all it does is throw a 'no such
word' error. That's one somewhat hacky way to implement it, but there
may be others.
</p>

<ul class="org-ul">
<li>There should be no way for code using the module to access the
"deleted" word. (Check for escape hatches via arbitrary dictionary
modification)</li>
<li>The word should be accessible again after the program using the
module has completed.</li>
</ul>
</div>
<ol class="org-ol">
<li><a id="orgd676709"></a><span class="todo TODO">TODO</span> experiment with nested envs as module loading mechanism<br />
<div class="outline-text-6" id="text-2-24-4-5-1">
<p>
First let's see if a nested env allows sandboxing
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">make an env with no access to io</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">load the functional module code</span>
<span class="org-kcats-brackets">[</span>functional<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> decache string read

<span class="org-comment-delimiter">;; </span><span class="org-comment">get the current dictionary and modify it</span>
<span class="org-kcats-brackets">[</span>dictionary<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">execute</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">Now create a new env with this dictionary and execute it</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span> print<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>program dictionary<span class="org-kcats-brackets">]</span> label environment evaluate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>asked <span class="org-kcats-brackets">[</span>standard<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>standard <span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> <span class="org-string">"\n"</span> <span class="org-function-name">join</span> encode <span class="org-function-name">put</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]]]]]</span>
</pre>
</div>

<p>
Yes!
</p>

<p>
Ok now let's make a word that takes a module and a program, builds a
new env.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-kcats-brackets">[</span>5 plus2<span class="org-kcats-brackets">]</span>
spawn
<span class="org-comment-delimiter">;</span><span class="org-comment">dictionary</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">float shielddown [dictionary program] label environment</span>
evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">7 <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-string">"foo"</span>
</pre>
</div>

<p>
Also, for debugging purposes it would seem we need a way of running
eval-step (outer) in a loop - perhaps an axiom that checks if the
program is empty, if not eval-step it and place eval-step back in the
program? Slightly better than a <code>loop</code> impl. Maybe it's ok for now.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>1 2 3 +<span class="org-kcats-brackets">]]]</span> environment eval-<span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>2 3 +<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
Let's see if it's possible to use an inner-env module and still debug it.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">the program we want to debug in the top level</span>
<span class="org-kcats-brackets">[</span>10 11
 <span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> draft inscribe
 <span class="org-kcats-brackets">[</span>plus2<span class="org-kcats-brackets">]</span> confine<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">TODO: the issue here is that we can't just eval-step once, We have</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">to make the next instruction also eval-step (unless the program is</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">already empty)</span>
<span class="org-kcats-brackets">[[</span>evaluate definition<span class="org-kcats-brackets">]</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">The inner env debugger - when we call `confine`, it's going to</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">call `evaluate`, which will not allow us to step through the inner</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">env's execution. In order to do that, we have to just eval-step</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">it. Instead of running evaluate as a single atomic word we just</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">make a kcats version of it.</span>
 <span class="org-kcats-brackets">[[[</span>program<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]</span> assign<span class="org-kcats-brackets">]</span> inscribe  
<span class="org-builtin">swap</span>
spawn 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>consume<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"not enough items on stack"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>confine<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>10 11 <span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> draft inscribe <span class="org-kcats-brackets">[</span>plus2<span class="org-kcats-brackets">]</span> confine<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">the program we want to debug in the top level</span>
10 11
<span class="org-kcats-brackets">[[</span>plus2 <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]]</span> draft inscribe
<span class="org-kcats-brackets">[</span>plus2<span class="org-kcats-brackets">]</span> confine
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">13 10
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org66aaa4f" class="outline-5">
<h5 id="org66aaa4f"><span class="section-number-5">2.24.4.6.</span> <span class="todo INPROGRESS">INPROGRESS</span> Access control</h5>
<div class="outline-text-5" id="text-2-24-4-6">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-04-07 Sun 13:53]</span></span></li>
</ul>
<p>
Take the word <code>define</code> which allows the caller to make arbitrary and
permanent changes to the dictionary. What if we wanted to restrict
access to that word such that authorized programs can call it but
others can't?
</p>
</div>
</div>
<div id="outline-container-orgf5e4da6" class="outline-5">
<h5 id="orgf5e4da6"><span class="section-number-5">2.24.4.7.</span> <span class="todo INPROGRESS">INPROGRESS</span> Words can refer to other words in the same library</h5>
<div class="outline-text-5" id="text-2-24-4-7">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-17 Sat 14:51]</span></span></li>
</ul>
</div>
</div>
<div id="outline-container-orgee457f2" class="outline-5">
<h5 id="orgee457f2"><span class="section-number-5">2.24.4.8.</span> <span class="todo TODO">TODO</span> Convenient module definition</h5>
<div class="outline-text-5" id="text-2-24-4-8">
<p>
We need a word that takes care of the common case: we want to define a
set of vocabulary, it's all additive, and some of the words refer to
each other. Previously we called that <code>draft</code>. Here's what the new <code>draft</code>
could look like, it breaks down into generating dictionary updates:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>number<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>spec definition<span class="org-kcats-brackets">]</span> label<span class="org-kcats-brackets">]</span>
 update
 <span class="org-kcats-brackets">[</span>cube<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>number<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>spec definition<span class="org-kcats-brackets">]</span> label<span class="org-kcats-brackets">]</span>
 update<span class="org-kcats-brackets">]</span>

  encode <span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> inscribe
</pre>
</div>

<p>
So we want the user to be able to write this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update
  <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]</span> label <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-kcats-brackets">[[</span>update<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span> encode<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the module name</span>
<span class="org-function-name">unwrap</span> inscribe
<span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>6 cube<span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">216
</pre>
</div>

<p>
can we recurse?
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>factorial <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> positive?<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[[</span>*<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[</span>dec<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> factorial<span class="org-kcats-brackets">]</span>
             when<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update
  <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]</span> label <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-kcats-brackets">[[</span>update<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span> encode<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the module name</span>
<span class="org-function-name">unwrap</span> <span class="org-comment-delimiter">; </span><span class="org-comment">inscribe</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[math] [6 1 factorial dropdown] resolve [2] lookup inspect</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">720
</pre>
</div>

<p>
let's see if we can make revise first
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>f<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>fff <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>hh<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>hash <span class="org-kcats-brackets">[[</span>type <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> fff hash<span class="org-kcats-brackets">]</span>
         addmethod <span class="org-kcats-brackets">[</span>f<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> resolve<span class="org-kcats-brackets">]]]</span> revise

<span class="org-kcats-brackets">[</span>hh<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>foo myfoo<span class="org-kcats-brackets">]]</span> association hash<span class="org-kcats-brackets">]</span> using

<span class="org-string">"foo"</span> hash =
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">yes
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>ff<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>f <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>gg<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>g <span class="org-kcats-brackets">[[</span>ff<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>f<span class="org-kcats-brackets">]</span> resolve<span class="org-kcats-brackets">]]]</span>
revise

<span class="org-kcats-brackets">[</span>gg<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>g<span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"foo"</span>
</pre>
</div>


<p>
lets see if the draft in terms of revise works
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>factorial <span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> positive?<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[[</span>*<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-kcats-brackets">[</span>dec<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> factorial<span class="org-kcats-brackets">]</span>
             when<span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>math<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>6 1 factorial <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">720
</pre>
</div>

<p>
Test if we can use resolve before a draft, to refer to existing
modules within a module. Now this works because inscribe can take
either serialized bytes or a parsed datastructure. If we pass the
latter, it can have words already resolved.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>innermodule<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>innerfn <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft

<span class="org-kcats-brackets">[</span>outermodule<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>innermodule<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>outerfn <span class="org-kcats-brackets">[</span>innerfn<span class="org-kcats-brackets">]]]</span> resolve
draft

<span class="org-kcats-brackets">[</span>outermodule<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>outerfn<span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"foo"</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span>innermodule<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[</span>innerfn <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]]</span> draft

           <span class="org-kcats-brackets">[</span>outermodule<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[</span>outerfn <span class="org-kcats-brackets">[[</span>innermodule<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>innerfn<span class="org-kcats-brackets">]</span> resolve<span class="org-kcats-brackets">]]]</span> 
           revise

           <span class="org-kcats-brackets">[</span>outermodule<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>outerfn<span class="org-kcats-brackets">]</span> using
          <span class="org-kcats-brackets">]]]</span> environment
<span class="org-kcats-brackets">[</span>advance<span class="org-kcats-brackets">]</span> 10 <span class="org-preprocessor">times</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">
<span class="org-kcats-brackets">[[</span>fiver <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>12 fiver<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span>0<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">add an alias (0 means don't bother with creating the alias)</span>
 <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">create full entries for each definition</span>
 <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">add 'join' to join the entries with the existing dictionary</span>
 inscribe <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">update dict and then wrap the hash as the module to be used </span>
using <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the program </span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">17
</pre>
</div>
</div>
</div>
<div id="outline-container-org6a84f6c" class="outline-5">
<h5 id="org6a84f6c"><span class="section-number-5">2.24.4.9.</span> <span class="todo TODO">TODO</span> convenient 'let'</h5>
<div class="outline-text-5" id="text-2-24-4-9">
<p>
We want define a module and use it inline without having to worry about its alias.
Let's see if we can implement <code>partition</code> this way.
</p>
<div class="org-src-container">
<pre class="src src-kcats">
<span class="org-comment-delimiter">;; </span><span class="org-comment">the module</span>

<span class="org-kcats-brackets">[[</span>square <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>cube <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> square *<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>9 cube<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>draft <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> using 
<span class="org-comment-delimiter">; </span><span class="org-comment">[</span>
<span class="org-comment-delimiter">;  </span><span class="org-comment">[[]</span>
<span class="org-comment-delimiter">;   </span><span class="org-comment">[over wrap take [join shift] bail]</span>
<span class="org-comment-delimiter">;   </span><span class="org-comment">[[over] dive wrap take swap drop shift]</span>
<span class="org-comment-delimiter">;   </span><span class="org-comment">if]</span>
<span class="org-comment-delimiter">;  </span><span class="org-comment">draft]</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">729
</pre>
</div>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[[</span>foo <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> revise<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span> <span class="org-comment-delimiter">;</span><span class="org-comment">tracer 100 taker collect</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>foo <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span>  <span class="org-function-name">map</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>foo <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org491360d" class="outline-5">
<h5 id="org491360d"><span class="section-number-5">2.24.4.10.</span> <span class="todo INPROGRESS">INPROGRESS</span> Break up the standard library</h5>
<div class="outline-text-5" id="text-2-24-4-10">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-04 Mon 20:22]</span></span></li>
</ul>
<p>
Question: how do we break it up? For example, does <code>io</code> refer to all I/O
operations or just the base stuff that they all depend on?
</p>

<p>
Some areas of functionality that already exist:
</p>
<ul class="org-ul">
<li>Debugger</li>
<li>Generators</li>
<li>Pipes
<ul class="org-ul">
<li>File</li>
<li>Network</li>
<li>Channel</li>
</ul></li>
<li>Encoding</li>
<li>Associations</li>
<li>Collections</li>
</ul>

<p>
There seem to be 3 types of modules:
</p>
<ul class="org-ul">
<li>Stuff that's part of the core functionality (can't do basic language
stuff without it, should be part of the binary). Could be up to and
including what's needed to call inscribe/using, which allows callers
to load their own modules.</li>
<li>Not core but can still be in the default namespace because it likely
doesn't collide with other stuff (io, nested env etc)</li>
<li>Stuff that's not used often enough to be in default namespace, or is
easy enough to refer in when needed (crypto, debugger)</li>
</ul>

<p>
The 2nd type, we can now use "inscribe" and make them normal modules,
but then they won't be in the default namespace. We can at least leave
them out of the binary. 
</p>
</div>
<ol class="org-ol">
<li><a id="org70dd05c"></a><span class="todo INPROGRESS">INPROGRESS</span> Figure out where to put modules on disk<br />
<div class="outline-text-6" id="text-2-24-4-10-1">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-04 Mon 20:22]</span></span></li>
</ul>
<p>
This will make the build and packaging more complex as it will have to
include other files besides the binary and deal with platform-specific
issues. The standard env could, however, still load a bunch of libs,
but maybe this could be overridden with cmdline args.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-function-name">unwrap</span> decache inscribe<span class="org-kcats-brackets">]]]</span> environment <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">Warning, failed to insert into dictionary: Dispenser(Sized(List(<span class="org-kcats-brackets">[</span>Int(5), Word(Word { data: 0x55782137afc0 : <span class="org-string">"+"</span>, namespace: None })<span class="org-kcats-brackets">]</span>)))
Warning: empty local module
<span class="org-kcats-brackets">[[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-function-name">unwrap</span> decache inscribe<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> decache inscribe<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>decache inscribe<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>foo <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>inscribe<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"W1tiYXJdIFs1ICtdIGFzc2lnbl0="</span> <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
             assign<span class="org-kcats-brackets">]</span>
            <span class="org-preprocessor">shielddown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shielddown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">shield</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                      assign<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                       assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                                          assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                                       assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[]</span> dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                                 assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                           assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
                     assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
            foo<span class="org-kcats-brackets">]]</span> dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
              assign<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
            assign<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
                      foo<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">inject</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]</span> dictionary_redacted
          #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-builtin">evert</span> <span class="org-function-name">take</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]</span> dictionary_redacted
          #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-function-name">take</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
            assign<span class="org-kcats-brackets">]</span>
           dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
           assign<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]</span> dictionary_redacted
          #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span>bar<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
            assign <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
                     foo<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span>5 +<span class="org-kcats-brackets">]</span>
            assign <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
                     foo<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>bar<span class="org-kcats-brackets">]</span> dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>assign <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
                     foo<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>5 +<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
              foo<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
            foo<span class="org-kcats-brackets">]]</span> dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
           foo<span class="org-kcats-brackets">]</span>
          dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span> foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-builtin">drop</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>dictionary_redacted #b64 <span class="org-string">"mz5w5sBIFt1413HhyrFOWKaa8MhJFlgZE/PeBAiaz40="</span>
          foo<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>crypto-builtins<span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-function-name">unwrap</span> decache
string read
<span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">wrap the definition so update leaves the literal value</span>
updates inscribe
<span class="org-function-name">wrap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the module alias</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"foobar"</span> encode hashbytes<span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">#b64 <span class="org-string">"Zm9vYmFy"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[[</span>baryyyy<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span> assign<span class="org-kcats-brackets">]</span> inscribe <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>6 baryyyy<span class="org-kcats-brackets">]</span> using
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">Warning, failed to insert into dictionary: Dispenser(Sized(List(<span class="org-kcats-brackets">[</span>Int(5), Word(Word { data: 0x55a8be888030 : <span class="org-string">"+"</span>, namespace: None })<span class="org-kcats-brackets">]</span>)))
Warning: empty local module
<span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>baryyyy<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>baryyyy<span class="org-kcats-brackets">]]]</span>
6
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo<span class="org-kcats-brackets">]</span>  <span class="org-kcats-brackets">[</span>bar<span class="org-kcats-brackets">]</span> resolve
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual foo<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>resolve<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"module not found"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>resolve<span class="org-kcats-brackets">]]]</span>
</pre>
</div>
</div>
</li>
<li><a id="org67f203d"></a><span class="todo INPROGRESS">INPROGRESS</span> Move core libs back to using include<sub>bytes</sub><br />
<div class="outline-text-6" id="text-2-24-4-10-2">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-14 Thu 17:11]</span></span></li>
</ul>
</div>
</li>
<li><a id="orga164bba"></a><span class="todo INPROGRESS">INPROGRESS</span> Figure out what to do about builtins<br />
<div class="outline-text-6" id="text-2-24-4-10-3">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-04 Mon 20:22]</span></span></li>
</ul>
</div>
</li>
<li><a id="org1bd2626"></a><span class="todo INPROGRESS">INPROGRESS</span> Group functions<br />
<div class="outline-text-6" id="text-2-24-4-10-4">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-02-27 Tue 11:58]</span></span></li>
</ul>
</div>
</li>
<li><a id="org23778a9"></a><span class="todo INPROGRESS">INPROGRESS</span> Determine module loading order<br />
<div class="outline-text-6" id="text-2-24-4-10-5">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-03-04 Mon 20:22]</span></span></li>
<li>stack ops builtins [drop clone evert]</li>
<li>stack motion builtins [swap swapdown float sink]</li>
<li>stack motion [flip] (only depends on own builtins)</li>
<li>collection builtins [join put count first step take wrap unwrap &#x2026;]</li>
<li>execution builtins [dip execute branch recur loop decide]</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org24b0c7f" class="outline-5">
<h5 id="org24b0c7f"><span class="section-number-5">2.24.4.11.</span> <span class="done CANCELED">CANCELED</span> Disallow module alias overwriting</h5>
<div class="outline-text-5" id="text-2-24-4-11">
<ul class="org-ul">
<li>State "CANCELED"   from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-04-07 Sun 13:53] </span></span> <br />
We're not going to be using aliases in this branch</li>
</ul>
<p>
It is a security problem to allow code to overwrite some other code's
alias for a module. Throw an error in this case. We should call insert
on the aliases, and if it returns something, it better be equal to
what we inserted.
</p>
</div>
</div>
<div id="outline-container-org305eb29" class="outline-5">
<h5 id="org305eb29"><span class="section-number-5">2.24.4.12.</span> <span class="todo TODO">TODO</span> Store data sources</h5>
<div class="outline-text-5" id="text-2-24-4-12">
<p>
When we load modules we will eventually be getting them from the
network but for now the stdlib needs to be loaded from disk.  So we
could just always look there by default, i guess. But if we need to
allow custom sources, we could add that alongside the aliases
</p>
</div>
</div>
<div id="outline-container-org061c5ec" class="outline-5">
<h5 id="org061c5ec"><span class="section-number-5">2.24.4.13.</span> <span class="todo TODO">TODO</span> Find stdlib by alias</h5>
<div class="outline-text-5" id="text-2-24-4-13">
</div>
<ol class="org-ol">
<li><a id="org8fbfa93"></a><span class="todo TODO">TODO</span> hardcode the aliases in the source<br /></li>
</ol>
</div>
<div id="outline-container-orgf8aa469" class="outline-5">
<h5 id="orgf8aa469"><span class="section-number-5">2.24.4.14.</span> <span class="todo TODO">TODO</span> LIbrary loading should be in order of decreasing trust</h5>
<div class="outline-text-5" id="text-2-24-4-14">
<p>
We shouldn't start with a standard env with access to the
filesystem. Instead the standard env should lack IO capability, and
force that to be loaded in an inner env.
</p>

<p>
So instead of dropping back to a functional env, we start with one and
load io capability when needed.
</p>

<p>
Questions:
</p>
<ul class="org-ul">
<li>How do we decide what "less trusted" means?</li>
<li>Does decreasing trust make sense?</li>
<li>Does that mean we should never need to delete words? Seems like
sometimes we might.</li>
</ul>

<p>
Decreasing trust seems to make sense, since you can't make a
trustworthy construct out of an untrusted, only vice versa.
</p>

<p>
What makes an env less trusted than its parent? Is it the additional
words? Is it just that any additional code requires more trust, since
it needs to be vetted?
</p>
</div>
</div>
</div>
<div id="outline-container-org6c679e2" class="outline-4">
<h4 id="org6c679e2"><span class="section-number-4">2.24.5.</span> <span class="todo TODO">TODO</span> Debugger needs special handling to work with nested environments</h4>
<div class="outline-text-4" id="text-2-24-5">
<p>
For example to collect a histogram of how many times each word was
executed, we can pass the word up the env chain, but we need some
extra words to deal with this.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">; </span><span class="org-comment">inner env</span>
<span class="org-kcats-brackets">[</span>1 2 3 + +<span class="org-kcats-brackets">]</span> stage
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> stage
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6
</pre>
</div>

<p>
Let's compare <code>evaluate</code> with the step-wise version
</p>
<div class="org-src-container">
<pre class="src src-kcats">
<span class="org-kcats-brackets">[</span>0 1 100000 1 range <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
timestamps <span class="org-function-name">take</span>
<span class="org-builtin">float</span> <span class="org-preprocessor">dipdown</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> - 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">66 <span class="org-kcats-brackets">[[</span>from systemtime<span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>type out<span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span>values <span class="org-kcats-brackets">[[</span>type integer<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>units milliseconds<span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>4999950000<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
Hm even with the rust impl of <code>finished?</code> it's 1500ms vs 66ms, about 25x slower.
</p>
</div>
</div>
</div>
<div id="outline-container-org4d0d9ab" class="outline-3">
<h3 id="org4d0d9ab"><span class="section-number-3">2.25.</span> <span class="todo INPROGRESS">INPROGRESS</span> Database</h3>
<div class="outline-text-3" id="text-2-25">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2023-12-31 Sun 10:17]</span></span></li>
</ul>
</div>
<div id="outline-container-org0bff99a" class="outline-4">
<h4 id="org0bff99a"><span class="section-number-4">2.25.1.</span> Books db</h4>
<div class="outline-text-4" id="text-2-25-1">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"George"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Orwell"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"1984"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1949<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>government dystopia surveillance totalitarianism freedom<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Aldous"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Huxley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Brave New World"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1932<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>society technology dystopia happiness drugs<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"F. Scott"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Fitzgerald"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Great Gatsby"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1925<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>wealth love obsession american-dream tragedy<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"J.D."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Salinger"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Catcher in the Rye"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1951<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adolescence alienation innocence society adulthood<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Jane"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Austen"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Pride and Prejudice"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1813<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>love marriage society class reputation<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Mary"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Shelley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Frankenstein"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1818<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>creation science responsibility monster humanity<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"John"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Steinbeck"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Of Mice and Men"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1937<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>friendship dream loneliness society tragedy<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Ernest"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Hemingway"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Old Man and the Sea"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1952<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>endurance nature old-age fisherman sea<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Harper"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Lee"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"To Kill a Mockingbird"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1960<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>racism innocence morality law childhood<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"J.R.R."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Tolkien"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Lord of the Rings"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1954<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure elf dwarf hobbit ring journey magic evil<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Joseph"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Conrad"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Heart of Darkness"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1899<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>colonization africa journey morality darkness europeans<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Leo"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Tolstoy"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"War and Peace"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1869<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>war peace society history love aristocracy<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Homer"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Odyssey"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year -800<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>journey odyssey homecoming gods heroism adventure<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Charlotte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bronte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Jane Eyre"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1847<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>love morality society class womanhood independence<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Mark"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Twain"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Adventures of Huckleberry Finn"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1884<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure racism slavery morality friendship river<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Ray"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bradbury"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Fahrenheit 451"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1953<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>censorship knowledge books society dystopia future<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Charles"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Dickens"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"A Tale of Two Cities"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1859<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>revolution love sacrifice resurrection society history<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"William"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Golding"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Lord of the Flies"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1954<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>society civilization savagery childhood morality island<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Miguel de"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Cervantes"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Don Quixote"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1605<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure idealism reality knight insanity literature<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"H.G."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Wells"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The War of the Worlds"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1898<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>invasion aliens society technology war humanity<span class="org-kcats-brackets">]]]</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">db <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>type <span class="org-kcats-brackets">[</span>book<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>publishYear<span class="org-kcats-brackets">]</span> lookup 1940 &gt;=<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
keep
</pre>
</div>

<p>
Insert some data
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"George"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Orwell"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"1984"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1949<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>government dystopia surveillance totalitarianism freedom<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Aldous"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Huxley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Brave New World"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1932<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>society technology dystopia happiness drugs<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"F. Scott"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Fitzgerald"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Great Gatsby"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1925<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>wealth love obsession american-dream tragedy<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"J.D."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Salinger"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Catcher in the Rye"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1951<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adolescence alienation innocence society adulthood<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Jane"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Austen"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Pride and Prejudice"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1813<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>love marriage society class reputation<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Mary"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Shelley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Frankenstein"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1818<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>creation science responsibility monster humanity<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"John"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Steinbeck"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Of Mice and Men"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1937<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>friendship dream loneliness society tragedy<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Ernest"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Hemingway"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Old Man and the Sea"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1952<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>endurance nature old-age fisherman sea<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Harper"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Lee"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"To Kill a Mockingbird"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1960<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>racism innocence morality law childhood<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"J.R.R."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Tolkien"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Lord of the Rings"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1954<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure elf dwarf hobbit ring journey magic evil<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Joseph"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Conrad"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Heart of Darkness"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1899<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>colonization africa journey morality darkness europeans<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Leo"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Tolstoy"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"War and Peace"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1869<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>war peace society history love aristocracy<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Homer"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Odyssey"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year -800<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>journey odyssey homecoming gods heroism adventure<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Charlotte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bronte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Jane Eyre"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1847<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>love morality society class womanhood independence<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Mark"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Twain"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Adventures of Huckleberry Finn"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1884<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure racism slavery morality friendship river<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Ray"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bradbury"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Fahrenheit 451"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1953<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>censorship knowledge books society dystopia future<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Charles"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Dickens"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"A Tale of Two Cities"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1859<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>revolution love sacrifice resurrection society history<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"William"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Golding"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Lord of the Flies"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1954<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>society civilization savagery childhood morality island<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"Miguel de"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Cervantes"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"Don Quixote"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1605<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>adventure idealism reality knight insanity literature<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-string">"H.G."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Wells"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>title <span class="org-string">"The War of the Worlds"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>year 1898<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[</span>invasion aliens society technology war humanity<span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[[</span>subjects<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>set<span class="org-kcats-brackets">]</span> update persist<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span><span class="org-function-name">first</span>-name <span class="org-string">"George"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Orwell"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1903<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1950<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Nobel Prize in Literature"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Aldous"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Huxley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1894<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1963<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Humanitarian Award"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"F. Scott"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Fitzgerald"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1896<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1940<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Pulitzer Prize"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"J.D."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Salinger"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1919<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 2010<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Jane"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Austen"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1775<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1817<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex f<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Mary"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Shelley"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1797<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1851<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex f<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"John"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Steinbeck"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1902<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1968<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Nobel Prize in Literature"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Ernest"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Hemingway"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1899<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1961<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Nobel Prize in Literature"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Harper"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Lee"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1926<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 2016<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex f<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Pulitzer Prize"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"J.R.R."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Tolkien"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1892<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1973<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Joseph"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Conrad"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"Poland"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1857<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1924<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Leo"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Tolstoy"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"Russia"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1828<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1910<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Homer"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">""</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"Greece"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year -800<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year -701<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Charlotte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Bronte"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1816<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1855<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex f<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Mark"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Twain"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1835<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1910<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Ray"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Bradbury"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1920<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 2012<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Charles"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Dickens"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1812<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1870<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"William"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Golding"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1911<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1993<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[</span><span class="org-string">"Nobel Prize in Literature"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"Miguel de"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Cervantes"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"Spain"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1547<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1616<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span>-name <span class="org-string">"H.G."</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-string">"Wells"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>country <span class="org-string">"United Kingdom"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>birth-year 1866<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>death-year 1946<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>awards <span class="org-kcats-brackets">[]]]]</span>
<span class="org-kcats-brackets">[[</span>awards<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>set<span class="org-kcats-brackets">]</span> update persist<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf3f0ae0" class="outline-4">
<h4 id="orgf3f0ae0"><span class="section-number-4">2.25.2.</span> Schema</h4>
<div class="outline-text-4" id="text-2-25-2">
<p>
Here's a database of the most basic and abstract observations
(ignoring time and observer for now - those are all "now" and "me").
</p>

<p>
Down to a certain level, all attributes are also entities of their
own, but at some point they have to be either axiomatic or
circular. In the table below <code>type</code> and <code>format</code> are axiomatic.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Entity</th>
<th scope="col" class="org-left">Attribute</th>
<th scope="col" class="org-left">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Alice</td>
<td class="org-left">street</td>
<td class="org-left">123 Fake St</td>
</tr>

<tr>
<td class="org-left">Alice</td>
<td class="org-left">email</td>
<td class="org-left">alice@alice.com</td>
</tr>

<tr>
<td class="org-left">Alice</td>
<td class="org-left">birthdate</td>
<td class="org-left">1/1/1980</td>
</tr>

<tr>
<td class="org-left">street</td>
<td class="org-left">type</td>
<td class="org-left">attribute</td>
</tr>

<tr>
<td class="org-left">street</td>
<td class="org-left">format</td>
<td class="org-left">string</td>
</tr>

<tr>
<td class="org-left">email</td>
<td class="org-left">type</td>
<td class="org-left">attribute</td>
</tr>

<tr>
<td class="org-left">email</td>
<td class="org-left">format</td>
<td class="org-left">string</td>
</tr>

<tr>
<td class="org-left">birthdate</td>
<td class="org-left">type</td>
<td class="org-left">attribute</td>
</tr>

<tr>
<td class="org-left">birthdate</td>
<td class="org-left">format</td>
<td class="org-left">integer</td>
</tr>

<tr>
<td class="org-left">Alice</td>
<td class="org-left">relationship</td>
<td class="org-left">Bob</td>
</tr>

<tr>
<td class="org-left">Alice-Bob</td>
<td class="org-left">type</td>
<td class="org-left">relationship</td>
</tr>

<tr>
<td class="org-left">Alice-Bob</td>
<td class="org-left">nature</td>
<td class="org-left">friends</td>
</tr>

<tr>
<td class="org-left">Alice-Bob</td>
<td class="org-left">trust</td>
<td class="org-left">5/10</td>
</tr>
</tbody>
</table>

<p>
Let's create an EAV table
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"CREATE TABLE EAV</span>
<span class="org-string">( Entity STRING,</span>
<span class="org-string">  Attribute STRING,</span>
<span class="org-string">  Value</span>
<span class="org-string">   );"</span> <span class="org-kcats-brackets">[]</span> database 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"DROP TABLE EAV;"</span> <span class="org-kcats-brackets">[]</span> database 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Create indices (should really do this for all the columns)
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"CREATE INDEX idx_entity ON EAV (Entity);</span>
<span class="org-string">CREATE INDEX idx_attribute ON EAV (Attribute);</span>
<span class="org-string">CREATE INDEX idx_valuestring ON EAV (ValueString);</span>
<span class="org-string">"</span> <span class="org-kcats-brackets">[]</span> database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Butters"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>type dog<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>weight 59.1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>breed <span class="org-kcats-brackets">[</span>shepherd labrador<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>breed<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>set<span class="org-kcats-brackets">]</span> update persist
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Butters"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type dog<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>weight 59.1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>breed <span class="org-kcats-brackets">[</span>shepherd labrador<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>breed<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>set<span class="org-kcats-brackets">]</span> update persist
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"select * from EAV where Attribute=:attr;"</span> <span class="org-kcats-brackets">[[</span><span class="org-string">":attr"</span> name<span class="org-kcats-brackets">]]</span> database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>Entity #b64 <span class="org-string">"oGAP/g0nSc6LRwQJJti3HA=="</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>Value <span class="org-string">"Butters"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>Attribute name<span class="org-kcats-brackets">]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb55251e" class="outline-4">
<h4 id="orgb55251e"><span class="section-number-4">2.25.3.</span> Implementation and experiments</h4>
<div class="outline-text-4" id="text-2-25-3">
<p>
Find book title/author that are about "adventure".
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book? subjects adventure<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>title? author?<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
Notes: It does seem like it should be possible to reuse sets of
constraints, or produce constraints from a partial object. Maybe make
this another layer on top of the datalog.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>subjects adventure<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>title ?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> ?<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
We could even write queries that cross objects - what authors of adventure books were born in 1900:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>subjects adventure<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>author <span class="org-kcats-brackets">[[</span>birthyear 1900<span class="org-kcats-brackets">]]]]</span>

</pre>
</div>

<p>
Notes: the select clause should use the variable names without the <code>?</code>
as the column alias. It's not clear when <code>book?</code> is used in all 3
constraints, which one should it join on? I don't think it matters but
we need to choose somehow. Variables that are only used in one place
<b>should</b> appear in the select clause, should error if it doesn't.
</p>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"select c2.value as title, c3.value as author</span>
<span class="org-string">   from EAV as c1</span>
<span class="org-string">   join EAV as c2 ON c1.entity = c2.entity AND c1.attribute = \"w|subjects\" AND c1.value = \"w|adventure\" AND c2.attribute = \"w|title\"</span>
<span class="org-string">   join EAV as c3 ON c1.entity = c3.entity AND c3.attribute = \"w|author-last\" </span>
<span class="org-string"> "</span> database 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>title <span class="org-string">"The Lord of the Rings"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author <span class="org-string">"Tolkien"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>title <span class="org-string">"Adventures of Huckleberry Finn"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author <span class="org-string">"Twain"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>title <span class="org-string">"Don Quixote"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author <span class="org-string">"Cervantes"</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book <span class="org-string">"author"</span> author<span class="org-kcats-brackets">]</span> 
 <span class="org-kcats-brackets">[</span>book <span class="org-string">"title"</span> title<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>author <span class="org-string">"birthYear"</span> 1945<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>author <span class="org-string">"name"</span> authorName<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span>authorName title<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"select c4.value, c2.value</span>
<span class="org-string"> from EAV as c1 </span>
<span class="org-string"> join EAV as c2 ON c1.entity = c2.entity AND c2.attribute = \"w|title\" AND c1.attribute = \"w|author\"</span>
<span class="org-string"> join EAV as c3 ON c1.value = c3.entity AND c3.attribute = \"w|birthYear\" AND c3.value = 1945</span>
<span class="org-string"> join EAV as c4 ON c1.value = c4.entity AND c4.attribute = \"w|name\""</span> database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>unwound <span class="org-kcats-brackets">[</span>database<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>consume<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"not enough items on stack"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>handled yes<span class="org-kcats-brackets">]]</span>
<span class="org-string">"select c4.value, c2.value\n from EAV as c1 \n join EAV as c2 ON c1.entity = c2.entity AND c2.attribute = \"w|title\" AND c1.attribute = \"w|author\"\n join EAV as c3 ON c1.value = c3.entity AND c3.attribute = \"w|birthYear\" AND c3.value = 1945\n join EAV as c4 ON c1.value = c4.entity AND c4.attribute = \"w|name\""</span>
</pre>
</div>

<p>
Let's copy the input/output here:
</p>

<pre class="example">
 [[book? subjects adventure]
  [book? title title?]
  [book? author-last author?]]
 
 [title? author?]

select c2.value as title, c3.value as author
    from EAV as c1
    join EAV as c2 ON c1.entity = c2.entity
                  AND c1.attribute = "w|subjects"
                  AND c1.value = "w|adventure"
                  AND c2.attribute = "w|title"
    join EAV as c3 ON c1.entity = c3.entity
                  AND c3.attribute = \"w|author-last\" 
</pre>
<p>
We need to be able to scan through the constraints and output pairs
that are linked via one or more variables. We could create a list of variables like so:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? title?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? author?<span class="org-kcats-brackets">]]</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>book? subjects adventure<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>book? subjects adventure<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>book? title title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author?<span class="org-kcats-brackets">]]]</span>


</pre>
</div>
<p>
Then start with the first row, what other rows have intersection with
it? (May need to add some set-based words here).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? title?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? author?<span class="org-kcats-brackets">]]</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">Module to operate on generic data, that are used throughout</span>
<span class="org-kcats-brackets">[[</span>fork <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>triangle <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">sink</span> <span class="org-builtin">swap</span> pair<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>indexed-as-property <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> indexed
                       <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">sink</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span>-all <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span> empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>selectkeys <span class="org-kcats-brackets">[</span>set <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> contains?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">datalog variables</span>
 <span class="org-kcats-brackets">[</span>variable? <span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span>string <span class="org-function-name">last</span> \? =<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>variable= <span class="org-kcats-brackets">[[[</span>pair <span class="org-kcats-brackets">[</span>variable?<span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>=<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">datalog constraints</span>
 <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>slot-combos <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>constraint <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> slots <span class="org-function-name">reverse</span> label<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">links between datalog constraints</span>
 <span class="org-kcats-brackets">[</span>links <span class="org-kcats-brackets">[</span>slot-combos
         <span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swapdown</span> 
          <span class="org-kcats-brackets">[[[</span>lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> both<span class="org-kcats-brackets">]</span> pairwise 
          variable=<span class="org-kcats-brackets">]</span>
         <span class="org-function-name">filter</span>    
         <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> pair <span class="org-builtin">sink</span> pair
          <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">swap</span> zip<span class="org-kcats-brackets">]</span>
         <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>all-links <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">sink</span>
             <span class="org-kcats-brackets">[[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> both <span class="org-comment-delimiter">;; </span><span class="org-comment">lookup the indices of both constraints</span>
              <span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">sink</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">move the indices under the constraints</span>
              <span class="org-kcats-brackets">[</span>links<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
              <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> 

             <span class="org-function-name">step</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-link <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-string">"c{0}.{1} = c{2}.{3}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">formatting pieces of query data into text</span>
 <span class="org-kcats-brackets">[</span>anded-together <span class="org-kcats-brackets">[</span><span class="org-string">" AND "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">where clause data processing</span>
 <span class="org-kcats-brackets">[</span>where-data <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> 
              <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> variable? not<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> = not<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> 
              <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> prepend<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-where <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> 
                <span class="org-string">"c{0}.{1} = :c{0}{1}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>make-where <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>where<span class="org-kcats-brackets">]</span> lookup anded-together<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span> <span class="org-kcats-brackets">[[[[</span>on<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[[</span>where<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup string<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> anded-together<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> 
               <span class="org-string">"JOIN EAV c{1} ON {0}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>make-query <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span> <span class="org-kcats-brackets">[[</span>on<span class="org-kcats-brackets">]</span>
                    <span class="org-kcats-brackets">[[</span>format-link<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> update
                    <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">SQL parameters for rusqlite</span>
 <span class="org-kcats-brackets">[</span>param-name <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-string">":c{0}{1}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>extract-params <span class="org-kcats-brackets">[[]</span> association <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span>params<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]</span>


 <span class="org-comment-delimiter">;; </span><span class="org-comment">SELECT clause</span>
 <span class="org-kcats-brackets">[</span>wordval? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> word?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>validate <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> not<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-string">"All selected query variables must appear somewhere in constraints"</span>
              <span class="org-kcats-brackets">[</span>reason variable<span class="org-kcats-brackets">]</span> label fail<span class="org-kcats-brackets">]</span>
             when<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>select-data <span class="org-kcats-brackets">[</span>dump <span class="org-builtin">swap</span>
               <span class="org-kcats-brackets">[[</span>slots selectkeys invert<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
                <span class="org-kcats-brackets">[</span>wordval?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">join</span> association<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-builtin">swap</span>
               <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make a list of the variable and 'index'</span>
                 <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>selectkeys<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make the program to cut down</span>
                  <span class="org-function-name">map</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span> 2 =<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
                 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> number?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> when<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">items are in random order due to coming from association, fix the order</span>
                <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span>
               <span class="org-preprocessor">shield</span> dropdeep zip
               validate dump<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">query </span>
 <span class="org-kcats-brackets">[</span>extract-data <span class="org-kcats-brackets">[[[[</span><span class="org-function-name">unwrap</span> all-links<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> where-data   <span class="org-comment-delimiter">; </span><span class="org-comment">[join] inject unwrap</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">build the query param map</span>
                   <span class="org-kcats-brackets">[[[]</span> <span class="org-builtin">swap</span>
                     <span class="org-kcats-brackets">[[</span>param-name<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">wrap</span> <span class="org-builtin">swap</span> assign<span class="org-kcats-brackets">]</span>
                     <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">build the actual query where clauses</span>
                    <span class="org-kcats-brackets">[[</span>format-where<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
                   fork<span class="org-kcats-brackets">]]</span>
                 fork<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">combine extracted items</span>

                <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">keep the original constraint to add properties to</span>
                <span class="org-function-name">unwrap</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>where params on<span class="org-kcats-brackets">]</span> label <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-select <span class="org-kcats-brackets">[[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span>
                  string butlast <span class="org-comment-delimiter">;; </span><span class="org-comment">remove the ? from the variable name for result column</span>
                  <span class="org-function-name">put</span>
                  <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
                  <span class="org-string">"c{1}.{0} as {2}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-string">", "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]]</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This is the program we need to modify that is `query`</span>

<span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">expand all combinations of constraints</span>
 <span class="org-kcats-brackets">[</span>constraint<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-comment-delimiter">;;</span><span class="org-comment">[] prepend ;; an empty constraint to represent the orignal EAV table we're joining with</span>
 <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> indexed-as-property
 triangle
 <span class="org-comment-delimiter">;; </span><span class="org-comment">for each pair of constraints, build the "ON" clause data for the JOIN</span>
 <span class="org-kcats-brackets">[</span>extract-data<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-kcats-brackets">[[</span>extract-params<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>make-query<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>make-where<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> select-data<span class="org-kcats-brackets">]]</span> fork 
 <span class="org-builtin">dropdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">don't need original anymore</span>
 <span class="org-function-name">unwrap</span> <span class="org-builtin">float</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>  
 <span class="org-builtin">swap</span> format-select 
 <span class="org-kcats-brackets">[</span><span class="org-string">" "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> triplet <span class="org-function-name">reverse</span>
 <span class="org-string">"SELECT {0} from EAV as c0 {1} WHERE {2}"</span> <span class="org-builtin">swap</span> format
 <span class="org-builtin">swap</span> dropdeep<span class="org-kcats-brackets">]</span>

let
<span class="org-kcats-brackets">[</span>query<span class="org-kcats-brackets">]</span> label  <span class="org-comment-delimiter">;; </span><span class="org-comment">the above program is the definition of `query`</span>

<span class="org-kcats-brackets">[[[</span>book? subjects love<span class="org-kcats-brackets">]</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">[book? subjects subjects?]</span>
  <span class="org-kcats-brackets">[</span>book? title book-title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">first</span> author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">last</span>-name author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? sex m<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span>

  <span class="org-kcats-brackets">[</span>author? birth-year author-birth-year?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span>
 query
 database
<span class="org-kcats-brackets">]</span> let <span class="org-preprocessor">execute</span>  
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[</span>attribute subjects<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 0<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c0attribute"</span> subjects<span class="org-kcats-brackets">]</span>
                                                                        <span class="org-kcats-brackets">[</span><span class="org-string">":c0value"</span> love<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value love<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c0.attribute = :c0attribute"</span> <span class="org-string">"c0.value = :c0value"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute title<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 1<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>1 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c1attribute"</span> title<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value book-title?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c1.attribute = :c1attribute"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 2<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>2 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>2 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c2attribute"</span> author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c2.attribute = :c2attribute"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute author-<span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 3<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>3 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>3 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>3 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>2 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c3attribute"</span> author-<span class="org-function-name">first</span><span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c3.attribute = :c3attribute"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute <span class="org-function-name">first</span>-name<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 4<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>4 value<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>3 value<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c4attribute"</span> <span class="org-function-name">first</span>-name<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c4.attribute = :c4attribute"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute <span class="org-function-name">last</span>-name<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 5<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>5 value<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>2 value<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>5 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c5attribute"</span> <span class="org-function-name">last</span>-name<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c5.attribute = :c5attribute"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute sex<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 6<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>6 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>6 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c6attribute"</span> sex<span class="org-kcats-brackets">]</span>
                                                                        <span class="org-kcats-brackets">[</span><span class="org-string">":c6value"</span> m<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value m<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c6.attribute = :c6attribute"</span> <span class="org-string">"c6.value = :c6value"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute country<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 7<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>7 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>7 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>7 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>6 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c7attribute"</span> country<span class="org-kcats-brackets">]</span>
                                                                        <span class="org-kcats-brackets">[</span><span class="org-string">":c7value"</span> <span class="org-string">"United States"</span><span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c7.attribute = :c7attribute"</span> <span class="org-string">"c7.value = :c7value"</span><span class="org-kcats-brackets">]]]</span>
                                                              <span class="org-kcats-brackets">[[</span>attribute birth-year<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>index 8<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>8 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>6 entity<span class="org-kcats-brackets">]]</span>
                                                                    <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
                                                                     <span class="org-kcats-brackets">[</span>7 entity<span class="org-kcats-brackets">]]]]</span>
                                                               <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c8attribute"</span> birth-year<span class="org-kcats-brackets">]]]</span>
                                                               <span class="org-kcats-brackets">[</span>value author-birth-year?<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c8.attribute = :c8attribute"</span><span class="org-kcats-brackets">]]]]]</span>
<span class="org-kcats-brackets">[[[</span>book-title? <span class="org-kcats-brackets">[</span>value 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span>? <span class="org-kcats-brackets">[</span>value 3<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span>? <span class="org-kcats-brackets">[</span>value 2<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>author-birth-year? <span class="org-kcats-brackets">[</span>value 8<span class="org-kcats-brackets">]]]]</span>
<span class="org-kcats-brackets">[[[</span>author-birth-year 1896<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span> <span class="org-string">"F. Scott"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Fitzgerald"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book-title <span class="org-string">"The Great Gatsby"</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>selectkeys <span class="org-kcats-brackets">[</span>set <span class="org-kcats-brackets">[</span>*1 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> contains?<span class="org-kcats-brackets">]</span> pack <span class="org-function-name">filter</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]]</span>

<span class="org-kcats-brackets">[[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span>

 <span class="org-kcats-brackets">[[[</span>attribute subjects<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 0<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c0attribute"</span> subjects<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span><span class="org-string">":c0value"</span> love<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value love<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c0.value = :c0value"</span> <span class="org-string">"c0.attribute = :c0attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute title<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 1<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>1 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c1attribute"</span> title<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value book-title?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c1.attribute = :c1attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 2<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>2 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>2 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c2attribute"</span> author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c2.attribute = :c2attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute author-<span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 3<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>3 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>0 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>3 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>3 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>2 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c3attribute"</span> author-<span class="org-function-name">first</span><span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c3.attribute = :c3attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute <span class="org-function-name">first</span>-name<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 4<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>4 value<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>3 value<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c4attribute"</span> <span class="org-function-name">first</span>-name<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c4.attribute = :c4attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute <span class="org-function-name">last</span>-name<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 5<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>5 value<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>2 value<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>5 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c5attribute"</span> <span class="org-function-name">last</span>-name<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c5.attribute = :c5attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute sex<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 6<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>6 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>6 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c6attribute"</span> sex<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span><span class="org-string">":c6value"</span> m<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value m<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c6.value = :c6value"</span> <span class="org-string">"c6.attribute = :c6attribute"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute country<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 7<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>7 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>7 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>7 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>6 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c7attribute"</span> country<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span><span class="org-string">":c7value"</span> <span class="org-string">"United States"</span><span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c7.attribute = :c7attribute"</span> <span class="org-string">"c7.value = :c7value"</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[[</span>attribute birth-year<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>index 8<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>8 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>6 entity<span class="org-kcats-brackets">]]</span>
        <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>7 entity<span class="org-kcats-brackets">]]]]</span>
   <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c8attribute"</span> birth-year<span class="org-kcats-brackets">]]]</span>
   <span class="org-kcats-brackets">[</span>value author-birth-year?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c8.attribute = :c8attribute"</span><span class="org-kcats-brackets">]]]]</span>

  <span class="org-comment-delimiter">;; </span><span class="org-comment">look at data</span>
 
 <span class="org-kcats-brackets">[[[</span>slots selectkeys invert<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> selectkeys<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">get both the index and the values</span>
  <span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">join them together into one assoc</span>
 <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">each constraint row data</span>

let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>book? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 0<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>love value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>subjects attribute<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>book-title? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 1<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title attribute<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span> attribute<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span>? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 2<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> attribute<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span>? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 3<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span>? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span>-name attribute<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 4<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span>? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 5<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name attribute<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 6<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>m value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>sex attribute<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>country attribute<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 7<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-string">"United States"</span> value<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-birth-year? value<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? entity<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>birth-year attribute<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 8<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">  <span class="org-kcats-brackets">[[</span>attribute birth-year<span class="org-kcats-brackets">]</span>
       <span class="org-kcats-brackets">[</span>entity author?<span class="org-kcats-brackets">]</span>
       <span class="org-kcats-brackets">[</span>index 8<span class="org-kcats-brackets">]</span>
       <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>8 entity<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>4 entity<span class="org-kcats-brackets">]]</span>
            <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>5 entity<span class="org-kcats-brackets">]]</span>
            <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>6 entity<span class="org-kcats-brackets">]]</span>
            <span class="org-kcats-brackets">[[</span>8 entity<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>7 entity<span class="org-kcats-brackets">]]]]</span>
       <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c8attribute"</span> birth-year<span class="org-kcats-brackets">]]]</span>
       <span class="org-kcats-brackets">[</span>value author-birth-year?<span class="org-kcats-brackets">]</span>
       <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c8.attribute = :c8attribute"</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>entity attribute value<span class="org-kcats-brackets">]</span> set <span class="org-kcats-brackets">[</span>*1 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> contains?<span class="org-kcats-brackets">]</span> pack <span class="org-function-name">filter</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b<span class="org-kcats-brackets">]]</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>times5 <span class="org-kcats-brackets">[</span>5 *<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>6 times5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>draft dictionary <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>emit encode hashbytes<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-kcats-brackets">[[[</span>words<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
 <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>dictmerge<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>
<span class="org-builtin">float</span> <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
<span class="org-builtin">swapdown</span> <span class="org-kcats-brackets">[</span>modules<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> update
<span class="org-kcats-brackets">[</span>dictionary program<span class="org-kcats-brackets">]</span> label environment
<span class="org-comment-delimiter">;; </span><span class="org-comment">TODO try using confine here</span>
<span class="org-kcats-brackets">[</span>*1 capture evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> pack <span class="org-preprocessor">execute</span>
</pre>
</div>

<p>
Test that putting the db query builder into a builtin module works
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book? subjects love<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span>? title?<span class="org-kcats-brackets">]</span> query

database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Fitzgerald"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Great Gatsby"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Austen"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"Pride and Prejudice"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Tolstoy"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"War and Peace"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Bronte"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"Jane Eyre"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span> <span class="org-string">"Dickens"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"A Tale of Two Cities"</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>


<p>
We need to rewrite the link-finding logic so that it does everything in one pass
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>variable? <span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span>string <span class="org-function-name">last</span> \? =<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>linked-line? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> set <span class="org-builtin">swap</span> contains?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>index-&gt;slot <span class="org-kcats-brackets">[</span>slots indexed<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[</span>book? subjects love<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">first</span> author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">last</span>-name author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? sex f<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? birth-year birth-year?<span class="org-kcats-brackets">]]</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">add indices to the constraint rows and internal items</span>
 <span class="org-kcats-brackets">[</span>indexed
  <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>indexed<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">pull in the row number into each cell</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> prepend <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> pair<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">catenate</span>
  <span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">filter out non variables</span>
 <span class="org-comment-delimiter">; </span><span class="org-comment">[second variable?] filter</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-function-name">wrap</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> prepend update<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">anything with only 1 entry is not a link</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">[second count 1 &gt;] filter association</span>
  <span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">now group by relevant line</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> 0 <span class="org-builtin">swap</span> 1 range <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>linked-line?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">]</span>
let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>love <span class="org-kcats-brackets">[[</span>0 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>book? <span class="org-kcats-brackets">[[</span>0 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>2 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>3 0<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[[</span>0 1<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>book? <span class="org-kcats-brackets">[[</span>0 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>2 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>3 0<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>title? <span class="org-kcats-brackets">[[</span>1 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-kcats-brackets">[[</span>1 1<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span>? <span class="org-kcats-brackets">[[</span>2 2<span class="org-kcats-brackets">]</span>
                 <span class="org-kcats-brackets">[</span>5 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-kcats-brackets">[[</span>2 1<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>book? <span class="org-kcats-brackets">[[</span>0 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>2 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>3 0<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>book? <span class="org-kcats-brackets">[[</span>0 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>2 0<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>3 0<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span>? <span class="org-kcats-brackets">[[</span>3 2<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[</span>4 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span> <span class="org-kcats-brackets">[[</span>3 1<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>author? <span class="org-kcats-brackets">[[</span>4 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>5 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>6 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>7 0<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span>? <span class="org-kcats-brackets">[[</span>3 2<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[</span>4 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span>-name <span class="org-kcats-brackets">[[</span>4 1<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">last</span>? <span class="org-kcats-brackets">[[</span>2 2<span class="org-kcats-brackets">]</span>
                 <span class="org-kcats-brackets">[</span>5 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-kcats-brackets">[[</span>5 1<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-kcats-brackets">[[</span>4 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>5 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>6 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>7 0<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>f <span class="org-kcats-brackets">[[</span>6 2<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>sex <span class="org-kcats-brackets">[[</span>6 1<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-kcats-brackets">[[</span>4 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>5 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>6 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>7 0<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>author? <span class="org-kcats-brackets">[[</span>4 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>5 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>6 0<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>7 0<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>birth-year <span class="org-kcats-brackets">[[</span>7 1<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>birth-year? <span class="org-kcats-brackets">[[</span>7 2<span class="org-kcats-brackets">]]]]]</span>
<span class="org-kcats-brackets">[[</span>author-<span class="org-function-name">first</span> <span class="org-kcats-brackets">[[</span>3 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">first</span>? <span class="org-kcats-brackets">[[</span>3 2<span class="org-kcats-brackets">]</span>
                 <span class="org-kcats-brackets">[</span>4 2<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span> <span class="org-kcats-brackets">[[</span>2 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>author-<span class="org-function-name">last</span>? <span class="org-kcats-brackets">[[</span>2 2<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[</span>5 2<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>author? <span class="org-kcats-brackets">[[</span>4 0<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>5 0<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>6 0<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>7 0<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>birth-year <span class="org-kcats-brackets">[[</span>7 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>birth-year? <span class="org-kcats-brackets">[[</span>7 2<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>book? <span class="org-kcats-brackets">[[</span>0 0<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>2 0<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[</span>3 0<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>f <span class="org-kcats-brackets">[[</span>6 2<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span>-name <span class="org-kcats-brackets">[[</span>4 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span>-name <span class="org-kcats-brackets">[[</span>5 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>love <span class="org-kcats-brackets">[[</span>0 2<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>sex <span class="org-kcats-brackets">[[</span>6 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>subjects <span class="org-kcats-brackets">[[</span>0 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>title <span class="org-kcats-brackets">[[</span>1 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>title? <span class="org-kcats-brackets">[[</span>1 2<span class="org-kcats-brackets">]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>variable? <span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span>string <span class="org-function-name">last</span> \? =<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>linked-line? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> set <span class="org-builtin">swap</span> contains?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>index-&gt;slot <span class="org-kcats-brackets">[</span>slots indexed<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[</span>book? subjects love<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">first</span> author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">last</span>-name author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? sex f<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? birth-year birth-year?<span class="org-kcats-brackets">]]</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">add indices to the constraint rows and internal items</span>
 <span class="org-kcats-brackets">[</span>indexed
  <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>indexed<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">pull in the row number into each cell</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> prepend <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> pair<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">catenate</span>
  <span class="org-kcats-brackets">[</span>joiner<span class="org-kcats-brackets">]</span> assemble <span class="org-function-name">unwrap</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">filter out non variables</span>
 <span class="org-comment-delimiter">; </span><span class="org-comment">[second variable?] filter</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-function-name">wrap</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> prepend update<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">anything with only 1 entry is not a link</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">[second count 1 &gt;] filter association</span>
  <span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">now group by relevant line</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span> 0 <span class="org-builtin">swap</span> 1 range <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>linked-line?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-kcats-brackets">]</span>
let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"SELECT c2.value as title, c3.value as author from EAV as c1</span>
<span class="org-string">JOIN EAV c2 ON c2.attribute = :c2attribute</span>
<span class="org-string">   AND c1.entity = c2.entity</span>
<span class="org-string">JOIN EAV c3 ON c3.attribute = :c3attribute</span>
<span class="org-string">   AND c2.entity = c3.entity AND c1.entity = c3.entity</span>
<span class="org-string">WHERE c1.attribute = :c1attribute AND c1.value = :c1value"</span>
<span class="org-kcats-brackets">[[</span><span class="org-string">":c1value"</span> adventure<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-string">":c2attribute"</span> title<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-string">":c1attribute"</span> subjects<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-string">":c3attribute"</span> author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]]</span>
database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>author <span class="org-string">"Tolkien"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>title <span class="org-string">"The Lord of the Rings"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>title <span class="org-string">"Adventures of Huckleberry Finn"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author <span class="org-string">"Twain"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[[</span>title <span class="org-string">"Don Quixote"</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author <span class="org-string">"Cervantes"</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"SELECT COUNT(*)</span>
<span class="org-string">FROM EAV </span>
<span class="org-string">WHERE value = 's|Don Quixote'"</span>
<span class="org-kcats-brackets">[]</span> database
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>COUNT(*) 1<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b c<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c d e<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>e f g<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span>
</pre>
</div>
<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a c e<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>b d f<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>book? subjects adventure<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>book? title title?<span class="org-kcats-brackets">]]</span> indexed
<span class="org-kcats-brackets">[[]</span> <span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>

<span class="org-kcats-brackets">[[</span>c0.entity c0.attribute c0.value<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>entity book?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>attribute subjects<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 1<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c1attribute"</span> subjects<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span><span class="org-string">":c1value"</span> adventure<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[]]</span>
  <span class="org-kcats-brackets">[</span>value adventure<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c1.attribute = :c1attribute"</span> <span class="org-string">"c1.value = :c1value"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>value title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>attribute title<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c2.attribute = :c2attribute"</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>2 entity<span class="org-kcats-brackets">]</span>
        <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]]]</span>
  <span class="org-kcats-brackets">[</span>index 2<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c2attribute"</span> title<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>params <span class="org-kcats-brackets">[[</span><span class="org-string">":c3attribute"</span> author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>entity book?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>index 3<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>attribute author-<span class="org-function-name">last</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>on <span class="org-kcats-brackets">[[[</span>3 entity<span class="org-kcats-brackets">]</span>
        <span class="org-kcats-brackets">[</span>2 entity<span class="org-kcats-brackets">]]</span>
       <span class="org-kcats-brackets">[[</span>3 entity<span class="org-kcats-brackets">]</span>
        <span class="org-kcats-brackets">[</span>1 entity<span class="org-kcats-brackets">]]]]</span>
  <span class="org-kcats-brackets">[</span>value author?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>where <span class="org-kcats-brackets">[</span><span class="org-string">"c3.attribute = :c3attribute"</span><span class="org-kcats-brackets">]]]]</span>

<span class="org-kcats-brackets">[</span>title? author?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>selectkeys <span class="org-kcats-brackets">[</span>set <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> contains?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>wordval? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> word?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>validate <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> not<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-string">"All selected query variables must appear somewhere in constraints"</span>
              <span class="org-kcats-brackets">[</span>reason variable<span class="org-kcats-brackets">]</span> label fail<span class="org-kcats-brackets">]</span>
             when<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>entity attribute value<span class="org-kcats-brackets">]</span> selectkeys invert<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span>wordval?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">join</span> association<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make a list of the variable and 'index'</span>
        <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>selectkeys<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make the program to cut down</span>
        <span class="org-function-name">map</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span> 2 =<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> number?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> when
       <span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> dropdeep zip validate<span class="org-kcats-brackets">]</span>
draft
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>title? <span class="org-kcats-brackets">[</span>value 2<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>author? <span class="org-kcats-brackets">[</span>value 3<span class="org-kcats-brackets">]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8e45118" class="outline-4">
<h4 id="org8e45118"><span class="section-number-4">2.25.4.</span> Tests database module</h4>
<div class="outline-text-4" id="text-2-25-4">
<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span>debug-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>decache inscribe<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span> 
<span class="org-kcats-brackets">[</span>database debug-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span>

<span class="org-kcats-brackets">[[[</span>book? title title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author author?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>title? author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span> query<span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span>program dictionary<span class="org-kcats-brackets">]</span> label environment <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">lm env</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[[stack] [snapshot] divedown assign] dip ;; capture the stack at runtime</span>

using <span class="org-comment-delimiter">;; </span><span class="org-comment">set up the resolver </span>
eval-<span class="org-function-name">step</span> eval-<span class="org-function-name">step</span> eval-<span class="org-function-name">step</span> eval-<span class="org-function-name">step</span> advance advance advance <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the program in the inner environment</span>
advance 
<span class="org-comment-delimiter">;</span><span class="org-comment">evaluate</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[stack] lookup restore ;; replace the stack with the result from the inner env</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"qyKhcjHmD5kJNFA6/M0EkQOrh/j2zANmwrQFL1T1w7A="</span> #b64 <span class="org-string">"BD6O7rckGISnnk+5AXZaa3/2qY/72dX3O68AED3pG64="</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>constraint<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> indexed-as-property triangle <span class="org-kcats-brackets">[</span>extract-data<span class="org-kcats-brackets">]</span>
                    <span class="org-function-name">map</span> <span class="org-kcats-brackets">[[</span>extract-params<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>make-query<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>make-where<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> select-data<span class="org-kcats-brackets">]]</span> fork <span class="org-builtin">dropdown</span>
                    <span class="org-function-name">unwrap</span> <span class="org-builtin">float</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                    <span class="org-function-name">map</span> <span class="org-builtin">swap</span> format-select <span class="org-kcats-brackets">[</span><span class="org-string">" "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> triplet
                    <span class="org-function-name">reverse</span> <span class="org-string">"SELECT {0} from EAV as c0 {1} WHERE {2}"</span> <span class="org-builtin">swap</span> format <span class="org-builtin">swap</span> dropdeep<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[</span>#b64 <span class="org-string">"nBeUBXUEzoR2f1PRlrc9UaOCrtcrgU+Bfkz87TTApQ0="</span><span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span>title? author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[[</span>book? title title?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? author author?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
                   <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]]]]]</span>
         <span class="org-kcats-brackets">[</span>title? author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
         <span class="org-kcats-brackets">[[</span>book? title title?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? author author?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]]]]]</span>
</pre>
</div>

<p>
Debug what's wrong with inner evaluate
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 +<span class="org-kcats-brackets">]</span> stage <span class="org-kcats-brackets">[</span>finished? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
write unnest-envs, so we can execute nested envs serially
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>2<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> stage
<span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span>
<span class="org-kcats-brackets">[</span>environment? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[[</span>stack <span class="org-function-name">first</span><span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">recur</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>environment?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>environment? not <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                              <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                                         <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                                                    <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]]</span>
                                                    <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                                                    <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
                                                   2<span class="org-kcats-brackets">]]</span>
                                         <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                                         <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
                                        1<span class="org-kcats-brackets">]]</span>
                              <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                              <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
                             <span class="org-kcats-brackets">[]]</span>
           <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>stack <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                           <span class="org-kcats-brackets">[[</span>environment? not<span class="org-kcats-brackets">]</span>
                            <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span>stack <span class="org-function-name">first</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">]</span>
                           <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
           <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]]</span>
                       <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                       <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
                      2<span class="org-kcats-brackets">]]</span>
            <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
            <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
           1<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1664184" class="outline-3">
<h3 id="org1664184"><span class="section-number-3">2.26.</span> <span class="todo TODO">TODO</span> Reduce CPU cost of `shield`&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></h3>
<div class="outline-text-3" id="text-2-26">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>1 2 3 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]]]</span> environment stepper 0 <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> inc<span class="org-kcats-brackets">]</span> cram
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">25 <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>1 2 3 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-comment-delimiter">; </span><span class="org-comment">[restore] dip dropdown</span>
           <span class="org-comment-delimiter">;</span><span class="org-comment">first take drop swap prepend restore ; take clonedown dip</span>
           <span class="org-kcats-brackets">]]]</span> environment
stepper collect
<span class="org-comment-delimiter">;</span><span class="org-comment">0 [drop inc] cram</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>program <span class="org-kcats-brackets">[</span>2 3 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>2 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>3 2 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span> <span class="org-function-name">unwrap</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>3 2 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>+ <span class="org-kcats-brackets">[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span> <span class="org-function-name">unwrap</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>5 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span> <span class="org-function-name">unwrap</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]]</span> 5 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]]</span> 5 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>program <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]</span> 5 1<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>5 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 2 1<span class="org-kcats-brackets">]</span> 1<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[]]]]</span>
<span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd762b82" class="outline-3">
<h3 id="orgd762b82"><span class="section-number-3">2.27.</span> <span class="todo TODO">TODO</span> Sort out feature dependencies</h3>
<div class="outline-text-3" id="text-2-27">
<div class="org-src-container">
<pre class="src src-dot">digraph G {
    // Define nodes
    core [label="Core words", style=filled, fillcolor=lightgreen, shape=rect];
    pipes [label="I/O pipes", style=filled, fillcolor=lightgreen, shape=rect];
    generators [label="Generators", style=filled, fillcolor=lightgreen, shape=rect];
    debug [label="Debugger", style=filled, fillcolor=lightgreen, shape=rect];
    crypto [label="Cryptography", style=filled, fillcolor=yellow, shape=rect];
    auth [label="Authentication Scripting", style=filled, fillcolor=yellow, shape=rect];
    localmod [label="Local Modules", style=filled, fillcolor=yellow, shape=rect];
    remotemod [label="Remote Modules"];
    revocation [label="Revocation Lists"];
    db [label="Persistent Database", style=filled, fillcolor=yellow, shape=rect];
    storage [label="Storage", fillcolor=lightgreen];
    cache [label="Hash-keyed blob cache", style=filled, fillcolow=yellow, shape=rect];
    streams [label="Content streams"];
    payments [label="Payments BTC"];
    contacts [label="Address Book"];
    messaging [label="Messaging"];
    backup [label="Data backup"];
    keys [label="Encryption Key management"];
    peers [label="Peer discovery"];
    names [label="Naming"];

    // Define edges to represent dependencies
    pipes -&gt; core; 
    generators -&gt; core;
    debug -&gt; core;
    crypto -&gt; core;
    localmod -&gt; core;
    localmod -&gt; cache;
    localmod -&gt; names;
    cache -&gt; core;
    cache -&gt; storage;
    auth -&gt; crypto;
    auth -&gt; revocation;
    remotemod -&gt; localmod;
    remotemod -&gt; auth;
    revocation -&gt; db;
    db -&gt; core;
    db -&gt; localmod;
    db -&gt; pipes;
    db -&gt; storage;

    // Application level
    messaging -&gt; contacts;
    contacts -&gt; auth;
    contacts -&gt; db;
    messaging -&gt; db;
    messaging -&gt; streams;
    streams -&gt; db;
    streams -&gt; names;
    streams -&gt; peers;
    peers -&gt; crypto;
    streams -&gt; pipes;
    streams -&gt; keys;
    //remotemod -&gt; streams;
    keys -&gt; db;
    contacts -&gt; streams;
    revocation -&gt; streams;
    backup -&gt; streams;
    backup -&gt; payments;
    names -&gt; storage;
    names -&gt; crypto;

}
</pre>
</div>
</div>
</div>
<div id="outline-container-org7427fb8" class="outline-3">
<h3 id="org7427fb8"><span class="section-number-3">2.28.</span> <span class="todo TODO">TODO</span> Improved error messages&#xa0;&#xa0;&#xa0;<span class="tag"><span class="errorHandling">errorHandling</span></span></h3>
<div class="outline-text-3" id="text-2-28">
</div>
<div id="outline-container-org7a3a533" class="outline-4">
<h4 id="org7a3a533"><span class="section-number-4">2.28.1.</span> <span class="todo TODO">TODO</span> Source mapping&#xa0;&#xa0;&#xa0;<span class="tag"><span class="debugging">debugging</span>&#xa0;<span class="errorHandling">errorHandling</span></span></h4>
<div class="outline-text-4" id="text-2-28-1">
<p>
It would be nice if we could tell which file any given word was read
from. We could do this at read time, but i don't think our edn parser
remembers byte positions, so that might need modification.
</p>
</div>
</div>
<div id="outline-container-org7d6983e" class="outline-4">
<h4 id="org7d6983e"><span class="section-number-4">2.28.2.</span> <span class="todo TODO">TODO</span> Causal chaining</h4>
<div class="outline-text-4" id="text-2-28-2">
<p>
Like java exceptions, we'd like to be able to say what other error
caused this one. Then the chain would go from the most general to the
most specific, eg "could not load library", "could not open file",
"permission denied".
</p>

<p>
The unwound field could be shortened too, to just whatever is extra,
similar to java's eliding of common stack elements in chained
exceptions.
</p>
</div>
</div>
</div>
<div id="outline-container-orga4b348c" class="outline-3">
<h3 id="orga4b348c"><span class="section-number-3">2.29.</span> <span class="todo INPROGRESS">INPROGRESS</span> Generate word dependency graph</h3>
<div class="outline-text-3" id="text-2-29">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-08-08 Thu 15:39]</span></span></li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats">dictionary

<span class="org-comment-delimiter">;; </span><span class="org-comment">nodes</span>
<span class="org-kcats-brackets">[[[</span><span class="org-function-name">first</span> string <span class="org-function-name">wrap</span> <span class="org-string">"\"{}\";\n"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
  <span class="org-string">""</span> <span class="org-builtin">swap</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">now do edges</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">only non-builtins (not sure this works)</span>
  <span class="org-kcats-brackets">[[</span>1 definition<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[[</span>list?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> keep
  <span class="org-comment-delimiter">;; </span><span class="org-comment">throw away everthing but the definition</span>
  <span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>definition<span class="org-kcats-brackets">]</span> lookup
        <span class="org-comment-delimiter">;; </span><span class="org-comment">reduce to a set of words</span>
        <span class="org-kcats-brackets">[]</span> set <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>word?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">]</span>
   update<span class="org-kcats-brackets">]</span> each
  <span class="org-comment-delimiter">;</span><span class="org-comment">10 taker ; collect ;; remove this to process the whole dict</span>
  <span class="org-comment-delimiter">;; </span><span class="org-comment">expand to an edge for each pair</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">second</span> not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> generate<span class="org-kcats-brackets">]</span> when
      <span class="org-comment-delimiter">;; </span><span class="org-comment">extract a pair</span>
      <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span>
      <span class="org-kcats-brackets">[</span><span class="org-function-name">pop</span> <span class="org-function-name">pop</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> pair <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
      when<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the 2nd item in the pair isn't empty </span>
  <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-string">"\"{}\" -&gt; \"{}\";\n"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]</span> each 
  joiner generate<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-string">"digraph G { {} {} }"</span> <span class="org-builtin">swap</span> format
<span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/graph4.dot"</span><span class="org-kcats-brackets">]]</span> pipe-in <span class="org-builtin">swap</span> encode <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>to <span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/graph4.dot"</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>type tunnel<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>values <span class="org-kcats-brackets">[[</span>type bytes<span class="org-kcats-brackets">]]]]</span>
dictionary_redacted
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">walk the definition to extract words</span>
<span class="org-kcats-brackets">[[</span>not<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-kcats-brackets">[</span>something?<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> pair <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
       <span class="org-function-name">join</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> generate<span class="org-kcats-brackets">]</span>
                    <span class="org-preprocessor">while</span><span class="org-kcats-brackets">]</span>
             <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[]</span> set <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">dive</span> <span class="org-builtin">drop</span> every? <span class="org-preprocessor">execute</span> generate <span class="org-function-name">join</span> not pair something? <span class="org-builtin">swap</span> <span class="org-preprocessor">while</span>
 <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
Extract one item from inner
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo <span class="org-kcats-brackets">[]]</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">pop pop [[first] divedown] shield swap pair [put] dip</span>

<span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span><span class="org-function-name">pop</span> <span class="org-function-name">pop</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> pair <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>
    when <span class="org-comment-delimiter">;; </span><span class="org-comment">the 2nd item in the pair isn't empty</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo <span class="org-kcats-brackets">[]]</span>
</pre>
</div>

<p>
The resulting graph is very hard to read.
</p>
</div>
</div>
<div id="outline-container-org58396d8" class="outline-3">
<h3 id="org58396d8"><span class="section-number-3">2.30.</span> <span class="todo INPROGRESS">INPROGRESS</span> Let doesn't inherit the current resolver</h3>
<div class="outline-text-3" id="text-2-30">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-08-04 Sun 09:33]</span></span></li>
</ul>
<p>
We need to capture the resolver like we do with the dictionary and
append to it. This is probably a code smell that says the resolver
should be part of the dictionary. Just bite the bullet and make the
dictionary a struct.
</p>

<p>
<code>using</code> now does capture the current resolver and extends it in the
front. Needs testing, I suspect the ordering might be a bit buggy.
</p>

<p>
As for sandboxing I think the solution was we have to actually remove
words we mean to make inaccessible so resolution order doesn't really
matter anymore.  In fact we may be able to ignore deleted words in the
merging of dictionaries. Removing words might not be a viable feature
of modules.
</p>
</div>
</div>
<div id="outline-container-orgdab592a" class="outline-3">
<h3 id="orgdab592a"><span class="section-number-3">2.31.</span> <span class="done DONE">DONE</span> Make templating a rust function</h3>
<div class="outline-text-3" id="text-2-31">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-08-08 Thu 15:37]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-08-08 Thu 15:36]</span></span></li>
</ul>
<p>
Templating is important enough to make it a rust function. No kcats
programs need to be called during the execution of templating so I
think it's easily done in rust. Then that solves the chicken/egg
problem where other stuff depends on template but template depends on
it. 
</p>
</div>
</div>
<div id="outline-container-org13e5763" class="outline-3">
<h3 id="org13e5763"><span class="section-number-3">2.32.</span> <span class="todo INPROGRESS">INPROGRESS</span> Add description to each example&#xa0;&#xa0;&#xa0;<span class="tag"><span class="testing">testing</span></span></h3>
<div class="outline-text-3" id="text-2-32">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-10-03 Thu 19:20]</span></span></li>
</ul>
</div>
</div>
<div id="outline-container-orgdd47502" class="outline-3">
<h3 id="orgdd47502"><span class="section-number-3">2.33.</span> <span class="todo TODO">TODO</span> Add integration tests&#xa0;&#xa0;&#xa0;<span class="tag"><span class="testing">testing</span></span></h3>
</div>
<div id="outline-container-org4322269" class="outline-3">
<h3 id="org4322269"><span class="section-number-3">2.34.</span> <span class="todo TODO">TODO</span> Size of option enums</h3>
<div class="outline-text-3" id="text-2-34">
<div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-constant">std</span>::mem;
<span class="org-keyword">extern</span> <span class="org-keyword">crate</span> internment;
<span class="org-keyword">use</span> <span class="org-constant">internment</span>::<span class="org-type">Intern</span>;

<span class="org-keyword">fn</span> <span class="org-function-name">main</span>() {
    <span class="org-comment-delimiter">// </span><span class="org-comment">Let's suppose this is our large type</span>
    <span class="org-keyword">struct</span> <span class="org-type">MyLargeType</span>(<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;);

    <span class="org-comment-delimiter">// </span><span class="org-comment">Using Intern to intern Vec&lt;u8&gt;</span>
    <span class="org-keyword">type</span> <span class="org-type">InternedLargeType</span> = <span class="org-type">Intern</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;&gt;;

    <span class="org-comment-delimiter">// </span><span class="org-comment">Size of Intern&lt;Vec&lt;u8&gt;&gt;</span>
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Size of Intern&lt;Vec&lt;u8&gt;&gt;: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-constant">mem</span>::size_of::&lt;<span class="org-type">Intern</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;&gt;&gt;());

    <span class="org-comment-delimiter">// </span><span class="org-comment">Size of Option&lt;Intern&lt;Vec&lt;u8&gt;&gt;&gt;</span>
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Size of Option&lt;Intern&lt;Vec&lt;u8&gt;&gt;&gt;: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-constant">mem</span>::size_of::&lt;<span class="org-type">Option</span>&lt;<span class="org-type">Intern</span>&lt;<span class="org-type">Vec</span>&lt;<span class="org-type">u8</span>&gt;&gt;&gt;&gt;());

    <span class="org-comment-delimiter">// </span><span class="org-comment">Example using MyLargeType with Intern</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">interned_value</span>: <span class="org-type">InternedLargeType</span> = <span class="org-type">Intern</span>::new(<span class="org-preprocessor">vec!</span>[0; 32]);
    <span class="org-keyword">let</span> <span class="org-variable-name">instance_with_intern</span> = <span class="org-type">Option</span>::<span class="org-type">Some</span>(interned_value);
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Size of instance_with_intern: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-constant">mem</span>::size_of_val(<span class="org-rust-ampersand">&amp;</span>instance_with_intern));

    <span class="org-comment-delimiter">// </span><span class="org-comment">Another way to illustrate</span>
    <span class="org-keyword">let</span> <span class="org-variable-name">interned_value_none</span>: <span class="org-type">Option</span>&lt;<span class="org-type">InternedLargeType</span>&gt; = <span class="org-type">Option</span>::<span class="org-type">None</span>;
    <span class="org-keyword">let</span> <span class="org-variable-name">interned_value_some</span>: <span class="org-type">Option</span>&lt;<span class="org-type">InternedLargeType</span>&gt; = <span class="org-type">Option</span>::<span class="org-type">Some</span>(<span class="org-type">Intern</span>::new(<span class="org-preprocessor">vec!</span>[0; 32]));

    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Size of interned_value_none: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-constant">mem</span>::size_of_val(<span class="org-rust-ampersand">&amp;</span>interned_value_none));
    <span class="org-rust-builtin-formatting-macro">println!</span>(<span class="org-string">"Size of interned_value_some: </span><span class="org-rust-string-interpolation">{}</span><span class="org-string">"</span>, <span class="org-constant">mem</span>::size_of_val(<span class="org-rust-ampersand">&amp;</span>interned_value_some));
}
</pre>
</div>

<pre class="example">
Size of Intern&lt;Vec&lt;u8&gt;&gt;: 8
Size of Option&lt;Intern&lt;Vec&lt;u8&gt;&gt;&gt;: 8
Size of instance_with_intern: 8
Size of interned_value_none: 8
Size of interned_value_some: 8
</pre>
</div>
</div>
<div id="outline-container-org832d852" class="outline-3">
<h3 id="org832d852"><span class="section-number-3">2.35.</span> <span class="todo TODO">TODO</span> Support converting Association to Set</h3>
<div class="outline-text-3" id="text-2-35">
<p>
This should probably return a set of keys, but the issue is the way
Derive works, we can't choose a different conversion based on the
final type we want. So we end up with a list of pairs because the
first step in the conversion is to a Iterator&lt;Entry&gt;. Until this is
fixed we'll comment out the relevant test in the word <code>intersection</code>
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[</span>a b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c d<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>e f<span class="org-kcats-brackets">]]</span> association
  <span class="org-kcats-brackets">[[</span>c x<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>e y<span class="org-kcats-brackets">]]</span> association intersection<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>c e<span class="org-kcats-brackets">]</span> set<span class="org-kcats-brackets">]</span> <span class="org-string">"Intersection of two associations expressed as set of common keys"</span><span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6e24e11" class="outline-3">
<h3 id="org6e24e11"><span class="section-number-3">2.36.</span> <span class="todo INPROGRESS">INPROGRESS</span> Debug nested envs</h3>
<div class="outline-text-3" id="text-2-36">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-09-08 Sun 10:36]</span></span></li>
</ul>
<p>
The problem is if we have this
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 +<span class="org-kcats-brackets">]</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>program stack<span class="org-kcats-brackets">]</span> label environment
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>program stack<span class="org-kcats-brackets">]</span> label environment
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
          <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                   <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>1 2 +<span class="org-kcats-brackets">]]</span>
                   <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                   <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[]]]]]]]]]</span>
</pre>
</div>

<p>
How do we step through the execution? I think perhaps we need to do this:
</p>

<p>
Let's say we want to <code>eval-step</code>. The ToS is an env (or eval-step would
fail anyway). If <b>that</b> env is executing <code>evaluate</code> we recur down the envs
until we hit one that's not, and run eval-step there.
</p>

<p>
The question is, do we have to unnest everything and then re-nest?
</p>

<p>
I think we can just build a path to pass to update. And then afterward
recur again to drop evaluate from programs that are already done.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">Make the nested envs</span>
<span class="org-kcats-brackets">[</span>1 2 +<span class="org-kcats-brackets">]</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>program stack<span class="org-kcats-brackets">]</span> label environment
<span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>program stack<span class="org-kcats-brackets">]</span> label environment
<span class="org-comment-delimiter">;; </span><span class="org-comment">stepping program</span>
<span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[[</span>evaluating? <span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]</span> starts?<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[]</span> <span class="org-builtin">swap</span>
  <span class="org-kcats-brackets">[[</span>evaluating?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[[</span>stack 0<span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">append the next part of the path to the accumulator</span>
   <span class="org-preprocessor">while</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> dropdeep<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">under the stepping prog</span>
 <span class="org-kcats-brackets">[</span>update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> flip <span class="org-builtin">drop</span>

 <span class="org-kcats-brackets">[</span>0 -2 slice <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddeep</span> 
 <span class="org-kcats-brackets">[[[[[</span>evaluating?<span class="org-kcats-brackets">]</span>
     <span class="org-kcats-brackets">[[</span>stack 0<span class="org-kcats-brackets">]</span> lookup finished?<span class="org-kcats-brackets">]]</span>
    <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[[</span>program<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span><span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span>
   when<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> flip <span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
 <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
let <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>evaluate<span class="org-kcats-brackets">]]</span>
          <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
          <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
                   <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]</span>
                   <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
                   <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]]]]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">5 <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual 5<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>program<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]]]</span>
5
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 +<span class="org-kcats-brackets">]</span> stage <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> update
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>dictionary dictionary_redacted<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>program <span class="org-kcats-brackets">[</span>2 +<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>resolver <span class="org-kcats-brackets">[]]</span>
  <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-kcats-brackets">[</span>3 4 <span class="org-kcats-brackets">[</span>5 6 <span class="org-kcats-brackets">[</span>7 8<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[</span>2 2 0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> update
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-kcats-brackets">[</span>3 4 <span class="org-kcats-brackets">[</span>6 6 <span class="org-kcats-brackets">[</span>7 8<span class="org-kcats-brackets">]]]]</span>
</pre>
</div>
</div>
<div id="outline-container-org61af6e1" class="outline-4">
<h4 id="org61af6e1"><span class="section-number-4">2.36.1.</span> <span class="done DONE">DONE</span> write environment? word</h4>
<div class="outline-text-4" id="text-2-36-1">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-09-08 Sun 11:21]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-09-08 Sun 10:37]</span></span></li>
</ul>
<p>
Will be an axiom word.
</p>
</div>
</div>
</div>
<div id="outline-container-org9ef94be" class="outline-3">
<h3 id="org9ef94be"><span class="section-number-3">2.37.</span> <span class="todo INPROGRESS">INPROGRESS</span> Emoji</h3>
<div class="outline-text-3" id="text-2-37">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-04 Wed 20:16]</span></span></li>
</ul>
</div>
<div id="outline-container-org0499c21" class="outline-4">
<h4 id="org0499c21"><span class="section-number-4">2.37.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Choose emoji aliases for combinators</h4>
<div class="outline-text-4" id="text-2-37-1">
<ul class="org-ul">
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-09 Sat 22:03]</span></span>
</p>

<p>
Choices:
</p></li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">execute</td>
<td class="org-left">▶️</td>
</tr>

<tr>
<td class="org-left">loop</td>
<td class="org-left">🌀 ♾</td>
</tr>

<tr>
<td class="org-left">dive</td>
<td class="org-left">🐋</td>
</tr>

<tr>
<td class="org-left">down</td>
<td class="org-left">⬇️</td>
</tr>

<tr>
<td class="org-left">inject</td>
<td class="org-left">💉</td>
</tr>

<tr>
<td class="org-left">dip</td>
<td class="org-left">🍲🪄</td>
</tr>

<tr>
<td class="org-left">every?</td>
<td class="org-left">💯</td>
</tr>

<tr>
<td class="org-left">any?</td>
<td class="org-left">💢📣</td>
</tr>

<tr>
<td class="org-left">map</td>
<td class="org-left">🚜</td>
</tr>

<tr>
<td class="org-left">shield</td>
<td class="org-left">🛡️</td>
</tr>

<tr>
<td class="org-left">decorate</td>
<td class="org-left">🎀</td>
</tr>

<tr>
<td class="org-left">if</td>
<td class="org-left">⚖️</td>
</tr>

<tr>
<td class="org-left">while</td>
<td class="org-left">⏳🕐</td>
</tr>

<tr>
<td class="org-left">filter</td>
<td class="org-left">🧲</td>
</tr>

<tr>
<td class="org-left">recur</td>
<td class="org-left">🪆</td>
</tr>

<tr>
<td class="org-left">clone</td>
<td class="org-left">👥</td>
</tr>

<tr>
<td class="org-left">swap</td>
<td class="org-left">🔀</td>
</tr>

<tr>
<td class="org-left">drop</td>
<td class="org-left">🗑️</td>
</tr>

<tr>
<td class="org-left">take</td>
<td class="org-left">📤</td>
</tr>

<tr>
<td class="org-left">put</td>
<td class="org-left">📮</td>
</tr>

<tr>
<td class="org-left">join</td>
<td class="org-left">🔗</td>
</tr>

<tr>
<td class="org-left">step</td>
<td class="org-left">🪜</td>
</tr>

<tr>
<td class="org-left">unwrap</td>
<td class="org-left">🍫</td>
</tr>

<tr>
<td class="org-left">wrap</td>
<td class="org-left">🎁</td>
</tr>

<tr>
<td class="org-left">sink</td>
<td class="org-left">⚓</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">🛟</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgd3ea916" class="outline-4">
<h4 id="orgd3ea916"><span class="section-number-4">2.37.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Automatic conversion of english -&gt; emoji</h4>
<div class="outline-text-4" id="text-2-37-2">
<ul class="org-ul">
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-11 Mon 08:21]</span></span>
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Module to operate on generic data, that are used throughout</span>
<span class="org-kcats-brackets">[[</span>fork <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>triangle <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">sink</span> <span class="org-builtin">swap</span> pair<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> collect<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>indexed-as-property <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> indexed
                       <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">sink</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span>-all <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span> empty<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>selectkeys <span class="org-kcats-brackets">[</span>set <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> contains?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">datalog variables</span>
 <span class="org-kcats-brackets">[</span>variable? <span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span>string <span class="org-function-name">last</span> \? =<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>variable= <span class="org-kcats-brackets">[[[</span>pair <span class="org-kcats-brackets">[</span>variable?<span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>=<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">datalog constraints</span>
 <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>slot-combos <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>constraint <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> slots <span class="org-function-name">reverse</span> label<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">links between datalog constraints</span>
 <span class="org-kcats-brackets">[</span>links <span class="org-kcats-brackets">[</span>slot-combos
         <span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swapdown</span> 
          <span class="org-kcats-brackets">[[[</span>lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span><span class="org-kcats-brackets">]</span> both<span class="org-kcats-brackets">]</span> pairwise 
          variable=<span class="org-kcats-brackets">]</span>
         <span class="org-function-name">filter</span>    
         <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> pair <span class="org-builtin">sink</span> pair
          <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">swap</span> zip<span class="org-kcats-brackets">]</span>
         <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>all-links <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">sink</span>
             <span class="org-kcats-brackets">[[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> both <span class="org-comment-delimiter">;; </span><span class="org-comment">lookup the indices of both constraints</span>
              <span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">sink</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">move the indices under the constraints</span>
              <span class="org-kcats-brackets">[</span>links<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
              <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> 

             <span class="org-function-name">step</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-link <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-string">"c{0}.{1} = c{2}.{3}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span> 

 <span class="org-comment-delimiter">;; </span><span class="org-comment">formatting pieces of query data into text</span>
 <span class="org-kcats-brackets">[</span>anded-together <span class="org-kcats-brackets">[</span><span class="org-string">" AND "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">where clause data processing</span>
 <span class="org-kcats-brackets">[</span>where-data <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span> 
              <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> variable? not<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> = not<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> every?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> 
              <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> prepend<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-where <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> 
                <span class="org-string">"c{0}.{1} = :c{0}{1}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>make-where <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>where<span class="org-kcats-brackets">]</span> lookup anded-together<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span> <span class="org-kcats-brackets">[[[[</span>on<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[[</span>where<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup string<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span> anded-together<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span> 
               <span class="org-string">"JOIN EAV c{1} ON {0}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>make-query <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span> <span class="org-kcats-brackets">[[</span>on<span class="org-kcats-brackets">]</span>
                    <span class="org-kcats-brackets">[[</span>format-link<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> update
                    <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">SQL parameters for rusqlite</span>
 <span class="org-kcats-brackets">[</span>param-name <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-string">":c{0}{1}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>extract-params <span class="org-kcats-brackets">[[]</span> association <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span>params<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]</span>


 <span class="org-comment-delimiter">;; </span><span class="org-comment">SELECT clause</span>
 <span class="org-kcats-brackets">[</span>wordval? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> word?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>validate <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> not<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-string">"All selected query variables must appear somewhere in constraints"</span>
              <span class="org-kcats-brackets">[</span>reason variable<span class="org-kcats-brackets">]</span> label fail<span class="org-kcats-brackets">]</span>
             when<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>select-data <span class="org-kcats-brackets">[</span>dump <span class="org-builtin">swap</span>
               <span class="org-kcats-brackets">[[</span>slots selectkeys invert<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
                <span class="org-kcats-brackets">[</span>wordval?<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">join</span> association<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
               <span class="org-builtin">swap</span>
               <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make a list of the variable and 'index'</span>
                 <span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>selectkeys<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make the program to cut down</span>
                 <span class="org-function-name">map</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span> 2 =<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
                 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> number?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> when<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">items are in random order due to coming from association, fix the order</span>
                <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span>
               <span class="org-preprocessor">shield</span> dropdeep zip
               validate dump<span class="org-kcats-brackets">]]</span>

 <span class="org-comment-delimiter">;; </span><span class="org-comment">query </span>
 <span class="org-kcats-brackets">[</span>extract-data <span class="org-kcats-brackets">[[[[</span><span class="org-function-name">unwrap</span> all-links<span class="org-kcats-brackets">]</span>
                  <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> where-data   <span class="org-comment-delimiter">; </span><span class="org-comment">[join] inject unwrap</span>
                   <span class="org-comment-delimiter">;; </span><span class="org-comment">build the query param map</span>
                   <span class="org-kcats-brackets">[[[]</span> <span class="org-builtin">swap</span>
                     <span class="org-kcats-brackets">[[</span>param-name<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-function-name">wrap</span> <span class="org-builtin">swap</span> assign<span class="org-kcats-brackets">]</span>
                     <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span>
                    <span class="org-comment-delimiter">;; </span><span class="org-comment">build the actual query where clauses</span>
                    <span class="org-kcats-brackets">[[</span>format-where<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]]</span>
                   fork<span class="org-kcats-brackets">]]</span>
                 fork<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">combine extracted items</span>

                <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">keep the original constraint to add properties to</span>
                <span class="org-function-name">unwrap</span> <span class="org-function-name">unwrap</span> <span class="org-kcats-brackets">[</span>where params on<span class="org-kcats-brackets">]</span> label <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>format-select <span class="org-kcats-brackets">[[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span>
                  string butlast <span class="org-comment-delimiter">;; </span><span class="org-comment">remove the ? from the variable name for result column</span>
                  <span class="org-function-name">put</span>
                  <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
                  <span class="org-string">"c{1}.{0} as {2}"</span> <span class="org-builtin">swap</span> format<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-string">", "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]]</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">This is the program we need to modify that is `query`</span>

<span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">expand all combinations of constraints</span>
 <span class="org-kcats-brackets">[</span>constraint<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-comment-delimiter">;;</span><span class="org-comment">[] prepend ;; an empty constraint to represent the orignal EAV table we're joining with</span>
 <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> indexed-as-property
 triangle
 <span class="org-comment-delimiter">;; </span><span class="org-comment">for each pair of constraints, build the "ON" clause data for the JOIN</span>
 <span class="org-kcats-brackets">[</span>extract-data<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
 <span class="org-kcats-brackets">[[</span>extract-params<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>make-query<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>make-where<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> select-data<span class="org-kcats-brackets">]]</span> fork 
 <span class="org-builtin">dropdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">don't need original anymore</span>
 <span class="org-function-name">unwrap</span> <span class="org-builtin">float</span>
 <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>  
 <span class="org-builtin">swap</span> format-select 
 <span class="org-kcats-brackets">[</span><span class="org-string">" "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> triplet <span class="org-function-name">reverse</span>
 <span class="org-string">"SELECT {0} from EAV as c0 {1} WHERE {2}"</span> <span class="org-builtin">swap</span> format
 <span class="org-builtin">swap</span> dropdeep<span class="org-kcats-brackets">]</span>

let
<span class="org-kcats-brackets">[</span>query<span class="org-kcats-brackets">]</span> label  <span class="org-comment-delimiter">;; </span><span class="org-comment">the above program is the definition of `query`</span>

<span class="org-kcats-brackets">[[[</span>book? subjects love<span class="org-kcats-brackets">]</span>
  <span class="org-comment-delimiter">;</span><span class="org-comment">[book? subjects subjects?]</span>
  <span class="org-kcats-brackets">[</span>book? title book-title?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span> author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">first</span> author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">last</span>-name author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? sex m<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span>

  <span class="org-kcats-brackets">[</span>author? birth-year author-birth-year?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span>
 query
 database
<span class="org-kcats-brackets">]</span> let <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span>emoji<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> decache string read
<span class="org-kcats-brackets">[[[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>1 definition<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">unwrap</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">invert</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association

<span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span>*1 <span class="org-builtin">swap</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> <span class="org-kcats-brackets">]</span> pack
walk
</pre>
</div></li>
</ul>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>fork <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128668;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>triangle <span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#129668; &#128256; <span class="org-kcats-brackets">[[</span>&#128238;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9875; &#128256; pair<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span> collect<span class="org-kcats-brackets">]</span> &#128737;&#65039;&#128317;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>indexed-a-property <span class="org-kcats-brackets">[</span>&#128256; indexed <span class="org-kcats-brackets">[</span>&#127851; &#9875; assign<span class="org-kcats-brackets">]</span> &#128668; &#128465;&#65039;&#128317;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span>-all <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span> empty<span class="org-kcats-brackets">]</span>
             &#128737;&#65039; &#128256; <span class="org-kcats-brackets">[</span>&#128279;<span class="org-kcats-brackets">]</span> &#129692;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>selectkeys <span class="org-kcats-brackets">[</span>set &#128256; <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> contains?<span class="org-kcats-brackets">]</span>
               &#129522; &#128465;&#65039;&#128317;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> &#128668; association<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>variable? <span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>string <span class="org-function-name">last</span> \? =<span class="org-kcats-brackets">]]</span>
              <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128175;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>variable= <span class="org-kcats-brackets">[[[</span>pair <span class="org-kcats-brackets">[</span>variable?<span class="org-kcats-brackets">]</span> &#128175;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>=<span class="org-kcats-brackets">]]</span>
              <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128175;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[[</span>entity attribute value<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[</span>slot-combos <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>slots <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]</span> &#128668;<span class="org-kcats-brackets">]</span> &#128668; <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>constraint <span class="org-kcats-brackets">[</span>&#127851; slots <span class="org-function-name">reverse</span> label<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>links <span class="org-kcats-brackets">[</span>slot-combos <span class="org-kcats-brackets">[[</span>&#127873;<span class="org-kcats-brackets">]</span> &#128668; &#127851; &#128256;&#128317; <span class="org-kcats-brackets">[[[</span>lookup<span class="org-kcats-brackets">]</span> &#128137;<span class="org-kcats-brackets">]</span>
                                   both<span class="org-kcats-brackets">]</span>
                       pairwise variable=<span class="org-kcats-brackets">]</span>
          &#129522; <span class="org-kcats-brackets">[</span>&#127851; pair &#9875; pair <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
             &#128668; &#128256; zip<span class="org-kcats-brackets">]</span>
          &#128668;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>all-links <span class="org-kcats-brackets">[[]</span> &#9875; <span class="org-kcats-brackets">[[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                     &#128737;&#65039;<span class="org-kcats-brackets">]</span>
                    both <span class="org-kcats-brackets">[</span>&#128256;&#128317;<span class="org-kcats-brackets">]</span> &#129668; &#9875; <span class="org-kcats-brackets">[</span>links<span class="org-kcats-brackets">]</span> &#128737;&#65039;&#128317; &#128256; <span class="org-kcats-brackets">[</span>&#128465;&#65039;&#128317; &#128465;&#65039;&#128317; &#128279;<span class="org-kcats-brackets">]</span> &#129668;<span class="org-kcats-brackets">]</span>
              &#129692; &#128465;&#65039;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>format-link <span class="org-kcats-brackets">[[</span>&#128279;<span class="org-kcats-brackets">]</span> &#128137; &#127851; <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> &#128668; <span class="org-string">"c{0}.{1} = c{2}.{3}"</span> &#128256; format<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>anded-together <span class="org-kcats-brackets">[</span><span class="org-string">" AND "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>where-data <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
               &#128737;&#65039; &#128256; <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> variable? not<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> &#127851; = not<span class="org-kcats-brackets">]]</span>
                     <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128175;<span class="org-kcats-brackets">]</span>
               &#129522; <span class="org-kcats-brackets">[</span>&#128256; prepend<span class="org-kcats-brackets">]</span>
               &#128668; &#128465;&#65039;&#128317;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>format-where <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> &#128668; <span class="org-string">"c{0}.{1} = :c{0}{1}"</span> &#128256; format<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>make-where <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>where<span class="org-kcats-brackets">]</span> lookup anded-together<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span> <span class="org-kcats-brackets">[[[[</span>on<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                 <span class="org-kcats-brackets">[[</span>where<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
                 <span class="org-kcats-brackets">[[</span>index<span class="org-kcats-brackets">]</span> lookup string<span class="org-kcats-brackets">]]</span>
                <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128668; <span class="org-kcats-brackets">[</span>&#128279; anded-together<span class="org-kcats-brackets">]</span>
                &#128137; <span class="org-string">"JOIN EAV c{1} ON {0}"</span> &#128256; format<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>make-query <span class="org-kcats-brackets">[</span><span class="org-function-name">rest</span> <span class="org-kcats-brackets">[[</span>on<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>format-link<span class="org-kcats-brackets">]</span> &#128668;<span class="org-kcats-brackets">]</span>
                     update <span class="org-kcats-brackets">[</span>format-<span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128279;<span class="org-kcats-brackets">]</span> &#128256; assign<span class="org-kcats-brackets">]</span>
               &#128668;<span class="org-kcats-brackets">]]</span>
  
  <span class="org-kcats-brackets">[</span>param-name <span class="org-kcats-brackets">[[</span>string<span class="org-kcats-brackets">]</span> &#128668; <span class="org-string">":c{0}{1}"</span> &#128256; format<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>extract-params <span class="org-kcats-brackets">[[]</span> association &#128256; <span class="org-kcats-brackets">[[</span>params<span class="org-kcats-brackets">]</span> lookup &#128279;<span class="org-kcats-brackets">]</span> &#129692;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>wordval? <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> word?<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>invert <span class="org-kcats-brackets">[[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> &#128668; association<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>validate <span class="org-kcats-brackets">[[[</span><span class="org-function-name">second</span> not<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-string">"All selected query variables must appear somewhere in constraints"</span> <span class="org-kcats-brackets">[</span>reason
                                                                                          variable<span class="org-kcats-brackets">]</span>
               label fail<span class="org-kcats-brackets">]</span>
              when<span class="org-kcats-brackets">]</span>
             &#128668;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>select-data <span class="org-kcats-brackets">[</span>dump &#128256; <span class="org-kcats-brackets">[[</span>slots selectkeys invert<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-kcats-brackets">[</span>wordval?<span class="org-kcats-brackets">]</span> &#129522; &#128279; association<span class="org-kcats-brackets">]</span> &#128668;
                &#128256; <span class="org-kcats-brackets">[[[</span>index<span class="org-kcats-brackets">]</span> &#128256; &#128238; &#127873; <span class="org-kcats-brackets">[</span>selectkeys<span class="org-kcats-brackets">]</span> &#128279; &#128668; <span class="org-kcats-brackets">[</span><span class="org-function-name">count</span> 2 =<span class="org-kcats-brackets">]</span> &#129522; <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> &#128668; <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> number?<span class="org-kcats-brackets">]</span>
                    <span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> when<span class="org-kcats-brackets">]</span>
                   &#128668;<span class="org-kcats-brackets">]</span>
                &#128737;&#65039; &#128465;&#65039;&#9196; zip validate dump<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>extract-data <span class="org-kcats-brackets">[[[[</span>&#127851; all-links<span class="org-kcats-brackets">]</span>
                   <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> where-data <span class="org-kcats-brackets">[[[]</span> &#128256; <span class="org-kcats-brackets">[[</span>param-name<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-kcats-brackets">[</span><span class="org-function-name">last</span><span class="org-kcats-brackets">]</span> &#129668; &#127873; &#128256; assign<span class="org-kcats-brackets">]</span>
                                       &#129692;<span class="org-kcats-brackets">]</span>
                                      <span class="org-kcats-brackets">[[</span>format-where<span class="org-kcats-brackets">]</span> &#128668;<span class="org-kcats-brackets">]]</span>
                    fork<span class="org-kcats-brackets">]]</span>
                  fork<span class="org-kcats-brackets">]</span>
                 &#128737;&#65039; <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> &#129668; &#127851; &#127851; <span class="org-kcats-brackets">[</span>where params on<span class="org-kcats-brackets">]</span> label &#128279;<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>format-select <span class="org-kcats-brackets">[[</span>&#127851; &#128256; string butlast &#128238; <span class="org-kcats-brackets">[</span>string<span class="org-kcats-brackets">]</span> &#128668; <span class="org-string">"c{1}.{0} as {2}"</span> &#128256; format<span class="org-kcats-brackets">]</span>
                  &#128668; <span class="org-string">", "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[</span>constraint<span class="org-kcats-brackets">]</span> &#128668; <span class="org-kcats-brackets">[</span>index<span class="org-kcats-brackets">]</span> indexed-as-property triangle <span class="org-kcats-brackets">[</span>extract-data<span class="org-kcats-brackets">]</span> &#128668; <span class="org-kcats-brackets">[[</span>extract-params<span class="org-kcats-brackets">]</span>
                                                                          <span class="org-kcats-brackets">[</span>make-query<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>make-where<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256; select-data<span class="org-kcats-brackets">]]</span>
  fork &#128465;&#65039;&#128317; &#127851; &#128735; <span class="org-kcats-brackets">[[</span>&#128279;<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
  &#128668; &#128256; format-select <span class="org-kcats-brackets">[</span><span class="org-string">" "</span> interpose <span class="org-function-name">join</span>-all<span class="org-kcats-brackets">]</span> &#129668; triplet
  <span class="org-function-name">reverse</span> <span class="org-string">"SELECT {0} from EAV as c0 {1} WHERE {2}"</span> &#128256; format &#128256; &#128465;&#65039;&#9196;<span class="org-kcats-brackets">]</span>
 let <span class="org-kcats-brackets">[</span>query<span class="org-kcats-brackets">]</span> label <span class="org-kcats-brackets">[[[</span>book? subjects love<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? title book-title?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">last</span>
                                                                      author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>book? author-<span class="org-function-name">first</span> author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">first</span>-name author-<span class="org-function-name">first</span>?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? <span class="org-function-name">last</span>-name
                                                                                            author-<span class="org-function-name">last</span>?<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>author? sex m<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? country <span class="org-string">"United States"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>author? birth-year author-birth-year?<span class="org-kcats-brackets">]]</span>
                    <span class="org-kcats-brackets">[</span>book-title? author-<span class="org-function-name">first</span>? author-<span class="org-function-name">last</span>? author-birth-year?<span class="org-kcats-brackets">]</span> query database<span class="org-kcats-brackets">]</span>
 let &#9654;&#65039;<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[[</span>name <span class="org-string">"Mouse"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 50<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Laptop"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 1000<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.7<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Desktop"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 1500<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.9<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock <span class="org-kcats-brackets">[]]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Tungsten Cube"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 2500<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 3.4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Keyboard"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 70<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock <span class="org-kcats-brackets">[]]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Monitor"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 200<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Camera"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 600<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]]</span>

  <span class="org-comment-delimiter">;; </span><span class="org-comment">make a generator</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> 

  <span class="org-comment-delimiter">;; </span><span class="org-comment">keep only rating &gt;= 4.5 AND inStock</span>
  <span class="org-kcats-brackets">[[[[</span>rating<span class="org-kcats-brackets">]</span> lookup 4.5 &gt;=<span class="org-kcats-brackets">]</span> 
    <span class="org-kcats-brackets">[[</span>inStock<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
   every?<span class="org-kcats-brackets">]</span> keep

  <span class="org-comment-delimiter">;; </span><span class="org-comment">find the remaining product with highest price</span>
  <span class="org-kcats-brackets">[[</span>pair <span class="org-kcats-brackets">[[</span>price<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-function-name">unwrap</span> &gt;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span>
   <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
  fold<span class="org-kcats-brackets">]</span> 
 <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span>emoji<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> decache string read
<span class="org-kcats-brackets">[[[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>1 definition<span class="org-kcats-brackets">]</span> lookup <span class="org-function-name">unwrap</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">invert</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">reverse</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> association

<span class="org-kcats-brackets">[[[</span>word?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> *1 <span class="org-builtin">swap</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> 
 <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> pack
walk
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[</span>name <span class="org-string">"Mouse"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 50<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Laptop"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 1000<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.7<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Desktop"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 1500<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.9<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock <span class="org-kcats-brackets">[]]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Tungsten Cube"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 2500<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 3.4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Keyboard"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 70<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.8<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock <span class="org-kcats-brackets">[]]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Monitor"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 200<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Camera"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>price 600<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>rating 4.3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inStock yes<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[[</span>rating<span class="org-kcats-brackets">]</span> lookup 4.5 &gt;=<span class="org-kcats-brackets">]</span>
        <span class="org-kcats-brackets">[[</span>inStock<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]]</span>
       <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128175;<span class="org-kcats-brackets">]</span>
 keep <span class="org-kcats-brackets">[[</span>pair <span class="org-kcats-brackets">[[</span>price<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> &#128668; &#127851; &gt;<span class="org-kcats-brackets">]</span>
       <span class="org-kcats-brackets">[]</span>
       <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#9878;&#65039;
       &#128465;&#65039;<span class="org-kcats-brackets">]</span> fold<span class="org-kcats-brackets">]</span> &#128737;&#65039;
</pre>
</div>
</div>
</div>
<div id="outline-container-org582a561" class="outline-4">
<h4 id="org582a561"><span class="section-number-4">2.37.3.</span> <span class="done DONE">DONE</span> Decide standard syntax</h4>
<div class="outline-text-4" id="text-2-37-3">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-11-21 Thu 10:49]</span></span></li>
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-11 Mon 08:22]</span></span>
</p>

<p>
We can make the convention either "combinators actually execute the
programs they modify" or "combinators only modify and you need
<code>execute</code> explicitly if you want to execute now"
</p>

<p>
Choices to be made:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">shield</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">vs</span>
<span class="org-kcats-brackets">[</span>foo bar<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">shielded execute</span>

<span class="org-kcats-brackets">[</span>..<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>foo bar<span class="org-kcats-brackets">]</span> &#128737;&#65039;<span class="org-kcats-brackets">]</span> when
<span class="org-comment-delimiter">;;</span><span class="org-comment">vs</span>
<span class="org-kcats-brackets">[</span>..<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>foo bar<span class="org-kcats-brackets">]</span> &#128737;&#65039; when
</pre>
</div></li>
</ul>

<p>
I think there's a lot of merit for <code>shielded</code>, but I don't think the
same value applies to <code>dip</code>. I think generally you want to execute it
immediately.
</p>
</div>
</div>
<div id="outline-container-org439e43c" class="outline-4">
<h4 id="org439e43c"><span class="section-number-4">2.37.4.</span> <span class="todo INPROGRESS">INPROGRESS</span> Emit emoji for empty list</h4>
<div class="outline-text-4" id="text-2-37-4">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-04 Wed 20:17]</span></span></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga76f642" class="outline-3">
<h3 id="orga76f642"><span class="section-number-3">2.38.</span> <span class="done DONE">DONE</span> Change yes to nonempty container</h3>
<div class="outline-text-3" id="text-2-38">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-03 Tue 19:21]</span></span></li>
</ul>
<p>
Using some neutral "thing" emoji like:
🔘 or ⚪️ or 🎯 or 🔹 
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>pred<span class="org-kcats-brackets">]</span> -&gt; <span class="org-kcats-brackets">[</span>&#128280;<span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">; </span><span class="org-comment">"container has something"</span>
       -&gt; <span class="org-kcats-brackets">[]</span>    <span class="org-comment-delimiter">; </span><span class="org-comment">"container is empty"</span>
</pre>
</div>

<p>
The beauty is:
</p>
<ol class="org-ol">
<li>The emoji reinforces that the actual value doesn't matter</li>
<li>It's just a token to make the container non-empty</li>
<li>Users don't need to remember what it is</li>
<li><p>
Visually distinct from actual data values
</p>

<p>
So predicates become:
</p></li>
</ol>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>even?<span class="org-kcats-brackets">]</span>    <span class="org-comment-delimiter">; </span><span class="org-comment">Returns [&#128280;] or []</span>
<span class="org-kcats-brackets">[</span>any?<span class="org-kcats-brackets">]</span>     <span class="org-comment-delimiter">; </span><span class="org-comment">Returns [&#128280;] or []</span>
<span class="org-kcats-brackets">[</span>empty?<span class="org-kcats-brackets">]</span>   <span class="org-comment-delimiter">; </span><span class="org-comment">Returns [&#128280;] or []</span>

</pre>
</div>
<p>
This feels more "honest" than:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>yes<span class="org-kcats-brackets">]</span>      <span class="org-comment-delimiter">; </span><span class="org-comment">Why yes specifically?</span>
<span class="org-kcats-brackets">[</span>thing<span class="org-kcats-brackets">]</span>    <span class="org-comment-delimiter">; </span><span class="org-comment">Still feels like it should mean something</span>
</pre>
</div>

<p>
Can also add words <code>anything</code> and <code>nothing</code> as aliases for these, that we
can use in default branch for <code>decide</code> and other places.
</p>

<p>
Also consider ✅ for 'yes'
</p>
</div>
</div>
<div id="outline-container-org6de996a" class="outline-3">
<h3 id="org6de996a"><span class="section-number-3">2.39.</span> <span class="todo INPROGRESS">INPROGRESS</span> Combinators</h3>
<div class="outline-text-3" id="text-2-39">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-13 Wed 09:11]</span></span></li>
</ul>
</div>
<div id="outline-container-org9a57038" class="outline-4">
<h4 id="org9a57038"><span class="section-number-4">2.39.1.</span> <span class="todo TODO">TODO</span> Discussion</h4>
<div class="outline-text-4" id="text-2-39-1">
<p>
Let's think about what the language would look like if combinators
that take programs didn't actually execute them but rather spit out
new programs. Here's <code>looped</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>looped <span class="org-kcats-brackets">[[[</span>*1 <span class="org-preprocessor">execute</span>
            *1 looped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span>
           <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
          pack<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>10 yes <span class="org-kcats-brackets">[</span>-2 * <span class="org-builtin">clone</span> 50 &lt;<span class="org-kcats-brackets">]</span> looped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
let <span class="org-preprocessor">execute</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">160
</pre>
</div>

<p>
step
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> 
                   *1 <span class="org-preprocessor">dip</span>
                   *1 stepped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
           pack<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> stepped<span class="org-kcats-brackets">]</span>
let <span class="org-preprocessor">execute</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-builtin">evert</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>sized?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>update <span class="org-kcats-brackets">[</span>dictionary program<span class="org-kcats-brackets">]</span>
           label environment <span class="org-kcats-brackets">[</span>*1 capture evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> pack <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
           <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
           <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
   <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>modules <span class="org-kcats-brackets">[]]</span>
   <span class="org-kcats-brackets">[</span>words 205_entries<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> *1 <span class="org-preprocessor">dip</span> *1 stepped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
             pack<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[]]</span>
 <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>modules<span class="org-kcats-brackets">]</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> stepped<span class="org-kcats-brackets">]</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span>
                                                                           update<span class="org-kcats-brackets">]</span>
                                                                          <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                                                                    <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
                                                         <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                                                              <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
                                                         <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                                                  <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
                                                 <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>modules <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>words 205_entries<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> *1 <span class="org-preprocessor">dip</span> *1 stepped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
           pack<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>



<p>
Here's some more 
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span>&#128101; <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> 
                   *1 <span class="org-preprocessor">dip</span>
                   *1 stepped &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
           pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> **1 <span class="org-builtin">evert</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> **1 <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>iffed <span class="org-kcats-brackets">[[</span>**3 <span class="org-comment-delimiter">;; </span><span class="org-comment">the condition</span>
          *2 *1 <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>looped <span class="org-kcats-brackets">[[[</span>**1
            *1 looped &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span>
           <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
          pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#9203; <span class="org-kcats-brackets">[[</span>*2 <span class="org-comment-delimiter">;; </span><span class="org-comment">run conditional</span>
           <span class="org-kcats-brackets">[</span>**1 <span class="org-comment-delimiter">;; </span><span class="org-comment">run body</span>
            *2 *1 &#9203; <span class="org-comment-delimiter">;; </span><span class="org-comment">next iteration</span>
            &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">do nothing if condition is false</span>
          pack <span class="org-function-name">unwrap</span> iffed<span class="org-kcats-brackets">]]]</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[2 3 [dropdown odd?] shielded ["odd"] ["even"] iffed]</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[3 [+] dipped 4 5 float execute]</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[1 2 [10 3 4 5] [* +] injection execute]</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[1 2 3 [dropdown *] shielded]</span>
  <span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> stepped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
 <span class="org-comment-delimiter">;</span><span class="org-comment">[5 [0 &gt;] &#128737;&#65039;</span>
 <span class="org-comment-delimiter">; </span><span class="org-comment">[&#128101; dec] &#9203; &#9654;&#65039;]</span>
 let &#9654;&#65039;
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-builtin">evert</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>sized?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>update <span class="org-kcats-brackets">[</span>dictionary program<span class="org-kcats-brackets">]</span>
           label environment <span class="org-kcats-brackets">[</span>*1 capture evaluate <span class="org-kcats-brackets">[</span>stack<span class="org-kcats-brackets">]</span> lookup restore<span class="org-kcats-brackets">]</span> pack &#9654;&#65039;<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
           <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
           <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
    <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
   <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>modules <span class="org-kcats-brackets">[]]</span>
   <span class="org-kcats-brackets">[</span>words 205_entries<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span>&#128101; <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> *1 <span class="org-preprocessor">dip</span> *1 stepped &#9654;&#65039;<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
             pack<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> **1 <span class="org-builtin">evert</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>&#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> **1 <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>iffed <span class="org-kcats-brackets">[[</span>**3 *2 *1 <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>looped <span class="org-kcats-brackets">[[[</span>**1 *1 looped &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
   <span class="org-kcats-brackets">[</span>&#9203; <span class="org-kcats-brackets">[[</span>*2 <span class="org-kcats-brackets">[</span>**1 *2 *1 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]</span> pack <span class="org-function-name">unwrap</span> iffed<span class="org-kcats-brackets">]]]</span>
  <span class="org-kcats-brackets">[]]</span>
 <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>modules<span class="org-kcats-brackets">]</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> stepped <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span>
                                                                            <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                                                                            <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
                                                                 <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>entry<span class="org-kcats-brackets">]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span>
                                                                      <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
                                                                 <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                                                          <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
                                                         <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>modules <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>words 205_entries<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>stepped <span class="org-kcats-brackets">[[</span>&#128101; <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> *1 <span class="org-preprocessor">dip</span> *1 stepped &#9654;&#65039;<span class="org-kcats-brackets">]</span>
            <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
           pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span>dipped <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> **1 <span class="org-builtin">evert</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128137; <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> **1 <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>iffed <span class="org-kcats-brackets">[[</span>**3 *2 *1 <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>looped <span class="org-kcats-brackets">[[[</span>**1 *1 looped &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>&#9203; <span class="org-kcats-brackets">[[</span>*2 <span class="org-kcats-brackets">[</span>**1 *2 *1 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]</span> pack <span class="org-function-name">unwrap</span> iffed<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[</span>2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> *1 <span class="org-preprocessor">dip</span> *1 stepped &#9654;&#65039;<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span> 
         pack <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>stepped<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>stepped &#9654;&#65039;<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 4<span class="org-kcats-brackets">]</span>
3
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[</span>2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span> <span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> stepped &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org83beb8a" class="outline-4">
<h4 id="org83beb8a"><span class="section-number-4">2.39.2.</span> <span class="done DONE">DONE</span> Update branch behavior to keep conditional</h4>
<div class="outline-text-4" id="text-2-39-2">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-11-16 Sat 18:52]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-13 Wed 12:21]</span></span></li>
</ul>
<p>
Currently <code>branch</code> discards the value it uses to choose a program to
run. But sometimes the program needs it. The false branch basically
never needs it so maybe we could auto-discard it. AI says that's weird
but I think it's better than having to prepend 'drop' to at least half
the programs.
</p>

<p>
try 'bail' impl
</p>
<div class="org-src-container">
<pre class="src src-kcats">3
<span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-kcats-brackets">[</span>3
                     <span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
                     <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
                     <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">][</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span>
          <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec <span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span>
                                          <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                         <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
                                         <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
                                         <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">]</span>
                              <span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
          <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>number?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec <span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span>
                                 <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
                                <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
                                <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">]</span>
                     <span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
2 3
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a 1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>b 2<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span>
<span class="org-kcats-brackets">[</span>lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">execute</span> assign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>b 3<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
recur
</p>
<div class="org-src-container">
<pre class="src src-kcats">3
<span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[**2 [*4 *3 *2 *1  recur execute] **1] [pack] shielddeep execute  dropdown if execute </span>
<span class="org-preprocessor">recur</span>  <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6
</pre>
</div>

<p>
decide(r)
</p>
<div class="org-src-container">
<pre class="src src-kcats">  6 <span class="org-kcats-brackets">[[</span>even?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]]</span>
  <span class="org-function-name">take</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">break up the pair</span>
   <span class="org-builtin">swap</span> 
   <span class="org-preprocessor">shield</span>
   <span class="org-comment-delimiter">;; </span><span class="org-comment">recur </span>
   flip <span class="org-kcats-brackets">[</span>*1 decide<span class="org-kcats-brackets">]</span> pack <span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">branch</span>
<span class="org-comment-delimiter">;  </span><span class="org-comment">[[]] or ;; return a program that returns nothing</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual even?<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>program?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>6 decide<span class="org-kcats-brackets">]</span>
even? <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">words <span class="org-kcats-brackets">[</span>decide definition<span class="org-kcats-brackets">]</span> lookup

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span> <span class="org-preprocessor">shield</span> flip <span class="org-kcats-brackets">[</span>*1 decide<span class="org-kcats-brackets">]</span>
       pack <span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
 bail <span class="org-kcats-brackets">[[]]</span> or<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
flatten
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b <span class="org-kcats-brackets">[</span>c <span class="org-kcats-brackets">[</span>d e<span class="org-kcats-brackets">]</span> f<span class="org-kcats-brackets">]</span> g<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c d e f g<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>inc <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> 
  <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span>
                        <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
                        <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
                        <span class="org-preprocessor">recur</span> <span class="org-comment-delimiter">;</span><span class="org-comment">execute unwrap</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>inc <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span>
            <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>inc <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
 <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>1 2 <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span>
      6<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-kcats-brackets">[</span>3 <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>inc <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> **1<span class="org-kcats-brackets">]</span> pack 
<span class="org-kcats-brackets">[</span>list? not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-builtin">swap</span>
<span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span> <span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span> <span class="org-function-name">unwrap</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>2 3 <span class="org-kcats-brackets">[</span>4 <span class="org-kcats-brackets">[</span>5 6<span class="org-kcats-brackets">]</span>
      7<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
map
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-builtin">dropdown</span> 5 + +<span class="org-kcats-brackets">]</span> 

<span class="org-kcats-brackets">[[</span><span class="org-builtin">swap</span> *1 <span class="org-preprocessor">shielddown</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">put empty results below list</span>
 <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> pack

<span class="org-kcats-brackets">[</span>12 13 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]]</span> <span class="org-preprocessor">dip</span>
<span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>18 19 20 21<span class="org-kcats-brackets">]</span> 13 12
</pre>
</div>

<p>
filter
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[[</span>*1 <span class="org-preprocessor">shield</span>
   <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span>
   <span class="org-preprocessor">if</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>  
pack
<span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span>
             <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">dropdown</span><span class="org-kcats-brackets">]</span>
       <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
  <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">shield</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">run the predicate with no stack effect</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if match, drop the pred result and put the original item.</span>

<span class="org-function-name">step</span>
<span class="org-kcats-brackets">[</span>*1 <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">place the empty result container beneath</span>
pack <span class="org-preprocessor">execute</span>

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 3<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">if</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span>
</pre>
</div>



<p>
fix step to not literally clone
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>1 23 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> 
                      *1 <span class="org-builtin">clone</span> <span class="org-preprocessor">dipdown</span>
                      <span class="org-function-name">step</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
                    pack <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">33
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"hi"</span><span class="org-kcats-brackets">]</span> 5 <span class="org-kcats-brackets">[</span>*1 <span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> dec <span class="org-kcats-brackets">[</span>*2 <span class="org-builtin">clone</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">times</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> pack 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>5 <span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> dec <span class="org-kcats-brackets">[[</span><span class="org-string">"hi"</span><span class="org-kcats-brackets">]</span> <span class="org-builtin">clone</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">times</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
prime
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 mod 0 = not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;</span><span class="org-comment">prime</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> **1<span class="org-kcats-brackets">]</span> pack<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">swap</span> <span class="org-function-name">join</span> <span class="org-preprocessor">while</span> <span class="org-function-name">join</span> <span class="org-preprocessor">execute</span>

<span class="org-comment-delimiter">;</span><span class="org-comment">[*3 clone *1 swap join *2 swap while] pack execute</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[[clone [execute] dip] divedown join while] pack</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[clone [execute] dip] divedown  join  while </span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual 1<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>dispenser?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>4 mod 0 = not<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-function-name">take</span>
                                                                       <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span>
           <span class="org-preprocessor">while</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]]]</span>
1 <span class="org-kcats-brackets">[</span>2 3 4 5<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
maybe we don't need prime?
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>1 2 3 4<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">while</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> 10
</pre>
</div>

<p>
redefine while in terms of recur?
</p>

<div class="org-src-container">
<pre class="src src-kcats">3 <span class="org-kcats-brackets">[</span>0 &gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">0 1 2 3
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb00d301" class="outline-4">
<h4 id="orgb00d301"><span class="section-number-4">2.39.3.</span> <span class="todo INPROGRESS">INPROGRESS</span> Update generators to compose more naturally</h4>
<div class="outline-text-4" id="text-2-39-3">
<ul class="org-ul">
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-16 Sat 18:52]</span></span>
</p>

<p>
The problem previously was that generators left a bunch of machinery
 on the stack. I think we can compose them via wrapping. I think we
 could have done that before. The challenge is figuring out how to
 keep state inside the program and only putting it onto the stack
 when needed.
</p>

<p>
We have a program that produces a value like <code>[take]</code> but it's not a
generator. To be a generator it needs to run itself and leave a copy
of itself below the produced item. So we can write 'generator', so that you only need to 'execute' the generator:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 11 23 4 5 6 7<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span> &#11036; &#11036; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">take from the source, swap the recurring</span>
                   <span class="org-comment-delimiter">;;</span><span class="org-comment">program beneath the value, if empty do nothing</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">increment each</span>
<span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039; <span class="org-kcats-brackets">[</span>*2 bail **1<span class="org-kcats-brackets">]</span> pack <span class="org-kcats-brackets">[]</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[&#9654;&#65039;] &#128256;</span>
 <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the generator below. If we get a value,</span>
                      <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the provided program on that value </span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">keep odd values</span>
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">build the conditional for recurrence</span>
<span class="org-kcats-brackets">[[</span>&#9654;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the generator below to get value v</span>
  <span class="org-kcats-brackets">[</span>*1 &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">check if v does NOT match given pred, </span>
  <span class="org-kcats-brackets">[</span>&#11036; &#11036;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if generator below is finished, return 2 empty values </span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop both the value v and the result of pred</span>
 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">repeat until generator below is finished</span>
pack
&#11036; <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">drop non-matching values in a while loop</span>
                <span class="org-comment-delimiter">;; </span><span class="org-comment">then emit a matching value</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">collect</span>
&#11036; <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128238;<span class="org-kcats-brackets">]</span> &#11036; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">place an empty container for results,</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">then execute the generator below.</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">If we get a value, place it in the container</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">and recur, otherwise stop.</span>
&#9654;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the whole thing</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">result =&gt; [5 7]</span>

<span class="org-comment-delimiter">; </span><span class="org-comment">[1 11 23 4 5 6 7]</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">liberate</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">[inc] each</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">[odd?] keep</span>
<span class="org-comment-delimiter">; </span><span class="org-comment">collect</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>number?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>* <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>11 23
                                                                           4 5 6 7<span class="org-kcats-brackets">]]</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                                                                              <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
                                                                                                             bail <span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                                                                             <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                                                                            <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                                                                                                           &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>odd?<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#11036; &#11036;<span class="org-kcats-brackets">]</span>
           &#8596;&#65039; <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#9654;&#65039; <span class="org-kcats-brackets">[[</span>odd?<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#11036; &#11036;<span class="org-kcats-brackets">]</span>
                       &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
               <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[[[</span>&#9654;&#65039; <span class="org-kcats-brackets">[[</span>odd?<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#11036; &#11036;<span class="org-kcats-brackets">]</span>
                         &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                        <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                        &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                      &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>&#11036;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>&#128238; <span class="org-kcats-brackets">[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011;<span class="org-kcats-brackets">]</span>
                                   <span class="org-kcats-brackets">[</span>&#128238;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
                                &#9654;&#65039;<span class="org-kcats-brackets">]</span>

           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>11 23 4 5 6 7<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
below is a version of 'each' that wraps the previous generator (needs
 that dropdeep, not sure why - something to do with the inner
 recurrence replacing itself AND the outer recurrence also replacing
 the inner recurrence along with the outer.
</p>

<p>
The solution is to separate the "produce a value" eg <code>[take]</code>, from a
generator (which both produces a value AND sets itself up to be
called again). The <code>recur</code> is a generator, but you don't want to wrap
a generator with a generator. You want to wrap a <b>producer</b> with a
generator - the generator should be the final bit added, I suppose
at consumption time? But then once you've made the generator you
can't add more layers?
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 11 23 4 5 6 7<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span><span class="org-comment-delimiter">; </span><span class="org-comment">&#11036; &#11036; [&#128256;] &#129670; ;; take from the source, swap the recurring</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">program beneath the value, if empty do nothing</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">increment each</span>
<span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039; <span class="org-kcats-brackets">[</span>**2 *1 bail<span class="org-kcats-brackets">]</span> pack <span class="org-comment-delimiter">;</span><span class="org-comment">[] [&#11036;] [&#128256; ] &#129670; ;; execute the generator below. If we get a value,</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">execute drop execute</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">execute the provided program on that value</span>
 <span class="org-kcats-brackets">[</span>*1 &#128011;<span class="org-kcats-brackets">]</span> pack <span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span>  <span class="org-kcats-brackets">[</span>&#128238;<span class="org-kcats-brackets">]</span> &#11036; <span class="org-kcats-brackets">[</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 121 529 16 25 36 49<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
I don't think this actually works because generators like <code>keep</code> need
to call their parents multiple times. So the generation logic is needed
</p>

<div class="org-src-container">
<pre class="src src-kcats">0 100 1 range
<span class="org-kcats-brackets">[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">take from the source, swap the recurring</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">program beneath the value, if empty do nothing</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">increment each</span>
<span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039; <span class="org-kcats-brackets">[</span>**2 *1 bail<span class="org-kcats-brackets">]</span> &#127890;
<span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the generator below. If we get a value,</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">execute the provided program on that value, dropping the parent generator</span>

<span class="org-kcats-brackets">[</span>7 mod 0 =<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">build the conditional for recurrence</span>
<span class="org-kcats-brackets">[[</span>**2 <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the generator below to get value v</span>
  <span class="org-kcats-brackets">[</span>*1 &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">check if v does NOT match given pred, </span>
  <span class="org-kcats-brackets">[</span>&#128307; &#128307;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if generator below is finished, return 2 empty values </span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop both the value v and the result of pred</span>
 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">repeat until generator below is finished</span>
&#127890;
<span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">drop non-matching values in a while loop</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">then emit a matching value</span>

<span class="org-comment-delimiter">;</span><span class="org-comment">&#128307; [[*1 &#128011;] &#127890;] &#129668; &#128256; [&#128238;] &#128307; [&#9654;&#65039;] &#129670;  &#9654;&#65039;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>actual <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                      <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
           bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                  <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                       bail<span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                 &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
           &#8596;&#65039;<span class="org-kcats-brackets">]</span>
          <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
          &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>number?<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>* <span class="org-kcats-brackets">[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                           <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                            <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                       <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                            bail<span class="org-kcats-brackets">]</span>
                           <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                      &#128256;<span class="org-kcats-brackets">]</span>
                <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
                &#8596;&#65039;<span class="org-kcats-brackets">]</span>
               <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
               &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 8 9 10 11 12 13
                                                                  14 15 16 17 18 19 20
                                                                  21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40
                                                                  41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60
                                                                  61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80
                                                                  81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99<span class="org-kcats-brackets">]]</span>
           <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                       <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                  <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                       bail<span class="org-kcats-brackets">]</span>
                                      <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                 &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
           &#8596;&#65039; <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                  <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                       bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                   <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                              <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                   bail<span class="org-kcats-brackets">]</span>
                                  <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                             &#128256;<span class="org-kcats-brackets">]</span>
                       <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
                       &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                      <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
               &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                             <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                        <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                             bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                         <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                    <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                         bail<span class="org-kcats-brackets">]</span>
                                        <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                   &#128256;<span class="org-kcats-brackets">]</span>
                             <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
                             &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                            <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                            &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                           <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                      &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>&#128238; <span class="org-kcats-brackets">[[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                       <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                  <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                       bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                   <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                              <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                   bail<span class="org-kcats-brackets">]</span>
                                                  <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                             &#128256;<span class="org-kcats-brackets">]</span>
                                       <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
                                       &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                                      <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                                      &#9203; &#9654;&#65039; <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                   <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                              <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                   bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                               <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                                          <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                               bail<span class="org-kcats-brackets">]</span>
                                                              <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                                         &#128256;<span class="org-kcats-brackets">]</span>
                                                   <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
                                                   &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                                                  <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
                                                  &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                                 <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                            &#128256;<span class="org-kcats-brackets">]</span>
                                      <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]</span>
                                     &#128011;<span class="org-kcats-brackets">]</span>
                                    <span class="org-kcats-brackets">[</span>&#128238;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                 &#9654;&#65039;<span class="org-kcats-brackets">]</span>

           <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
             <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
  bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                         <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
              bail<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
        &#128256;<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
             <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
  bail <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
              <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">snapshot</span> <span class="org-builtin">evert</span> <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                         <span class="org-preprocessor">dip</span> <span class="org-builtin">evert</span> <span class="org-builtin">dropdown</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
              bail<span class="org-kcats-brackets">]</span>
             <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span>
        &#128256;<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
 &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span> &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 8 9 10 11 12 13
                                                    14 15 16 17 18 19 20
                                                    21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40
                                                    41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60
                                                    61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80
                                                    81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 100 1 range
liberate
<span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> each
<span class="org-kcats-brackets">[</span>7 mod 0 =<span class="org-kcats-brackets">]</span> keep
collect
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>49 196 441 784 1225 1764 2401 3136 3969 4900 5929 7056 8281 9604<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
work on keep to wrap previous
</p>
<div class="org-src-container">
<pre class="src src-kcats">1 100 1 range liberate
<span class="org-kcats-brackets">[</span> 7 mod 0 =<span class="org-kcats-brackets">]</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">build the conditional for recurrence</span>
<span class="org-kcats-brackets">[</span>*2
 <span class="org-kcats-brackets">[</span>&#9654;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">execute the generator below to get value v</span>
  <span class="org-kcats-brackets">[</span>*1 &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">check if v does NOT match given pred, </span>
  <span class="org-kcats-brackets">[</span>&#128307; &#128307;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if generator below is finished, return 2 empty values </span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop both the value v and the result of pred</span>
 &#9203; &#9654;&#65039; <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">repeat until generator below is finished</span>
&#127890;
<span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span> &#128256;<span class="org-kcats-brackets">]</span> &#129670; <span class="org-comment-delimiter">;; </span><span class="org-comment">drop non-matching values in a while loop</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">then emit a matching value</span>
&#128307; <span class="org-kcats-brackets">[[</span> &#128011;<span class="org-kcats-brackets">]</span> &#127890; <span class="org-kcats-brackets">]</span> &#129668; &#128256; <span class="org-kcats-brackets">[</span>&#128238; &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#128307; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670;  &#9654;&#65039; 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>7 14 21 28 35 42 49 56 63 70 77 84 91 98<span class="org-kcats-brackets">]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org61b2afe" class="outline-4">
<h4 id="org61b2afe"><span class="section-number-4">2.39.4.</span> <span class="done DONE">DONE</span> Fix recur logic</h4>
<div class="outline-text-4" id="text-2-39-4">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-17 Sun 19:37]</span></span></li>
</ul>
<p>
The branches are backward, should match <code>while</code>, with the loop body
being first. Currently recur has the exit branch first and the main
body 2nd.
</p>

<div class="org-src-container">
<pre class="src src-kcats">5
<span class="org-kcats-brackets">[</span>2 &gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">clone</span> dec dump<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>**3 <span class="org-kcats-brackets">[</span>*4 *3 *2 *1 <span class="org-preprocessor">recur</span> <span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> **1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>pack<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">shielddeep</span> <span class="org-preprocessor">execute</span> dropdeep <span class="org-builtin">swap</span> <span class="org-preprocessor">if</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>3 4 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>2 3 4 5<span class="org-kcats-brackets">]</span>
120
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>pred<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>then<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>else<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>combo<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>*3 <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[]</span>  <span class="org-kcats-brackets">]</span> 
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc8f1255" class="outline-4">
<h4 id="orgc8f1255"><span class="section-number-4">2.39.5.</span> <span class="done DONE">DONE</span> Every</h4>
<div class="outline-text-4" id="text-2-39-5">
<ul class="org-ul">
<li>State "DONE"       from "INPROGRESS" <span class="timestamp-wrapper"><span class="timestamp">[2024-11-23 Sat 19:56]</span></span></li>
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-23 Sat 11:02]</span></span>
two booleans: all matching so far?
 is there any more numbers?</li>
</ul>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">11 [2 4 6] [+ odd?] &#8226;&#128737;&#65039;</span>
12 <span class="org-kcats-brackets">[[</span> even?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 mod 0 =<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039;
 <span class="org-kcats-brackets">[[</span>&#128228; &#128256; 1&#65039;&#8419; &#128011; &#128101;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">more items</span>
  <span class="org-kcats-brackets">[[]</span> &#9989; <span class="org-kcats-brackets">[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">empty list, return &#9989;</span>
  &#8596;&#65039;<span class="org-kcats-brackets">]</span> &#127890;
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;  
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">&#9989; 12
</pre>
</div>
</div>
</div>
<div id="outline-container-org063293f" class="outline-4">
<h4 id="org063293f"><span class="section-number-4">2.39.6.</span> <span class="todo INPROGRESS">INPROGRESS</span> Recover</h4>
<div class="outline-text-4" id="text-2-39-6">
<ul class="org-ul">
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-11-23 Sat 19:56]</span></span>
</p>

<div class="org-src-container">
<pre class="src src-kcats"> 1 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128465;&#65039; 2 +<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">snapshot</span><span class="org-kcats-brackets">]</span> &#128011;
&#128256; <span class="org-kcats-brackets">[</span>handle<span class="org-kcats-brackets">]</span> &#128279; &#128137; &#9654;&#65039; 
<span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> error?<span class="org-kcats-brackets">]</span> &#128737;&#65039;
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#9986;&#65039;1&#65039;&#8419;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> &#128465;&#65039;<span class="org-kcats-brackets">]</span>
&#9878;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#127890; &#9654;&#65039; 


<span class="org-comment-delimiter">;</span><span class="org-comment">[[[&#9986;&#65039;1&#65039;&#8419; handle] &#127890;] &#129668; ;; add handle to the end of test</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[snapshot] &#8226;&#129668; ;; rec test ss</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">sink inject &#9654;&#65039; ;; res rec</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">first error?] &#128737;&#65039;  ;; err? res rec</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[&#128465;&#65039; &#8226;&#128465;&#65039; &#128256; &#9654;&#65039;];; drop the snapshot and run recovery</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">[evert &#128465;&#65039;] ;; use snapshot as stack</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">if &#9654;&#65039; </span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 <span class="org-string">"oh fudge"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>5 +<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#128248;<span class="org-kcats-brackets">]</span> &#128011;
 &#128256; <span class="org-kcats-brackets">[</span>handle<span class="org-kcats-brackets">]</span> &#128279; &#128137; &#9654;&#65039; 
 <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> error?<span class="org-kcats-brackets">]</span> &#128737;&#65039;
 <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#9986;&#65039;1&#65039;&#8419;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span><span class="org-builtin">evert</span> &#128465;&#65039;<span class="org-kcats-brackets">]</span>
 &#9878;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#127890; <span class="org-kcats-brackets">[</span>&#127873;<span class="org-kcats-brackets">]</span> &#129668; &#128279; &#128668; &#9654;&#65039;

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>6 7 5<span class="org-kcats-brackets">]</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org34edec9" class="outline-3">
<h3 id="org34edec9"><span class="section-number-3">2.40.</span> <span class="todo TODO">TODO</span> Rename combinators to noun-based</h3>
<div class="outline-text-3" id="text-2-40">
<dl class="org-dl">
<dt>recur</dt><dd>recurrence</dd>
<dt>repeat</dt><dd>repetition</dd>
<dt>inject</dt><dd>injection</dd>
<dt>(no term)</dt><dd>::</dd>
</dl>

<p>
Most of these no longer matter since they're emojis but there are some english stragglers.
</p>
</div>
</div>
<div id="outline-container-org4444a82" class="outline-3">
<h3 id="org4444a82"><span class="section-number-3">2.41.</span> <span class="done DONE">DONE</span> Support 'doc' field of dictionary entries</h3>
<div class="outline-text-3" id="text-2-41">
<ul class="org-ul">
<li>State "DONE"       from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-03 Tue 19:08]</span></span></li>
</ul>
</div>
</div>
<div id="outline-container-org95536d9" class="outline-3">
<h3 id="org95536d9"><span class="section-number-3">2.42.</span> <span class="todo INPROGRESS">INPROGRESS</span> Back to stacking generators with optional encapsulation</h3>
<div class="outline-text-3" id="text-2-42">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-11 Wed 20:12]</span></span></li>
</ul>
</div>
<div id="outline-container-orgd2b4d28" class="outline-4">
<h4 id="orgd2b4d28"><span class="section-number-4">2.42.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> See if we can wrap state with generator</h4>
<div class="outline-text-4" id="text-2-42-1">
<ul class="org-ul">
<li>State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-11 Wed 20:12]</span></span></li>
</ul>
<p>
The fact that there's leftover state even after a generator is done,
seems wrong. We should get rid of both.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> liberator 5
<span class="org-kcats-brackets">[[[</span>positive?<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128465;&#65039; 1&#65039;&#8419; &#128011;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#9878;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#127890;<span class="org-kcats-brackets">]</span>
&#128011; <span class="org-kcats-brackets">[[</span>dec &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span>
    &#129668;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039; &#128307;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670;

collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
I think a good approach here may be to use evert/inject. So instead of
just stacking generators right on top of the stack, wrap it in a list,
and inject to generate a value, then take to extract:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>  <span class="org-kcats-brackets">[[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> liberator <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> each collect<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039;
<span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039; &#128228;
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>consume<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled &#128307;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"not enough items on stack"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
               &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
              bail<span class="org-kcats-brackets">]</span>
           &#129668; &#128256; <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                      &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                               &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                              bail<span class="org-kcats-brackets">]</span>
                      &#129668; &#128256;<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039; <span class="org-kcats-brackets">[</span>1 4 9 16 25<span class="org-kcats-brackets">]</span> &#128256; <span class="org-kcats-brackets">[</span>&#128238; &#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                            &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                     &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                    bail<span class="org-kcats-brackets">]</span>
                                            &#129668; &#128256; <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                       &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                                &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                               bail<span class="org-kcats-brackets">]</span>
                                                       &#129668; &#128256;<span class="org-kcats-brackets">]</span>
                                                      <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                                 &#128256;<span class="org-kcats-brackets">]</span>
                                            <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                                           &#128011;<span class="org-kcats-brackets">]</span>
                                          <span class="org-kcats-brackets">[</span>&#128238; &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span>
                                          &#128307; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                   &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           &#128307; &#8596;&#65039; &#128307; &#129510; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039; &#128228;<span class="org-kcats-brackets">]]]</span>
&#128307;
</pre>
</div>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> liberator <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> each collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>consume<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled &#128307;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"not enough items on stack"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
               &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
              bail<span class="org-kcats-brackets">]</span>
           &#129668; &#128256; <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                      &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                               &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                              bail<span class="org-kcats-brackets">]</span>
                      &#129668; &#128256;<span class="org-kcats-brackets">]</span>
                     <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                &#128256;<span class="org-kcats-brackets">]</span>
           <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039; <span class="org-kcats-brackets">[</span>1 4 9 16 25<span class="org-kcats-brackets">]</span> &#128256; <span class="org-kcats-brackets">[</span>&#128238; &#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                            &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                     &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                    bail<span class="org-kcats-brackets">]</span>
                                            &#129668; &#128256; <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039; <span class="org-kcats-brackets">[[</span>&#128228; <span class="org-kcats-brackets">[[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128256;<span class="org-kcats-brackets">]</span>
                                                       &#128307; &#8596;&#65039; &#128256; <span class="org-kcats-brackets">[[</span>&#128248; &#129510; <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
                                                                &#129668; &#129510; &#8226;&#128465;&#65039; <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span>
                                                               bail<span class="org-kcats-brackets">]</span>
                                                       &#129668; &#128256;<span class="org-kcats-brackets">]</span>
                                                      <span class="org-kcats-brackets">[</span>&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                                 &#128256;<span class="org-kcats-brackets">]</span>
                                            <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span>
                                           &#128011;<span class="org-kcats-brackets">]</span>
                                          <span class="org-kcats-brackets">[</span>&#128238; &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span>
                                          &#128307; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
                                   &#9654;&#65039;<span class="org-kcats-brackets">]</span>
           &#128307; &#8596;&#65039;<span class="org-kcats-brackets">]]]</span>
&#128307;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf188a7e" class="outline-4">
<h4 id="orgf188a7e"><span class="section-number-4">2.42.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Convert some generators to not wrap</h4>
<div class="outline-text-4" id="text-2-42-2">
<ul class="org-ul">
<li><p>
State "INPROGRESS" from "TODO"       <span class="timestamp-wrapper"><span class="timestamp">[2024-12-11 Wed 20:12]</span></span>
</p>

<div class="org-src-container">
<pre class="src src-kcats">-1 <span class="org-kcats-brackets">[</span>&#128101; inc<span class="org-kcats-brackets">]</span> generator &#9654;&#65039; 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[[</span>&#128101; inc<span class="org-kcats-brackets">]</span>
   &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
-1
</pre>
</div>

<p>
test combining generators
</p>
<div class="org-src-container">
<pre class="src src-kcats">  <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>integers generator<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039;
  <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>5 taker<span class="org-kcats-brackets">]</span>  &#128137; &#9654;&#65039; &#128256; &#128279; 
<span class="org-kcats-brackets">[</span>collect<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039; <span class="org-function-name">first</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 1 2 3 4<span class="org-kcats-brackets">]</span>
</pre>
</div></li>
</ul>

<p>
now try combining before execution
</p>
<div class="org-src-container">
<pre class="src src-kcats">   <span class="org-kcats-brackets">[</span>integers generator<span class="org-kcats-brackets">]</span> &#128137; 
   <span class="org-kcats-brackets">[</span>5 taker<span class="org-kcats-brackets">]</span>  &#128137; &#128279;
   <span class="org-kcats-brackets">[]</span> &#128256; &#9654;&#65039; 
<span class="org-kcats-brackets">[</span>collect<span class="org-kcats-brackets">]</span> &#128137; &#9654;&#65039; <span class="org-function-name">first</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 1 2 3 4<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
encapsulation
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> liberator
 <span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> keep
 collect<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> &#128256; &#128137; &#9654;&#65039; <span class="org-function-name">first</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 3 5<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
aka assemble
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>odd?<span class="org-kcats-brackets">]</span> keep
 collect<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>liberator &#9986;&#65039;1&#65039;&#8419;<span class="org-kcats-brackets">]</span> &#127890;
<span class="org-kcats-brackets">[</span>&#127873;<span class="org-kcats-brackets">]</span> &#129668; &#128137; &#9654;&#65039; <span class="org-function-name">first</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 3 5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
<div id="outline-container-orgefc56a9" class="outline-5">
<h5 id="orgefc56a9"><span class="section-number-5">2.42.2.1.</span> each</h5>
<div class="outline-text-5" id="text-2-42-2-1">
<div class="org-src-container">
<pre class="src src-kcats">integers generator
5 taker
<span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span>
&#8226;&#128737;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">prevent mapping program from overwriting stack</span>
<span class="org-kcats-brackets">[</span>&#9654;&#65039; 1&#65039;&#8419; bail<span class="org-kcats-brackets">]</span> &#127890; <span class="org-comment-delimiter">;; </span><span class="org-comment">only execute the mapping program if parent produces value</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; 
collect
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 1 4 9 16<span class="org-kcats-brackets">]</span> 4
</pre>
</div>
</div>
</div>
<div id="outline-container-org96114d4" class="outline-5">
<h5 id="org96114d4"><span class="section-number-5">2.42.2.2.</span> joiner</h5>
<div class="outline-text-5" id="text-2-42-2-2">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 5 6<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>7 8 9<span class="org-kcats-brackets">]]</span> liberator
<span class="org-kcats-brackets">[</span>&#128279;<span class="org-kcats-brackets">]</span> fold
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 8 9<span class="org-kcats-brackets">]</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats">
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>expected <span class="org-kcats-brackets">[[</span>&#128279;<span class="org-kcats-brackets">]</span> fold<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled &#128307;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"Deprecated"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound &#128307;<span class="org-kcats-brackets">]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8534841" class="outline-5">
<h5 id="org8534841"><span class="section-number-5">2.42.2.3.</span> skipper</h5>
<div class="outline-text-5" id="text-2-42-2-3">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">integers generator</span>
<span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 8 9 10<span class="org-kcats-brackets">]</span> liberator
<span class="org-kcats-brackets">[</span>5 &lt;<span class="org-kcats-brackets">]</span>
&#9989;
<span class="org-kcats-brackets">[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#129668; 
  <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#129668; and<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>&#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128307; &#128307;
<span class="org-kcats-brackets">[</span>&#128735; &#128307; &#9875;<span class="org-kcats-brackets">]</span>
&#129670;
<span class="org-comment-delimiter">;</span><span class="org-comment">30 taker</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>5 6 7 8 9 10<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#129668; <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#129668; and<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128307; <span class="org-kcats-brackets">[</span>dump<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128735; &#128307; &#9875;<span class="org-kcats-brackets">]</span> &#129670;
                &#9654;&#65039;<span class="org-kcats-brackets">]</span>
&#128307; <span class="org-kcats-brackets">[</span>5 &lt;<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
have : rform pred val
need : val rform [] pred gform
float -&gt; val rform pred
[] sink 
</p>
<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#129668; <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#129668; and<span class="org-kcats-brackets">]</span> &#128307; &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>dump &#128735; &#128307; &#128256; dump<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 &lt;<span class="org-kcats-brackets">]</span>
 5 <span class="org-kcats-brackets">[[</span>inc &#128101;<span class="org-kcats-brackets">]</span>
    &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>5 &#128307; <span class="org-kcats-brackets">[[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#129668; <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#129668; and<span class="org-kcats-brackets">]</span> &#128307; &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>dump &#128735; &#128307; &#128256; dump<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5
                                                                                &lt;<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[[</span>inc &#128101;<span class="org-kcats-brackets">]</span>
  &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#129668; <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#129668; and<span class="org-kcats-brackets">]</span> &#128307; &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>dump &#128735; &#128307; &#128256; dump<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 &lt;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>inc &#128101;<span class="org-kcats-brackets">]</span>
 &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
5
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> &#9775;&#65039; &#9775;&#65039;
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">&#128307;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">integers generator</span>
<span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 1<span class="org-kcats-brackets">]</span> liberator
<span class="org-kcats-brackets">[</span>5 &lt;<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">get the item from parent</span>
<span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">run the pred on it, keep the pred</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]]</span> &#9878;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">when parent is empty, leave negative on the stack</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">keep consuming items while they match pred</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">first value that doesn't match pred, drop pred,</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">leave an empty generator that falls through to the value below</span>
<span class="org-kcats-brackets">[[[]]]</span> &#8596;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">if parent ran out, leave a generator that produces end-of-stream</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">30 taker</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>5 6 7 1<span class="org-kcats-brackets">]</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 -3 4 5<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> skipper collect<span class="org-kcats-brackets">]</span>
assemble
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>-3 4 5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf7dbba5" class="outline-5">
<h5 id="orgf7dbba5"><span class="section-number-5">2.42.2.4.</span> keep</h5>
<div class="outline-text-5" id="text-2-42-2-4">
<div class="org-src-container">
<pre class="src src-kcats">integers generator
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span>

<span class="org-kcats-brackets">[</span>&#9654;&#65039;  <span class="org-comment-delimiter">;; </span><span class="org-comment">exec the generator below to get value v</span>
 <span class="org-kcats-brackets">[</span>1&#65039;&#8419; &#128737;&#65039; &#9654;&#65039; &#9775;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">check if v does NOT match given pred, </span>
 <span class="org-kcats-brackets">[</span>&#128307; &#128307;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if generator below is finished, return 2 empty values </span>
 &#8596;&#65039; <span class="org-kcats-brackets">]</span> &#127890;
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">drop both the value v and the result of pred</span>
&#9203; <span class="org-comment-delimiter">;; </span><span class="org-comment">repeat until generator below is finished</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670;
5 taker
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 3 5 7 9<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>inc &#128101;<span class="org-kcats-brackets">]</span>
             &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
9
</pre>
</div>
</div>
</div>
<div id="outline-container-org06b0205" class="outline-5">
<h5 id="org06b0205"><span class="section-number-5">2.42.2.5.</span> dropper</h5>
<div class="outline-text-5" id="text-2-42-2-5">
<div class="org-src-container">
<pre class="src src-kcats">  <span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7<span class="org-kcats-brackets">]</span> liberator
  6 
  <span class="org-kcats-brackets">[[[[[</span>positive?<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
     <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011; <span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128175; &#9654;&#65039;<span class="org-kcats-brackets">]</span>

   <span class="org-kcats-brackets">[</span>&#128465;&#65039; dec<span class="org-kcats-brackets">]</span> &#9203; &#9654;&#65039; dump <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span> collect
<span class="org-comment-delimiter">;</span><span class="org-comment">&#9654;&#65039; &#128465;&#65039; &#9654;&#65039; &#128465;&#65039; &#9654;&#65039; &#128465;&#65039; &#9654;&#65039; </span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>7<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[</span>7<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5 6 7 8 9 10<span class="org-kcats-brackets">]</span> 
 <span class="org-kcats-brackets">[</span>  11
   <span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">condition</span>
   <span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011; <span class="org-comment-delimiter">;; </span><span class="org-comment">call parent </span>
    <span class="org-kcats-brackets">[]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if we get something, we're done</span>
    <span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise signal stop with empty generator</span>
    &#8596;&#65039;<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>&#128465;&#65039; &#9654;&#65039; <span class="org-kcats-brackets">[]]</span> &#9878;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">if counter reaches zero we're done dropping </span>
   <span class="org-kcats-brackets">[</span>&#128465;&#65039; dec<span class="org-kcats-brackets">]</span> &#9203; <span class="org-comment-delimiter">;; </span><span class="org-comment">decrement the counter and drop the value we got</span>
<span class="org-comment-delimiter">;</span><span class="org-comment">10 taker</span>
   collect<span class="org-kcats-brackets">]</span> assemble
<span class="org-comment-delimiter">;</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">&#128307;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span> liberator
3
<span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">counter still positive?</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011; <span class="org-comment-delimiter">;; </span><span class="org-comment">run the parent generator</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[]]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">add padding to drop later</span>
<span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> &#9878;&#65039; <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise return nothing</span>
<span class="org-kcats-brackets">[[</span>dec<span class="org-kcats-brackets">]</span> &#129668;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">decrement counter</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039; &#128307;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">discard the counter and parent, all done</span>
<span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670;
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">
</pre>
</div>
</div>
</div>
<div id="outline-container-orga22c272" class="outline-5">
<h5 id="orga22c272"><span class="section-number-5">2.42.2.6.</span> catcher</h5>
<div class="outline-text-5" id="text-2-42-2-6">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 -4 5<span class="org-kcats-brackets">]</span> liberator
<span class="org-kcats-brackets">[</span>positive?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011; <span class="org-comment-delimiter">;; </span><span class="org-comment">get value from parent</span>
 <span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039;<span class="org-kcats-brackets">]</span> bail <span class="org-comment-delimiter">;; </span><span class="org-comment">only check pred iff we get a value, preserve pred</span>
 &#128307;
 <span class="org-kcats-brackets">[</span>&#128307; &#128307; &#128307;<span class="org-kcats-brackets">]</span> &#8596;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">place some dummy values to drop if we didn't get a value</span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128256;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">iff pred matches drop the pred result </span>
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#128465;&#65039; &#128465;&#65039; &#128307;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise drop all the stuff we no longer need</span>
&#9878;&#65039; &#128307;
<span class="org-kcats-brackets">[[</span>&#128307;<span class="org-kcats-brackets">]</span> &#128307;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; collect

</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128307;<span class="org-kcats-brackets">]</span> -4 <span class="org-kcats-brackets">[[</span>&#128228;<span class="org-kcats-brackets">]</span> &#128307; &#128307; <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdaa5aa8" class="outline-5">
<h5 id="orgdaa5aa8"><span class="section-number-5">2.42.2.7.</span> produce</h5>
<div class="outline-text-5" id="text-2-42-2-7">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>integers generator
 <span class="org-kcats-brackets">[</span>&#128101; *<span class="org-kcats-brackets">]</span> each
 10 taker
 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> fold<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> &#128256; &#128137; &#9654;&#65039; <span class="org-function-name">first</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">285
</pre>
</div>
</div>
</div>
<div id="outline-container-orga5e75c1" class="outline-5">
<h5 id="orga5e75c1"><span class="section-number-5">2.42.2.8.</span> cram</h5>
<div class="outline-text-5" id="text-2-42-2-8">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;</span><span class="org-comment">[&#9654;&#65039;] &#129668; ;; generate the first item below the reducer</span>
integers generator 5 dropper 10 taker
0
<span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#8226;&#128011;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">check that we generated another item</span>
<span class="org-kcats-brackets">[</span>&#128256; <span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128737;&#65039; &#9654;&#65039; &#9875; &#8226;&#128465;&#65039; &#8226;&#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if so, run the reducer shielded and drop component items</span>
&#128307; <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise stop</span>
<span class="org-kcats-brackets">[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670;
&#9654;&#65039; &#128465;&#65039;
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">95 14
</pre>
</div>
</div>
</div>
<div id="outline-container-orgacc5d4d" class="outline-5">
<h5 id="orgacc5d4d"><span class="section-number-5">2.42.2.9.</span> indexer</h5>
<div class="outline-text-5" id="text-2-42-2-9">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span> liberator
0 <span class="org-kcats-brackets">[[</span>&#9654;&#65039;<span class="org-kcats-brackets">]</span> &#128011; <span class="org-kcats-brackets">[[</span>pair<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039; &#9654;&#65039; <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> &#129668;<span class="org-kcats-brackets">]</span> bail<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>&#128465;&#65039; <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span>&#128256;<span class="org-kcats-brackets">]</span> &#129670; collect 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>0 foo<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 bar<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 baz<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>indexer collect<span class="org-kcats-brackets">]</span> assemble 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>0 foo<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>1 bar<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>2 baz<span class="org-kcats-brackets">]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf411ec8" class="outline-5">
<h5 id="orgf411ec8"><span class="section-number-5">2.42.2.10.</span> flatten</h5>
<div class="outline-text-5" id="text-2-42-2-10">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a <span class="org-kcats-brackets">[</span>b <span class="org-kcats-brackets">[</span>c e f<span class="org-kcats-brackets">]</span> d<span class="org-kcats-brackets">]]</span> &#128307; &#128256;
<span class="org-kcats-brackets">[</span>list?<span class="org-kcats-brackets">]</span> &#128737;&#65039; <span class="org-kcats-brackets">[</span>&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128238;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#129692; &#9654;&#65039;<span class="org-kcats-brackets">]</span> &#129670; &#9654;&#65039;
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>a b c e f d<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdb01225" class="outline-5">
<h5 id="orgdb01225"><span class="section-number-5">2.42.2.11.</span> siphon</h5>
<div class="outline-text-5" id="text-2-42-2-11">
<p>
deprecate?
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>integers generator
 100 dropper
 10 taker
 <span class="org-kcats-brackets">[</span>character<span class="org-kcats-brackets">]</span> each
 <span class="org-string">""</span> &#129529; &#9654;&#65039;<span class="org-kcats-brackets">]</span>
siphon
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"defghijklm"</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org2d053d1" class="outline-3">
<h3 id="org2d053d1"><span class="section-number-3">2.43.</span> <span class="todo TODO">TODO</span> max-by min-by</h3>
<div class="outline-text-3" id="text-2-43">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>price 25<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>name bar<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>price 15<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>name foo<span class="org-kcats-brackets">]]</span>
<span class="org-kcats-brackets">[[</span>price<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>compare-by &#127873;<span class="org-kcats-brackets">]</span> &#8226;&#128737;&#65039; &#9654;&#65039; <span class="org-kcats-brackets">[</span>less<span class="org-kcats-brackets">]</span> =
<span class="org-kcats-brackets">[</span>&#128465;&#65039; &#8226;&#128465;&#65039;<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>&#128465;&#65039;<span class="org-kcats-brackets">]</span> &#8596;&#65039; 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>price 25<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>name bar<span class="org-kcats-brackets">]]</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Skyrod Vactai</p>
<p class="date">Created: 2025-02-20 Thu 20:43</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
